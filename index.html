<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Plantafel Digital</title>
  <style>
    :root {
      --bg-main: #15181d;
      --bg-panel: #1f232a;
      --bg-col: #1a1d23;
      --line: #30343b;
      --accent: #2b7bff;
      --danger: #d53b3b;
      --txt: #fff;
      --txt-dim: #c5cbd6;
      --radius-lg: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg-main);
      color: var(--txt);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: .5rem;
    }
    header {
      display: flex;
      align-items: center;
      gap: .6rem;
      padding: .6rem .9rem;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.04);
    }
    header .pill {
      background: #0f9d58;
      width: .55rem;
      height: .55rem;
      border-radius: 999px;
      margin-right: .35rem;
    }
    select, input, button {
      border: none;
      outline: none;
      font: inherit;
    }
    select, input {
      background: #0f1115;
      color: #fff;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 8px;
      padding: .3rem .5rem;
    }
    button {
      background: var(--accent);
      color: #fff;
      border-radius: 9px;
      padding: .35rem .7rem;
      cursor: pointer;
      transition: .15s;
    }
    button.secondary {
      background: rgba(0,0,0,.0);
      border: 1px solid rgba(255,255,255,.07);
    }
    button:hover { opacity: .9; }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .5rem;
      overflow: hidden;
      padding: 0 .6rem .6rem;
    }

    /* FEINPLANUNG (14 Tage / 4 Wochen) */
    .board-fein {
      display: flex;
      flex-direction: column;
      gap: .5rem;
      overflow: auto;
    }
    .week-row {
      display: grid;
      grid-template-columns: repeat(5, minmax(180px, 1fr));
      gap: .5rem;
      min-height: 170px;
    }
    .day-col {
      background: var(--bg-col);
      border: 1px solid rgba(255,255,255,.02);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      min-height: 140px;
    }
    .day-head {
      padding: .35rem .45rem .25rem;
      border-bottom: 1px solid rgba(255,255,255,.03);
      font-size: .7rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--txt-dim);
    }
    .day-body {
      flex: 1;
      padding: .35rem .4rem .4rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    .card {
      background: rgba(0,0,0,.13);
      border: 1px solid rgba(255,255,255,.04);
      border-radius: 10px;
      padding: .25rem .35rem;
      font-size: .65rem;
      display: flex;
      flex-direction: column;
      gap: .2rem;
      cursor: grab;
    }
    .card small { color: rgba(0,0,0,.4); } /* wird eh überschrieben */
    .badge {
      display: inline-flex;
      gap: .3rem;
      align-items: center;
      font-size: .58rem;
      background: rgba(0,0,0,.25);
      padding: .1rem .35rem;
      border-radius: 999px;
    }
    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
    }
    .card-title { font-weight: 600; }
    .card-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: .6rem;
      cursor: pointer;
    }

    /* GROBPLANUNG 12 MONATE */
    .board-grob {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, minmax(220px,1fr));
      gap: .7rem;
      overflow: auto;
    }
    .month-col {
      background: var(--bg-col);
      border: 1px solid rgba(255,255,255,.02);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      min-height: 180px;
    }
    .month-head {
      padding: .35rem .5rem;
      border-bottom: 1px solid rgba(255,255,255,.03);
      font-size: .72rem;
      color: var(--txt-dim);
      display: flex;
      justify-content: space-between;
    }
    .month-body {
      flex: 1;
      padding: .35rem .4rem .4rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    /* DIALOGE */
    dialog {
      border: none;
      background: rgba(9,9,9,.6);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1rem 1rem .8rem;
      color: #fff;
      width: min(420px, 90vw);
    }
    dialog::backdrop { background: rgba(0,0,0,.3); }
    .dlg-title { font-weight: 600; margin-bottom: .5rem; }
    .field { display: flex; flex-direction: column; gap: .25rem; margin-bottom: .45rem;}
    .field label { font-size: .65rem; color: var(--txt-dim); }
    .field input, .field select, .field textarea {
      background: #0f1115;
      border: 1px solid rgba(255,255,255,.05);
      border-radius: 7px;
      padding: .25rem .45rem;
      color: #fff;
      font-size: .72rem;
    }
    .dlg-actions {
      display: flex;
      justify-content: flex-end;
      gap: .4rem;
      margin-top: .4rem;
    }

    /* kleine Helfer */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <header>
    <div class="pill"></div>
    <span>verbunden</span>
    <label style="margin-left:.6rem;">Ansicht:</label>
    <select id="viewSel">
      <option value="4w">4 Wochen (Mo–Fr)</option>
      <option value="14d">14 Tage (Mo–Fr)</option>
      <option value="12m">12 Monate (grob)</option>
    </select>
    <label style="margin-left:.6rem;">Start:</label>
    <input type="date" id="startDate">
    <button id="btnReload" class="secondary">Neu laden</button>
    <label style="margin-left:auto; display:flex; gap:.3rem; align-items:center;">
      <input type="checkbox" id="chkUrlaub" /> Urlaub/Krank/Schule
    </label>
    <label style="display:flex; gap:.3rem; align-items:center;">
      <input type="checkbox" id="chkAutoReload" checked /> Auto-Reload
    </label>
    <button id="btnMaster" class="secondary">Stammdaten</button>
    <button id="btnAdd">+ Eintrag</button>
  </header>

  <main>
    <div id="board" class="board-fein"></div>
  </main>

  <!-- Dialog Eintrag -->
  <dialog id="entryDlg">
    <div class="dlg-title" id="dlgTitle">Neuer Eintrag</div>
    <form method="dialog" id="entryForm">
      <div class="field" id="fldTitel">
        <label for="eTitel">Auftrag / Titel</label>
        <input id="eTitel" required />
      </div>
      <div class="field">
        <label for="eMitarbeiter">Mitarbeiter</label>
        <select id="eMitarbeiter">
          <option value="">– keiner –</option>
        </select>
      </div>
      <div class="field" id="fldFahrzeug">
        <label for="eFahrzeug">Fahrzeug</label>
        <select id="eFahrzeug">
          <option value="">– keines –</option>
        </select>
      </div>
      <div class="field" id="fldBaustelle">
        <label for="eBaustelle">Baustelle</label>
        <select id="eBaustelle">
          <option value="">– keine –</option>
        </select>
      </div>
      <div class="field">
        <label for="eStatus">Status</label>
        <select id="eStatus">
          <option value="">normal</option>
          <option value="urlaub">Urlaub</option>
          <option value="krank">Krank</option>
          <option value="schule">Schule</option>
        </select>
      </div>
      <div class="field">
        <label for="eNotiz">Notiz</label>
        <textarea id="eNotiz" rows="2"></textarea>
      </div>
      <input type="hidden" id="eDate">
      <input type="hidden" id="eId">
      <div class="dlg-actions">
        <button type="button" id="btnEntryCancel" class="secondary">Abbrechen</button>
        <button type="submit" id="btnEntrySave">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog Stammdaten -->
  <dialog id="masterDlg">
    <div class="dlg-title">Stammdaten</div>
    <div class="field">
      <label>Mitarbeitername</label>
      <div style="display:flex; gap:.3rem;">
        <input id="mName" placeholder="z. B. Thomas" />
        <button type="button" id="btnMAdd">+ Hinzufügen</button>
      </div>
      <ul id="mList"></ul>
    </div>
    <div class="field">
      <label>Fahrzeug</label>
      <div style="display:flex; gap:.3rem;">
        <input id="fName" placeholder="z. B. Doka" />
        <button type="button" id="btnFAdd">+ Hinzufügen</button>
      </div>
      <ul id="fList"></ul>
    </div>
    <div class="field">
      <label>Baustelle</label>
      <div style="display:flex; gap:.3rem;">
        <input id="bName" placeholder="z. B. Musterstraße 4" />
        <button type="button" id="btnBAdd">+ Hinzufügen</button>
      </div>
      <ul id="bList"></ul>
    </div>
    <div class="dlg-actions">
      <button type="button" id="btnMasterClose">Schließen</button>
    </div>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";

    const supa = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM
    const board = document.getElementById("board");
    const viewSel = document.getElementById("viewSel");
    const startDateInput = document.getElementById("startDate");
    const btnReload = document.getElementById("btnReload");
    const chkUrlaub = document.getElementById("chkUrlaub");
    const chkAutoReload = document.getElementById("chkAutoReload");
    const btnAdd = document.getElementById("btnAdd");
    const btnMaster = document.getElementById("btnMaster");
    const entryDlg = document.getElementById("entryDlg");
    const masterDlg = document.getElementById("masterDlg");
    const eTitel = document.getElementById("eTitel");
    const eMitarbeiter = document.getElementById("eMitarbeiter");
    const eFahrzeug = document.getElementById("eFahrzeug");
    const eBaustelle = document.getElementById("eBaustelle");
    const eStatus = document.getElementById("eStatus");
    const eNotiz = document.getElementById("eNotiz");
    const eDate = document.getElementById("eDate");
    const eId = document.getElementById("eId");
    const btnEntryCancel = document.getElementById("btnEntryCancel");
    const btnEntrySave = document.getElementById("btnEntrySave");
    const mName = document.getElementById("mName");
    const fName = document.getElementById("fName");
    const bName = document.getElementById("bName");
    const mList = document.getElementById("mList");
    const fList = document.getElementById("fList");
    const bList = document.getElementById("bList");
    const btnMAdd = document.getElementById("btnMAdd");
    const btnFAdd = document.getElementById("btnFAdd");
    const btnBAdd = document.getElementById("btnBAdd");
    const btnMasterClose = document.getElementById("btnMasterClose");
    const fldTitel = document.getElementById("fldTitel");
    const fldFahrzeug = document.getElementById("fldFahrzeug");
    const fldBaustelle = document.getElementById("fldBaustelle");

    // STATE
    let entries = [];
    let mitarbeiter = [];
    let fahrzeuge = [];
    let baustellen = [];
    let autoReloadTimer = null;

    // Hilfen
    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function startOfWeek(date) {
      const d = new Date(date);
      // Montag = 1
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      return d;
    }
    function iso(d) { return d.toISOString().slice(0,10); }
    function addDaysSkipWeekend(d, count) {
      const nd = new Date(d);
      let added = 0;
      while (added < count) {
        nd.setDate(nd.getDate() + 1);
        if (nd.getDay() !== 0 && nd.getDay() !== 6) {
          added++;
        }
      }
      return nd;
    }
    function hashColor(str) {
      // deterministic color from string
      let h = 0;
      for (let i=0;i<str.length;i++) h = str.charCodeAt(i) + ((h<<5)-h);
      const hue = Math.abs(h) % 360;
      return `hsl(${hue}, 65%, 50%)`;
    }
    function cardColorFor(entry) {
      if (entry.status === "urlaub" || entry.status === "krank" || entry.status === "schule") {
        return "var(--danger)";
      }
      if (entry.mitarbeiter) return hashColor(entry.mitarbeiter);
      if (entry.fahrzeug) return "#2b7bff";
      if (entry.baustelle) return "#ff9f43";
      return "rgba(255,255,255,.05)";
    }

    // LOAD DATA
    async function loadAll() {
      const [eRes, mRes, fRes, bRes] = await Promise.all([
        supa.from("plantafel").select("*").order("tag",{ascending:true}),
        supa.from("mitarbeiter").select("*"),
        supa.from("fahrzeuge").select("*"),
        supa.from("baustellen").select("*")
      ]);
      entries = eRes.data || [];
      mitarbeiter = mRes.data || [];
      fahrzeuge = fRes.data || [];
      baustellen = bRes.data || [];
      fillMasterLists();
      render();
    }

    function fillMasterLists() {
      // Dialog listen
      mList.innerHTML = mitarbeiter.length ? mitarbeiter.map(m=>`<li>${m.name}</li>`).join("") : "<li>Keine Mitarbeiter</li>";
      fList.innerHTML = fahrzeuge.length ? fahrzeuge.map(m=>`<li>${m.name}</li>`).join("") : "<li>Keine Fahrzeuge</li>";
      bList.innerHTML = baustellen.length ? baustellen.map(m=>`<li>${m.name}</li>`).join("") : "<li>Keine Baustellen</li>";
      // Form selects
      eMitarbeiter.innerHTML = '<option value="">– keiner –</option>' + mitarbeiter.map(m=>`<option value="${m.name}">${m.name}</option>`).join("");
      eFahrzeug.innerHTML = '<option value="">– keines –</option>' + fahrzeuge.map(m=>`<option value="${m.name}">${m.name}</option>`).join("");
      eBaustelle.innerHTML = '<option value="">– keine –</option>' + baustellen.map(m=>`<option value="${m.name}">${m.name}</option>`).join("");
    }

    function render() {
      const view = viewSel.value;
      board.innerHTML = "";
      if (view === "12m") {
        board.className = "board-grob";
        renderGrob();
      } else {
        board.className = "board-fein";
        renderFein(view);
      }
    }

    function renderFein(view) {
      // 4 Wochen (Mo-Fr) = 4 week-rows x 5 cols
      const startISO = startDateInput.value || todayISO();
      let d = startOfWeek(startISO);

      if (view === "4w") {
        for (let w=0; w<4; w++) {
          const row = document.createElement("div");
          row.className = "week-row";
          for (let day=0; day<5; day++) {
            const dayDate = new Date(d);
            dayDate.setDate(d.getDate() + (w*7) + day);
            const col = buildDayCol(dayDate);
            row.appendChild(col);
          }
          board.appendChild(row);
        }
      } else {
        // 14 Tage (Mo-Fr) -> 2 Zeilen à 7 Arbeitstage
        const days = [];
        let cur = startOfWeek(startISO);
        // wir gehen einfach 14 Arbeitstage durch
        let need = 14;
        while (need>0) {
          if (cur.getDay() !== 0 && cur.getDay() !== 6) {
            days.push(new Date(cur));
            need--;
          }
          cur.setDate(cur.getDate()+1);
        }
        // 2 rows
        for (let r=0;r<2;r++) {
          const row = document.createElement("div");
          row.className = "week-row";
          for (let c=0;c<7;c++) {
            const idx = r*7 + c;
            const dayDate = days[idx];
            const col = dayDate ? buildDayCol(dayDate) : document.createElement("div");
            if (dayDate) row.appendChild(col);
          }
          board.appendChild(row);
        }
      }
    }

    function buildDayCol(dateObj) {
      const col = document.createElement("div");
      col.className = "day-col";
      col.dataset.date = iso(dateObj);

      const head = document.createElement("div");
      head.className = "day-head";
      head.innerHTML = `<span>${weekday(dateObj)} ${iso(dateObj)}</span><button class="secondary" data-add="${iso(dateObj)}" style="font-size:.55rem;padding:.1rem .35rem;">+</button>`;
      const body = document.createElement("div");
      body.className = "day-body";
      // entries for this day (is_detailed=true)
      const todays = entries.filter(e=>e.is_detailed && e.tag === iso(dateObj));
      const filterUrlaub = chkUrlaub.checked;
      todays.forEach(e=>{
        if (!filterUrlaub && (e.status==="urlaub"||e.status==="krank"||e.status==="schule")) return;
        body.appendChild(buildCard(e));
      });

      col.appendChild(head);
      col.appendChild(body);

      // drop handlers
      col.addEventListener("dragover", ev => ev.preventDefault());
      col.addEventListener("drop", ev => {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("text/plain");
        if (!id) return;
        const targetDate = col.dataset.date;
        moveEntryToDate(id, targetDate, true);
      });

      return col;
    }

    function weekday(d) {
      const names = ["So","Mo","Di","Mi","Do","Fr","Sa"];
      return names[d.getDay()];
    }

    function renderGrob() {
      // 12 Monate ab Start
      const startISO = startDateInput.value || todayISO();
      const start = new Date(startISO);
      const startMonth = start.getMonth();
      const startYear = start.getFullYear();

      for (let i=0;i<12;i++) {
        const mCol = document.createElement("div");
        mCol.className = "month-col";
        const monthDate = new Date(startYear, startMonth + i, 1);
        const monthISO = monthDate.toISOString().slice(0,7); // YYYY-MM
        const head = document.createElement("div");
        head.className = "month-head";
        head.innerHTML = `<span>${monthName(monthDate)}</span><button class="secondary" data-add-month="${monthISO}" style="font-size:.55rem;padding:.1rem .35rem;">+</button>`;
        const body = document.createElement("div");
        body.className = "month-body";

        // entries with this month and is_detailed = false
        const monEntries = entries.filter(e => !e.is_detailed && e.tag && e.tag.startsWith(monthISO));
        monEntries.forEach(e=>{
          body.appendChild(buildCard(e));
        });

        mCol.appendChild(head);
        mCol.appendChild(body);

        // allow drop
        mCol.addEventListener("dragover", ev=>ev.preventDefault());
        mCol.addEventListener("drop", ev=>{
          ev.preventDefault();
          const id = ev.dataTransfer.getData("text/plain");
          if (!id) return;
          // move back to grob: just set is_detailed=false
          updateEntry(id, { is_detailed: false });
        });

        board.appendChild(mCol);
      }
    }

    function monthName(d) {
      return d.toLocaleString("de-DE",{month:"long", year:"numeric"});
    }

    function buildCard(e) {
      const div = document.createElement("div");
      div.className = "card";
      div.draggable = true;
      div.dataset.id = e.id;
      const col = cardColorFor(e);
      div.style.background = col;
      div.style.borderColor = "rgba(0,0,0,.1)";
      div.style.color = "#fff";

      const top = document.createElement("div");
      top.className = "card-top";
      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = e.titel || (e.status ? e.status.toUpperCase() : "(ohne Titel)");
      const close = document.createElement("button");
      close.className = "card-close";
      close.textContent = "×";
      close.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        if (confirm("Eintrag löschen?")) deleteEntry(e.id);
      });
      top.appendChild(title);
      top.appendChild(close);

      const meta = document.createElement("div");
      meta.style.display = "flex";
      meta.style.flexWrap = "wrap";
      meta.style.gap = ".2rem";
      meta.style.fontSize = ".58rem";
      if (e.mitarbeiter) {
        const s = document.createElement("span");
        s.className = "badge";
        s.textContent = e.mitarbeiter;
        s.style.background = "rgba(0,0,0,.25)";
        meta.appendChild(s);
      }
      if (e.fahrzeug) {
        const s = document.createElement("span");
        s.className = "badge";
        s.textContent = e.fahrzeug;
        s.style.background = "rgba(0,0,0,.25)";
        meta.appendChild(s);
      }
      if (e.baustelle) {
        const s = document.createElement("span");
        s.className = "badge";
        s.textContent = e.baustelle;
        s.style.background = "rgba(0,0,0,.25)";
        meta.appendChild(s);
      }
      if (e.status) {
        const s = document.createElement("span");
        s.className = "badge";
        s.textContent = e.status;
        s.style.background = "rgba(0,0,0,.25)";
        meta.appendChild(s);
      }

      div.appendChild(top);
      if (meta.children.length) div.appendChild(meta);
      if (e.notiz) {
        const p = document.createElement("div");
        p.textContent = e.notiz;
        p.style.fontSize = ".55rem";
        p.style.opacity = .9;
        div.appendChild(p);
      }

      div.addEventListener("dragstart", ev=>{
        ev.dataTransfer.setData("text/plain", e.id);
      });

      div.addEventListener("click", ()=>{
        openEntryDialog(e);
      });

      return div;
    }

    // CRUD
    async function createEntry(data) {
      const { data:ins, error } = await supa.from("plantafel").insert(data).select().single();
      if (!error && ins) {
        entries.push(ins);
        render();
      }
    }
    async function updateEntry(id, patch) {
      const { data:upd, error } = await supa.from("plantafel").update(patch).eq("id", id).select().single();
      if (!error && upd) {
        const idx = entries.findIndex(e=>e.id===id);
        if (idx>-1) entries[idx] = upd;
        render();
      }
    }
    async function deleteEntry(id) {
      await supa.from("plantafel").delete().eq("id", id);
      entries = entries.filter(e=>e.id!==id);
      render();
    }
    function moveEntryToDate(id, dateISO, asDetailed) {
      updateEntry(id, { tag: dateISO, is_detailed: asDetailed });
    }

    // Dialog logik
    function openEntryDialog(e) {
      document.getElementById("dlgTitle").textContent = e ? "Eintrag bearbeiten" : "Neuer Eintrag";
      eId.value = e ? e.id : "";
      eTitel.value = e ? (e.titel || "") : "";
      eMitarbeiter.value = e ? (e.mitarbeiter || "") : "";
      eFahrzeug.value = e ? (e.fahrzeug || "") : "";
      eBaustelle.value = e ? (e.baustelle || "") : "";
      eStatus.value = e ? (e.status || "") : "";
      eNotiz.value = e ? (e.notiz || "") : "";
      eDate.value = e ? (e.tag || (startDateInput.value || todayISO())) : (startDateInput.value || todayISO());

      applyStatusVisibility(e ? e.status : "");

      entryDlg.showModal();
    }

    function applyStatusVisibility(status) {
      const special = (status === "urlaub" || status === "krank" || status === "schule");
      fldTitel.style.display = special ? "none" : "flex";
      fldFahrzeug.style.display = special ? "none" : "flex";
      fldBaustelle.style.display = special ? "none" : "flex";
      if (special) eTitel.required = false; else eTitel.required = true;
    }

    btnEntryCancel.addEventListener("click", ()=> entryDlg.close());
    eStatus.addEventListener("change", ()=> applyStatusVisibility(eStatus.value));

    entryForm.addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const isEdit = !!eId.value;
      const payload = {
        tag: eDate.value,
        titel: eTitel.value,
        mitarbeiter: eMitarbeiter.value,
        fahrzeug: eFahrzeug.value,
        baustelle: eBaustelle.value,
        status: eStatus.value,
        notiz: eNotiz.value,
      };
      // wenn aus 12m aufgerufen → is_detailed=false
      const currentView = viewSel.value;
      payload.is_detailed = currentView !== "12m";

      // bei Urlaub/Krank/Schule Titel leer lassen
      if (payload.status === "urlaub" || payload.status === "krank" || payload.status === "schule") {
        payload.titel = "";
        payload.is_detailed = true; // das gehört in den Tag
      }

      if (isEdit) {
        await updateEntry(eId.value, payload);
      } else {
        await createEntry(payload);
      }
      entryDlg.close();
    });

    // Stammdaten-Dialog
    btnMaster.addEventListener("click", ()=> masterDlg.showModal());
    btnMasterClose.addEventListener("click", ()=> masterDlg.close());
    btnMAdd.addEventListener("click", async ()=>{
      const name = mName.value.trim();
      if (!name) return;
      const { data } = await supa.from("mitarbeiter").insert({name}).select().single();
      if (data) {
        mitarbeiter.push(data);
        fillMasterLists();
        mName.value = "";
      }
    });
    btnFAdd.addEventListener("click", async ()=>{
      const name = fName.value.trim();
      if (!name) return;
      const { data } = await supa.from("fahrzeuge").insert({name}).select().single();
      if (data) {
        fahrzeuge.push(data);
        fillMasterLists();
        fName.value = "";
      }
    });
    btnBAdd.addEventListener("click", async ()=>{
      const name = bName.value.trim();
      if (!name) return;
      const { data } = await supa.from("baustellen").insert({name}).select().single();
      if (data) {
        baustellen.push(data);
        fillMasterLists();
        bName.value = "";
      }
    });

    // header buttons
    btnReload.addEventListener("click", loadAll);
    viewSel.addEventListener("change", render);
    chkUrlaub.addEventListener("change", render);
    btnAdd.addEventListener("click", ()=> openEntryDialog(null));

    // delegations for "+" in columns / months
    document.addEventListener("click", ev=>{
      const dateAdd = ev.target.getAttribute("data-add");
      if (dateAdd) {
        eDate.value = dateAdd;
        viewSel.value !== "12m" ? (eTitel.value="") : null;
        openEntryDialog(null);
      }
      const monthAdd = ev.target.getAttribute("data-add-month");
      if (monthAdd) {
        // pick 1st of month
        eDate.value = monthAdd + "-01";
        // this is grob
        viewSel.value = "12m";
        openEntryDialog(null);
      }
    });

    // auto reload
    function setupAutoReload() {
      if (autoReloadTimer) clearInterval(autoReloadTimer);
      if (chkAutoReload.checked) {
        autoReloadTimer = setInterval(loadAll, 20000);
      }
    }
    chkAutoReload.addEventListener("change", setupAutoReload);

    // init
    startDateInput.value = todayISO();
    loadAll();
    setupAutoReload();
  </script>
</body>
</html>
