<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Plantafel Digital</title>
  <style>
    :root {
      --bg: #171b20;
      --panel: #1f242b;
      --card: #252b33;
      --accent: #2d6bff;
      --danger: #d9534f;
      --txt: #fff;
      --muted: #aab2bd;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      gap: .75rem;
      align-items: center;
      padding: .75rem 1rem;
      background: rgba(0,0,0,.35);
      border-bottom: 1px solid rgba(255,255,255,.03);
    }
    header .pill {
      background: #1c7c35;
      padding: .25rem .75rem;
      border-radius: 999px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    header select,
    header input[type="date"] {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.05);
      color: var(--txt);
      border-radius: 6px;
      padding: .4rem .55rem;
    }
    header button {
      background: var(--accent);
      border: none;
      color: #fff;
      border-radius: 6px;
      padding: .45rem .7rem;
      cursor: pointer;
      font-weight: 500;
    }
    main {
      flex: 1;
      overflow: auto;
      display: flex;
    }
    #board {
      display: flex;
      gap: .75rem;
      padding: .75rem;
      min-height: 100%;
      width: max-content;
    }
    .day-col {
      background: rgba(255,255,255,.015);
      border: 1px solid rgba(255,255,255,.03);
      border-radius: 8px;
      width: 180px;
      min-height: calc(100vh - 110px);
      display: flex;
      flex-direction: column;
    }
    .day-head {
      padding: .5rem .5rem .35rem;
      border-bottom: 1px solid rgba(255,255,255,.03);
    }
    .day-head .dow {
      font-size: .7rem;
      color: var(--muted);
    }
    .day-head .date {
      font-weight: 600;
      font-size: .8rem;
    }
    .entries {
      flex: 1;
      padding: .35rem .35rem .9rem;
      display: flex;
      flex-direction: column;
      gap: .4rem;
    }
    .entry {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.03);
      border-radius: 6px;
      padding: .35rem .4rem .35rem;
      font-size: .72rem;
      cursor: grab;
    }
    .entry.red {
      border-left: 4px solid var(--danger);
    }
    .entry-title {
      font-weight: 600;
      margin-bottom: .25rem;
    }
    .entry-meta {
      font-size: .65rem;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
    }
    .fab {
      position: fixed;
      right: 1.3rem;
      bottom: 1.3rem;
      background: var(--accent);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 1.4rem;
      cursor: pointer;
    }
    dialog {
      background: #1c2127;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      width: min(420px, 95vw);
      color: #fff;
    }
    dialog form {
      display: flex;
      flex-direction: column;
      gap: .6rem;
      padding: 1rem 1rem .5rem;
    }
    dialog label {
      font-size: .7rem;
      color: var(--muted);
    }
    dialog input,
    dialog select,
    dialog textarea {
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.03);
      border-radius: 6px;
      padding: .35rem .5rem;
      color: #fff;
      font-size: .8rem;
    }
    dialog .actions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
      padding: .5rem 1rem 1rem;
    }
    dialog button {
      border: none;
      border-radius: 6px;
      padding: .45rem .75rem;
      cursor: pointer;
    }
    dialog .ghost {
      background: rgba(255,255,255,.02);
      color: #fff;
    }
    dialog .primary {
      background: var(--accent);
      color: #fff;
    }
    /* Stammdaten-Dialog */
    #dlg-stammdaten .section {
      background: rgba(0,0,0,.22);
      border-radius: 6px;
      padding: .6rem .6rem .6rem;
      margin-bottom: .6rem;
    }
    #dlg-stammdaten h3 {
      margin: 0 0 .4rem;
      font-size: .8rem;
    }
    #dlg-stammdaten ul {
      margin: .4rem 0 0;
      padding: 0;
      list-style: none;
      font-size: .7rem;
      max-height: 90px;
      overflow: auto;
    }
    #dlg-stammdaten li {
      padding: .2rem 0;
      border-bottom: 1px solid rgba(255,255,255,.03);
    }
  </style>
</head>
<body>
  <header>
    <div class="pill"><span style="width:8px;height:8px;border-radius:50%;background:#3fcf4d;display:inline-block"></span> verbunden</div>
    <label>Ansicht:
      <select id="viewSel">
        <option value="14">14 Tage</option>
        <option value="4w" selected>4 Wochen (Mo‚ÄìFr)</option>
        <option value="12m">12 Monate</option>
      </select>
    </label>
    <label>Start:
      <input type="date" id="startDate" />
    </label>
    <button id="btnReload">Neu laden</button>
    <button id="btnStammdaten">Stammdaten</button>
    <label style="display:flex;align-items:center;gap:.35rem;margin-left:auto;font-size:.7rem;">
      <input type="checkbox" id="chkUrlaub" /> Urlaub/Krank/Schule
    </label>
  </header>

  <main>
    <div id="board"></div>
  </main>

  <div class="fab" id="fabPlus">+</div>

  <!-- Dialog Eintrag -->
  <dialog id="dlg-entry">
    <form id="entryForm">
      <input type="hidden" id="entry-id" />
      <label>Titel
        <input id="entry-titel" required />
      </label>
      <label>Mitarbeiter
        <select id="entry-mitarbeiter">
          <option value="">‚Äì keiner ‚Äì</option>
        </select>
      </label>
      <label>Fahrzeug
        <select id="entry-fahrzeug">
          <option value="">‚Äì keines ‚Äì</option>
        </select>
      </label>
      <label>Baustelle
        <select id="entry-baustelle">
          <option value="">‚Äì keine ‚Äì</option>
        </select>
      </label>
      <label>Status
        <select id="entry-status">
          <option value="">‚Äì normal ‚Äì</option>
          <option value="urlaub">Urlaub</option>
          <option value="krank">Krank</option>
          <option value="schule">Schule</option>
        </select>
      </label>
      <label>Tag
        <input type="date" id="entry-tag" required />
      </label>
      <div class="actions">
        <button type="button" class="ghost" id="btnEntryCancel">Abbrechen</button>
        <button type="submit" class="primary">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog Stammdaten -->
  <dialog id="dlg-stammdaten">
    <form id="stammForm" onsubmit="return false;">
      <h2>Stammdaten</h2>

      <div class="section">
        <h3>Mitarbeiter</h3>
        <div style="display:flex;gap:.4rem;margin-bottom:.4rem;">
          <input id="st-mitarbeiter" placeholder="Mitarbeitername" />
          <button type="button" class="primary" id="btnAddMitarbeiter">+ hinzuf√ºgen</button>
        </div>
        <ul id="list-mitarbeiter"><li>‚Äì keine ‚Äì</li></ul>
      </div>

      <div class="section">
        <h3>Fahrzeuge</h3>
        <div style="display:flex;gap:.4rem;margin-bottom:.4rem;">
          <input id="st-fahrzeug" placeholder="Fahrzeug" />
          <button type="button" class="primary" id="btnAddFahrzeug">+ hinzuf√ºgen</button>
        </div>
        <ul id="list-fahrzeuge"><li>‚Äì keine ‚Äì</li></ul>
      </div>

      <div class="section">
        <h3>Baustellen</h3>
        <div style="display:flex;gap:.4rem;margin-bottom:.4rem;">
          <input id="st-baustelle" placeholder="Baustelle" />
          <button type="button" class="primary" id="btnAddBaustelle">+ hinzuf√ºgen</button>
        </div>
        <ul id="list-baustellen"><li>‚Äì keine ‚Äì</li></ul>
      </div>

      <div class="actions">
        <button type="button" class="primary" id="btnStammClose">Schlie√üen</button>
      </div>
    </form>
  </dialog>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase Setup ===
    const SUPABASE_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === Elemente ===
    const board = document.getElementById("board");
    const viewSel = document.getElementById("viewSel");
    const startDate = document.getElementById("startDate");
    const btnReload = document.getElementById("btnReload");
    const btnStammdaten = document.getElementById("btnStammdaten");
    const fabPlus = document.getElementById("fabPlus");
    const dlgEntry = document.getElementById("dlg-entry");
    const entryForm = document.getElementById("entryForm");
    const dlgStamm = document.getElementById("dlg-stammdaten");
    const chkUrlaub = document.getElementById("chkUrlaub");

    // Stammdaten-Listen
    const listMitarbeiter = document.getElementById("list-mitarbeiter");
    const listFahrzeuge   = document.getElementById("list-fahrzeuge");
    const listBaustellen  = document.getElementById("list-baustellen");

    const selEntryMitarbeiter = document.getElementById("entry-mitarbeiter");
    const selEntryFahrzeug = document.getElementById("entry-fahrzeug");
    const selEntryBaustelle = document.getElementById("entry-baustelle");

    // === Init ===
    startDate.valueAsDate = new Date();
    loadBoard();
    loadStammdaten();

    // === Events ===
    btnReload.onclick = loadBoard;
    viewSel.onchange = loadBoard;
    startDate.onchange = loadBoard;
    chkUrlaub.onchange = loadBoard;

    btnStammdaten.onclick = () => {
      loadStammdaten().then(() => dlgStamm.showModal());
    };
    document.getElementById("btnStammClose").onclick = () => dlgStamm.close();

    document.getElementById("btnAddMitarbeiter").onclick = async () => {
      const name = document.getElementById("st-mitarbeiter").value.trim();
      if (!name) return;
      await supa.from("mitarbeiter").insert({ name });
      document.getElementById("st-mitarbeiter").value = "";
      loadStammdaten();
    };
    document.getElementById("btnAddFahrzeug").onclick = async () => {
      const name = document.getElementById("st-fahrzeug").value.trim();
      if (!name) return;
      await supa.from("fahrzeuge").insert({ name });
      document.getElementById("st-fahrzeug").value = "";
      loadStammdaten();
    };
    document.getElementById("btnAddBaustelle").onclick = async () => {
      const name = document.getElementById("st-baustelle").value.trim();
      if (!name) return;
      await supa.from("baustellen").insert({ name });
      document.getElementById("st-baustelle").value = "";
      loadStammdaten();
    };

    fabPlus.onclick = () => {
      openEntryDialog({ tag: startDate.value });
    };
    document.getElementById("btnEntryCancel").onclick = () => dlgEntry.close();

    entryForm.onsubmit = async (ev) => {
      ev.preventDefault();
      const id = document.getElementById("entry-id").value;
      const titel = document.getElementById("entry-titel").value.trim();
      const tag = document.getElementById("entry-tag").value;
      const mitarbeiter = document.getElementById("entry-mitarbeiter").value;
      const fahrzeug = document.getElementById("entry-fahrzeug").value;
      const baustelle = document.getElementById("entry-baustelle").value;
      const status = document.getElementById("entry-status").value;

      const payload = { titel, tag, mitarbeiter, fahrzeug, baustelle, status };
      if (!id) {
        await supa.from("plantafel").insert(payload);
      } else {
        await supa.from("plantafel").update(payload).eq("id", id);
      }
      dlgEntry.close();
      loadBoard();
    };

    // === Funktionen ===
    async function loadStammdaten() {
      const [mit, fah, bau] = await Promise.all([
        supa.from("mitarbeiter").select().order("name", { ascending: true }),
        supa.from("fahrzeuge").select().order("name", { ascending: true }),
        supa.from("baustellen").select().order("name", { ascending: true }),
      ]);

      renderList(listMitarbeiter, mit.data, "name");
      renderList(listFahrzeuge, fah.data, "name");
      renderList(listBaustellen, bau.data, "name");

      fillSelect(selEntryMitarbeiter, mit.data, "name");
      fillSelect(selEntryFahrzeug, fah.data, "name");
      fillSelect(selEntryBaustelle, bau.data, "name");
    }

    function renderList(ul, rows, field) {
      ul.innerHTML = "";
      if (!rows || !rows.length) {
        ul.innerHTML = "<li>‚Äì keine ‚Äì</li>";
        return;
      }
      rows.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r[field] || "(ohne Name)";
        ul.appendChild(li);
      });
    }
    function fillSelect(sel, rows, field) {
      sel.innerHTML = '<option value="">‚Äì keiner ‚Äì</option>';
      if (!rows) return;
      rows.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r[field];
        opt.textContent = r[field];
        sel.appendChild(opt);
      });
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function formatDateISO(d) {
      return d.toISOString().slice(0,10);
    }
    function getWeekdayName(d) {
      return ["So","Mo","Di","Mi","Do","Fr","Sa"][d.getDay()];
    }
    function formatDE(d) {
      return d.toLocaleDateString("de-DE", { day:"2-digit", month:"2-digit", year:"numeric" });
    }

    async function loadBoard() {
      board.innerHTML = "Lade‚Ä¶";
      const start = new Date(startDate.value);
      let dates = [];

      if (viewSel.value === "14") {
        for (let i=0;i<14;i++) dates.push(addDays(start, i));
      } else if (viewSel.value === "4w") {
        // 4 Wochen Mo‚ÄìFr -> 4*5 = 20 Tage
        let d = new Date(start);
        for (let i=0;i<28;i++) {
          const cur = addDays(d, i);
          if (cur.getDay() === 0 || cur.getDay() === 6) continue;
          dates.push(cur);
        }
      } else {
        // 12 Monate: jeweils 1. des Monats
        let monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
        for (let m = 0; m < 12; m++) {
          dates.push(new Date(monthStart.getFullYear(), monthStart.getMonth() + m, 1));
        }
      }

      // Eintr√§ge holen
      const minDate = formatDateISO(dates[0]);
      const maxDate = formatDateISO(dates[dates.length-1]);
      const { data: entries } = await supa
        .from("plantafel")
        .select()
        .gte("tag", minDate)
        .lte("tag", maxDate)
        .order("tag", { ascending: true })
        .order("sort", { ascending: true });

      board.innerHTML = "";
      dates.forEach(d => {
        const col = document.createElement("div");
        col.className = "day-col";
        col.dataset.date = formatDateISO(d);

        const head = document.createElement("div");
        head.className = "day-head";
        head.innerHTML = `<div class="dow">${getWeekdayName(d)} ${formatDE(d)}</div>`;
        col.appendChild(head);

        const list = document.createElement("div");
        list.className = "entries";
        list.ondragover = (ev)=>ev.preventDefault();
        list.ondrop = (ev)=>onDrop(ev, formatDateISO(d));
        col.appendChild(list);

        const todays = (entries || []).filter(e => e.tag === formatDateISO(d));
        todays.forEach(e => {
          const div = document.createElement("div");
          div.className = "entry" + (isRed(e.status) ? " red" : "");
          div.draggable = true;
          div.ondragstart = (ev)=>onDrag(ev, e);
          div.onclick = ()=>openEntryDialog(e);
          div.innerHTML = `
            <div class="entry-title">${e.titel || "(ohne Titel)"}</div>
            <div class="entry-meta">
              ${e.mitarbeiter ? "üë∑ " + e.mitarbeiter : ""}
              ${e.fahrzeug ? "üöê " + e.fahrzeug : ""}
              ${e.baustelle ? "üìç " + e.baustelle : ""}
              ${e.status ? "‚ö† " + e.status : ""}
            </div>
          `;
          list.appendChild(div);
        });

        board.appendChild(col);
      });
    }

    function isRed(status) {
      return status === "urlaub" || status === "krank" || status === "schule";
    }

    let dragData = null;
    function onDrag(ev, entry) {
      dragData = entry;
    }
    async function onDrop(ev, newDate) {
      ev.preventDefault();
      if (!dragData) return;
      await supa.from("plantafel").update({ tag: newDate }).eq("id", dragData.id);
      dragData = null;
      loadBoard();
    }

    function openEntryDialog(entry) {
      document.getElementById("entry-id").value = entry.id || "";
      document.getElementById("entry-titel").value = entry.titel || "";
      document.getElementById("entry-mitarbeiter").value = entry.mitarbeiter || "";
      document.getElementById("entry-fahrzeug").value = entry.fahrzeug || "";
      document.getElementById("entry-baustelle").value = entry.baustelle || "";
      document.getElementById("entry-status").value = entry.status || "";
      document.getElementById("entry-tag").value = entry.tag || startDate.value;
      dlgEntry.showModal();
    }
  </script>
</body>
</html>
