<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plantafel Digital</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --card:#0b1222; --card2:#0d1325;
    --text:#e5e7eb; --muted:#a1a1aa; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --grid:#1f2937; --dashed:#334155;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .topbar{display:flex;align-items:center;gap:.5rem;background:#0b1220;padding:.6rem 1rem;border-bottom:1px solid #0b1b32;position:sticky;top:0;z-index:50}
  .brand{font-weight:700;letter-spacing:.3px}
  .sp{flex:1}
  .seg, .btn, select, input[type="date"]{background:#0e1628;border:1px solid #1f2b40;color:var(--text);border-radius:.6rem;padding:.45rem .6rem}
  .btn{cursor:pointer}
  .btn.primary{background:#1b2845;border-color:#27406e}
  .btn.ghost{background:#0b1220;border-color:#18243c}
  .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
  .legend{display:flex;align-items:center;gap:.5rem}
  .dot{width:.65rem;height:.65rem;border-radius:50%}
  .wrap{padding:1rem;max-width:1400px;margin:0 auto}
  .grid{border:1px solid #16233a;border-radius:1rem;overflow:hidden}
  .thead{display:grid;background:#0b1324;border-bottom:1px solid #16233a}
  .tbody{display:grid}
  .kw{padding:.6rem .7rem;border-right:1px solid #16233a;background:#0a1222}
  .cell{border-right:1px dashed var(--dashed);border-bottom:1px dashed var(--dashed);min-height:130px;padding:.35rem;position:relative}
  .drop{height:100%;border:2px dashed transparent;border-radius:.7rem;padding:.25rem}
  .drop.over{border-color:#35507c;background:rgba(53,80,124,.18)}
  .item{background:linear-gradient(180deg,#13233f,#0f1c34);border:1px solid #284166;border-radius:.8rem;padding:.45rem .6rem;margin:.25rem 0;box-shadow:0 6px 14px rgba(0,0,0,.25);position:relative}
  .title{font-weight:600;font-size:.95rem;margin-bottom:.3rem}
  .chips{display:flex;gap:.35rem;flex-wrap:wrap}
  .chip{padding:.12rem .5rem;border-radius:999px;font-size:.78rem;border:1px solid #1f2b40;background:#0c162a}
  .tools{position:absolute;top:.35rem;right:.35rem;display:flex;gap:.25rem}
  .tbtn{width:22px;height:22px;border:1px solid #27406e;background:#0e1830;border-radius:6px;color:#cbd5e1;cursor:pointer;font-size:.8rem;display:grid;place-items:center}
  .status-ring{position:absolute;inset:-2px;border:2px solid transparent;border-radius:.8rem;pointer-events:none}
  .status-rot{border-color:var(--bad)}
  .hint{margin-top:.35rem;font-size:.76rem;color:#ffb4a8}
  .fab{position:fixed;right:18px;bottom:18px;background:#0b4fff;border:none;color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:28px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
  dialog{border:none;border-radius:1rem;background:#0f1a2e;color:var(--text);padding:0;max-width:720px;width:min(720px,95vw)}
  .dlg-h{padding:1rem 1.2rem;border-bottom:1px solid #1c2b46;font-weight:700}
  .dlg-b{padding:1rem 1.2rem}
  .dlg-f{padding:1rem 1.2rem;border-top:1px solid #1c2b46;display:flex;justify-content:flex-end;gap:.5rem}
  .fld{margin:.6rem 0}
  .taglist{display:flex;gap:.4rem;flex-wrap:wrap}
  .tag{border:1px solid #1f2b40;background:#0c162a;padding:.28rem .6rem;border-radius:999px;cursor:pointer;font-size:.85rem}
  .tag.sel{outline:2px solid #365487}
  .rang{display:flex;gap:.6rem;align-items:center}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111b2f;border:1px solid #243552;padding:.6rem 1rem;border-radius:.6rem;display:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.82rem;color:#8ab4ff}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Plantafel</div>
    <div class="sp"></div>
    <div class="row">
      <label>Ansicht:
        <select id="viewSel" class="seg">
          <option value="14">14 Tage (Mo–Fr)</option>
          <option value="28">4 Wochen (Mo–Fr)</option>
          <option value="m12">12 Monate (Grobplanung)</option>
        </select>
      </label>
      <label>Start:
        <input id="startDate" type="date" class="seg" />
      </label>
      <button id="reloadBtn" class="btn">Neu laden</button>
    </div>
    <div class="sp"></div>
    <div class="legend">
      <span class="dot" style="background:var(--bad)"></span> Urlaub/Krank/Schule
    </div>
    <div class="sp"></div>
    <div class="row">
      <div class="mono" id="statusTxt">Status: lokal</div>
      <button id="zoomOut" class="btn ghost">–</button>
      <input id="zoomRange" type="range" min="80" max="140" value="100" />
      <button id="zoomIn" class="btn ghost">+</button>
      <button id="autoBtn" class="btn">Auto-Reload</button>
      <button id="masterBtn" class="btn">Stammdaten</button>
      <button id="addBtn" class="btn primary">+ Eintrag</button>
    </div>
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
  </div>

  <button class="fab" id="fab">+</button>

  <!-- Eintrags-Dialog -->
  <dialog id="entryDlg">
    <div class="dlg-h">Eintrag bearbeiten</div>
    <div class="dlg-b">
      <div class="fld">
        <label>Titel<br/><input id="fTitle" class="seg" style="width:100%" placeholder="z. B. Hofmühl Eichstätt" /></label>
      </div>
      <div class="fld">
        <label>Status</label>
        <div class="taglist" id="fStatus"></div>
      </div>
      <div class="fld" id="dateBlock">
        <label>Datum</label>
        <div class="rang">
          <input id="fDate" type="date" class="seg" />
          <label>Dauer</label>
          <select id="fDur" class="seg">
            <option value="1">nur dieser Tag</option>
            <option value="2">2 Tage</option><option value="3">3 Tage</option>
            <option value="4">4 Tage</option><option value="5">5 Tage</option>
            <option value="6">6 Tage</option><option value="7">7 Tage</option>
            <option value="8">8 Tage</option><option value="9">9 Tage</option>
            <option value="10">10 Tage</option>
          </select>
        </div>
      </div>
      <div class="fld">
        <label>Mitarbeiter</label>
        <div class="taglist" id="fPeople"></div>
      </div>
      <div class="fld">
        <label>Fahrzeuge</label>
        <div class="taglist" id="fCars"></div>
      </div>
      <div class="fld">
        <button id="toBacklog" class="btn ghost">↩ In Grobplanung (Monat)</button>
        <button id="toSchedule" class="btn ghost">→ In Feinplanung (4 Wo / 14 T)</button>
      </div>
    </div>
    <div class="dlg-f">
      <button id="delBtn" class="btn">Löschen</button>
      <button id="cancelBtn" class="btn">Abbrechen</button>
      <button id="saveBtn" class="btn primary">Speichern</button>
    </div>
  </dialog>

  <!-- Stammdaten-Dialog -->
  <dialog id="masterDlg">
    <div class="dlg-h">Stammdaten</div>
    <div class="dlg-b">
      <div class="fld">
        <div style="font-weight:600;margin-bottom:.3rem">Mitarbeiter (mind. 25 eindeutige Farben)</div>
        <div class="taglist" id="mPeople"></div>
        <div class="rang">
          <input id="newPerson" class="seg" placeholder="Name" />
          <button id="addPerson" class="btn">Hinzufügen</button>
        </div>
      </div>
      <div class="fld">
        <div style="font-weight:600;margin-bottom:.3rem">Fahrzeuge</div>
        <div class="taglist" id="mCars"></div>
        <div class="rang">
          <input id="newCar" class="seg" placeholder="Fahrzeug" />
          <button id="addCar" class="btn">Hinzufügen</button>
        </div>
      </div>
      <div class="fld">
        Hinweis: Urlaub / Krank / Schule werden **immer rot** markiert (Rand/Fokus).
      </div>
    </div>
    <div class="dlg-f">
      <button id="masterClose" class="btn primary">Fertig</button>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

<script type="module">
  /* ===========================
   * Firebase – CDN (v12)
   * =========================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
    onSnapshot, query, where, orderBy, getDocs
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // >>>>>>>> HIER DEINE KONFIG AUS DEM FIREBASE-FENSTER EINTRAGEN <<<<<<<<
  const firebaseConfig = {
    apiKey: "AIzaSyDWpF...deinKey...",             // <- bitte mit deinem Wert ersetzen
    authDomain: "plantafelfreyich100.firebaseapp.com",
    projectId: "plantafelfreyich100",
    storageBucket: "plantafelfreyich100.appspot.com", // (optional, kann auch falsch sein – wird hier nicht genutzt)
    messagingSenderId: "962959193135",
    appId: "1:962959193135:web:e446279447815c0ef91da",
    measurementId: "G-W5VGSSLTRC"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const C_ENTRIES = collection(db,"entries");
  const D_SETTINGS = doc(db,"settings","global");

  /* ===========================
   * Hilfen
   * =========================== */
  const $ = sel => document.querySelector(sel);
  const grid = $("#grid");
  const viewSel = $("#viewSel");
  const startDate = $("#startDate");
  const reloadBtn = $("#reloadBtn");
  const autoBtn = $("#autoBtn");
  const masterBtn = $("#masterBtn");
  const addBtn = $("#addBtn");
  const fab = $("#fab");
  const zoomRange=$("#zoomRange"), zoomIn=$("#zoomIn"), zoomOut=$("#zoomOut");
  const statusTxt=$("#statusTxt");
  let autoTimer=null;

  const COLORS25 = [
    "#22c55e","#ef4444","#60a5fa","#a855f7","#f59e0b","#10b981","#f97316","#3b82f6",
    "#eab308","#6366f1","#84cc16","#06b6d4","#d946ef","#94a3b8","#f43f5e","#14b8a6",
    "#8b5cf6","#fbbf24","#0ea5e9","#34d399","#fb7185","#a3e635","#38bdf8","#c084fc",
    "#e879f9","#67e8f9","#fde047","#9f1239","#047857","#1e293b"
  ];

  // Stammdaten im Speicher (werden aus Firestore geladen)
  let MASTER = { people:[], cars:[] };

  // aktuell geladene Karten
  let ENTRY_MAP = new Map(); // id -> entry

  // util
  const toISO = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  const addDays = (d,n)=> { const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  const mondayOf = (d)=>{ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); return x; }
  const weeksBetween = (start, count)=> Array.from({length:count},(_,i)=> addDays(start,i*7));
  const pretty = (d)=> d.toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit"});

  function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",2200); }

  /* ===========================
   * Stammdaten laden / speichern
   * =========================== */
  async function loadMaster(){
    const snap = await getDoc(D_SETTINGS);
    if (snap.exists()){
      MASTER = snap.data();
    } else {
      MASTER = {
        people:[
          {name:"Thomas", color:COLORS25[0]},
          {name:"Patrick", color:COLORS25[2]},
          {name:"Herbert", color:COLORS25[1]},
          {name:"Artiom", color:COLORS25[3]},
          {name:"Juppi", color:COLORS25[4]},
          {name:"Terry", color:COLORS25[5]}
        ],
        cars:["Doka","Crafter","Mercedes Bus","Ford"]
      };
      await setDoc(D_SETTINGS, MASTER);
    }
    renderMasterDialog();
  }

  function colorOf(name){
    const p = MASTER.people.find(x=>x.name===name);
    if (!p){ // Fallback: verteilen
      const idx = Math.abs([...name].reduce((a,c)=>a+c.charCodeAt(0),0)) % COLORS25.length;
      return COLORS25[idx];
    }
    return p.color || COLORS25[0];
  }

  /* ===========================
   * Grid rendern
   * =========================== */
  function buildGrid14or28(daysTotal){
    const start = startDate.value ? new Date(startDate.value) : new Date();
    const mo = mondayOf(start);

    const weeks = weeksBetween(mo, Math.ceil(daysTotal/5));
    // Kopf
    let cols = 6; // KW + Mo..Fr
    grid.innerHTML="";
    grid.className="grid";
    const thead=document.createElement("div"); thead.className="thead";
    thead.style.gridTemplateColumns=`160px repeat(5, 1fr)`;
    const headRow=document.createElement("div");
    headRow.style.display="contents";
    ["KW / Zeitraum","Mo","Di","Mi","Do","Fr"].forEach(h=>{
      const el=document.createElement("div");
      el.className= h==="KW / Zeitraum" ? "kw" : "cell";
      el.textContent=h;
      el.style.fontWeight="700"; el.style.minHeight="40px";
      thead.appendChild(el);
    });
    grid.appendChild(thead);

    // Body
    const tbody=document.createElement("div"); tbody.className="tbody";
    tbody.style.gridTemplateColumns=`160px repeat(5, 1fr)`;
    grid.appendChild(tbody);

    weeks.forEach(w=>{
      // Reihe 1: Datumszeile
      const kw = getKW(w);
      const zeitraum = `${pretty(w)} – ${pretty(addDays(w,4))}`;
      const kwc = div("kw", `KW ${kw}\n${zeitraum}`);
      tbody.appendChild(kwc);
      for (let i=0;i<5;i++){
        const day = addDays(w,i);
        const cell= div("cell"); cell.dataset.date = toISO(day);
        cell.appendChild(makeDropZone({type:"day", date: toISO(day)}));
        tbody.appendChild(cell);
      }
      // zweite Reihe: Projekt-Zeile
      const kw2 = div("kw","Projekt"); kw2.style.borderTop="1px solid #16233a";
      tbody.appendChild(kw2);
      for (let i=0;i<5;i++){
        const day = addDays(w,i);
        const cell= div("cell"); cell.style.borderTop="1px solid #16233a";
        cell.dataset.date = toISO(day);
        cell.appendChild(makeDropZone({type:"day", date: toISO(day)}));
        tbody.appendChild(cell);
      }
    });
  }

  function buildGrid12M(){
    grid.innerHTML="";
    const thead=document.createElement("div"); thead.className="thead";
    thead.style.gridTemplateColumns="repeat(3, 1fr)";
    thead.style.display="none";
    grid.appendChild(thead);

    const tbody=document.createElement("div"); tbody.className="tbody";
    tbody.style.gridTemplateColumns="repeat(3, 1fr)";
    grid.appendChild(tbody);

    const base = startDate.value ? new Date(startDate.value) : new Date();
    const year = base.getFullYear();
    for (let m=0;m<12;m++){
      const card = div("cell");
      card.style.minHeight="180px";
      const monthName = new Date(year,m,1).toLocaleDateString("de-DE",{month:"long",year:"numeric"});
      const head = div(null, monthName); head.style.fontWeight="700"; head.style.marginBottom=".3rem";
      card.appendChild(head);
      card.appendChild(makeDropZone({type:"month",year,month:m}));
      tbody.appendChild(card);
    }
  }

  function makeDropZone(meta){
    const dz = div("drop");
    dz.addEventListener("dragover", e=>{ e.preventDefault(); dz.classList.add("over"); });
    dz.addEventListener("dragleave", ()=> dz.classList.remove("over"));
    dz.addEventListener("drop", async e=>{
      e.preventDefault(); dz.classList.remove("over");
      const payload = JSON.parse(e.dataTransfer.getData("text/plain")||"{}");
      if (!payload.id) return;
      const it = ENTRY_MAP.get(payload.id);
      if (!it) return;

      if (meta.type==="day"){
        // in Feinplanung legen
        it.view="schedule";
        it.date=meta.date;
        if (!it.durationDays) it.durationDays=1;
        delete it.year; delete it.month;
        await updateDoc(doc(db,"entries",it.id), it);
        toast("Verschoben in Feinplanung");
      } else if (meta.type==="month"){
        // in Grobplanung
        it.view="backlog";
        it.year=meta.year; it.month=meta.month;
        delete it.date; delete it.durationDays;
        await updateDoc(doc(db,"entries",it.id), it);
        toast("Verschoben in Grobplanung");
      }
    });
    return dz;
  }

  function render(){
    const mode = viewSel.value;
    if (mode==="m12") buildGrid12M();
    else buildGrid14or28(Number(mode));

    // Karten rendern (aus ENTRY_MAP)
    for (const it of ENTRY_MAP.values()){
      if (viewSel.value==="m12"){
        if (it.view!=="backlog") continue;
        const idx = it.month ?? 0;
        const cells = grid.querySelectorAll(".tbody .cell");
        const monthCells = Array.from(cells);
        const cell = monthCells[idx];
        if (!cell) continue;
        cell.querySelector(".drop").appendChild(renderItem(it));
      }else{
        if (it.view!=="schedule") continue;
        const span = it.durationDays||1;
        for (let d=0; d<span; d++){
          const dayISO = toISO(addDays(new Date(it.date), d));
          const cell = grid.querySelector(`.cell[data-date="${dayISO}"] .drop`);
          if (cell) cell.appendChild(renderItem(it,d>0)); // Kopie-Visualisierung für Mehrtageskarten
        }
      }
    }
    applyZoom();
  }

  function renderItem(it, faded=false){
    const el = div("item");
    el.draggable=true;
    el.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("text/plain", JSON.stringify({id:it.id}));
    });
    const ring = div("status-ring");
    if (["Urlaub","Krank","Schule"].includes(it.status)) ring.classList.add("status-rot");
    el.appendChild(ring);

    const t = div("title", it.title||"(ohne Titel)");
    if (faded) t.style.opacity=".6";
    el.appendChild(t);

    const chips = div("chips");
    (it.cars||[]).forEach(c=> chips.appendChild(chip(c)));
    (it.people||[]).forEach(p=> chips.appendChild(chip(p, colorOf(p))));
    el.appendChild(chips);

    // Konflikt-Hinweise (doppelt)
    if (it.view==="schedule"){
      const warns = conflictsFor(it);
      if (warns.length){
        const h = div("hint", warns.join(", "));
        el.appendChild(h);
      }
    }

    const tools = div("tools");
    const edit=btn("✎", ()=>openEntry(it.id));
    const del =btn("✕", async ()=>{
      await deleteDoc(doc(db,"entries",it.id));
      toast("Gelöscht");
    });
    tools.append(edit,del);
    el.appendChild(tools);
    return el;
  }

  function conflictsFor(it){
    if (!it.date) return [];
    const res=[];
    const sameDay = [...ENTRY_MAP.values()].filter(e=> e.view==="schedule");
    const span = it.durationDays||1;
    for (const p of (it.people||[])){
      let count=0;
      for (const other of sameDay){
        const s = new Date(other.date);
        const eDur = other.durationDays||1;
        for (let d=0; d<eDur; d++){
          const iso = toISO(addDays(s,d));
          for (let dd=0; dd<span; dd++){
            const meIso = toISO(addDays(new Date(it.date),dd));
            if (iso===meIso && other.people?.includes(p)) count++;
          }
        }
      }
      if (count>1) res.push(`${p} doppelt`);
    }
    return res;
  }

  /* ===========================
   * Dialoge
   * =========================== */
  const entryDlg=$("#entryDlg");
  const masterDlg=$("#masterDlg");

  const fTitle=$("#fTitle"), fStatus=$("#fStatus"), fDate=$("#fDate"), fDur=$("#fDur"), fPeople=$("#fPeople"), fCars=$("#fCars");
  const toBacklog=$("#toBacklog"), toSchedule=$("#toSchedule");
  const saveBtn=$("#saveBtn"), delBtn=$("#delBtn"), cancelBtn=$("#cancelBtn");

  let EDIT_ID=null;

  function fillTags(container, items, selected, colorFn){
    container.innerHTML="";
    items.forEach(x=>{
      const name = typeof x==="string"? x : x.name;
      const tag = div("tag", name);
      if (colorFn) { tag.style.background=colorFn(name); tag.style.borderColor="#091123"; }
      if (selected?.includes(name)) tag.classList.add("sel");
      tag.addEventListener("click", ()=>{
        tag.classList.toggle("sel");
      });
      container.appendChild(tag);
    });
  }

  function selectedFrom(container){
    return [...container.querySelectorAll(".tag.sel")].map(t=>t.textContent);
  }

  function openEntry(id=null, preset={}){
    EDIT_ID=id;
    const it = id ? ENTRY_MAP.get(id) : ( { status:"Normal", durationDays:1, people:[], cars:[], ...preset } );
    fTitle.value = it.title ?? "";
    renderStatus(it.status||"Normal");
    fDate.value = it.date ? it.date : toISO(new Date());
    fDur.value = it.durationDays||1;
    fillTags(fPeople, MASTER.people, it.people, colorOf);
    fillTags(fCars, MASTER.cars, it.cars);

    // Buttons
    toBacklog.disabled = (viewSel.value==="m12");
    toSchedule.disabled = (viewSel.value!=="m12");
    delBtn.style.display = id ? "inline-flex" : "none";

    // Datum-Block: in Grobplanung nicht sinnvoll
    $("#dateBlock").style.display = (viewSel.value==="m12") ? "none" : "block";

    entryDlg.showModal();
  }

  function renderStatus(active){
    const opts=["Normal","Urlaub","Krank","Schule"];
    fStatus.innerHTML="";
    opts.forEach(s=>{
      const t = div("tag", s);
      if (s===active) t.classList.add("sel");
      t.addEventListener("click", ()=>{
        [...fStatus.children].forEach(c=>c.classList.remove("sel"));
        t.classList.add("sel");
      });
      fStatus.appendChild(t);
    });
  }
  function currentStatus(){
    const el=[...fStatus.children].find(x=>x.classList.contains("sel"));
    return el? el.textContent : "Normal";
  }

  cancelBtn.onclick=()=> entryDlg.close();
  delBtn.onclick= async ()=>{
    if (!EDIT_ID) return;
    await deleteDoc(doc(db,"entries",EDIT_ID));
    entryDlg.close(); toast("Gelöscht");
  };
  saveBtn.onclick= async ()=>{
    const payload = {
      title: fTitle.value.trim(),
      status: currentStatus(),
      people: selectedFrom(fPeople),
      cars: selectedFrom(fCars)
    };
    if (viewSel.value==="m12"){
      // speichere als Backlog (Monat: Januar per Default)
      const base = startDate.value ? new Date(startDate.value) : new Date();
      payload.view="backlog";
      payload.year=base.getFullYear();
      payload.month=0; // Januar (kann per Drag aus Monat geändert werden)
    } else {
      payload.view="schedule";
      payload.date = fDate.value || toISO(new Date());
      payload.durationDays = Number(fDur.value)||1;
    }
    if (EDIT_ID){
      await updateDoc(doc(db,"entries",EDIT_ID), payload);
      toast("Gespeichert");
    }else{
      await addDoc(C_ENTRIES, payload);
      toast("Angelegt");
    }
    entryDlg.close();
  };

  toBacklog.onclick = async ()=>{
    if (!EDIT_ID) return;
    const base = startDate.value ? new Date(startDate.value) : new Date();
    await updateDoc(doc(db,"entries",EDIT_ID), { view:"backlog", year:base.getFullYear(), month:0, date:null, durationDays:null });
    entryDlg.close(); toast("In Grobplanung");
  };
  toSchedule.onclick = async ()=>{
    if (!EDIT_ID) return;
    const d = toISO(new Date());
    await updateDoc(doc(db,"entries",EDIT_ID), { view:"schedule", date:d, durationDays:1, year:null, month:null });
    entryDlg.close(); toast("In Feinplanung");
  };

  // Stammdaten
  const mPeople=$("#mPeople"), mCars=$("#mCars"), addPerson=$("#addPerson"), newPerson=$("#newPerson"), addCar=$("#addCar"), newCar=$("#newCar");
  function renderMasterDialog(){
    // Personen
    mPeople.innerHTML="";
    MASTER.people.forEach((p,i)=>{
      const tag = div("tag", p.name);
      tag.style.background=p.color; tag.style.borderColor="#091123";
      tag.title="Klick zum Entfernen";
      tag.onclick= async ()=>{
        MASTER.people.splice(i,1);
        await setDoc(D_SETTINGS, MASTER);
        renderMasterDialog(); render();
      };
      mPeople.appendChild(tag);
    });
    // Fahrzeuge
    mCars.innerHTML="";
    MASTER.cars.forEach((c,i)=>{
      const tag = div("tag", c);
      tag.title="Klick zum Entfernen";
      tag.onclick= async ()=>{
        MASTER.cars.splice(i,1);
        await setDoc(D_SETTINGS, MASTER);
        renderMasterDialog(); render();
      };
      mCars.appendChild(tag);
    });
  }
  masterBtn.onclick=()=> masterDlg.showModal();
  $("#masterClose").onclick=()=> masterDlg.close();
  addPerson.onclick= async ()=>{
    const name = newPerson.value.trim(); if (!name) return;
    const used = new Set(MASTER.people.map(p=>p.color));
    const color = COLORS25.find(c=>!used.has(c)) || COLORS25[(MASTER.people.length)%COLORS25.length];
    MASTER.people.push({name, color});
    await setDoc(D_SETTINGS, MASTER);
    newPerson.value=""; renderMasterDialog(); render();
  };
  addCar.onclick= async ()=>{
    const name = newCar.value.trim(); if (!name) return;
    MASTER.cars.push(name);
    await setDoc(D_SETTINGS, MASTER);
    newCar.value=""; renderMasterDialog();
  };

  /* ===========================
   * Live-Sync (onSnapshot)
   * =========================== */
  function startLive(){
    // Settings live
    onSnapshot(D_SETTINGS, snap=>{
      if (snap.exists()){
        MASTER = snap.data();
        render();
      }
    });
    // Entries live
    onSnapshot(query(C_ENTRIES), qs=>{
      ENTRY_MAP.clear();
      qs.forEach(d=> ENTRY_MAP.set(d.id,{id:d.id, ...d.data()}));
      render();
    });
  }

  /* ===========================
   * UI-Ereignisse
   * =========================== */
  reloadBtn.onclick = ()=> render();
  addBtn.onclick = ()=> openEntry(null);
  fab.onclick = ()=> openEntry(null);
  viewSel.onchange = ()=> render();
  startDate.onchange = ()=> render();
  autoBtn.onclick = ()=>{
    if (autoTimer){ clearInterval(autoTimer); autoTimer=null; autoBtn.classList.remove("primary"); toast("Auto-Reload aus"); }
    else { autoTimer=setInterval(()=>render(),5000); autoBtn.classList.add("primary"); toast("Auto-Reload an"); }
  };
  function applyZoom(){ const z=Number(zoomRange.value)/100; grid.style.transform=`scale(${z})`; grid.style.transformOrigin="top left"; grid.style.width=`${100/z}%`; }
  zoomRange.oninput = applyZoom;
  zoomIn.onclick = ()=>{ zoomRange.value = Math.min(140, Number(zoomRange.value)+10); applyZoom(); };
  zoomOut.onclick = ()=>{ zoomRange.value = Math.max(80, Number(zoomRange.value)-10); applyZoom(); };

  /* ===========================
   * Helpers (DOM)
   * =========================== */
  function div(cls, txt){ const d=document.createElement("div"); if (cls) d.className=cls; if (txt) d.textContent=txt; return d; }
  function chip(txt, bg){ const c=div("chip",txt); if (bg){ c.style.background=bg; c.style.borderColor="#091123"; } return c; }
  function btn(txt, fn){ const b=document.createElement("button"); b.className="tbtn"; b.textContent=txt; b.onclick=fn; return b; }
  function getKW(d){
    const a=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (a.getUTCDay()+6)%7;
    a.setUTCDate(a.getUTCDate()-dayNum+3);
    const firstThursday=new Date(Date.UTC(a.getUTCFullYear(),0,4));
    const diff=a-firstThursday;
    return 1 + Math.round(diff / 604800000);
  }

  /* ===========================
   * Initialisierung
   * =========================== */
  (function init(){
    // Startdatum = heutiger Montag
    const mo = mondayOf(new Date());
    startDate.value = toISO(mo);
    statusTxt.textContent = "Status: online (Firestore)";
    loadMaster().then(()=> startLive());
    render();
  })();
</script>
</body>
</html>
