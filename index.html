<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Plantafel – Büro & Lager</title>
<style>
  :root{
    --bg:#0f1625; --panel:#17243b; --panel2:#1b2a45; --soft:#22375d;
    --text:#e7f0ff; --muted:#a3b6d9; --red:#ff6b6b; --brand:#2f6aff;
    --chip:#273b61; --chipText:#dfe9ff; --grid:#203459;
    --card:#1b2a45; --cardBorder:#2c4473; --shadow:rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .bar{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#0c1321;border-bottom:1px solid #0b1a33;position:sticky;top:0;z-index:50}
  h1{margin:0 12px 0 0;font-size:18px}
  select,input[type="date"]{background:var(--panel);color:var(--text);border:1px solid #223555;border-radius:8px;padding:8px 10px;outline:none}
  .btn{background:var(--soft);color:var(--text);border:1px solid #2b4473;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:#396ef8}
  .btn.ghost{background:transparent;border-color:#2b4473}
  .wrap{padding:16px}
  .board{max-width:1400px;margin:0 auto}
  .hint{padding:8px 14px;background:#0d1a31;border-top:1px solid #0b1a33;color:var(--muted);font-size:13px}

  /* Wochen – wachsend in der Höhe */
  .week{background:var(--panel);border-radius:14px;box-shadow:0 6px 18px var(--shadow);overflow:hidden;margin-bottom:22px}
  .weekHead,.weekBody{display:grid;grid-template-columns:220px repeat(5,1fr)}
  .weekHead div{padding:12px;background:var(--panel2);border-right:1px solid #20375f;font-weight:600;font-size:13px}
  .label{padding:12px;font-weight:600;color:#c7d6f2;background:var(--panel2);border-right:1px solid #20375f}
  .dayCol{
    min-height:140px;border-right:1px dashed #29416c;padding:10px;
    background:linear-gradient(transparent 31px,var(--grid) 31px,var(--grid) 32px,transparent 32px);
    background-size:100% 48px;
  }
  .dropNote{font-size:12px;color:#9fb6dc;opacity:.75;user-select:none}

  /* Karten */
  .card{background:var(--card);border:1px solid var(--cardBorder);border-radius:14px;padding:8px 10px;margin-bottom:10px;position:relative;box-shadow:0 3px 10px rgba(0,0,0,.25)}
  .title{font-weight:700;font-size:14px;margin-bottom:6px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:var(--chip);color:var(--chipText);padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #2a4676}
  .emp{font-weight:700}
  .tools{position:absolute;top:6px;right:8px;display:flex;gap:6px}
  .tool{width:20px;height:20px;display:grid;place-items:center;border-radius:6px;background:#203a6a;color:#cfe0ff;font-size:12px;cursor:pointer;border:1px solid #2b4a84}
  .status-uk{box-shadow: inset 0 0 0 2px var(--red);background:linear-gradient(180deg,#2a1013,var(--card))}

  /* Monate */
  .months{display:grid;gap:16px;grid-template-columns:repeat(4,1fr)}
  .month{background:var(--panel);border:1px solid #20365e;border-radius:14px;padding:12px;min-height:170px;box-shadow:0 6px 18px var(--shadow)}
  .month h3{margin:2px 2px 10px;font-size:14px}
  .month .drop{min-height:120px;padding:8px;border:1px dashed #29416c;border-radius:12px}

  /* Dialoge */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:100}
  .modal.open{display:flex}
  .dialog{background:var(--panel);border:1px solid #29416c;width:min(760px,94vw);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.45)}
  .dialog header{padding:14px 16px;font-weight:800;border-bottom:1px solid #29416c}
  .dialog .content{padding:14px 16px;display:grid;gap:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row label{width:120px;color:#c2d4f7;font-size:13px}
  .pill{padding:6px 10px;border-radius:999px;background:#23365a;border:1px solid #32507f;cursor:pointer;user-select:none}
  .pill.active{outline:2px solid #7fb0ff}
  .dialog footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid #29416c}

  .fab{position:fixed;right:20px;bottom:20px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:#2f6aff;color:white;font-size:26px;cursor:pointer;z-index:40;box-shadow:0 10px 22px rgba(0,0,0,.45);border:1px solid #396ef8}
</style>
</head>
<body>

<div class="bar">
  <h1>Plantafel</h1>
  <label>Ansicht:
    <select id="viewSel">
      <option value="14">14 Tage (Mo–Fr)</option>
      <option value="28" selected>4 Wochen (Mo–Fr)</option>
      <option value="m12">12 Monate (Grobplanung)</option>
    </select>
  </label>
  <label>Start:
    <input type="date" id="startDate"/>
  </label>
  <button class="btn" id="todayBtn">Heute</button>
  <button class="btn" id="reloadBtn">Neu laden</button>
  <div style="flex:1"></div>
  <span style="display:inline-grid;grid-auto-flow:column;align-items:center;gap:6px;color:#aabbe0">
    <span style="width:10px;height:10px;border-radius:50%;background:#ce2b2b"></span> Urlaub/Krank/Schule
  </span>
  <button class="btn" id="stammdatenBtn">Stammdaten</button>
  <button class="btn primary" id="addBtn">+ Eintrag</button>
</div>
<div class="hint">Drag & Drop: Karte auf Ziel ziehen → „Verschieben“ oder „Duplizieren“. Klick auf Karte = bearbeiten. X = löschen.</div>

<div class="wrap"><div class="board" id="board"></div></div>
<div class="fab" id="fab">+</div>

<!-- Edit -->
<div class="modal" id="editModal">
  <div class="dialog">
    <header>Eintrag bearbeiten</header>
    <div class="content" id="editContent"></div>
    <footer>
      <button class="btn ghost" id="toCoarseBtn">→ Grobplanung</button>
      <button class="btn ghost" id="toFineBtn">→ Feinplanung</button>
      <div style="flex:1"></div>
      <button class="btn" id="cancelEdit">Abbrechen</button>
      <button class="btn primary" id="saveEdit">Speichern</button>
    </footer>
  </div>
</div>

<!-- Stammdaten -->
<div class="modal" id="stammModal">
  <div class="dialog">
    <header>Stammdaten</header>
    <div class="content">
      <div class="row">
        <label>Neuer Mitarbeiter</label>
        <input id="empName" placeholder="Name" class="pill" style="flex:1"/>
        <button class="btn" id="empAdd">Hinzufügen</button>
      </div>
      <div class="row" id="empList"></div>
      <div class="row">
        <label>Neues Fahrzeug</label>
        <input id="vehName" placeholder="Fahrzeug" class="pill" style="flex:1"/>
        <button class="btn" id="vehAdd">Hinzufügen</button>
      </div>
      <div class="row" id="vehList"></div>
    </div>
    <footer><div style="flex:1"></div><button class="btn" id="closeStamm">Schließen</button></footer>
  </div>
</div>

<script>
/* ===== LocalStorage Keys ===== */
const LS_ENTRIES="pt_entries_v5"; const LS_SETTINGS="pt_settings_v5";

/* ===== Farben für Mitarbeiter (30+) ===== */
const COLOR_POOL=["#2ecc71","#3498db","#e67e22","#9b59b6","#e74c3c","#1abc9c","#f1c40f","#16a085","#2980b9","#8e44ad","#c0392b","#2c3e50","#d35400","#27ae60","#7f8c8d","#95a5a6","#e84393","#6c5ce7","#00b894","#fd79a8","#0984e3","#00cec9","#e17055","#4834d4","#22a6b3","#f0932b","#6ab04c","#eb4d4b","#be2edd","#130f40","#ff9f1a","#00a8ff"];

/* ===== Modus, Zoom, Auto-Reload ===== */
const urlParams = new URLSearchParams(location.search);
const MODE = (urlParams.get("mode")==="lager") ? "lager" : "buero";
const zoomVal = parseFloat(urlParams.get("zoom")||"1");
document.body.style.zoom = zoomVal;
if(MODE==="lager"){ setInterval(()=>location.reload(),60000); } // 60s Reload im Lager

/* ===== Robuste Datumshilfen (nur lokale Zeiten) ===== */
function dLocal(y,m,d){ return new Date(y,m,d); }
function fmt(d){ const z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function parseDateAny(s){
  if(!s) return new Date();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const [y,m,d]=s.split("-").map(Number); return dLocal(y,m-1,d); }
  if(/^\d{2}\.\d{2}\.\d{4}$/.test(s)){ const [d,m,y]=s.split(".").map(Number); return dLocal(y,m-1,d); }
  const t=new Date(s); return dLocal(t.getFullYear(),t.getMonth(),t.getDate());
}
function mondayOf(d){ const x=dLocal(d.getFullYear(),d.getMonth(),d.getDate()); const wd=x.getDay(); const diff=(wd===0?-6:1-wd); x.setDate(x.getDate()+diff); return x; }
function addDays(d,n){ return dLocal(d.getFullYear(),d.getMonth(),d.getDate()+n); }
function uid(){ return Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(6); }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
function getKW(d){ const date=dLocal(d.getFullYear(),d.getMonth(),d.getDate()); date.setDate(date.getDate()+3-((date.getDay()+6)%7)); const w1=dLocal(date.getFullYear(),0,4); return 1+Math.round(((date-w1)/86400000-3+((w1.getDay()+6)%7))/7); }

/* ===== Settings / Einträge (lokal) ===== */
function loadSettings(){
  let s=JSON.parse(localStorage.getItem(LS_SETTINGS)||"null");
  if(!s){
    s={employees:[
      {name:"Thomas",color:COLOR_POOL[0],active:true},
      {name:"Patrick",color:COLOR_POOL[1],active:true},
      {name:"Herbert",color:COLOR_POOL[2],active:true},
      {name:"Artiom",color:COLOR_POOL[3],active:true},
      {name:"Juppi",color:COLOR_POOL[4],active:true},
    ],vehicles:["Doka","Crafter","Mercedes Bus","Ford"]};
    localStorage.setItem(LS_SETTINGS,JSON.stringify(s));
  }
  return s;
}
function saveSettings(s){ localStorage.setItem(LS_SETTINGS,JSON.stringify(s)); }
function loadEntries(){ const raw=localStorage.getItem(LS_ENTRIES); return raw?JSON.parse(raw):[]; }
function saveEntries(a){ localStorage.setItem(LS_ENTRIES,JSON.stringify(a)); }

/* ===== UI References ===== */
let SETTINGS=loadSettings(); let ENTRIES=loadEntries();
const viewSel=document.getElementById("viewSel"), startDate=document.getElementById("startDate"), board=document.getElementById("board");

/* ===== Render Switch ===== */
function render(){ board.innerHTML=""; const v=viewSel.value; if(v==="m12") renderMonths(); else renderWeeks(Number(v)); }

/* ===== Wochenansichten (14 / 28) ===== */
function renderWeeks(windowDays){
  let d0 = startDate.value ? mondayOf(parseDateAny(startDate.value)) : mondayOf(new Date());
  if(!startDate.value) startDate.value = fmt(d0); // nur initial befüllen

  const wrap=document.createElement("div"); wrap.className="week";

  const head=document.createElement("div"); head.className="weekHead";
  head.innerHTML = `<div>KW / Zeitraum</div>` + [0,1,2,3,4].map(i=>{
    const dd=addDays(d0,i); return `<div>${["Mo","Di","Mi","Do","Fr"][i]}<br><span class="muted">${fmt(dd)}</span></div>`;
  }).join("");
  wrap.appendChild(head);

  const rows = windowDays===14?2:4;

  for(let w=0; w<rows; w++){
    const row=document.createElement("div"); row.className="weekBody";
    const wStart=addDays(d0,w*7), wEnd=addDays(wStart,4); const kw=getKW(wStart);
    const label=document.createElement("div"); label.className="label";
    label.innerHTML=`KW ${kw}<br><span class="muted">${fmt(wStart)} – ${fmt(wEnd)}</span><br><br><span class="muted">Projekt</span>`;
    row.appendChild(label);

    for(let i=0;i<5;i++){
      const col=document.createElement("div"); col.className="dayCol";
      const target=fmt(addDays(wStart,i)); col.dataset.date=target;

      if(MODE==="buero"){
        col.ondragover=e=>e.preventDefault();
        col.ondrop=e=>dropToDay(e,target);
        col.onclick=ev=>{ if(ev.target!==col && ev.target.closest(".card")) return;
          openEdit({id:uid(),title:"",status:"normal",date:target,duration:1,employees:[],vehicles:[],board:"fine",isNew:true});
        };
      }else{
        col.style.pointerEvents="auto";
      }

      const note=document.createElement("div"); note.className="dropNote";
      note.textContent = (MODE==="buero") ? "Klicken zum Eintragen · Drag & Drop möglich" : "Anzeige";
      col.appendChild(note);

      const cards=ENTRIES.filter(x=>x.board==="fine"&&x.date===target).sort((a,b)=>(a.status!=="normal")-(b.status!=="normal"));
      cards.forEach(ent=>col.appendChild(cardEl(ent)));

      // Doppelte Mitarbeiter Hinweis
      const todays=ENTRIES.filter(x=>x.board==="fine"&&x.date===target);
      const dup=dupEmployees(todays);
      dup.forEach(n=>{ const w=document.createElement("div"); w.className="chip"; w.style.background="#3a2a11"; w.textContent=`${n} doppelt`; col.appendChild(w); });

      row.appendChild(col);
    }
    wrap.appendChild(row);
  }
  board.appendChild(wrap);
}
function dupEmployees(cards){ const m={}; cards.forEach(c=>(c.employees||[]).forEach(n=>m[n]=(m[n]||0)+1)); return Object.keys(m).filter(k=>m[k]>1); }

/* ===== Monatsansicht (12 Monate, Grobplanung) ===== */
function renderMonths(){
  let base = startDate.value ? parseDateAny(startDate.value) : new Date();
  const jan1 = dLocal(base.getFullYear(),0,1);
  if(!startDate.value) startDate.value = fmt(jan1);

  const grid=document.createElement("div"); grid.className="months";
  for(let m=0;m<12;m++){
    const md=new Date(jan1.getFullYear(),m,1);
    const box=document.createElement("div"); box.className ="month";
    const h=document.createElement("h3"); h.textContent=md.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
    const drop=document.createElement("div"); drop.className="drop"; drop.dataset.month=m;

    if(MODE==="buero"){
      drop.onclick=ev=>{
        if(ev.target!==drop && ev.target.closest(".card")) return;
        openEdit({id:uid(),title:"",status:"normal",date:fmt(md),duration:1,employees:[],vehicles:[],board:"coarse",isNew:true});
      };
      drop.ondragover=e=>e.preventDefault();
      drop.ondrop=e=>dropToMonth(e,m,md);
    }

    ENTRIES.filter(x=> x.board==="coarse" && sameMonth(x,md)).forEach(ent=> drop.appendChild(cardEl(ent)) );
    box.appendChild(h); box.appendChild(drop); grid.appendChild(box);
  }
  board.appendChild(grid);
}
function sameMonth(e, md){ const d=parseDateAny(e.date); return d.getFullYear()===md.getFullYear() && d.getMonth()===md.getMonth(); }

/* ===== Karte erzeugen ===== */
function cardEl(ent){
  const el=document.createElement("div"); el.className="card"; if(ent.status!=="normal") el.classList.add("status-uk");
  const canWrite = (MODE==="buero");
  el.draggable = canWrite;
  if(canWrite){ el.ondragstart=e=>e.dataTransfer.setData("text/plain",ent.id); }
  const title=document.createElement("div"); title.className="title";
  title.textContent = ent.title || (ent.status==="urlaub"?"Urlaub":ent.status==="krank"?"Krank":ent.status==="schule"?"Schule":"Projekt");
  el.appendChild(title);
  const tools=document.createElement("div"); tools.className="tools";
  const tE=document.createElement("div"); tE.className="tool"; tE.title="Bearbeiten"; tE.textContent="✎";
  const tX=document.createElement("div"); tX.className="tool"; tX.title="Löschen"; tX.textContent="×";
  if(canWrite){
    tE.onclick=ev=>{ev.stopPropagation();openEdit(ent);};
    tX.onclick=ev=>{ev.stopPropagation(); if(confirm("Eintrag löschen?")) removeEntry(ent.id);};
  }else{
    tE.style.opacity=".4"; tE.style.pointerEvents="none";
    tX.style.opacity=".4"; tX.style.pointerEvents="none";
  }
  tools.appendChild(tE); tools.appendChild(tX); el.appendChild(tools);
  const chips=document.createElement("div"); chips.className="chips";
  (ent.vehicles||[]).forEach(v=>{ const c=document.createElement("span"); c.className="chip"; c.textContent=v; chips.appendChild(c); });
  (ent.employees||[]).forEach(n=>{ const emp=SETTINGS.employees.find(e=>e.name===n);
    const c=document.createElement("span"); c.className="chip emp"; c.textContent=n; c.style.background=emp?emp.color:"#3a4f78"; c.style.borderColor="#1d2f55"; chips.appendChild(c);
  });
  el.appendChild(chips);
  if(canWrite){ el.onclick=()=>openEdit(ent); }
  return el;
}

/* ===== Drag & Drop Handler ===== */
function dropToDay(e,targetDate){
  const id=e.dataTransfer.getData("text/plain"); const ent=ENTRIES.find(x=>x.id===id); if(!ent) return;
  const dupe=confirm("OK = duplizieren · Abbrechen = verschieben");
  if(dupe){ const copy=JSON.parse(JSON.stringify(ent)); copy.id=uid(); copy.date=targetDate; copy.board="fine"; ENTRIES.push(copy); }
  else { ent.date=targetDate; ent.board="fine"; }
  saveEntries(ENTRIES); render();
}
function dropToMonth(e,mi,md){
  const id=e.dataTransfer.getData("text/plain"); const ent=ENTRIES.find(x=>x.id===id); if(!ent) return;
  const dupe=confirm("OK = duplizieren · Abbrechen = verschieben");
  const newDate=fmt(new Date(md.getFullYear(),mi,1));
  if(dupe){ const copy=JSON.parse(JSON.stringify(ent)); copy.id=uid(); copy.date=newDate; copy.board="coarse"; ENTRIES.push(copy); }
  else { ent.date=newDate; ent.board="coarse"; }
  saveEntries(ENTRIES); render();
}

/* ===== Edit-Dialog ===== */
const editModal=document.getElementById("editModal"); const editContent=document.getElementById("editContent");
const saveEditBtn=document.getElementById("saveEdit"); const cancelEditBtn=document.getElementById("cancelEdit");
const toFineBtn=document.getElementById("toFineBtn"); const toCoarseBtn=document.getElementById("toCoarseBtn");
let editing=null;

function pill(label,on,fn,color=null){
  const p=document.createElement("span"); p.className="pill"+(on?" active":""); p.textContent=label;
  if(color){p.style.background=color;p.style.borderColor="#10253f";p.style.fontWeight="700";p.style.color="#081b0e";}
  p.onclick=()=>fn(p); return p;
}
function openEdit(ent){ if(MODE==="lager") return; editing=JSON.parse(JSON.stringify(ent)); drawEdit(); editModal.classList.add("open"); }
function drawEdit(){
  const e=editing; editContent.innerHTML="";
  // Titel
  const r1=document.createElement("div"); r1.className="row"; r1.innerHTML=`<label>Titel</label>`;
  const t=document.createElement("input"); t.className="pill"; t.style.flex="1"; t.value=e.title || (e.status!=="normal"?cap(e.status):""); t.oninput=()=>editing.title=t.value; r1.appendChild(t); editContent.appendChild(r1);
  // Status
  const r2=document.createElement("div"); r2.className="row"; r2.innerHTML=`<label>Status</label>`;
  ["normal","urlaub","krank","schule"].forEach(st=>{ const p=pill(cap(st),e.status===st,()=>{editing.status=st;drawEdit();}); if(st!=="normal"){p.style.background="#4a1e1e";p.style.borderColor="#7a2a2a"} r2.appendChild(p); });
  editContent.appendChild(r2);
  // Datum
  const r3=document.createElement("div"); r3.className="row"; r3.innerHTML=`<label>Datum</label>`;
  const d=document.createElement("input"); d.type="date"; d.className="pill"; d.value=e.date || fmt(new Date()); d.oninput=()=>editing.date=d.value; r3.appendChild(d); editContent.appendChild(r3);
  // Mitarbeiter
  const r4=document.createElement("div"); r4.className="row"; r4.innerHTML=`<label>Mitarbeiter</label>`;
  if(!e.employees) e.employees=[];
  SETTINGS.employees.filter(x=>x.active).forEach(emp=>{ const on=e.employees.includes(emp.name);
    r4.appendChild(pill(emp.name,on,(pl)=>{const i=editing.employees.indexOf(emp.name); if(i>=0) editing.employees.splice(i,1); else editing.employees.push(emp.name); pl.classList.toggle("active");},emp.color));
  }); editContent.appendChild(r4);
  // Fahrzeuge
  const r5=document.createElement("div"); r5.className="row"; r5.innerHTML=`<label>Fahrzeuge</label>`;
  if(!e.vehicles) e.vehicles=[];
  SETTINGS.vehicles.forEach(v=>{ const on=e.vehicles.includes(v);
    r5.appendChild(pill(v,on,(pl)=>{const i=editing.vehicles.indexOf(v); if(i>=0) editing.vehicles.splice(i,1); else editing.vehicles.push(v); pl.classList.toggle("active");}));
  }); editContent.appendChild(r5);
  // Dauer
  const r6=document.createElement("div"); r6.className="row"; r6.innerHTML=`<label>Dauer</label>`;
  const sel=document.createElement("select"); sel.className="pill"; [1,2,3,4,5,6,7,8,9,10].forEach(n=>{const o=document.createElement("option");o.value=n;o.textContent=n===1?"nur dieser Tag":`${n} Tage`; if(n==(e.duration||1)) o.selected=true; sel.appendChild(o);}); sel.onchange=()=>editing.duration=Number(sel.value); r6.appendChild(sel); editContent.appendChild(r6);
  // Urlaub/Krank/Schule → Titel fix
  if(e.status!=="normal"){ t.value=cap(e.status); t.disabled=true; } else { t.disabled=false; }
  // Move-Buttons
  toCoarseBtn.disabled = e.board==="coarse";
  toFineBtn.disabled   = e.board==="fine";
}
cancelEditBtn.onclick=()=>editModal.classList.remove("open");
saveEditBtn.onclick=()=>{
  if(editing.status!=="normal") editing.title=cap(editing.status);
  if(editing.isNew){ delete editing.isNew; ENTRIES.push(editing); }
  else{ const i=ENTRIES.findIndex(x=>x.id===editing.id); if(i>=0) ENTRIES[i]=editing; }
  saveEntries(ENTRIES); editModal.classList.remove("open"); render();
};
toFineBtn.onclick=()=>{
  editing.board="fine";
  const d=parseDateAny(editing.date); const mo=mondayOf(d);
  startDate.value=fmt(mo); viewSel.value="28";
  const i=ENTRIES.findIndex(x=>x.id===editing.id); if(i>=0) ENTRIES[i]=editing; else ENTRIES.push(editing);
  saveEntries(ENTRIES); editModal.classList.remove("open"); render();
};
toCoarseBtn.onclick=()=>{
  editing.board="coarse";
  const d=parseDateAny(editing.date); const jan=new Date(d.getFullYear(),0,1);
  startDate.value=fmt(jan); viewSel.value="m12";
  const i=ENTRIES.findIndex(x=>x.id===editing.id); if(i>=0) ENTRIES[i]=editing; else ENTRIES.push(editing);
  saveEntries(ENTRIES); editModal.classList.remove("open"); render();
};
function removeEntry(id){ if(!confirm("Eintrag löschen?")) return; ENTRIES=ENTRIES.filter(x=>x.id!==id); saveEntries(ENTRIES); render(); }

/* ===== Stammdaten ===== */
const stammModal=document.getElementById("stammModal");
const empList=document.getElementById("empList"); const empName=document.getElementById("empName"); const empAdd=document.getElementById("empAdd");
const vehList=document.getElementById("vehList"); const vehName=document.getElementById("vehName"); const vehAdd=document.getElementById("vehAdd");
document.getElementById("closeStamm").onclick=()=>stammModal.classList.remove("open");

function drawStamm(){
  empList.innerHTML="";
  SETTINGS.employees.forEach((e,idx)=>{
    const chip=document.createElement("span"); chip.className="pill"; chip.style.background=e.color; chip.textContent=e.name; chip.title="Klick = aktiv/inaktiv";
    if(!e.active){ chip.style.filter="grayscale(1) brightness(.8)"; chip.style.opacity=".7"; }
    chip.onclick=()=>{ e.active=!e.active; saveSettings(SETTINGS); drawStamm(); render(); };
    const del=document.createElement("span"); del.className="pill"; del.style.background="#3a1b1b"; del.textContent="×"; del.title="Löschen";
    del.onclick=()=>{ if(!confirm("Mitarbeiter entfernen?")) return; SETTINGS.employees.splice(idx,1); saveSettings(SETTINGS); drawStamm(); render(); };
    empList.appendChild(chip); empList.appendChild(del);
  });

  vehList.innerHTML="";
  SETTINGS.vehicles.forEach((v,idx)=>{
    const chip=document.createElement("span"); chip.className="pill"; chip.textContent=v;
    const del=document.createElement("span"); del.className="pill"; del.style.background="#3a1b1b"; del.textContent="×";
    del.onclick=()=>{ if(!confirm("Fahrzeug entfernen?")) return; SETTINGS.vehicles.splice(idx,1); saveSettings(SETTINGS); drawStamm(); render(); };
    vehList.appendChild(chip); vehList.appendChild(del);
  });
}
empAdd.onclick=()=>{ const n=empName.value.trim(); if(!n) return;
  const used=new Set(SETTINGS.employees.map(e=>e.color));
  const col=COLOR_POOL.find(c=>!used.has(c))||COLOR_POOL[SETTINGS.employees.length%COLOR_POOL.length];
  SETTINGS.employees.push({name:n,color:col,active:true});
  empName.value=""; saveSettings(SETTINGS); drawStamm(); render();
};
vehAdd.onclick=()=>{ const n=vehName.value.trim(); if(!n) return;
  SETTINGS.vehicles.push(n); vehName.value="";
  saveSettings(SETTINGS); drawStamm(); render();
};

/* ===== Toolbar ===== */
document.getElementById("reloadBtn").onclick=()=>render();
document.getElementById("todayBtn").onclick=()=>{ const mo=mondayOf(new Date()); startDate.value=fmt(mo); render(); };
document.getElementById("stammdatenBtn").onclick=()=>{ if(MODE==="lager"){ alert("Nur im Büro bearbeitbar."); return; } drawStamm(); stammModal.classList.add("open"); };
document.getElementById("addBtn").onclick=()=>{ if(MODE==="lager"){ alert("Nur im Büro bearbeitbar."); return; } openEdit({id:uid(),title:"",status:"normal",date:startDate.value||fmt(new Date()),duration:1,employees:[],vehicles:[],board:viewSel.value==="m12"?"coarse":"fine",isNew:true}); };
document.getElementById("fab").onclick=()=>document.getElementById("addBtn").click();
document.getElementById("viewSel").onchange=()=>{ if(MODE==="lager"){ viewSel.value="14"; return; } render(); };
document.getElementById("startDate").onchange=()=>render();

/* ===== Init (Start = HEUTE) ===== */
(function(){
  if(MODE==="lager"){ document.getElementById("stammdatenBtn").style.display="none"; document.getElementById("addBtn").style.display="none"; document.getElementById("fab").style.display="none"; document.getElementById("viewSel").value="14"; }
  const mo=mondayOf(new Date()); startDate.value=fmt(mo); render();
})();
</script>
</body>
</html>
