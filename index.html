<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plantafel Digital</title>
  <style>
    :root {
      --bg-dark: #1a1d22;
      --bg-card: #2a2f37;
      --bg-card-border: #3a404c;
      --text-main: #fff;
      --text-dim: #9ca3b0;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-red: #ef4444;
      --radius-lg: 10px;
      --radius-md: 6px;
      --gap: 8px;
      --font-stack: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
    }

    body {
      margin: 0;
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: var(--font-stack);
      font-size: 14px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
    }

    /* ======= TOP BAR ======= */
    .topbar {
      background: #111418;
      color: var(--text-main);
      padding: 10px 12px;
      border-bottom: 1px solid #2a303a;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
      position: relative;
    }
    .row-line1,
    .row-line2 {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .brand {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      background: #00000033;
      padding: 6px 10px;
      border-radius: var(--radius-md);
      border: 1px solid #2a303a;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: max-content;
    }

    .field-label {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.2;
    }

    select,
    input[type="text"] {
      background-color: #1f232a;
      color: var(--text-main);
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      padding: 6px 8px;
      font-size: 14px;
      min-width: 180px;
    }

    .inline-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .btn {
      background-color: #2a2f37;
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      line-height: 1.2;
    }
    .btn.primary {
      background-color: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #fff;
      font-weight: 600;
    }
    .btn.ghost {
      background-color: transparent;
      border-color: #515967;
      color: var(--text-dim);
    }
    .btn.small {
      font-size: 13px;
      padding: 4px 8px;
      line-height: 1.1;
    }

    .status-light {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: #1f232a;
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      padding: 6px 10px;
      font-size: 13px;
      line-height: 1.2;
      font-weight: 500;
      min-width: max-content;
    }
    .dot-red,
    .dot-green {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }
    .dot-red { background-color: var(--accent-red); }
    .dot-green { background-color: var(--accent-green); }

    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      background-color: #1f232a;
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      padding: 6px 10px;
      font-size: 13px;
      line-height: 1.2;
    }
    .toggle-wrap input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .zoom-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: max-content;
      color: var(--text-dim);
      font-size: 12px;
    }
    .zoom-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .zoom-row input[type="range"] {
      width: 140px;
      accent-color: var(--accent-blue);
    }

    .spacer {
      flex: 1;
    }

    /* Hinweiszeile unter den Controls */
    .hint-row {
      font-size: 12px;
      color: var(--text-dim);
    }
    .hint-row strong {
      color: #fff;
      font-weight: 500;
    }

    /* ======= STATUS FOOTER LEFT (rot=Urlaub/...) ======= */
    .status-footer {
      font-size: 12px;
      color: var(--text-dim);
      padding: 6px 12px 0 12px;
    }

    /* ======= BOARD WRAPPER ======= */
    .board-scroll {
      position: relative;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 12px;
    }

    /* Das Grid für die Wochen/Spalten */
    .board-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(220px,1fr));
      gap: var(--gap);
      min-width: 1100px;
      border: 1px solid #2a303a;
      background-color: #1f2229;
      border-radius: var(--radius-lg);
      padding: 12px;
      transform-origin: top left;
    }

    /* Spalten (=Tage bzw. KW Blöcke) */
    .day-col {
      display: flex;
      flex-direction: column;
      background-color: #1f232a;
      border: 1px solid #2f3541;
      border-radius: var(--radius-md);
      min-height: 220px;
    }

    .day-head {
      border-bottom: 1px solid #2f3541;
      padding: 8px;
      font-size: 12px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 2px;
      color: var(--text-main);
    }
    .day-head .kw {
      font-size: 11px;
      color: var(--accent-blue);
      font-weight: 600;
    }
    .day-head .date-line {
      font-size: 11px;
      color: var(--text-dim);
    }

    .day-body {
      flex: 1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    .drop-hint {
      font-size: 11px;
      color: #6b7280;
      border: 1px dashed #4b5563;
      border-radius: var(--radius-md);
      background-color: #1a1d22;
      padding: 8px;
      text-align: center;
    }

    /* Karte / Eintrag */
    .card {
      background-color: var(--bg-card);
      border: 1px solid var(--bg-card-border);
      border-radius: var(--radius-md);
      color: var(--text-main);
      padding: 8px;
      font-size: 12px;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: grab;
      position: relative;
    }
    .card.red {
      border-left: 4px solid var(--accent-red);
      padding-left: 6px;
    }
    .card .title-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
      font-weight: 600;
      color: #fff;
    }
    .card .subtitle {
      font-size: 11px;
      color: var(--text-dim);
    }

    .card .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .tag-person {
      background-color: #374151;
      color: #fff;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 11px;
      line-height: 1.2;
      border: 1px solid #4b5563;
    }

    .card-actions {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      gap: 4px;
    }
    .card-btn {
      background-color: #1f232a;
      border: 1px solid #4b5563;
      border-radius: var(--radius-md);
      font-size: 10px;
      line-height: 1;
      color: var(--text-dim);
      padding: 2px 4px;
      cursor: pointer;
    }
    .card-btn:hover {
      background-color: #3b4252;
      color: #fff;
    }

    /* Floating Add Button rechts unten */
    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background-color: var(--accent-blue);
      color: #fff;
      border-radius: 999px;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 500;
      line-height: 1;
      border: none;
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
      cursor: pointer;
    }

    /* Cloud-Dot rechts oben in der Bar (Verbindung)*/
    .conn-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background-color: #1f232a;
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      padding: 6px 10px;
      font-size: 13px;
      font-weight: 500;
      line-height: 1.2;
    }
    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background-color: var(--accent-green);
    }
    .conn-dot.offline {
      background-color: var(--accent-red);
    }

    /* Dialog / Modal */
    dialog {
      background-color: #1f232a;
      color: var(--text-main);
      border: 1px solid #3a404c;
      border-radius: var(--radius-lg);
      padding: 16px;
      max-width: 320px;
      width: calc(100% - 32px);
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
    }
    dialog::backdrop {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(2px);
    }
    .dlg-head {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #fff;
    }
    .dlg-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    .dlg-body label {
      font-size: 13px;
      color: var(--text-dim);
      display: block;
      margin-bottom: 4px;
    }
    .dlg-body input,
    .dlg-body textarea {
      width: 100%;
      background-color: #111418;
      color: #fff;
      border: 1px solid #3a404c;
      border-radius: var(--radius-md);
      font-size: 13px;
      padding: 8px;
    }
    .dlg-body textarea {
      min-height: 60px;
      resize: vertical;
    }
    .dlg-foot {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
    }

    /* kleine Helper Badges */
    .badge-role {
      display: inline-block;
      font-size: 11px;
      line-height: 1.2;
      padding: 2px 6px;
      border-radius: 999px;
      background-color: #374151;
      border: 1px solid #4b5563;
      color: #fff;
      margin-left: 4px;
    }

    @media (max-width: 700px) {
      .row-line1,
      .row-line2 {
        flex-direction: column;
        align-items: flex-start;
      }
      .spacer {
        display: none;
      }
      .zoom-row input[type="range"] {
        width: 120px;
      }
      .board-grid {
        min-width: 900px;
      }
    }
  </style>
</head>
<body>

  <!-- ======== TOP BAR ======== -->
  <div class="topbar">
    <div class="row-line1">
      <div class="brand">Plantafel</div>

      <div class="field-group">
        <div class="field-label">Ansicht:</div>
        <select id="viewSel">
          <option value="4w">4 Wochen (Mo–Fr)</option>
          <option value="3w">3 Wochen</option>
          <option value="2w">2 Wochen</option>
          <option value="1w">1 Woche</option>
        </select>
      </div>

      <div class="field-group">
        <div class="field-label">Start:</div>
        <input id="startDate" type="text" placeholder="TT.MM.JJJJ" />
      </div>

      <button class="btn" id="btnReload">Neu laden</button>

      <div class="status-light" id="statusBlock">
        <div class="dot-red"></div>
        <span>Urlaub/Krank/Schule</span>
        <button class="btn small" id="btnUrlaubMinus">-</button>
        <button class="btn small" id="btnUrlaubPlus">+</button>
      </div>

      <div class="toggle-wrap">
        <input type="checkbox" id="autoReloadChk" />
        <label for="autoReloadChk" style="cursor:pointer;">Auto-Reload</label>
      </div>

      <button class="btn" id="btnStammdaten">Stammdaten</button>
      <button class="btn primary" id="btnAdd">+ Eintrag</button>

      <div class="spacer"></div>

      <div class="conn-indicator" id="cloudStatus">
        <div class="conn-dot" id="cloudDot"></div>
        <span id="cloudText">verbunden</span>
      </div>

      <div class="zoom-wrap">
        <span>Zoom</span>
        <div class="zoom-row">
          <input id="zoomRange" type="range" min="0.5" max="1.5" step="0.05" value="1" />
        </div>
      </div>
    </div>

    <div class="row-line2">
      <div class="hint-row">
        Drag &amp; Drop: Karte auf Ziel ziehen → „Verschieben“ oder „Duplizieren“. Klick auf Karte = bearbeiten, X = löschen.
      </div>
    </div>
  </div>

  <!-- mini Status Fußzeile (links oben wie bei dir) -->
  <div class="status-footer">
    Status rot = Urlaub/Krank/Schule
  </div>

  <!-- ======== BOARD ======== -->
  <div class="board-scroll">
    <div class="board-grid" id="boardGrid" style="transform:scale(1);">
      <!-- Spalten/Tage werden dynamisch aus Firestore geladen -->
    </div>
  </div>

  <!-- Floating Add Button -->
  <button class="fab" id="fabAdd">+</button>

  <!-- ======== DIALOG: EINTRAG BEARBEITEN/NEU ======== -->
  <dialog id="entryDlg">
    <div class="dlg-head">Eintrag</div>
    <div class="dlg-body">
      <div>
        <label for="mTitle">Titel / Projekt</label>
        <input id="mTitle" placeholder="Projekt / Kunde / Baustelle" />
      </div>
      <div>
        <label for="mText">Beschreibung / Notiz</label>
        <textarea id="mText" placeholder="z. B. 'Mercedes Bus', Material, Besonderheiten …"></textarea>
      </div>
      <div>
        <label for="mDate">Datum (TT.MM.JJJJ)</label>
        <input id="mDate" placeholder="TT.MM.JJJJ" />
      </div>
      <div>
        <label>Mitarbeiter (Kommagetrennt)</label>
        <input id="mCrew" placeholder="z. B. Patrick, Herbert" />
      </div>
      <div>
        <label>Status / Typ</label>
        <select id="mStatus">
          <option value="normal">Normal</option>
          <option value="urlaub">Urlaub / Krank / Schule</option>
        </select>
      </div>
      <input type="hidden" id="mDocId" />
    </div>
    <div class="dlg-foot">
      <button class="btn ghost" id="btnEntryCancel">Abbrechen</button>
      <button class="btn primary" id="btnEntrySave">Speichern</button>
    </div>
  </dialog>

  <!-- ======== DIALOG: STAMMDATEN ======== -->
  <dialog id="masterDlg">
    <div class="dlg-head">Stammdaten</div>
    <div class="dlg-body">
      <div>
        <label for="mNote">Team-Notiz</label>
        <input id="mNote" placeholder="optional" />
      </div>
      <div>
        <label for="mDefaultCrew">Standard-Team (Kommagetrennt)</label>
        <input id="mDefaultCrew" placeholder="z. B. Patrick, Herbert" />
      </div>
    </div>
    <div class="dlg-foot">
      <button class="btn ghost" id="btnMasterCancel">Abbrechen</button>
      <button class="btn primary" id="btnMasterSave">Speichern</button>
    </div>
  </dialog>

  <!-- ======== SCRIPT: APP LOGIK + FIREBASE ======== -->
  <script type="module">
    /********************************************************
     * Firebase SDK (ohne AppCheck, stabil)
     ********************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
      getDoc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    /********************************************************
     * Firebase-Konfiguration (deine project-Daten)
     ********************************************************/
    const firebaseConfig = {
      apiKey: "AIzAsyDpWFf-XnO238X-ebCVg6a42DRxm9f4SxDT",
      authDomain: "plantafelfreylclich100.firebaseapp.com",
      projectId: "plantafelfreylclich100",
      storageBucket: "plantafelfreylclich100.appspot.com",
      messagingSenderId: "962959139135",
      appId: "1:962959139135:web:e4462794477815c0ef91d4a",
      measurementId: "G-W5GVSSLTRC"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    // Debug Zugriff im Browser
    window.__db = db;

    /********************************************************
     * Element-Referenzen / UI
     ********************************************************/
    const $ = (sel) => document.querySelector(sel);

    const boardGrid     = $("#boardGrid");
    const cloudDot      = $("#cloudDot");
    const cloudText     = $("#cloudText");
    const zoomRange     = $("#zoomRange");

    const viewSel       = $("#viewSel");
    const startDate     = $("#startDate");
    const btnReload     = $("#btnReload");
    const btnUrlaubMinus= $("#btnUrlaubMinus");
    const btnUrlaubPlus = $("#btnUrlaubPlus");
    const autoReloadChk = $("#autoReloadChk");
    const btnStammdaten = $("#btnStammdaten");
    const btnAdd        = $("#btnAdd");
    const fabAdd        = $("#fabAdd");

    // Dialog Eintrag
    const entryDlg      = $("#entryDlg");
    const mTitle        = $("#mTitle");
    const mText         = $("#mText");
    const mDate         = $("#mDate");
    const mCrew         = $("#mCrew");
    const mStatus       = $("#mStatus");
    const mDocId        = $("#mDocId");
    const btnEntryCancel= $("#btnEntryCancel");
    const btnEntrySave  = $("#btnEntrySave");

    // Dialog Stammdaten
    const masterDlg      = $("#masterDlg");
    const mNote          = $("#mNote");
    const mDefaultCrew   = $("#mDefaultCrew");
    const btnMasterCancel= $("#btnMasterCancel");
    const btnMasterSave  = $("#btnMasterSave");

    /********************************************************
     * State
     ********************************************************/
    let unsubListener = null; // Firestore Live-Listener
    let currentZoom   = 1;

    // Hilfsfunktion für Datum formatiert (TT.MM.JJJJ)
    function formatDate(d) {
      const dd   = String(d.getDate()).padStart(2,"0");
      const mm   = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}.${mm}.${yyyy}`;
    }

    // parse "TT.MM.JJJJ" -> Date
    function parseDate(str) {
      const parts = str.split(".");
      if(parts.length!==3) return null;
      const dd = parseInt(parts[0],10);
      const mm = parseInt(parts[1],10)-1;
      const yy = parseInt(parts[2],10);
      const d = new Date(yy,mm,dd);
      if(isNaN(d.getTime())) return null;
      return d;
    }

    // Erzeuge ein Array von Tagen (z. B. Mo-Fr x 4 Wochen)
    function buildDaySlots(startDay, viewMode) {
      // viewMode "4w" = 4 Wochen Mo-Fr = 20 Spalten
      // aktuell im UI zeigen wir 5 Spalten nebeneinander (Mo-Fr),
      // aber du hattest vorher Scroll nach rechts mit vielen Wochen.
      // Wir machen simpel: 4 Wochen x5 Tage = 20 Tage in Reihenfolge.
      const weeks = (viewMode==="4w"?4: viewMode==="3w"?3: viewMode==="2w"?2:1);
      const daysPerWeek = 5; // Mo-Fr
      // wir verschieben startDay zurück bis Montag
      const base = new Date(startDay.getTime());
      while(base.getDay()!==1) { // 1 = Montag
        base.setDate(base.getDate()-1);
      }

      const slots=[];
      for(let w=0; w<weeks; w++){
        for(let d=0; d<daysPerWeek; d++){
          const cur = new Date(base.getTime());
          cur.setDate(base.getDate() + w*7 + d);
          slots.push({
            date: cur,
            iso: cur.toISOString().slice(0,10), // "2025-10-30"
          });
        }
      }
      return slots;
    }

    /********************************************************
     * Render Board (Days + Cards)
     ********************************************************/
    function renderBoard(daySlots, docsByDay) {
      // docsByDay: { "2025-10-30": [ {id,...}, ... ], ... }

      // Grid dynamisch: wir wollen 5 Spalten pro "Reihe" -> wir packen ALLE Tage in Rows zu je 5
      const colsPerRow = 5;
      const totalCols  = daySlots.length;
      // CSS Grid bleibt 5 Spalten fix; wir rendern mehrere ".board-grid" rows nacheinander
      // ABER zur Vereinfachung hier machen wir eine einzige boardGrid
      // und jede 5er-Gruppe bekommt eine zusätzliche Border oben.
      // (Das ist optisch nah genug an deiner Ansicht.)

      boardGrid.innerHTML = ""; // clear

      daySlots.forEach((slot, idx) => {
        const dObj = slot.date;
        const dow  = dObj.toLocaleDateString("de-DE", { weekday:"short" }); // Mo, Di, ...
        const dstr = dObj.toLocaleDateString("de-DE", { year:"numeric", month:"2-digit", day:"2-digit" });

        // KW berechnen
        const tmp = new Date(dObj.getTime());
        const oneJan = new Date(tmp.getFullYear(),0,1);
        const diff = Math.round(((tmp - oneJan)/86400000)+((oneJan.getDay()+6)%7));
        const kw = Math.ceil(diff/7);

        const dayCol = document.createElement("div");
        dayCol.className = "day-col";
        dayCol.dataset.dateIso = slot.iso;

        // Kopf
        const head = document.createElement("div");
        head.className = "day-head";

        const kwLine = document.createElement("div");
        kwLine.className = "kw";
        kwLine.textContent = `KW ${String(kw).padStart(2,"0")}  ${dow}`;
        head.appendChild(kwLine);

        const dateLine = document.createElement("div");
        dateLine.className = "date-line";
        dateLine.textContent = dstr;
        head.appendChild(dateLine);

        dayCol.appendChild(head);

        // Body
        const body = document.createElement("div");
        body.className = "day-body";

        const list = docsByDay[slot.iso] || [];
        if(list.length===0){
          const dh = document.createElement("div");
          dh.className = "drop-hint";
          dh.textContent = "Klicken zum Eintragen · Drag & Drop möglich";
          dh.addEventListener("click",()=>openEntryDlgNew(slot.iso));
          body.appendChild(dh);
        } else {
          list.forEach(item=>{
            body.appendChild(renderCard(item, slot.iso));
          });
          // Platz für weiteren Klick
          const dh2=document.createElement("div");
          dh2.className="drop-hint";
          dh2.textContent="Klicken zum Eintragen · Drag & Drop möglich";
          dh2.addEventListener("click",()=>openEntryDlgNew(slot.iso));
          body.appendChild(dh2);
        }

        dayCol.appendChild(body);
        boardGrid.appendChild(dayCol);
      });
    }

    // Karte rendern
    function renderCard(item, isoDate){
      const div=document.createElement("div");
      div.className = "card" + (item.status==="urlaub"?" red":"");
      div.draggable = true;
      div.dataset.docId   = item.id;
      div.dataset.dateIso = isoDate;

      // actions (X / bearbeiten)
      const actions=document.createElement("div");
      actions.className="card-actions";

      const btnDel=document.createElement("button");
      btnDel.className="card-btn";
      btnDel.textContent="X";
      btnDel.title="Löschen";
      btnDel.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        deleteEntry(item.id);
      });
      actions.appendChild(btnDel);

      const btnEdit=document.createElement("button");
      btnEdit.className="card-btn";
      btnEdit.textContent="✎";
      btnEdit.title="Bearbeiten";
      btnEdit.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        openEntryDlgEdit(item);
      });
      actions.appendChild(btnEdit);

      div.appendChild(actions);

      // title row
      const trow=document.createElement("div");
      trow.className="title-row";
      const tt=document.createElement("div");
      tt.textContent = item.title || "(ohne Titel)";
      trow.appendChild(tt);
      div.appendChild(trow);

      // subtitle / beschreibung
      if(item.text){
        const st=document.createElement("div");
        st.className="subtitle";
        st.textContent=item.text;
        div.appendChild(st);
      }

      // crew tags
      if(item.crew && item.crew.length){
        const tags=document.createElement("div");
        tags.className="tags";
        item.crew.forEach(c=>{
          const tag=document.createElement("div");
          tag.className="tag-person";
          tag.textContent=c.trim();
          tags.appendChild(tag);
        });
        div.appendChild(tags);
      }

      // Drag Events rudimentär
      div.addEventListener("dragstart",(ev)=>{
        ev.dataTransfer.setData("text/plain", JSON.stringify({
          id: item.id,
          from: isoDate
        }));
      });

      return div;
    }

    /********************************************************
     * Firestore Laden + Live-Listener
     ********************************************************/
    // wir speichern Einträge in Collection "plantafel"
    // Dokument-Felder:
    // { title, text, dateIso:"2025-10-30", crew:["Patrick","Herbert"], status:"urlaub"/"normal", ts }
    async function loadBoardOnceAndListen() {
      // Listener beenden falls aktiv
      if(unsubListener){ unsubListener(); unsubListener=null; }

      const qRef = collection(db,"plantafel");
      // Wir hören auf ALLES und filtern dann im JS auf sichtbaren Zeitraum
      unsubListener = onSnapshot(qRef, snap=>{
        const allDocs=[];
        snap.forEach(docSnap=>{
          const data=docSnap.data();
          allDocs.push({
            id: docSnap.id,
            title: data.title || "",
            text: data.text || "",
            dateIso: data.dateIso || "",
            crew: Array.isArray(data.crew)? data.crew: [],
            status: data.status || "normal",
          });
        });
        refreshBoardFromData(allDocs);
      }, err=>{
        console.error("onSnapshot Fehler:",err);
        setOffline();
      });
    }

    function refreshBoardFromData(allDocs){
      const vMode = viewSel.value; // "4w" ...
      const baseDate = parseDate(startDate.value) || new Date();

      const daySlots = buildDaySlots(baseDate, vMode);

      // nach Tag gruppieren
      const mapByDay = {};
      for(const d of daySlots){
        mapByDay[d.iso]=[];
      }
      for(const item of allDocs){
        if(mapByDay[item.dateIso]){
          mapByDay[item.dateIso].push(item);
        }
      }

      renderBoard(daySlots, mapByDay);
      setOnline();
    }

    /********************************************************
     * CRUD Einträge
     ********************************************************/
    async function saveEntry(){
      const id    = mDocId.value.trim();
      const title = mTitle.value.trim();
      const text  = mText.value.trim();
      const rawDate = mDate.value.trim();
      const crewStr = mCrew.value.trim();
      const status  = mStatus.value;

      // Date-Check
      const parsed = parseDate(rawDate);
      if(!parsed){
        alert("Ungültiges Datum. Bitte TT.MM.JJJJ");
        return;
      }
      const iso = parsed.toISOString().slice(0,10);

      const crewArr = crewStr ? crewStr.split(",").map(s=>s.trim()).filter(Boolean) : [];

      const payload = {
        title,
        text,
        dateIso: iso,
        crew: crewArr,
        status,
        ts: serverTimestamp(),
      };

      try {
        if(id){
          // update
          await updateDoc(doc(db,"plantafel",id), payload);
        } else {
          // neu
          await addDoc(collection(db,"plantafel"), payload);
        }
        closeEntryDlg();
      } catch(e){
        console.error("Speichern fehlgeschlagen:", e);
        alert("Konnte nicht speichern.");
      }
    }

    async function deleteEntry(id){
      if(!confirm("Diesen Eintrag wirklich löschen?")) return;
      try {
        await deleteDoc(doc(db,"plantafel",id));
      } catch(e){
        console.error("Löschen fehlgeschlagen:", e);
        alert("Konnte nicht löschen.");
      }
    }

    /********************************************************
     * Stammdaten (Collection "settings", doc "default")
     ********************************************************/
    async function loadStammdatenToDialog(){
      try{
        const ref = doc(db,"settings","default");
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data = snap.data();
          mNote.value = data.note || "";
          mDefaultCrew.value = Array.isArray(data.defaultCrew)
            ? data.defaultCrew.join(", ")
            : "";
        } else {
          mNote.value = "";
          mDefaultCrew.value = "";
        }
      }catch(e){
        console.warn("Stammdaten lesen fehlgeschlagen:", e);
        mNote.value = "";
        mDefaultCrew.value = "";
      }
    }

    async function saveStammdaten(){
      const note = mNote.value.trim();
      const crewArr = mDefaultCrew.value.split(",").map(s=>s.trim()).filter(Boolean);

      try{
        await setDoc(doc(db,"settings","default"), {
          note,
          defaultCrew: crewArr,
          ts: serverTimestamp()
        });
        closeMasterDlg();
      }catch(e){
        console.error("Stammdaten speichern fehlgeschlagen:", e);
        alert("Konnte Stammdaten nicht speichern.");
      }
    }

    /********************************************************
     * Dialogsteuerung
     ********************************************************/
    function openEntryDlgNew(prefillIso){
      mDocId.value="";
      mTitle.value="";
      mText.value="";
      mCrew.value="";
      mStatus.value="normal";
      // Datum vorbelegen
      if(prefillIso){
        const d=new Date(prefillIso+"T00:00:00");
        mDate.value = formatDate(d);
      } else {
        mDate.value = formatDate(new Date());
      }
      entryDlg.showModal();
    }
    function openEntryDlgEdit(item){
      mDocId.value=item.id;
      mTitle.value=item.title || "";
      mText.value=item.text || "";
      mCrew.value=(item.crew||[]).join(", ");
      mStatus.value=item.status||"normal";

      if(item.dateIso){
        const d=new Date(item.dateIso+"T00:00:00");
        mDate.value=formatDate(d);
      } else {
        mDate.value=formatDate(new Date());
      }
      entryDlg.showModal();
    }
    function closeEntryDlg(){
      entryDlg.close();
    }

    async function openMasterDlg(){
      await loadStammdatenToDialog();
      masterDlg.showModal();
    }
    function closeMasterDlg(){
      masterDlg.close();
    }

    /********************************************************
     * Verbindung / Status-Anzeige
     ********************************************************/
    function setOnline(){
      cloudDot.classList.remove("offline");
      cloudText.textContent = "verbunden";
    }
    function setOffline(){
      cloudDot.classList.add("offline");
      cloudText.textContent = "offline";
    }

    /********************************************************
     * Zoom
     ********************************************************/
    zoomRange.addEventListener("input", ()=>{
      currentZoom = parseFloat(zoomRange.value)||1;
      boardGrid.style.transform = `scale(${currentZoom})`;
    });

    /********************************************************
     * Events UI
     ********************************************************/
    btnAdd.addEventListener("click", ()=>openEntryDlgNew());
    fabAdd.addEventListener("click", ()=>openEntryDlgNew());

    btnEntryCancel.addEventListener("click", closeEntryDlg);
    btnEntrySave.addEventListener("click", saveEntry);

    btnStammdaten.addEventListener("click", openMasterDlg);
    btnMasterCancel.addEventListener("click", closeMasterDlg);
    btnMasterSave.addEventListener("click", saveStammdaten);

    btnReload.addEventListener("click", ()=>{
      // hart neu laden aus Firestore
      if(unsubListener){ unsubListener(); unsubListener=null; }
      loadBoardOnceAndListen();
    });

    // Datum Start vorbelegen (heute)
    startDate.value = formatDate(new Date());

    // Erste Initialisierung
    loadBoardOnceAndListen();
  </script>
</body>
</html>
