<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plantafel Digital</title>

<style>
    :root {
        --bg-main:#121416;
        --bg-panel:#1e2227;
        --bg-panel-border:#2a3038;
        --text-main:#f4f4f4;
        --text-dim:#9ba3ad;
        --accent:#2d6bff;
        --danger:#d9534f;
        --radius-lg:12px;
        --radius-sm:6px;
        --gap:8px;
        --col-header:#2a3038;
        --badge-bg:#2a3038;
        --badge-text:#ffffff;
    }

    body{
        margin:0;
        background:var(--bg-main);
        color:var(--text-main);
        font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
        font-size:14px;
        line-height:1.4;
        display:flex;
        flex-direction:column;
        min-height:100vh;
    }

    header{
        background:linear-gradient(to right,#1e2227 0%,#242a31 100%);
        border-bottom:1px solid var(--bg-panel-border);
        padding:10px 12px;
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap:8px 12px;
        position:relative;
        z-index:10;
        box-shadow:0 10px 30px rgba(0,0,0,.6);
    }

    header .group{
        display:flex;
        flex-wrap:wrap;
        align-items:center;
        gap:8px;
        background:#0000;
    }

    label.small{
        font-size:12px;
        color:var(--text-dim);
        display:flex;
        flex-direction:column;
        font-weight:500;
    }

    select, input[type="date"], input[type="text"]{
        background:#0f1114;
        border:1px solid var(--bg-panel-border);
        color:var(--text-main);
        padding:6px 8px;
        border-radius:var(--radius-sm);
        min-width:120px;
        font-size:13px;
    }

    button.btn{
        background:#2a3038;
        border:1px solid var(--bg-panel-border);
        color:var(--text-main);
        padding:6px 10px;
        font-size:13px;
        border-radius:var(--radius-sm);
        cursor:pointer;
        line-height:1.2;
        white-space:nowrap;
    }
    button.btn.primary{
        background:var(--accent);
        border-color:var(--accent);
        color:#fff;
        font-weight:600;
    }
    button.btn.ghost{
        background:#0000;
        border:1px solid var(--bg-panel-border);
        color:var(--text-dim);
    }
    button.btn.danger{
        background:var(--danger);
        border-color:var(--danger);
        color:#fff;
    }

    .statusDot{
        display:inline-block;
        width:8px;
        height:8px;
        border-radius:50%;
        background:#34c759;
        margin-right:6px;
    }
    .statusDot.off{
        background:#d9534f;
    }
    .statusWrap{
        font-size:13px;
        font-weight:500;
        display:flex;
        align-items:center;
        min-width:90px;
        user-select:none;
    }

    .toggleRow{
        display:flex;
        align-items:center;
        gap:6px;
        font-size:13px;
        color:var(--text-main);
        user-select:none;
    }
    .toggleRow input[type="checkbox"]{
        accent-color:var(--accent);
        width:16px;
        height:16px;
        cursor:pointer;
    }

    /* FAB */
    .fabWrapper{
        position:fixed;
        right:16px;
        bottom:16px;
        z-index:30;
    }
    .fabMain{
        width:42px;
        height:42px;
        border-radius:50%;
        background:var(--accent);
        color:#fff;
        border:none;
        font-size:24px;
        font-weight:500;
        line-height:0;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        box-shadow:0 10px 30px rgba(0,0,0,.6);
    }

    /* BOARD AREA */
    .boardOuter{
        flex:1;
        overflow:auto;
        padding:16px;
    }

    .boardGrid{
        display:grid;
        grid-template-columns:repeat(var(--cols,5),minmax(240px,1fr));
        gap:12px;
        min-width:max-content;
    }

    .dayCol{
        background:var(--bg-panel);
        border:1px solid var(--bg-panel-border);
        border-radius:var(--radius-lg);
        display:flex;
        flex-direction:column;
        min-height:220px;
        box-shadow:0 8px 24px rgba(0,0,0,.5);
        position:relative;
    }

    .dayHeader{
        background:var(--col-header);
        border-bottom:1px solid var(--bg-panel-border);
        border-radius:var(--radius-lg) var(--radius-lg) 0 0;
        padding:8px 10px 6px;
        font-size:12px;
        line-height:1.3;
        display:flex;
        flex-wrap:wrap;
        justify-content:space-between;
        align-items:flex-start;
        min-height:44px;
    }
    .dayHeader .left{
        display:flex;
        flex-direction:column;
    }
    .dayHeader .kw{
        color:var(--accent);
        font-weight:600;
        font-size:12px;
    }
    .dayHeader .dateLine{
        font-size:11px;
        color:var(--text-dim);
    }

    .cardList{
        flex:1;
        padding:10px;
        display:flex;
        flex-direction:column;
        gap:8px;
    }

    .dropHint{
        font-size:12px;
        line-height:1.3;
        color:var(--text-dim);
        text-align:center;
        padding:16px 8px;
        border:1px dashed var(--bg-panel-border);
        border-radius:var(--radius-sm);
        min-height:64px;
    }

    .jobCard{
        background:#0f1114;
        border:1px solid var(--bg-panel-border);
        border-radius:var(--radius-sm);
        box-shadow:0 8px 20px rgba(0,0,0,.6);
        padding:8px;
        font-size:12px;
        line-height:1.4;
        cursor:grab;
        position:relative;
    }
    .jobCard.dragging{
        opacity:.5;
    }
    .cardHeaderRow{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        margin-bottom:4px;
        color:var(--text-main);
        font-weight:600;
        font-size:12px;
    }
    .cardHeaderRow .titleWrap{
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        align-items:center;
    }
    .badgeStatus{
        background:var(--badge-bg);
        color:var(--badge-text);
        border-radius:999px;
        padding:2px 6px;
        font-size:11px;
        font-weight:500;
        line-height:1.3;
    }
    .badgeStatus.red{
        background:#8a1f1f;
        color:#fff;
    }
    .badgeStatus.green{
        background:#1f8a34;
        color:#fff;
    }
    .badgeStatus.blue{
        background:#1f3f8a;
        color:#fff;
    }

    .cardHeaderRow .cardActions{
        display:flex;
        gap:4px;
        flex-shrink:0;
    }
    .tinyBtn{
        background:#0000;
        border:1px solid var(--bg-panel-border);
        border-radius:4px;
        padding:0 4px;
        font-size:11px;
        line-height:1.4;
        color:var(--text-dim);
        cursor:pointer;
        min-width:18px;
        height:18px;
        display:flex;
        align-items:center;
        justify-content:center;
    }
    .tinyBtn:hover{
        background:#2a3038;
        color:var(--text-main);
    }

    .cardBody{
        color:var(--text-dim);
        font-size:11px;
        line-height:1.4;
        display:flex;
        flex-wrap:wrap;
        gap:4px 8px;
    }
    .pill{
        background:#2a3038;
        border-radius:999px;
        padding:2px 6px;
        font-size:11px;
        color:#fff;
        line-height:1.3;
    }

    footer{
        font-size:11px;
        color:var(--text-dim);
        padding:8px 12px;
        border-top:1px solid var(--bg-panel-border);
        background:#0f1114;
    }

    /* Dialog Overlay */
    dialog{
        background:#1e2227;
        color:var(--text-main);
        border:1px solid var(--bg-panel-border);
        border-radius:var(--radius-lg);
        max-width:400px;
        width:90vw;
        box-shadow:0 30px 80px rgba(0,0,0,.9);
    }
    dialog::backdrop{
        background:rgba(0,0,0,.6);
    }
    .dlg-head{
        padding:16px;
        border-bottom:1px solid var(--bg-panel-border);
        font-weight:600;
        font-size:14px;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
    }
    .dlg-body{
        padding:16px;
        display:flex;
        flex-direction:column;
        gap:12px;
        max-height:50vh;
        overflow:auto;
    }
    .dlg-foot{
        padding:16px;
        border-top:1px solid var(--bg-panel-border);
        display:flex;
        justify-content:flex-end;
        gap:8px;
        flex-wrap:wrap;
    }

    .formRow{
        display:flex;
        flex-direction:column;
        gap:4px;
        font-size:13px;
    }
    .formRow label{
        color:var(--text-dim);
        font-size:12px;
        font-weight:500;
    }
    .multiLine{
        min-height:48px;
        resize:vertical;
        background:#0f1114;
        border:1px solid var(--bg-panel-border);
        color:var(--text-main);
        border-radius:var(--radius-sm);
        font-size:13px;
        line-height:1.4;
        padding:6px 8px;
    }

    .rowSplit2{
        display:flex;
        flex-wrap:wrap;
        gap:12px;
    }
    .rowSplit2 .formRow{
        flex:1 1 120px;
    }

    .chipsArea{
        display:flex;
        flex-wrap:wrap;
        gap:6px;
    }
    .chipToggle{
        border:1px solid var(--bg-panel-border);
        background:#2a3038;
        color:#fff;
        border-radius:999px;
        padding:4px 8px;
        font-size:12px;
        cursor:pointer;
        line-height:1.2;
    }
    .chipToggle.off{
        background:#0f1114;
        color:var(--text-dim);
    }

    /* Auto-reload text */
    .dimNote{
        font-size:11px;
        color:var(--text-dim);
        font-style:italic;
    }

    @media (max-width:800px){
        header{
            flex-direction:column;
            align-items:flex-start;
        }
        .boardOuter{
            padding:8px;
        }
        .boardGrid{
            grid-template-columns:repeat(var(--cols,3),minmax(200px,1fr));
            gap:8px;
        }
    }
</style>
</head>
<body>

<header>
    <div class="group">
        <div class="statusWrap">
            <span class="statusDot" id="cloudDot"></span>
            <span id="cloudText">verbunden</span>
        </div>

        <div class="group">
            <label class="small">
                Ansicht:
                <select id="viewSel">
                    <option value="4w">4 Wochen (Mo–Fr)</option>
                    <option value="6w">6 Wochen</option>
                    <option value="3m">3 Monate</option>
                </select>
            </label>

            <label class="small">
                Start:
                <input id="startDate" type="date"/>
            </label>

            <button class="btn" id="btnReload">Neu laden</button>
        </div>

        <div class="group">
            <button class="btn" id="btnStatus">Urlaub/Krank/Schule</button>
            <div class="toggleRow">
                <input type="checkbox" id="autoReloadChk"/>
                <label for="autoReloadChk">Auto-Reload</label>
            </div>
            <button class="btn" id="btnMasterData">Stammdaten</button>
            <button class="btn primary" id="btnNewEntry">+ Eintrag</button>
        </div>
    </div>
</header>

<div class="boardOuter">
    <div id="board" class="boardGrid" style="--cols:5;">
        <!-- Spalten/Tage werden hier via JS reingebaut -->
    </div>
</div>

<footer>
    Status rot = Urlaub/Krank/Schule
</footer>

<!-- Dialog: Neuer/ Bearbeiten Eintrag -->
<dialog id="entryDlg">
    <div class="dlg-head">
        <div id="dlgEntryTitle">Eintrag</div>
        <button class="btn tinyBtn danger" id="btnDeleteEntry" title="Löschen">X</button>
    </div>
    <div class="dlg-body">
        <div class="formRow">
            <label for="fTitle">Titel / Projekt</label>
            <input id="fTitle" type="text" placeholder="z. B. 'Dollinger und Schneider PV Anlage'"/>
        </div>

        <div class="formRow">
            <label for="fNote">Beschreibung / Notiz</label>
            <textarea id="fNote" class="multiLine" placeholder="z. B. 'Mercedes Bus'"></textarea>
        </div>

        <div class="rowSplit2">
            <div class="formRow">
                <label>Mitarbeiter</label>
                <div id="empChips" class="chipsArea">
                    <!-- Dynamisch Chips -->
                </div>
                <div class="dimNote">Klick zum Auswählen/Abwählen</div>
            </div>

            <div class="formRow">
                <label>Fahrzeug / Gerät</label>
                <div id="vehChips" class="chipsArea">
                    <!-- Dynamisch Chips -->
                </div>
            </div>
        </div>

        <div class="rowSplit2">
            <div class="formRow">
                <label>Status / Farbe</label>
                <div id="statusChips" class="chipsArea">
                    <!-- Dynamisch Chips, z. B. Rot = Urlaub -->
                </div>
            </div>

            <div class="formRow">
                <label for="fDayTarget">Tag / Spalte</label>
                <select id="fDayTarget"></select>
            </div>
        </div>

        <input type="hidden" id="fDocId" />
    </div>
    <div class="dlg-foot">
        <button class="btn ghost" id="btnEntryCancel">Abbrechen</button>
        <button class="btn primary" id="btnEntrySave">Speichern</button>
    </div>
</dialog>

<!-- Dialog: Stammdaten (Mitarbeiter, Fahrzeuge, Statusfarben) -->
<dialog id="masterDlg">
    <div class="dlg-head">
        <div>Stammdaten</div>
        <button class="btn tinyBtn" id="btnMasterClose">✕</button>
    </div>
    <div class="dlg-body">
        <div class="formRow">
            <label>Mitarbeiter</label>
            <textarea id="mEmployees" class="multiLine"
                placeholder="Ein Name pro Zeile&#10;z. B. Herbert&#10;Patrick"></textarea>
        </div>

        <div class="formRow">
            <label>Fahrzeuge / Geräte</label>
            <textarea id="mVehicles" class="multiLine"
                placeholder="Ein Eintrag pro Zeile&#10;z. B. Mercedes Bus&#10;Kran LKW"></textarea>
        </div>

        <div class="formRow">
            <label>Status / Farben</label>
            <textarea id="mStatuses" class="multiLine"
                placeholder="Format: Name|Farbe&#10;z. B. Urlaub/Krank/Schule|red&#10;Normaler Einsatz|blue"></textarea>
            <div class="dimNote">
                Farbe darf sein: red, green, blue (wird als farbige Plakette angezeigt)
            </div>
        </div>
        <div class="dimNote">
            Diese Stammdaten gelten für alle Geräte. Änderungen hier wirken global.
        </div>
    </div>
    <div class="dlg-foot">
        <button class="btn ghost" id="btnMasterCancel">Abbrechen</button>
        <button class="btn primary" id="btnMasterSave">Speichern</button>
    </div>
</dialog>

<!-- Firebase / App-Logik -->
<script type="module">
/* -------------------------------------------------------------------------------------------------
   1. Firebase INITIALISIEREN (ohne AppCheck, ohne heartbeat)
--------------------------------------------------------------------------------------------------*/

// Firebase SDK (stabile Version ohne Cache-Tricks)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
    getFirestore,
    collection,
    doc,
    addDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    getDoc,
    getDocs,
    onSnapshot,
    query,
    where,
    orderBy,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// <-- deine echte Konfiguration (aus Firebase Console, die du mir gezeigt hast)
const firebaseConfig = {
    apiKey: "AIzaSyDpwF-XnO23Bx-ebCV6g642D7xm9f45xDT",
    authDomain: "plantafelfreyllich100.firebaseapp.com",
    projectId: "plantafelfreyllich100",
    storageBucket: "plantafelfreyllich100.appspot.com",
    messagingSenderId: "96295913315",
    appId: "1:96295913315:web:e4462794478f15c0ef914da",
    measurementId: "G-W5GVSSLTRC"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);

// Status-Anzeige oben
const cloudDot  = document.getElementById("cloudDot");
const cloudText = document.getElementById("cloudText");
function setOnlineState(ok){
    if(ok){
        cloudDot.classList.remove("off");
        cloudText.textContent="verbunden";
    }else{
        cloudDot.classList.add("off");
        cloudText.textContent="offline";
    }
}
setOnlineState(true); // wir probieren optimistisch connected zu zeigen

/* -------------------------------------------------------------------------------------------------
   2. STATE IM BROWSER
--------------------------------------------------------------------------------------------------*/

// wir halten Stammdaten hier live
let employees = []; // ["Herbert","Patrick",...]
let vehicles  = []; // ["Mercedes Bus","Kran",...]
let statuses  = []; // [{label:"Urlaub/Krank/Schule",color:"red"}, ...]

// Board-Daten
// job = { id, title, note, emps[], vehs[], statusLabel,statusColor, dayKey, ts }
let jobs = [];

// welche Ansicht?
const viewSel      = document.getElementById("viewSel");
const startDateInp = document.getElementById("startDate");
// AutoReload
const autoReloadChk = document.getElementById("autoReloadChk");

// Mapping der Ansicht -> wie viele Tage (ungefähr)
const VIEW_MODES = {
    "4w": 20,   // 4 Wochen Mo-Fr (4*5=20)
    "6w": 30,   // 6 Wochen ~30 Arbeitstage
    "3m": 60    // 3 Monate grob ~60 Arbeitstage
};

// Helper: Datum normalisieren auf 00:00
function startOfDay(d){
    const x=new Date(d);
    x.setHours(0,0,0,0);
    return x;
}

// wir bauen uns eine Liste Tage (Spalten) ab Start
function buildDayRange(){
    const mode = viewSel.value;
    const count = VIEW_MODES[mode] ?? 20;

    let start = startDateInp.value
        ? new Date(startDateInp.value+"T00:00")
        : new Date();

    // Bei "4w" machen wir Montag als Start
    if(mode==="4w"){
        const day = start.getDay(); // So=0, Mo=1 ...
        const diffToMon = (day===0?6:day-1);
        start = new Date(start.getTime()-diffToMon*86400000);
    }

    const result=[];
    for(let i=0;i<count;i++){
        const d=new Date(start.getTime()+i*86400000);
        // Nur Mo-Fr in 4w Modus?
        if(mode==="4w"){
            const dow=d.getDay();
            if(dow===0 || dow===6){
                continue;
            }
        }
        result.push(d);
    }
    return result;
}

// Key für einen Tag, zB "2025-10-30"
function dayKeyFromDate(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
}

// KW berechnen (kalenderwoche, grob ISO)
function getKW(d){
    const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = tmp.getUTCDay() || 7;
    tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
    return weekNo;
}

// Deutschen Wochentag kurz
const WD = ["So","Mo","Di","Mi","Do","Fr","Sa"];

/* -------------------------------------------------------------------------------------------------
   3. FIRESTORE-LAYER
--------------------------------------------------------------------------------------------------*/

// Collections:
// - "plantafel" (Einträge)
// - "settings"  (Stammdaten)

async function loadSettingsOnce(){
    try{
        const snap = await getDocs(collection(db,"settings"));
        const emps=[], vehs=[], stats=[];
        snap.forEach(docSnap=>{
            const data=docSnap.data();
            if(data.type==="employees" && Array.isArray(data.items)){
                emps.push(...data.items);
            }
            if(data.type==="vehicles" && Array.isArray(data.items)){
                vehs.push(...data.items);
            }
            if(data.type==="statuses" && Array.isArray(data.items)){
                stats.push(...data.items);
            }
        });
        employees = emps;
        vehicles  = vehs;
        statuses  = stats;
    }catch(e){
        console.error("loadSettingsOnce:", e);
        setOnlineState(false);
    }
}

async function saveSettings(){
    // wir speichern in 3 docs:
    // settings/employees, settings/vehicles, settings/statuses
    try{
        await setDoc(doc(db,"settings","employees"),{
            type:"employees",
            items: employees
        });
        await setDoc(doc(db,"settings","vehicles"),{
            type:"vehicles",
            items: vehicles
        });
        await setDoc(doc(db,"settings","statuses"),{
            type:"statuses",
            items: statuses
        });
        setOnlineState(true);
    }catch(e){
        console.error("saveSettings:", e);
        setOnlineState(false);
    }
}

async function createOrUpdateJob(job){
    // wenn job.id vorhanden -> update, sonst add
    const payload={
        title: job.title||"",
        note: job.note||"",
        emps: Array.isArray(job.emps)?job.emps:[],
        vehs: Array.isArray(job.vehs)?job.vehs:[],
        statusLabel: job.statusLabel||"",
        statusColor: job.statusColor||"",
        dayKey: job.dayKey||"",
        ts: serverTimestamp()
    };

    try{
        if(job.id){
            await updateDoc(doc(db,"plantafel",job.id),payload);
        }else{
            const ref=await addDoc(collection(db,"plantafel"),payload);
            job.id=ref.id;
        }
        setOnlineState(true);
    }catch(e){
        console.error("createOrUpdateJob:",e);
        setOnlineState(false);
    }
}

async function deleteJob(id){
    try{
        await deleteDoc(doc(db,"plantafel",id));
        setOnlineState(true);
    }catch(e){
        console.error("deleteJob:", e);
        setOnlineState(false);
    }
}

// Live-Listener auf plantafel
function subscribeJobs(){
    // einfache Sortierung nach ts
    const qJobs = query(collection(db,"plantafel"), orderBy("ts","asc"));
    onSnapshot(qJobs,(snap)=>{
        const arr=[];
        snap.forEach(docSnap=>{
            const d=docSnap.data();
            arr.push({
                id:docSnap.id,
                title:d.title||"",
                note:d.note||"",
                emps:Array.isArray(d.emps)?d.emps:[],
                vehs:Array.isArray(d.vehs)?d.vehs:[],
                statusLabel:d.statusLabel||"",
                statusColor:d.statusColor||"",
                dayKey:d.dayKey||"",
                ts:d.ts||null
            });
        });
        jobs=arr;
        renderBoard();
    },(err)=>{
        console.error("onSnapshot plantafel:",err);
        setOnlineState(false);
    });
}

/* -------------------------------------------------------------------------------------------------
   4. RENDER BOARD
--------------------------------------------------------------------------------------------------*/

const boardEl = document.getElementById("board");
const fDayTarget = document.getElementById("fDayTarget");

// Drag & Drop globals
let dragJobId=null;

function renderBoard(){
    const days = buildDayRange();

    // dayKey Liste für Dialog-Auswahl
    fDayTarget.innerHTML="";
    days.forEach(d=>{
        const dk=dayKeyFromDate(d);
        const opt=document.createElement("option");
        opt.value=dk;
        const txt=`KW ${getKW(d)} ${WD[d.getDay()]} ${d.toLocaleDateString("de-DE")}`;
        opt.textContent=txt;
        fDayTarget.appendChild(opt);
    });

    // CSS Spaltenanzahl
    boardEl.style.setProperty("--cols",Math.max(days.length,1));

    // board leeren
    boardEl.innerHTML="";

    // Für jede Spalte Box bauen
    for(const day of days){
        const dk   = dayKeyFromDate(day);
        const kw   = getKW(day);
        const wd   = WD[day.getDay()];
        const dateStr = day.toLocaleDateString("de-DE");

        const colDiv=document.createElement("div");
        colDiv.className="dayCol";
        colDiv.dataset.dayKey=dk;

        const header=document.createElement("div");
        header.className="dayHeader";

        const left=document.createElement("div");
        left.className="left";
        const kwLine=document.createElement("div");
        kwLine.className="kw";
        kwLine.textContent=`KW ${kw} ${wd}`;
        const dLine=document.createElement("div");
        dLine.className="dateLine";
        dLine.textContent=dateStr;
        left.appendChild(kwLine);
        left.appendChild(dLine);

        const right=document.createElement("div");
        right.style.fontSize="11px";
        right.style.color="var(--text-dim)";
        right.textContent=dk;

        header.appendChild(left);
        header.appendChild(right);

        const list=document.createElement("div");
        list.className="cardList";
        list.dataset.dayKey=dk;

        // Einträge, die zu diesem Tag gehören
        const dayJobs=jobs.filter(j=>j.dayKey===dk);

        if(dayJobs.length===0){
            const hint=document.createElement("div");
            hint.className="dropHint";
            hint.textContent="Klicken zum Eintragen · Drag & Drop möglich";
            list.appendChild(hint);
        }else{
            dayJobs.forEach(job=>{
                const card=buildJobCard(job);
                list.appendChild(card);
            });
        }

        // Klick in leeren Bereich -> neuen Eintrag erstellen
        list.addEventListener("dblclick",(ev)=>{
            if(ev.target===list || ev.target.classList.contains("dropHint")){
                openEntryDialogForNew(dk);
            }
        });

        // Drag & Drop Support
        list.addEventListener("dragover",ev=>{
            ev.preventDefault();
        });
        list.addEventListener("drop",ev=>{
            ev.preventDefault();
            if(!dragJobId)return;
            moveJobToDay(dragJobId,dk);
            dragJobId=null;
        });

        colDiv.appendChild(header);
        colDiv.appendChild(list);
        boardEl.appendChild(colDiv);
    }
}

function buildJobCard(job){
    const card=document.createElement("div");
    card.className="jobCard";
    card.setAttribute("draggable","true");
    card.dataset.jobId=job.id;

    card.addEventListener("dragstart",()=>{
        dragJobId=job.id;
        card.classList.add("dragging");
    });
    card.addEventListener("dragend",()=>{
        card.classList.remove("dragging");
    });

    // Header
    const top=document.createElement("div");
    top.className="cardHeaderRow";

    const titleWrap=document.createElement("div");
    titleWrap.className="titleWrap";

    const titleSpan=document.createElement("span");
    titleSpan.textContent=job.title||"(ohne Titel)";
    titleWrap.appendChild(titleSpan);

    if(job.statusLabel){
        const st=document.createElement("span");
        st.className="badgeStatus";
        if(job.statusColor==="red") st.classList.add("red");
        if(job.statusColor==="green") st.classList.add("green");
        if(job.statusColor==="blue") st.classList.add("blue");
        st.textContent=job.statusLabel;
        titleWrap.appendChild(st);
    }

    const actDiv=document.createElement("div");
    actDiv.className="cardActions";

    const btnEdit=document.createElement("button");
    btnEdit.className="tinyBtn";
    btnEdit.textContent="✎";
    btnEdit.title="Bearbeiten";
    btnEdit.addEventListener("click",()=>{
        openEntryDialogForEdit(job.id);
    });

    const btnDup=document.createElement("button");
    btnDup.className="tinyBtn";
    btnDup.textContent="⧉";
    btnDup.title="Duplizieren";
    btnDup.addEventListener("click",()=>{
        duplicateJob(job.id);
    });

    const btnDel=document.createElement("button");
    btnDel.className="tinyBtn";
    btnDel.textContent="X";
    btnDel.title="Löschen";
    btnDel.addEventListener("click",()=>{
        if(confirm("Diesen Eintrag wirklich löschen?")){
            deleteJob(job.id);
        }
    });

    actDiv.appendChild(btnEdit);
    actDiv.appendChild(btnDup);
    actDiv.appendChild(btnDel);

    top.appendChild(titleWrap);
    top.appendChild(actDiv);

    // Body
    const body=document.createElement("div");
    body.className="cardBody";

    if(job.note){
        const n=document.createElement("div");
        n.className="pill";
        n.textContent=job.note;
        body.appendChild(n);
    }
    if(job.emps && job.emps.length){
        const e=document.createElement("div");
        e.className="pill";
        e.textContent=job.emps.join(", ");
        body.appendChild(e);
    }
    if(job.vehs && job.vehs.length){
        const v=document.createElement("div");
        v.className="pill";
        v.textContent=job.vehs.join(", ");
        body.appendChild(v);
    }

    card.appendChild(top);
    card.appendChild(body);

    // Doppelklick ganze Karte -> bearbeiten
    card.addEventListener("dblclick",()=>{
        openEntryDialogForEdit(job.id);
    });

    return card;
}

async function moveJobToDay(jobId,newDayKey){
    const j = jobs.find(x=>x.id===jobId);
    if(!j)return;
    j.dayKey=newDayKey;
    await createOrUpdateJob(j);
}

/* -------------------------------------------------------------------------------------------------
   5. DIALOG: EINTRAG
--------------------------------------------------------------------------------------------------*/

const entryDlg        = document.getElementById("entryDlg");
const btnEntryCancel  = document.getElementById("btnEntryCancel");
const btnEntrySave    = document.getElementById("btnEntrySave");
const btnDeleteEntry  = document.getElementById("btnDeleteEntry");

const fDocId   = document.getElementById("fDocId");
const fTitle   = document.getElementById("fTitle");
const fNote    = document.getElementById("fNote");

const empChips = document.getElementById("empChips");
const vehChips = document.getElementById("vehChips");
const statusChips = document.getElementById("statusChips");

function renderChipList(container,items,selectedArr){
    container.innerHTML="";
    items.forEach(val=>{
        let label,valColor;
        if(typeof val==="string"){
            label=val;
            valColor=null;
        }else{
            // status {label,color}
            label=val.label;
            valColor=val.color;
        }

        const chip=document.createElement("div");
        chip.className="chipToggle";

        if(valColor){
            // farbige status chips
            if(valColor==="red") chip.style.background="#8a1f1f";
            if(valColor==="green") chip.style.background="#1f8a34";
            if(valColor==="blue") chip.style.background="#1f3f8a";
        }

        const active = selectedArr.includes(label);
        if(!active) chip.classList.add("off");

        chip.textContent=label;
        chip.addEventListener("click",()=>{
            if(chip.classList.contains("off")){
                chip.classList.remove("off");
            }else{
                chip.classList.add("off");
            }
        });
        container.appendChild(chip);
    });
}

function getSelectedFrom(container){
    const out=[];
    [...container.children].forEach(ch=>{
        if(!ch.classList.contains("off")){
            out.push(ch.textContent.trim());
        }
    });
    return out;
}

// bei Status erlauben wir nur EINEN aktiv
function renderStatusChips(selectedLabel){
    statusChips.innerHTML="";
    statuses.forEach(st=>{
        const chip=document.createElement("div");
        chip.className="chipToggle";
        // farbstil
        if(st.color==="red") chip.style.background="#8a1f1f";
        if(st.color==="green") chip.style.background="#1f8a34";
        if(st.color==="blue") chip.style.background="#1f3f8a";

        if(st.label!==selectedLabel){
            chip.classList.add("off");
        }

        chip.textContent=st.label;
        chip.addEventListener("click",()=>{
            // single select
            [...statusChips.children].forEach(o=>o.classList.add("off"));
            chip.classList.remove("off");
        });
        statusChips.appendChild(chip);
    });
}
function getSelectedStatus(){
    let chosen=null;
    [...statusChips.children].forEach(ch=>{
        if(!ch.classList.contains("off")){
            chosen=ch.textContent.trim();
        }
    });
    if(!chosen) return {label:"",color:""};
    const stObj = statuses.find(s=>s.label===chosen);
    if(!stObj) return {label:chosen,color:""};
    return {label:stObj.label,color:stObj.color||""};
}

function openEntryDialogForNew(dayKey){
    fDocId.value="";
    fTitle.value="";
    fNote.value="";

    // Mitarbeiter/Fahrzeuge Chips leer (alle off)
    renderChipList(empChips, employees, []);
    renderChipList(vehChips, vehicles, []);
    renderStatusChips("");

    // Ziel-Tag auswählen
    fDayTarget.value=dayKey || "";

    entryDlg.showModal();
}

function openEntryDialogForEdit(jobId){
    const job = jobs.find(j=>j.id===jobId);
    if(!job)return;

    fDocId.value=job.id;
    fTitle.value=job.title||"";
    fNote.value=job.note||"";

    renderChipList(empChips, employees, job.emps||[]);
    renderChipList(vehChips, vehicles, job.vehs||[]);
    renderStatusChips(job.statusLabel||"");

    fDayTarget.value=job.dayKey||"";

    entryDlg.showModal();
}

btnEntryCancel.addEventListener("click",()=>{
    entryDlg.close();
});

btnDeleteEntry.addEventListener("click",async()=>{
    const id = fDocId.value;
    if(id){
        if(confirm("Wirklich löschen?")){
            await deleteJob(id);
            entryDlg.close();
        }
    }else{
        // neuer Eintrag, noch nicht gespeichert -> einfach schließen
        entryDlg.close();
    }
});

btnEntrySave.addEventListener("click",async()=>{
    const id = fDocId.value || null;

    const selEmps = getSelectedFrom(empChips);
    const selVehs = getSelectedFrom(vehChips);
    const stObj   = getSelectedStatus();

    const rec = {
        id,
        title: fTitle.value.trim(),
        note:  fNote.value.trim(),
        emps:  selEmps,
        vehs:  selVehs,
        statusLabel: stObj.label,
        statusColor: stObj.color,
        dayKey: fDayTarget.value
    };

    await createOrUpdateJob(rec);
    entryDlg.close();
});

/* -------------------------------------------------------------------------------------------------
   6. DIALOG: STAMMDATEN
--------------------------------------------------------------------------------------------------*/

const masterDlg     = document.getElementById("masterDlg");
const btnMasterData = document.getElementById("btnMasterData");
const btnMasterClose= document.getElementById("btnMasterClose");
const btnMasterCancel= document.getElementById("btnMasterCancel");
const btnMasterSave = document.getElementById("btnMasterSave");

const mEmployees = document.getElementById("mEmployees");
const mVehicles  = document.getElementById("mVehicles");
const mStatuses  = document.getElementById("mStatuses");

btnMasterData.addEventListener("click",()=>{
    // bestehende Stammdaten reinschreiben
    mEmployees.value = employees.join("\n");
    mVehicles.value  = vehicles.join("\n");
    mStatuses.value  = statuses.map(s=>`${s.label}|${s.color}`).join("\n");
    masterDlg.showModal();
});
btnMasterClose.addEventListener("click",()=> masterDlg.close());
btnMasterCancel.addEventListener("click",()=> masterDlg.close());

btnMasterSave.addEventListener("click",async()=>{
    const empLines = mEmployees.value.split("\n").map(v=>v.trim()).filter(Boolean);
    const vehLines = mVehicles.value.split("\n").map(v=>v.trim()).filter(Boolean);

    const statLines = mStatuses.value.split("\n").map(v=>v.trim()).filter(Boolean);
    const newStats=[];
    statLines.forEach(line=>{
        const [lbl,color] = line.split("|");
        if(lbl){
            newStats.push({
                label:lbl.trim(),
                color:(color||"").trim()
            });
        }
    });

    employees = empLines;
    vehicles  = vehLines;
    statuses  = newStats;

    await saveSettings();
    masterDlg.close();
});

/* -------------------------------------------------------------------------------------------------
   7. OBERE BUTTONS / AUTO-RELOAD
--------------------------------------------------------------------------------------------------*/

const btnReload     = document.getElementById("btnReload");
const btnNewEntry   = document.getElementById("btnNewEntry");

btnNewEntry.addEventListener("click",()=>{
    // Standard: erster Tag der aktuellen Ansicht
    const days = buildDayRange();
    const dk = days.length? dayKeyFromDate(days[0]):"";
    openEntryDialogForNew(dk);
});

btnReload.addEventListener("click",()=>{
    renderBoard(); // lokal neuzeichnen
});

viewSel.addEventListener("change",()=>{
    renderBoard();
});
startDateInp.addEventListener("change",()=>{
    renderBoard();
});

let autoReloadTimer=null;
function setupAutoReload(){
    if(autoReloadTimer){
        clearInterval(autoReloadTimer);
        autoReloadTimer=null;
    }
    if(autoReloadChk.checked){
        autoReloadTimer=setInterval(()=>{
            renderBoard(); // einfach nochmal zeichnen
        },5000); // alle 5s einfach neuzeichnen
    }
}
autoReloadChk.addEventListener("change",setupAutoReload);

/* -------------------------------------------------------------------------------------------------
   8. INIT FLOW
--------------------------------------------------------------------------------------------------*/

async function initApp(){
    // Startwert für Datum: heute
    const today=new Date();
    const y=today.getFullYear();
    const m=String(today.getMonth()+1).padStart(2,"0");
    const d=String(today.getDate()).padStart(2,"0");
    startDateInp.value=`${y}-${m}-${d}`;

    // Stammdaten laden
    await loadSettingsOnce();

    // Live Jobs hören
    subscribeJobs();

    // erstes Rendering (leer bis Daten kommen)
    renderBoard();

    setupAutoReload();
}

initApp();
</script>
</body>
</html>
