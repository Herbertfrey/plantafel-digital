<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plantafel Digital (Supabase)</title>
    <style>
      :root {
        --bg: #111820;
        --panel: #1b222c;
        --card: #202a36;
        --accent: #2f6dff;
        --accent-soft: rgba(47, 109, 255, 0.12);
        --danger: #d74b4b;
        --text: #ffffff;
        --muted: #9aa6b5;
        --radius: 10px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        background: var(--panel);
        padding: 10px 14px;
        display: flex;
        gap: 10px;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-right: 6px;
      }
      .green { background: #2ecc71; }
      .red { background: #e74c3c; }
      .inline {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      select,
      input[type="date"],
      button,
      textarea,
      input[type="text"] {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: inherit;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 14px;
      }
      button.primary {
        background: var(--accent);
        border-color: transparent;
        color: #fff;
        cursor: pointer;
      }
      button.danger {
        background: rgba(215, 75, 75, 0.15);
        border-color: rgba(215, 75, 75, 0.4);
        color: #fff;
      }
      main {
        flex: 1;
        overflow: auto;
        padding: 10px 14px 70px;
        display: flex;
        gap: 10px;
      }
      .board {
        display: flex;
        gap: 10px;
        min-width: max-content;
        width: max-content;
      }
      .day-col {
        width: 230px;
        background: rgba(255, 255, 255, 0.01);
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
      }
      .day-head {
        padding: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      .day-head small {
        color: var(--muted);
      }
      .cards {
        flex: 1;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 8px 8px 6px;
        cursor: grab;
      }
      .card h4 {
        margin: 0 0 4px;
        font-size: 14px;
      }
      .card small {
        display: block;
        color: var(--muted);
        font-size: 12px;
      }
      .card .row {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        margin-top: 4px;
      }
      .status-pill {
        background: rgba(47, 109, 255, 0.1);
        border: 1px solid rgba(47, 109, 255, 0.3);
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }
      .fab {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        border-radius: 999px;
        background: var(--accent);
        border: none;
        color: #fff;
        font-size: 28px;
        line-height: 48px;
        text-align: center;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(47, 109, 255, 0.25);
      }
      dialog {
        border: none;
        border-radius: 14px;
        background: #10151b;
        color: #fff;
        width: min(500px, 100vw - 20px);
      }
      .dlg-body {
        padding: 14px 16px 4px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .dlg-footer {
        padding: 12px 16px 14px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      label {
        font-size: 13px;
        color: #d6dbe1;
      }
      footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.35);
        padding: 4px 12px;
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 900px) {
        header {
          flex-wrap: wrap;
        }
        .day-col {
          width: 75vw;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="inline">
        <div id="onlineDot" class="dot red"></div>
        <strong id="onlineText">getrennt</strong>
      </div>

      <div class="inline">
        <span>Ansicht:</span>
        <select id="rangeSel">
          <option value="7">1 Woche</option>
          <option value="14">2 Wochen</option>
          <option value="28" selected>4 Wochen (Mo–Fr)</option>
        </select>
      </div>
      <div class="inline">
        <span>Start:</span>
        <input type="date" id="startDate" />
      </div>
      <button id="btnReload">Neu laden</button>
    </header>

    <main>
      <div id="board" class="board"></div>
    </main>

    <button class="fab" id="btnAdd">+</button>

    <!-- Dialog Eintrag -->
    <dialog id="entryDlg">
      <form method="dialog">
        <div class="dlg-body">
          <h3 id="dlgTitle">Eintrag</h3>
          <label>
            Datum
            <input type="date" id="fDate" required />
          </label>
          <label>
            Titel / Auftrag
            <input type="text" id="fTitle" placeholder="z.B. Baustelle X" required />
          </label>
          <label>
            Mitarbeiter
            <input type="text" id="fMitarbeiter" placeholder="Name, Name ..." />
          </label>
          <label>
            Fahrzeug
            <input type="text" id="fFahrzeug" placeholder="Bus / Sprinter / ..." />
          </label>
          <label>
            Status
            <input type="text" id="fStatus" placeholder="normal / Urlaub / Krank" />
          </label>
          <label>
            Notiz
            <textarea id="fNote" rows="2" placeholder="optional"></textarea>
          </label>
        </div>
        <div class="dlg-footer">
          <button value="cancel">Abbrechen</button>
          <button class="primary" id="btnSaveEntry" value="default">Speichern</button>
          <button class="danger" id="btnDelEntry" type="button" style="margin-left: auto; display: none;">Löschen</button>
        </div>
      </form>
    </dialog>

    <footer>
      Supabase Version – Tabelle: <code>plantafel</code>. Drag &amp; Drop = Datum ändern.
    </footer>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // === deine Supabase Daten ===
      const SUPABASE_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // HTML refs
      const boardEl = document.getElementById("board");
      const startDateEl = document.getElementById("startDate");
      const rangeSel = document.getElementById("rangeSel");
      const btnReload = document.getElementById("btnReload");
      const btnAdd = document.getElementById("btnAdd");
      const entryDlg = document.getElementById("entryDlg");
      const fDate = document.getElementById("fDate");
      const fTitle = document.getElementById("fTitle");
      const fMitarbeiter = document.getElementById("fMitarbeiter");
      const fFahrzeug = document.getElementById("fFahrzeug");
      const fStatus = document.getElementById("fStatus");
      const fNote = document.getElementById("fNote");
      const btnSaveEntry = document.getElementById("btnSaveEntry");
      const btnDelEntry = document.getElementById("btnDelEntry");
      const dlgTitle = document.getElementById("dlgTitle");
      const onlineDot = document.getElementById("onlineDot");
      const onlineText = document.getElementById("onlineText");

      let currentEntries = [];
      let editingId = null;

      // init date
      const todayIso = new Date().toISOString().slice(0, 10);
      startDateEl.value = todayIso;

      async function checkConn() {
        try {
          const { data, error } = await supabase.from("plantafel").select("id").limit(1);
          if (error) throw error;
          onlineDot.className = "dot green";
          onlineText.textContent = "verbunden";
        } catch (err) {
          console.warn(err);
          onlineDot.className = "dot red";
          onlineText.textContent = "getrennt";
        }
      }

      async function loadEntries() {
        const start = new Date(startDateEl.value);
        const days = parseInt(rangeSel.value, 10);

        const end = new Date(start);
        end.setDate(start.getDate() + days);

        // YYYY-MM-DD
        const startStr = start.toISOString().slice(0, 10);
        const endStr = end.toISOString().slice(0, 10);

        const { data, error } = await supabase
          .from("plantafel")
          .select("*")
          .gte("tag", startStr)
          .lte("tag", endStr)
          .order("tag", { ascending: true })
          .order("sort", { ascending: true });

        if (error) {
          console.error(error);
          return;
        }

        currentEntries = data;
        renderBoard();
      }

      function renderBoard() {
        boardEl.innerHTML = "";
        const start = new Date(startDateEl.value);
        const days = parseInt(rangeSel.value, 10);

        for (let i = 0; i < days; i++) {
          const d = new Date(start);
          d.setDate(start.getDate() + i);

          // wenn 4 Wochen (Mo–Fr) gewählt ist, Wochenenden überspringen
          if (rangeSel.value === "28") {
            const day = d.getDay();
            if (day === 0 || day === 6) {
              continue;
            }
          }

          const iso = d.toISOString().slice(0, 10);
          const col = document.createElement("div");
          col.className = "day-col";
          col.dataset.date = iso;

          const head = document.createElement("div");
          head.className = "day-head";
          head.innerHTML =
            "<strong>" +
            d.toLocaleDateString("de-DE", { weekday: "short" }) +
            "</strong> " +
            "<div>" +
            d.toLocaleDateString("de-DE") +
            "</div>";
          col.appendChild(head);

          const cards = document.createElement("div");
          cards.className = "cards";
          cards.ondragover = (ev) => ev.preventDefault();
          cards.ondrop = (ev) => handleDrop(ev, iso);
          col.appendChild(cards);

          const es = currentEntries.filter((e) => e.tag === iso);
          es.forEach((e) => {
            const card = makeCard(e);
            cards.appendChild(card);
          });

          boardEl.appendChild(col);
        }
      }

      function makeCard(e) {
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;
        card.dataset.id = e.id;
        card.ondragstart = (ev) => {
          ev.dataTransfer.setData("text/plain", e.id);
        };
        card.onclick = () => openEdit(e);

        card.innerHTML =
          "<h4>" +
          (e.titel || "(ohne Titel)") +
          "</h4>" +
          "<small>" +
          (e.mitarbeiter || "") +
          (e.fahrzeug ? " · " + e.fahrzeug : "") +
          "</small>" +
          (e.status
            ? '<div class="row"><span class="status-pill">' + e.status + "</span></div>"
            : "");

        return card;
      }

      async function handleDrop(ev, newDate) {
        ev.preventDefault();
        const id = ev.dataTransfer.getData("text/plain");
        if (!id) return;
        // update in supabase
        await supabase.from("plantafel").update({ tag: newDate }).eq("id", id);
        // lokal auch ändern
        const entry = currentEntries.find((x) => x.id === id);
        if (entry) {
          entry.tag = newDate;
        }
        renderBoard();
      }

      function openNew(dateIso) {
        editingId = null;
        dlgTitle.textContent = "Neuer Eintrag";
        fDate.value = dateIso || startDateEl.value;
        fTitle.value = "";
        fMitarbeiter.value = "";
        fFahrzeug.value = "";
        fStatus.value = "";
        fNote.value = "";
        btnDelEntry.style.display = "none";
        entryDlg.showModal();
      }

      function openEdit(e) {
        editingId = e.id;
        dlgTitle.textContent = "Eintrag bearbeiten";
        fDate.value = e.tag;
        fTitle.value = e.titel || "";
        fMitarbeiter.value = e.mitarbeiter || "";
        fFahrzeug.value = e.fahrzeug || "";
        fStatus.value = e.status || "";
        fNote.value = e.notiz || "";
        btnDelEntry.style.display = "inline-flex";
        entryDlg.showModal();
      }

      async function saveEntry(ev) {
        ev?.preventDefault?.();
        const payload = {
          tag: fDate.value,
          titel: fTitle.value,
          mitarbeiter: fMitarbeiter.value,
          fahrzeug: fFahrzeug.value,
          status: fStatus.value,
          notiz: fNote.value,
        };

        if (!payload.tag || !payload.titel) {
          alert("Datum und Titel sind Pflicht.");
          return;
        }

        if (editingId) {
          await supabase.from("plantafel").update(payload).eq("id", editingId);
        } else {
          await supabase.from("plantafel").insert(payload);
        }
        entryDlg.close();
        loadEntries();
      }

      async function deleteEntry() {
        if (!editingId) return;
        if (!confirm("Eintrag wirklich löschen?")) return;
        await supabase.from("plantafel").delete().eq("id", editingId);
        entryDlg.close();
        loadEntries();
      }

      // events
      btnReload.onclick = () => loadEntries();
      btnAdd.onclick = () => openNew();
      btnSaveEntry.onclick = saveEntry;
      btnDelEntry.onclick = deleteEntry;
      startDateEl.onchange = () => loadEntries();
      rangeSel.onchange = () => loadEntries();

      // realtime
      supabase
        .channel("public:plantafel")
        .on(
          "postgres_changes",
          { event: "*", schema: "public", table: "plantafel" },
          (payload) => {
            // einfach neu laden
            loadEntries();
          }
        )
        .subscribe();

      // init
      (async function () {
        await checkConn();
        await loadEntries();
      })();
    </script>
  </body>
</html>
