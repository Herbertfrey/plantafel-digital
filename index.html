<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantafel Dachdeckerei Frey</title>
  <style>
    :root {
      --bg: #f7f8fa;
      --card: #fff;
      --accent: #1e3a8a;
      --text: #111;
      --muted: #666;
      --danger: #ef4444;
      --ok: #10b981;
      font-family: system-ui, Arial, sans-serif;
    }
    body {
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: var(--accent);
      color: white;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 20px; margin: 0; }
    nav button {
      background: white;
      color: var(--accent);
      border: none;
      margin-left: 6px;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
    }
    #board {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-auto-rows: 140px;
      gap: 8px;
      padding: 12px;
      overflow-y: auto;
    }
    .day {
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 6px;
    }
    .day h3 {
      font-size: 14px;
      margin: 0 0 4px 0;
      color: var(--accent);
    }
    .entry {
      background: #e0e7ff;
      border-radius: 6px;
      margin: 2px 0;
      padding: 4px 6px;
      cursor: grab;
      font-size: 13px;
    }
    .entry[data-status="Krank"],
    .entry[data-status="Urlaub"],
    .entry[data-status="Schule"] {
      background: var(--danger);
      color: #fff;
    }
    .entry.dragging { opacity: 0.6; }
    footer {
      background: var(--card);
      text-align: center;
      padding: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    dialog {
      border: none;
      border-radius: 8px;
      padding: 20px;
      width: 300px;
    }
    dialog label { display:block; margin-top:8px; }
    dialog input, dialog select {
      width: 100%; padding: 4px; margin-top:2px;
    }
    dialog button {
      margin-top:10px; padding:6px 10px; border:none; border-radius:5px;
      background: var(--accent); color:white; cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Digitale Plantafel â€“ Dachdeckerei Frey</h1>
    <nav>
      <button id="view14">14 Tage</button>
      <button id="view4w">4 Wochen</button>
      <button id="view12m">12 Monate</button>
      <button id="add">+ Eintrag</button>
      <button id="stammdaten">Stammdaten</button>
    </nav>
  </header>

  <main id="board"></main>
  <footer>Â© 2025 Dachdeckerei Frey</footer>

  <!-- Dialog neues Projekt -->
  <dialog id="dlg">
    <form id="frm">
      <h3>Neuer Eintrag</h3>
      <label>Baustelle
        <input id="baustelle" required />
      </label>
      <label>Von (bis optional)
        <input type="date" id="von" required />
        <input type="date" id="bis" />
      </label>
      <label>Mitarbeiter (Mehrfachwahl mit Strg)
        <select id="mitarbeiter" multiple></select>
      </label>
      <label>Fahrzeuge (Mehrfachwahl mit Strg)
        <select id="fahrzeuge" multiple></select>
      </label>
      <label>Status
        <select id="status">
          <option value="">â€“ â€“ â€“</option>
          <option value="Krank">Krank</option>
          <option value="Urlaub">Urlaub</option>
          <option value="Schule">Schule</option>
        </select>
      </label>
      <button type="submit">Speichern</button>
    </form>
  </dialog>
  <script>
    // ====== BASIS-DATEN (werden in Block 3 aus Supabase geladen) ======
    let STAMM_MITARBEITER = [];   // z.B. ["Sepp", "Hans"]
    let STAMM_FAHRZEUGE = [];     // z.B. ["Bus 1", "Kran"]
    let EINTRAEGE = [];           // wird angezeigt

    // aktuelle Ansicht
    let currentView = "14"; // "14" | "4w" | "12m"

    const boardEl = document.getElementById("board");
    const dlg = document.getElementById("dlg");
    const frm = document.getElementById("frm");
    const selMitarbeiter = document.getElementById("mitarbeiter");
    const selFahrzeuge = document.getElementById("fahrzeuge");
    const fldBaustelle = document.getElementById("baustelle");
    const fldVon = document.getElementById("von");
    const fldBis = document.getElementById("bis");
    const fldStatus = document.getElementById("status");

    // ========= HILFE =========
    function toISO(d) {
      return d.toISOString().slice(0,10);
    }
    function addDays(d, n) {
      const c = new Date(d);
      c.setDate(c.getDate() + n);
      return c;
    }
    function mondayOf(d) {
      const c = new Date(d);
      const day = c.getDay(); // So=0
      const diff = (day === 0 ? -6 : 1 - day);
      c.setDate(c.getDate() + diff);
      return c;
    }

    // ========= ANSICHT RENDERN =========
    function render() {
      boardEl.innerHTML = "";
      if (currentView === "12m") {
        render12Months();
      } else if (currentView === "4w") {
        renderWeeks(4);
      } else {
        renderWeeks(2); // 14 Tage
      }
    }

    // nur Moâ€“Fr-Spalten
    function renderWeeks(weeks) {
      boardEl.className = "board-grid view-4w";
      boardEl.innerHTML = "";
      const start = mondayOf(new Date());
      let dayCursor = start;
      for (let w = 0; w < weeks; w++) {
        for (let d = 0; d < 5; d++) { // Moâ€“Fr
          const iso = toISO(dayCursor);
          const dayDiv = document.createElement("div");
          dayDiv.className = "day";
          dayDiv.dataset.date = iso;
          dayDiv.ondragover = ev => ev.preventDefault();
          dayDiv.ondrop = onDropDay;
          const head = document.createElement("h3");
          head.textContent = dayCursor.toLocaleDateString("de-DE", { weekday: "short", day:"2-digit", month:"2-digit" });
          dayDiv.appendChild(head);

          // EintrÃ¤ge fÃ¼r diesen Tag
          EINTRAEGE.filter(e => e.tag === iso).forEach(e => {
            const card = renderEntryCard(e);
            dayDiv.appendChild(card);
          });

          boardEl.appendChild(dayDiv);
          dayCursor = addDays(dayCursor, 1);
        }
        // Wochenende Ã¼berspringen
        dayCursor = addDays(dayCursor, 2);
      }
    }

    function render12Months() {
      boardEl.className = "board-grid view-12m";
      boardEl.innerHTML = "";
      const now = new Date();
      const year = now.getFullYear();
      for (let m = 0; m < 12; m++) {
        const cell = document.createElement("div");
        cell.className = "day";
        const head = document.createElement("h3");
        head.textContent = new Date(year, m, 1).toLocaleDateString("de-DE", { month:"long", year:"numeric" });
        cell.appendChild(head);

        // alle EintrÃ¤ge aus diesem Monat
        EINTRAEGE.filter(e => {
          if (!e.tag) return false;
          const dt = new Date(e.tag);
          return dt.getFullYear() === year && dt.getMonth() === m;
        }).forEach(e => {
          const card = renderEntryCard(e);
          cell.appendChild(card);
        });

        boardEl.appendChild(cell);
      }
    }

    function renderEntryCard(e) {
      const div = document.createElement("div");
      div.className = "entry";
      div.draggable = true;
      div.dataset.id = e.id;
      div.textContent = e.baustelle || "(ohne Titel)";
      if (e.status) {
        div.dataset.status = e.status;
      }
      div.ondragstart = onDragStart;
      div.onclick = () => editEntry(e.id);
      return div;
    }

    // ========= DRAG & DROP =========
    let dragId = null;
    function onDragStart(ev) {
      dragId = ev.target.dataset.id;
    }
    function onDropDay(ev) {
      ev.preventDefault();
      const day = ev.currentTarget.dataset.date;
      if (!dragId) return;
      // Eintrag verschieben
      const idx = EINTRAEGE.findIndex(x => x.id == dragId);
      if (idx >= 0) {
        EINTRAEGE[idx].tag = day;
        saveEntryToStorage(EINTRAEGE[idx]); // in Block 3 ersetzen wir das mit Supabase
        render();
      }
      dragId = null;
    }

    // ========= DIALOG =========
    function openDialog(defaultDate) {
      fillStammdatenInDialog();
      fldBaustelle.value = "";
      fldVon.value = defaultDate || toISO(new Date());
      fldBis.value = "";
      fldStatus.value = "";
      dlg.showModal();
      frm.onsubmit = onDialogSubmit;
    }

    function editEntry(id) {
      const e = EINTRAEGE.find(x => x.id == id);
      if (!e) return;
      fillStammdatenInDialog();
      fldBaustelle.value = e.baustelle || "";
      fldVon.value = e.tag || toISO(new Date());
      fldBis.value = e.bis || "";
      fldStatus.value = e.status || "";
      // Mehrfachauswahl
      Array.from(selMitarbeiter.options).forEach(o => o.selected = e.mitarbeiter?.includes(o.value));
      Array.from(selFahrzeuge.options).forEach(o => o.selected = e.fahrzeuge?.includes(o.value));
      dlg.showModal();
      frm.onsubmit = (ev) => {
        ev.preventDefault();
        // aktualisieren
        e.baustelle = fldBaustelle.value;
        e.tag = fldVon.value;
        e.bis = fldBis.value;
        e.status = fldStatus.value;
        e.mitarbeiter = Array.from(selMitarbeiter.selectedOptions).map(o => o.value);
        e.fahrzeuge = Array.from(selFahrzeuge.selectedOptions).map(o => o.value);
        saveEntryToStorage(e);
        dlg.close();
        render();
      };
    }

    function onDialogSubmit(ev) {
      ev.preventDefault();
      const neu = {
        id: Date.now().toString(),
        baustelle: fldBaustelle.value,
        tag: fldVon.value,
        bis: fldBis.value,
        status: fldStatus.value,
        mitarbeiter: Array.from(selMitarbeiter.selectedOptions).map(o => o.value),
        fahrzeuge: Array.from(selFahrzeuge.selectedOptions).map(o => o.value),
      };
      EINTRAEGE.push(neu);
      saveEntryToStorage(neu);
      dlg.close();
      render();
    }

    function fillStammdatenInDialog() {
      selMitarbeiter.innerHTML = "";
      STAMM_MITARBEITER.forEach(n => {
        const o = document.createElement("option");
        o.value = o.textContent = n;
        selMitarbeiter.appendChild(o);
      });
      selFahrzeuge.innerHTML = "";
      STAMM_FAHRZEUGE.forEach(n => {
        const o = document.createElement("option");
        o.value = o.textContent = n;
        selFahrzeuge.appendChild(o);
      });
    }

    // ========= LOKAL SPEICHERN (Platzhalter) =========
    function saveEntryToStorage(e) {
      // hier kommt in Block 3 Supabase hin
      localStorage.setItem("plantafelEntries", JSON.stringify(EINTRAEGE));
    }
    function loadEntriesFromStorage() {
      const raw = localStorage.getItem("plantafelEntries");
      if (raw) {
        EINTRAEGE = JSON.parse(raw);
      } else {
        EINTRAEGE = [];
      }
    }

    // ========= EVENTS =========
    document.getElementById("view14").onclick = () => { currentView = "14"; render(); };
    document.getElementById("view4w").onclick  = () => { currentView = "4w"; render(); };
    document.getElementById("view12m").onclick = () => { currentView = "12m"; render(); };
    document.getElementById("add").onclick = () => openDialog();

    document.getElementById("stammdaten").onclick = () => {
      alert("Stammdaten kommen aus Supabase â€“ wird im nÃ¤chsten Block geladen.\nJetzt erst mal nur Testdaten.");
    };

    // ========= START =========
    (function init() {
      // Demo-Stammdaten â€“ werden in Block 3 von Supabase ersetzt
      STAMM_MITARBEITER = ["Herbert", "Max", "Sven", "Timo"];
      STAMM_FAHRZEUGE = ["Bus 1", "Bus 2", "Kran"];
      loadEntriesFromStorage();
      render();
    })();
  </script>
</body>
</html>
  <script>
    // ... alles aus Block 2 bleibt oben drÃ¼ber stehen ...

    // ===== Supabase: deine Daten =====
    const SUPA_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
    const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // ðŸ‘‰ ersetze die alten Speicherfunktionen jetzt durch Supabase:

    async function saveEntryToStorage(e) {
      // prÃ¼fen ob Eintrag schon existiert
      const { data: exists, error: err1 } = await supa
        .from("plantafel")
        .select("id")
        .eq("id", e.id)
        .maybeSingle();

      // Supabase kann keine Arrays direkt, daher als JSON-String
      const payload = {
        id: e.id,
        tag: e.tag,
        bis: e.bis || null,
        baustelle: e.baustelle || "",
        status: e.status || "",
        mitarbeiter: JSON.stringify(e.mitarbeiter || []),
        fahrzeuge: JSON.stringify(e.fahrzeuge || [])
      };

      if (exists) {
        await supa.from("plantafel").update(payload).eq("id", e.id);
      } else {
        await supa.from("plantafel").insert(payload);
      }
    }

    async function loadEntriesFromStorage() {
      EINTRAEGE = [];
      // EintrÃ¤ge holen
      const { data: rows, error } = await supa
        .from("plantafel")
        .select("*")
        .order("tag", { ascending: true });

      if (!error && rows) {
        EINTRAEGE = rows.map(r => ({
          id: r.id,
          tag: r.tag,
          bis: r.bis,
          baustelle: r.baustelle,
          status: r.status,
          mitarbeiter: r.mitarbeiter ? JSON.parse(r.mitarbeiter) : [],
          fahrzeuge: r.fahrzeuge ? JSON.parse(r.fahrzeuge) : []
        }));
      }

      // Stammdaten holen
      const { data: mit, error: e1 } = await supa.from("mitarbeiter").select("*").order("name");
      const { data: fah, error: e2 } = await supa.from("fahrzeuge").select("*").order("name");

      STAMM_MITARBEITER = (mit || []).map(x => x.name);
      STAMM_FAHRZEUGE = (fah || []).map(x => x.name);

      render();
    }

    // Stammdaten-Buttons aus Block 2 ersetzen:
    document.getElementById("stammdaten").onclick = async () => {
      const name = prompt("Neuer Mitarbeiter/Fahrzeug? 'm:Name' oder 'f:Name'");
      if (!name) return;
      if (name.startsWith("m:")) {
        await supa.from("mitarbeiter").insert({ name: name.substring(2).trim() });
      } else if (name.startsWith("f:")) {
        await supa.from("fahrzeuge").insert({ name: name.substring(2).trim() });
      }
      await loadEntriesFromStorage();
    };

    // beim Start nicht localStorage, sondern Supabase:
    (async function initSupabase() {
      await loadEntriesFromStorage();
    })();
  </script>
</body>
</html>
