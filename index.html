<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantafel Digital – Sync (Firebase, ohne AppCheck)</title>
  <style>
    :root{
      --bg:#0f141b; --bg2:#141a22; --panel:#1a2230; --text:#e9eef5;
      --muted:#9fb1c7; --accent:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --card:#10161f; --grid:#243347; --chip:#22324a;
    }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#0e131a,#0b1118 60%,#0a1016); color:var(--text)}
    .topbar{
      display:flex; gap:.5rem; align-items:center; padding:.75rem 1rem;
      position:sticky; top:0; background:rgba(10,16,22,.9); backdrop-filter:blur(8px);
      border-bottom:1px solid #223047; z-index:5
    }
    .title{font-weight:700; letter-spacing:.2px; margin-right:.5rem}
    .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    select,input,button{
      background:var(--panel); color:var(--text); border:1px solid #28364b;
      padding:.45rem .6rem; border-radius:.6rem; outline:none
    }
    button.primary{background:var(--accent); border-color:transparent}
    button.ghost{background:transparent; border-color:#2a3a50}
    .badge{display:inline-flex; align-items:center; gap:.4rem; background:#203047; color:#bcd1ea;
      border:1px solid #314765; border-radius:999px; padding:.25rem .6rem; font-size:.9rem}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    main{padding:1rem; max-width:1400px; margin:auto}
    .grid{
      display:grid; grid-template-columns: 120px repeat(5, 1fr); gap:10px;
      transform-origin:0 0;
    }
    .weekrow{display:contents}
    .cell, .weeklabel{
      background:var(--bg2); border:1px dashed #2a3b54; border-radius:.8rem; min-height:120px;
      padding:.5rem; position:relative; overflow:hidden
    }
    .weeklabel{
      grid-column:1; display:flex; align-items:center; justify-content:center; font-weight:700; color:#c7d7ec;
      min-height:120px; background:linear-gradient(180deg,#172234,#111827); border-style:solid
    }
    .dayhead{
      font-size:.85rem; color:var(--muted); position:absolute; top:.45rem; right:.6rem
    }
    .slot{margin-top:1.4rem; display:flex; flex-direction:column; gap:.5rem}
    .card{
      background:linear-gradient(180deg,#0f1621,#0b121a); border:1px solid #2b3c56; border-radius:.7rem;
      padding:.45rem .55rem; box-shadow:0 2px 10px rgba(0,0,0,.25)
    }
    .card .title{font-weight:700; font-size:.95rem}
    .chips{display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.3rem}
    .chip{background:var(--chip); border:1px solid #314765; border-radius:999px; padding:.15rem .5rem; font-size:.8rem}
    .actions{position:absolute; top:.35rem; left:.45rem; display:flex; gap:.3rem}
    .iconbtn{background:transparent; border:1px solid #2c3a50; color:#cfe1fb; padding:.1rem .35rem; border-radius:.5rem; font-size:.8rem; cursor:pointer}
    .foot{margin-top:1rem; opacity:.7; font-size:.85rem}

    dialog{border:none; border-radius:1rem; padding:0; width:min(680px, 95vw); background:#0f1621; color:var(--text)}
    .dlg-head{padding:1rem 1.2rem; border-bottom:1px solid #273955; font-weight:700}
    .dlg-body{padding:1rem 1.2rem; display:grid; gap:.75rem}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:.75rem}
    .fld{display:flex; flex-direction:column; gap:.3rem}
    .fld label{font-size:.9rem; color:#b7c8df}
    .chipsel{display:flex; flex-wrap:wrap; gap:.35rem}
    .chipsel .chip{cursor:pointer}
    .dlg-foot{display:flex; justify-content:flex-end; gap:.5rem; padding:1rem 1.2rem; border-top:1px solid #273955}
    .warn{color:#ffd19a}

    /* mobile */
    @media (max-width: 900px){
      .grid{grid-template-columns: 96px repeat(5, 1fr)}
      .grid2{grid-template-columns: 1fr}
      .cell,.weeklabel{min-height:90px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Plantafel</div>
    <div class="row">
      <label>Ansicht:</label>
      <select id="viewSel">
        <option value="4w">4 Wochen (Mo–Fr)</option>
        <option value="2w">14 Tage (Mo–Fr)</option>
        <option value="12m">12 Monate (Grob)</option>
      </select>
    </div>
    <div class="row">
      <label>Start:</label>
      <input id="startDate" type="date">
      <button id="btnReload" class="ghost">Neu laden</button>
    </div>

    <div class="row" style="margin-left:auto">
      <span class="badge"><span class="dot ok" id="cloudDot"></span> verbunden</span>
      <button id="btnMaster" class="ghost">Stammdaten</button>
      <button id="btnAdd" class="primary">+ Eintrag</button>
    </div>
  </div>

  <main>
    <div id="grid" class="grid" style="scale: 1"></div>
    <div class="foot">Status rot = Urlaub/Krank/Schule</div>

    <!-- Zoom -->
    <div style="position:fixed; right:14px; top:68px; background:#0f1621; border:1px solid #28364b; padding:.5rem .75rem; border-radius:.75rem;">
      <div style="font-size:.85rem; color:#b9cbe3; margin-bottom:.25rem;">Zoom</div>
      <input id="zoomRange" type="range" min="70" max="130" value="100" />
    </div>
  </main>

  <!-- Dialog: Eintrag -->
  <dialog id="entryDlg">
    <div class="dlg-head">Eintrag</div>
    <form method="dialog" class="dlg-body">
      <div class="grid2">
        <div class="fld">
          <label>Titel</label>
          <input id="fTitle" />
        </div>
        <div class="fld">
          <label>Status</label>
          <select id="fStatus">
            <option value="normal">Normal</option>
            <option value="urlaub">Urlaub</option>
            <option value="krank">Krank</option>
            <option value="schule">Schule</option>
          </select>
        </div>
        <div class="fld">
          <label>Datum</label>
          <input id="fDate" type="date" />
        </div>
        <div class="fld">
          <label>Dauer</label>
          <select id="fDuration">
            <option value="1">nur dieser Tag</option>
            <option value="3">3 Tage</option>
            <option value="5">1 Woche</option>
            <option value="10">2 Wochen</option>
          </select>
        </div>
      </div>

      <div class="fld">
        <label>Mitarbeiter (Mehrfach)</label>
        <div id="chipMitarbeiter" class="chipsel"></div>
      </div>

      <div class="fld">
        <label>Fahrzeuge (Mehrfach)</label>
        <div id="chipFahrzeuge" class="chipsel"></div>
      </div>

      <div class="warn" id="warnText" style="display:none">Hinweis: Urlaub/Krank/Schule wird rot dargestellt.</div>
    </form>
    <div class="dlg-foot">
      <button id="btnDel" class="ghost" style="margin-right:auto; display:none">Löschen</button>
      <button id="btnCancel" class="ghost">Abbrechen</button>
      <button id="btnSave" class="primary">Speichern</button>
    </div>
  </dialog>

  <!-- Dialog: Stammdaten -->
  <dialog id="masterDlg">
    <div class="dlg-head">Stammdaten</div>
    <div class="dlg-body">
      <div class="fld">
        <label>Mitarbeiter (Kommagetrennt)</label>
        <input id="mMitarbeiter" placeholder="z.B. Thomas, Patrick, Herbert, Artiom, Juppi" />
      </div>
      <div class="fld">
        <label>Fahrzeuge (Kommagetrennt)</label>
        <input id="mFahrzeuge" placeholder="z.B. Doka, Crafter, Mercedes Bus, Ford" />
      </div>
      <div class="fld">
        <label>Team-Notiz</label>
        <input id="mNote" placeholder="optional" />
      </div>
    </div>
    <div class="dlg-foot">
      <button id="btnMasterCancel" class="ghost">Abbrechen</button>
      <button id="btnMasterSave" class="primary">Speichern</button>
    </div>
  </dialog>

  <!-- Firebase + App (ohne AppCheck) -->
  <script type="module">
    // ---- Firebase SDK (Cache-Buster ?v=6) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js?v=6";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, getDoc, getDocs,
      onSnapshot, query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js?v=6";

    // ---- Deine Firebase-Konfiguration (aus der Konsole) ----
  
    const firebaseConfig = {
      apiKey: "AIzaSyDpWF-XnO23Bx-ebCvg6a42Drxm9f4SxDI",
      authDomain: "plantafelfreylich100.firebaseapp.com",
      projectId: "plantafelfreylich100",
      storageBucket: "plantafelfreylich100.firebasestorage.app",
      messagingSenderId: "96295193135",
      appId: "1:96295193135:web:e446279447815c0ef914da",
      measurementId: "G-W5VG5SLTRC"
    };
    
    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    window.__db = db; // zum Debuggen in der Konsole

    // ---------- Utility ----------
    const $ = sel => document.querySelector(sel);
    const gridEl = $("#grid");
    const viewSel = $("#viewSel");
    const startDate = $("#startDate");
    const zoomRange = $("#zoomRange");
    const cloudDot = $("#cloudDot");
    const btnReload = $("#btnReload");
    const btnAdd = $("#btnAdd");
    const btnMaster = $("#btnMaster");

    const entryDlg = $("#entryDlg");
    const fTitle = $("#fTitle");
    const fStatus = $("#fStatus");
    const fDate = $("#fDate");
    const fDuration = $("#fDuration");
    const chipMitarbeiter = $("#chipMitarbeiter");
    const chipFahrzeuge = $("#chipFahrzeuge");
    const btnSave = $("#btnSave");
    const btnCancel = $("#btnCancel");
    const btnDel = $("#btnDel");
    const warnText = $("#warnText");

    const masterDlg = $("#masterDlg");
    const mMitarbeiter = $("#mMitarbeiter");
    const mFahrzeuge = $("#mFahrzeuge");
    const mNote = $("#mNote");
    const btnMasterSave = $("#btnMasterSave");
    const btnMasterCancel = $("#btnMasterCancel");

    let master = {
      mitarbeiter: ["Thomas","Patrick","Herbert","Artiom","Juppi","Terry"],
      fahrzeuge: ["Doka","Crafter","Mercedes Bus","Ford","Mercedes Bus Doka"],
      note: ""
    };

    let curStart = mondayOf(new Date());
    let curSpanDays = 20; // 4 Wochen Mo–Fr
    let unsub = null;
    let editingId = null;
    let selectedMitarbeiter = new Set();
    let selectedFahrzeuge = new Set();

    function mondayOf(d){
      const x = new Date(d); const day = x.getDay() || 7; // 1..7 (Mo..So)
      if(day>1) x.setDate(x.getDate() - (day-1));
      x.setHours(0,0,0,0);
      return x;
    }
    function fmt(d){ return d.toISOString().slice(0,10); }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function inRange(dateStr, start, end){
      return dateStr >= fmt(start) && dateStr <= fmt(end);
    }

    // ---------- Stammdaten laden ----------
    async function loadMaster(){
      try{
        const ds = await getDoc(doc(collection(db,"settings"), "master"));
        if(ds.exists()){
          master = ds.data();
        }
      }catch(e){ /* ignore – erste Nutzung */ }
    }
    function renderChipList(container, values, selSet){
      container.innerHTML = "";
      values.forEach(v=>{
        const c = document.createElement("div");
        c.className = "chip";
        c.textContent = v;
        const active = selSet.has(v);
        if(active){ c.style.outline="2px solid var(--accent)"; c.style.background="#284268"; }
        c.onclick = ()=>{
          if(selSet.has(v)) selSet.delete(v); else selSet.add(v);
          renderChipList(container, values, selSet);
        };
        container.appendChild(c);
      });
    }

    // ---------- Grid rendern ----------
    function setView(v){
      if(v==="4w"){ curSpanDays = 20; }
      else if(v==="2w"){ curSpanDays = 10; }
      else { curSpanDays = 0; } // 12 Monate separat
      buildGrid();
      subscribe();
    }
    function buildGrid(){
      if(viewSel.value==="12m"){ renderMonths(); return; }
      gridEl.innerHTML="";
      // Kopfzeile unsichtbar – wir zeichnen pro Woche eine Zeile
      const weeks = Math.ceil(curSpanDays/5);
      for(let w=0; w<weeks; w++){
        const weekStart = addDays(curStart, w*7);
        const weekLabel = document.createElement("div");
        weekLabel.className = "weeklabel";
        const kw = getISOWeek(weekStart);
        const ws = fmt(weekStart); const we = fmt(addDays(weekStart,4));
        weekLabel.textContent = `KW ${kw}  ${ws} – ${we}`;
        gridEl.appendChild(weekLabel);
        for(let d=0; d<5; d++){
          const day = addDays(weekStart, d);
          const cell = document.createElement("div");
          cell.className="cell";
          cell.dataset.date = fmt(day);
          const head = document.createElement("div");
          head.className="dayhead";
          head.textContent = day.toLocaleDateString("de-DE",{weekday:"short", year:"numeric", month:"2-digit", day:"2-digit"});
          const slot = document.createElement("div");
          slot.className="slot";
          cell.appendChild(head);
          cell.appendChild(slot);
          cell.addEventListener("click",(e)=>{
            if(e.target.closest(".card")) return; // Klick auf Karte handled separat
            openEntryDialog({date: cell.dataset.date});
          });
          gridEl.appendChild(cell);
        }
      }
    }
    function renderMonths(){
      gridEl.innerHTML="";
      // 12 Monate – Grobplanung Platzhalter
      const wrap = document.createElement("div");
      wrap.style.display="grid";
      wrap.style.gridTemplateColumns="repeat(3, 1fr)";
      wrap.style.gap="12px";
      for(let m=0;m<12;m++){
        const box = document.createElement("div");
        box.className="cell";
        box.style.minHeight="120px";
        const dt = new Date(curStart.getFullYear(), m, 1);
        const t = document.createElement("div");
        t.className="dayhead";
        t.textContent = dt.toLocaleDateString("de-DE",{month:"long", year:"numeric"});
        const slot = document.createElement("div");
        slot.className="slot";
        slot.style.marginTop = "1.2rem";
        box.appendChild(t); box.appendChild(slot);
        wrap.appendChild(box);
      }
      gridEl.appendChild(wrap);
    }
    function getISOWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // ---------- Firestore Sync ----------
    function subscribe(){
      if(unsub) { unsub(); unsub=null; }
      const start = curStart;
      const end = addDays(start, (viewSel.value==="12m")? 365 : (curSpanDays+ (Math.ceil(curSpanDays/5)-1)*2) ); // grob
      const qRef = query(collection(db,"plantafel"),
        where("date", ">=", fmt(start)),
        where("date", "<=", fmt(end)),
        orderBy("date","asc"),
        orderBy("createdAt","asc")
      );
      cloudDot.classList.remove("bad"); cloudDot.classList.add("ok");
      unsub = onSnapshot(qRef, snap=>{
        const items = [];
        snap.forEach(docSnap => items.push({id:docSnap.id, ...docSnap.data()}));
        renderItems(items);
      }, err=>{
        console.error(err);
        cloudDot.classList.remove("ok"); cloudDot.classList.add("bad");
      });
    }

    function renderItems(items){
      // erst Slots leeren
      document.querySelectorAll(".cell .slot, .cell .slot2").forEach(s=>s.innerHTML="");
      if(viewSel.value==="12m"){
        // Grobplanung, nach Monat einsortieren
        items.forEach(it=>{
          const d = new Date(it.date);
          const boxes = gridEl.querySelectorAll(".cell");
          const idx = d.getMonth();
          const slot = boxes[idx].querySelector(".slot");
          slot.appendChild(makeCard(it));
        });
        return;
      }
      const end = addDays(curStart, curSpanDays + (Math.ceil(curSpanDays/5)-1)*2);
      items.forEach(it=>{
        if(!inRange(it.date, curStart, end)) return;
        const cell = gridEl.querySelector(`.cell[data-date="${it.date}"]`);
        if(!cell) return;
        cell.querySelector(".slot").appendChild(makeCard(it));
      });
    }

    function makeCard(it){
      const card = document.createElement("div");
      card.className="card";
      if(it.status && ["urlaub","krank","schule"].includes(it.status)){
        card.style.borderColor = "var(--bad)";
        card.style.boxShadow = "0 0 0 1px rgba(239,68,68,.25), 0 8px 18px rgba(0,0,0,.35)";
      }
      const actions = document.createElement("div");
      actions.className="actions";
      const edit = document.createElement("button"); edit.className="iconbtn"; edit.textContent="✎";
      const del = document.createElement("button"); del.className="iconbtn"; del.textContent="×";
      actions.append(edit, del);
      card.appendChild(actions);

      const t = document.createElement("div"); t.className="title"; t.textContent = it.title || "(ohne Titel)";
      const chips = document.createElement("div"); chips.className="chips";
      (it.mitarbeiter || []).forEach(m => chips.appendChild(chipEl(m)));
      (it.fahrzeuge || []).forEach(f => chips.appendChild(chipEl(f)));
      card.append(t, chips);

      edit.onclick = (e)=>{ e.stopPropagation(); openEntryDialog(it); };
      del.onclick = async (e)=>{ e.stopPropagation(); if(confirm("Eintrag löschen?")){
        await deleteDoc(doc(collection(db,"plantafel"), it.id)); } };

      return card;
    }
    function chipEl(txt){ const c=document.createElement("span"); c.className="chip"; c.textContent=txt; return c; }

    // ---------- Dialoge ----------
    function openEntryDialog(it){
      editingId = it.id || null;
      fTitle.value = it.title || "";
      fStatus.value = it.status || "normal";
      fDate.value = it.date || fmt(new Date());
      fDuration.value = String(it.duration || 1);
      selectedMitarbeiter = new Set(it.mitarbeiter || []);
      selectedFahrzeuge = new Set(it.fahrzeuge || []);
      warnText.style.display = (["urlaub","krank","schule"].includes(fStatus.value))? "block":"none";
      renderChipList(chipMitarbeiter, master.mitarbeiter, selectedMitarbeiter);
      renderChipList(chipFahrzeuge, master.fahrzeuge, selectedFahrzeuge);
      btnDel.style.display = editingId ? "inline-flex" : "none";
      entryDlg.showModal();
    }
    btnCancel.onclick = ()=> entryDlg.close();
    fStatus.onchange = ()=> { warnText.style.display = (["urlaub","krank","schule"].includes(fStatus.value))? "block":"none"; };

    btnSave.onclick = async ()=>{
      const base = {
        title: fTitle.value?.trim() || "",
        status: fStatus.value,
        date: fDate.value,
        duration: Number(fDuration.value||1),
        mitarbeiter: Array.from(selectedMitarbeiter),
        fahrzeuge: Array.from(selectedFahrzeuge),
        updatedAt: serverTimestamp(),
      };
      // Serien-Eintrag über Dauer
      const days = Math.max(1, Number(fDuration.value||1));
      const batchDates = [];
      for(let i=0;i<days;i++){
        // nur Mo–Fr befüllen
        const d = new Date(fDate.value); d.setDate(d.getDate()+i);
        const wd = d.getDay(); if(wd===0||wd===6) continue;
        batchDates.push(fmt(d));
      }
      if(editingId){
        // vorhandenen Tag ändern (nur erster Termin)
        await updateDoc(doc(collection(db,"plantafel"), editingId), base);
      }else{
        for(const ds of batchDates){
          await addDoc(collection(db,"plantafel"), {
            ...base, date: ds, createdAt: serverTimestamp()
          });
        }
      }
      entryDlg.close();
    };
    btnDel.onclick = async ()=>{
      if(!editingId) return;
      if(confirm("Eintrag wirklich löschen?")){
        await deleteDoc(doc(collection(db,"plantafel"), editingId));
        entryDlg.close();
      }
    };

    // Stammdaten
    btnMaster.onclick = async ()=>{
      await loadMaster();
      mMitarbeiter.value = (master.mitarbeiter||[]).join(", ");
      mFahrzeuge.value = (master.fahrzeuge||[]).join(", ");
      mNote.value = master.note || "";
      masterDlg.showModal();
    };
    btnMasterCancel.onclick = ()=> masterDlg.close();
    btnMasterSave.onclick = async ()=>{
      master = {
        mitarbeiter: splitCSV(mMitarbeiter.value),
        fahrzeuge: splitCSV(mFahrzeuge.value),
        note: mNote.value?.trim() || ""
      };
      await setDoc(doc(collection(db,"settings"), "master"), master, {merge:true});
      masterDlg.close();
    };
    function splitCSV(s){ return (s||"").split(",").map(x=>x.trim()).filter(Boolean); }

    // ---------- Steuerung ----------
    viewSel.onchange = ()=> setView(viewSel.value);
    startDate.onchange = ()=>{
      const d = new Date(startDate.value); curStart = mondayOf(d);
      buildGrid(); subscribe();
    };
    btnReload.onclick = ()=>{ buildGrid(); subscribe(); };
    zoomRange.oninput = ()=>{ gridEl.style.scale = (Number(zoomRange.value)/100); };

    // ---------- Start ----------
    (async function init(){
      await loadMaster();
      // Toolbar init
      const now = new Date();
      curStart = mondayOf(now);
      startDate.value = fmt(curStart);
      viewSel.value = "4w";
      buildGrid();
      subscribe();
    })();
  </script>
</body>
</html>
