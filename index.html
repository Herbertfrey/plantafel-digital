<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Plantafel Digital</title>
<style>
  :root{
    --bg:#0f1620; --panel:#17212e; --panel2:#1e2a3a; --text:#d9e1ee;
    --muted:#91a0b7; --primary:#3a86ff; --danger:#ef4444; --ok:#22c55e;
    --card:#213245; --card-border:#2e4158; --badge:#2b3e55; --shadow:rgba(0,0,0,.25);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;}
  .toolbar{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--panel),#131b27);padding:10px 12px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 12px var(--shadow)}
  .toolbar label{opacity:.9;margin-right:6px}
  .toolbar .btn{background:#2b3a52;border:1px solid #394b69;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
  .toolbar .btn.primary{background:var(--primary);border-color:#2e6be6}
  .toolbar .btn.ghost{background:transparent;border-color:#2c3950}
  .toolbar select,.toolbar input[type="date"]{background:#203146;border:1px solid #2e4158;color:var(--text);padding:8px 10px;border-radius:10px}
  .hint{padding:8px 12px;color:var(--muted)}
  #board{padding:16px;min-height:calc(100vh - 120px)}
  /* Grid â€“ Tage/Wochen */
  .weekgrid{display:grid;gap:10px}
  .weekgrid.cols-5{grid-template-columns:160px repeat(5,1fr)}
  .weekgrid .kwcol{background:var(--panel2);border:1px solid #263349;border-radius:12px;padding:10px;min-width:160px}
  .weekgrid .day{background:var(--panel2);border:1px dashed #2d3a4f;border-radius:12px;min-height:120px;padding:10px;position:relative;overflow:hidden}
  .weekgrid .day h4{margin:0 0 8px 0;color:#aab8cf;font-weight:600}
  /* Grid â€“ Monate */
  .monthgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .month{background:var(--panel2);border:1px solid #263349;border-radius:14px;padding:12px;min-height:140px}
  .month h3{margin:0 0 8px 0;color:#aab8cf}
  /* Karten */
  .card{background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:8px 10px;margin:6px 0;box-shadow:0 4px 12px var(--shadow);cursor:grab}
  .card .title{font-weight:700;margin-bottom:6px}
  .card .badges{display:flex;flex-wrap:wrap;gap:6px}
  .badge{background:var(--badge);border:1px solid #3a516e;padding:2px 8px;border-radius:999px;font-size:12px}
  .card .actions{position:absolute;top:6px;right:6px;display:flex;gap:6px}
  .iconbtn{background:#2a394e;border:1px solid #3a4d68;border-radius:8px;color:#cfe0ff;cursor:pointer;padding:2px 6px;font-size:12px}
  .card.red{box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}
  /* Modal */
  dialog{border:none;border-radius:18px;background:#0f1a2a;color:var(--text);width:min(760px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-head{padding:14px 16px;border-bottom:1px solid #24334a;font-weight:700}
  .modal-body{padding:16px;display:grid;grid-template-columns:1fr;gap:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pill{background:#1c2c41;border:1px solid #2d425f;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none}
  .pill.active{background:#2c3f59;border-color:#4d6a93;box-shadow:inset 0 0 0 2px #34527a}
  .modal-actions{padding:12px 16px;border-top:1px solid #24334a;display:flex;justify-content:flex-end;gap:10px}
  /* Floater */
  .fab{position:fixed;right:18px;bottom:18px;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:var(--primary);color:#fff;border:none;box-shadow:0 10px 24px var(--shadow);cursor:pointer;font-size:26px}
  /* Statusdot */
  #cloud-dot{position:fixed;left:8px;bottom:26px;width:10px;height:10px;border-radius:50%;background:#666;box-shadow:0 0 0 3px rgba(0,0,0,.25)}
  /* Zoom */
  .zoom{width:140px}
</style>
</head>
<body>
  <div class="toolbar">
    <strong>Plantafel</strong>
    <label>Ansicht:</label>
    <select id="view">
      <option value="14">14 Tage (Moâ€“Fr)</option>
      <option value="28" selected>4 Wochen (Moâ€“Fr)</option>
      <option value="365">12 Monate (Grobplanung)</option>
    </select>

    <label>Start:</label>
    <input id="start" type="date" />
    <button id="reload" class="btn">Neu laden</button>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <span id="status-dot" title="Status">ðŸ”´</span>
      <div title="Zoom">
        <input id="zoom" class="zoom" type="range" min="80" max="180" value="120" />
      </div>
      <label style="display:flex;gap:6px;align-items:center" title="Seite regelmÃ¤ÃŸig neu laden (fÃ¼r Monitor)">
        <input id="autorefresh" type="checkbox" />
        <span class="btn ghost">Auto-Reload</span>
      </label>
      <button id="openSettings" class="btn">Stammdaten</button>
      <button id="add" class="btn primary">+ Eintrag</button>
    </div>
  </div>

  <div class="hint">Drag & Drop: Karte auf Ziel ziehen â†’ â€žVerschiebenâ€œ oder â€žDuplizierenâ€œ. Klick auf Karte = bearbeiten, X = lÃ¶schen.</div>

  <div id="board"></div>

  <button class="fab" id="fab" title="Neuer Eintrag">+</button>
  <div id="cloud-dot" title="Cloud-Verbindung"></div>

  <!-- Modal: Editor -->
  <dialog id="dlg">
    <div class="modal-head">Eintrag bearbeiten</div>
    <form method="dialog" class="modal-body" id="form">
      <div class="row">
        <label style="width:110px">Titel</label>
        <input id="f_title" required style="flex:1;background:#18263a;border:1px solid #2c3f5a;color:#fff;padding:10px;border-radius:12px" />
      </div>

      <div class="row">
        <label style="width:110px">Status</label>
        <div id="f_status" class="row">
          <span data-v="normal"  class="pill active">Normal</span>
          <span data-v="urlaub"  class="pill" style="background:#3a2930;border-color:#6a3a46">Urlaub</span>
          <span data-v="krank"   class="pill" style="background:#3a2a2a;border-color:#6a3a3a">Krank</span>
          <span data-v="schule"  class="pill" style="background:#2f2a3a;border-color:#4a3a6a">Schule</span>
        </div>
      </div>

      <div class="row">
        <label style="width:110px">Datum</label>
        <input id="f_date" type="date" required style="background:#18263a;border:1px solid #2c3f5a;color:#fff;padding:10px;border-radius:12px" />
        <label style="margin-left:12px">Dauer</label>
        <select id="f_days" style="background:#18263a;border:1px solid #2c3f5a;color:#fff;padding:10px;border-radius:12px">
          <option value="1">nur dieser Tag</option>
          <option value="2">2 Tage</option>
          <option value="3">3 Tage</option>
          <option value="4">4 Tage</option>
          <option value="5">5 Tage</option>
          <option value="10">2 Wochen</option>
        </select>
      </div>

      <div class="row">
        <label style="width:110px">Mitarbeiter</label>
        <div id="f_staff" class="row"></div>
      </div>

      <div class="row">
        <label style="width:110px">Fahrzeuge</label>
        <div id="f_cars" class="row"></div>
      </div>

      <div class="row">
        <label style="width:110px">Tafel</label>
        <div id="f_board" class="row">
          <span data-v="fine"   class="pill active">Feinplanung</span>
          <span data-v="coarse" class="pill">Grobplanung</span>
        </div>
      </div>

      <input type="hidden" id="f_id" />
    </form>
    <div class="modal-actions">
      <button id="btnDelete" class="btn" style="background:#3a2430;border-color:#5a3248">LÃ¶schen</button>
      <button id="btnDup" class="btn">Duplizieren</button>
      <button id="btnCancel" class="btn">Abbrechen</button>
      <button id="btnSave" class="btn primary">Speichern</button>
    </div>
  </dialog>

  <!-- Modal: Stammdaten -->
  <dialog id="dlgSettings">
    <div class="modal-head">Stammdaten</div>
    <div class="modal-body">
      <div class="row" style="flex-direction:column;gap:6px">
        <label>Mitarbeiter (kommagetrennt)</label>
        <textarea id="s_staff" rows="3" style="background:#18263a;border:1px solid #2c3f5a;color:#fff;padding:10px;border-radius:12px"></textarea>
      </div>
      <div class="row" style="flex-direction:column;gap:6px">
        <label>Fahrzeuge (kommagetrennt)</label>
        <textarea id="s_cars" rows="3" style="background:#18263a;border:1px solid #2c3f5a;color:#fff;padding:10px;border-radius:12px"></textarea>
      </div>
    </div>
    <div class="modal-actions">
      <button id="btnSettingsCancel" class="btn">Abbrechen</button>
      <button id="btnSettingsSave" class="btn primary">Speichern</button>
    </div>
  </dialog>

  <!-- Firebase + App-Logik (ohne App Check) -->
  <script type="module">
    /* Firebase SDK (CDN) */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, setDoc, updateDoc, getDoc,
      deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /* >>>>> Firebase-Konfig â€“ bitte prÃ¼fen (deine Werte aus der Konsole) <<<<< */
    const firebaseConfig = {
      apiKey: "AIzaSyDpwF_KnO23BX-ebCVG9642DrXmf94SxDI",
      authDomain: "plantafelfreyllich100.firebaseapp.com",
      projectId: "plantafelfreyllich100",
      storageBucket: "plantafelfreyllich100.firebasestorage.app",
      messagingSenderId: "962959139135",
      appId: "1:962959139135:web:e44627944781c50ef91d4a",
      measurementId: "G-W5GSSLTRC"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Offline-Cache (optional)
    try { await enableIndexedDbPersistence(db); } catch(e){ /* kann ignoriert werden */ }

    /* UI References */
    const $ = sel => document.querySelector(sel);
    const viewSel = $('#view');
    const startInp = $('#start');
    const boardEl = $('#board');
    const dlg = $('#dlg');
    const dlgSettings = $('#dlgSettings');

    /* Stammdaten laden/speichern */
    async function loadSettings(){
      const ref = doc(db,'settings','default');
      const snap = await getDoc(ref);
      if(snap.exists()){
        const s = snap.data();
        window._settings = {
          staff: s.staff || ['Thomas','Patrick','Herbert','Artiom','Juppi','Terry'],
          cars:  s.cars  || ['Doka','Crafter','Mercedes Bus','Ford','Mercedes Bus Doka']
        };
      }else{
        window._settings = {
          staff:['Thomas','Patrick','Herbert','Artiom','Juppi','Terry'],
          cars:['Doka','Crafter','Mercedes Bus','Ford','Mercedes Bus Doka']
        };
        await setDoc(ref, window._settings);
      }
    }
    function openSettings(){
      $('#s_staff').value = (window._settings?.staff||[]).join(', ');
      $('#s_cars').value  = (window._settings?.cars||[]).join(', ');
      dlgSettings.showModal();
    }
    $('#openSettings').onclick = openSettings;
    $('#btnSettingsCancel').onclick = ()=> dlgSettings.close();
    $('#btnSettingsSave').onclick = async ()=>{
      const staff = $('#s_staff').value.split(',').map(s=>s.trim()).filter(Boolean);
      const cars  = $('#s_cars').value.split(',').map(s=>s.trim()).filter(Boolean);
      await setDoc(doc(db,'settings','default'),{staff,cars});
      window._settings = {staff,cars};
      dlgSettings.close();
      render(); // aktualisiere die Auswahl im Editor
    };

    /* Utilities */
    const fmtISO = d => d.toISOString().slice(0,10);
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x};
    function mondayOf(date){
      const d=new Date(date); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d;
    }
    function firstOfMonth(date){ const d=new Date(date); d.setDate(1); return d; }
    function monthName(i){ return ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'][i]; }
    function kw(d){ d=new Date(d); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-((d.getDay()+6)%7)); const week1=new Date(d.getFullYear(),0,4); return 1+Math.round(((d-week1)/86400000-3+((week1.getDay()+6)%7))/7); }

    /* Global state */
    let unsub = null;
    let items = []; // aktuelle EintrÃ¤ge
    let zoomPx = 120;

    /* Render */
    function clearBoard(){ boardEl.innerHTML=''; }
    function setStatusDot(ok){ $('#status-dot').textContent = ok ? 'ðŸŸ¢' : 'ðŸ”´'; $('#cloud-dot').style.background = ok ? '#22c55e' : '#ef4444'; }

    function dayCell(dateStr){
      const div = document.createElement('div');
      div.className='day droptarget';
      div.dataset.date = dateStr;
      const d = new Date(dateStr);
      const h = document.createElement('h4');
      h.textContent = d.toLocaleDateString('de-DE',{weekday:'short', year:'numeric', month:'2-digit', day:'2-digit'});
      div.appendChild(h);
      div.ondragover = e=> e.preventDefault();
      div.ondrop = async e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const one = items.find(x=>x.id===id);
        if(!one) return;
        await updateDoc(doc(db,'entries',id), { date: dateStr, board:'fine', updated: serverTimestamp() });
      };
      return div;
    }

    function monthCell(year,monthIdx){
      const div = document.createElement('div');
      div.className='month droptarget';
      div.dataset.year=year; div.dataset.month=monthIdx;
      const h=document.createElement('h3'); h.textContent = `${monthName(monthIdx)} ${year}`; div.appendChild(h);
      div.ondragover = e=> e.preventDefault();
      div.ondrop = async e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const one = items.find(x=>x.id===id);
        if(!one) return;
        const newDate = fmtISO(new Date(year,monthIdx,1));
        await updateDoc(doc(db,'entries',id), { date:newDate, board:'coarse', updated: serverTimestamp() });
      };
      return div;
    }

    function cardHTML(it){
      const el = document.createElement('div');
      el.className = 'card' + (it.status!=='normal' ? ' red':'');
      el.draggable = true;
      el.style.minHeight = zoomPx+'px';
      el.ondragstart = e=> e.dataTransfer.setData('text/plain', it.id);

      const t = document.createElement('div');
      t.className='title';
      t.textContent = it.title || '(ohne Titel)';
      el.appendChild(t);

      const bb = document.createElement('div');
      bb.className='badges';
      if(Array.isArray(it.staff))   it.staff.forEach(s=>{ const b=document.createElement('span'); b.className='badge'; b.textContent=s; bb.appendChild(b); });
      if(Array.isArray(it.cars))    it.cars.forEach(s=>{ const b=document.createElement('span'); b.className='badge'; b.textContent=s; bb.appendChild(b); });
      if(it.status!=='normal'){ const b=document.createElement('span'); b.className='badge'; b.textContent=it.status; b.style.background='#5a2a2a'; bb.appendChild(b); }
      el.appendChild(bb);

      const acts=document.createElement('div'); acts.className='actions';
      const edit=document.createElement('button'); edit.className='iconbtn'; edit.textContent='âœŽ'; edit.title='Bearbeiten';
      const del=document.createElement('button'); del.className='iconbtn'; del.textContent='Ã—'; del.title='LÃ¶schen';
      acts.appendChild(edit); acts.appendChild(del); el.appendChild(acts);

      edit.onclick = ()=> openEditor(it);
      del.onclick = async ()=> { if(confirm('Eintrag lÃ¶schen?')) await deleteDoc(doc(db,'entries',it.id)); };

      return el;
    }

    function render(){
      clearBoard();
      const view = viewSel.value;
      if(view==='365'){ // Grobplanung, 12 Monate ab Start
        const start = new Date(startInp.value || fmtISO(new Date()));
        const y0 = start.getFullYear();
        const m0 = start.getMonth();
        const wrapper=document.createElement('div'); wrapper.className='monthgrid';
        for(let i=0;i<12;i++){
          const y = y0 + Math.floor((m0+i)/12);
          const m = (m0+i)%12;
          const cell=monthCell(y,m);
          const monthStart = fmtISO(new Date(y,m,1));
          const monthEnd = fmtISO(new Date(y,m+1,0));
          // add cards (board == coarse) whose date lies in month
          items.filter(x=>x.board==='coarse' && x.date>=monthStart && x.date<=monthEnd)
               .forEach(it=> cell.appendChild(cardHTML(it)));
          wrapper.appendChild(cell);
        }
        boardEl.appendChild(wrapper);
      } else {
        const days = (view==='14'?14:28);
        const start = mondayOf(startInp.value || new Date());
        const table=document.createElement('div'); table.className='weekgrid cols-5';
        // 4 Wochen Raster mit KW Spalte
        const weeks = Math.ceil(days/5);
        for(let w=0; w<weeks; w++){
          // KW Spalte
          const kwcol=document.createElement('div'); kwcol.className='kwcol';
          const d0 = addDays(start, w*7);
          const d5 = addDays(d0,6);
          const k = kw(d0);
          kwcol.innerHTML = `<div style="font-weight:700;margin-bottom:6px">KW ${String(k).padStart(2,'0')}</div>
            <div style="color:#aab8cf;font-size:12px">${fmtISO(d0)} â€“ ${fmtISO(d5)}</div>
            <div style="margin-top:10px;color:#aab8cf">Projekt</div>`;
          table.appendChild(kwcol);
          // Moâ€“Fr
          for(let d=0; d<5; d++){
            const date = addDays(d0,d);
            const ds = fmtISO(date);
            const cell = dayCell(ds);
            // EintrÃ¤ge (board == fine) die an diesem Tag liegen (inkl. Dauer)
            items.filter(x=>{
              if(x.board!=='fine') return false;
              const startD = new Date(x.date);
              const endD = addDays(startD,(x.days||1)-1);
              return date>=startD && date<=endD;
            }).forEach(it=> cell.appendChild(cardHTML(it)));
            table.appendChild(cell);
          }
        }
        boardEl.appendChild(table);
      }
    }

    /* Realtime-Live-Query: wir hÃ¶ren immer auf den passenden Bereich */
    function attachListener(){
      if(unsub) { unsub(); unsub=null; }
      const view = viewSel.value;
      const start = new Date(startInp.value || fmtISO(new Date()));
      let qRef;
      if(view==='365'){
        const y0=start.getFullYear(); const m0=start.getMonth();
        const startISO = fmtISO(new Date(y0,m0,1));
        const endISO   = fmtISO(new Date(y0,m0+12,0));
        qRef = query(collection(db,'entries'), where('date','>=',startISO), where('date','<=',endISO), orderBy('date'));
      }else{
        const s = mondayOf(start);
        const e = addDays(s, (view==='14'?14:28)-1);
        const startISO = fmtISO(s);
        const endISO   = fmtISO(e);
        qRef = query(collection(db,'entries'), where('date','>=',startISO), where('date','<=',endISO), orderBy('date'));
      }
      unsub = onSnapshot(qRef, snap=>{
        const arr=[];
        snap.forEach(d=> arr.push({id:d.id, ...d.data()}));
        items = arr;
        setStatusDot(true);
        render();
      }, err=>{
        console.error('Snapshot error', err);
        setStatusDot(false);
      });
    }

    /* Editor */
    function pills(containerId, val){
      const box = $(containerId);
      box.querySelectorAll('.pill').forEach(p=>{
        p.classList.toggle('active', p.dataset.v===val);
      });
    }
    function collectPills(container){
      return Array.from(container.querySelectorAll('.pill.active')).map(x=>x.dataset.v);
    }
    function buildSelectable(container, list){
      container.innerHTML='';
      list.forEach(name=>{
        const s=document.createElement('span');
        s.className='pill'; s.textContent=name; s.dataset.v=name;
        s.onclick=()=> s.classList.toggle('active');
        container.appendChild(s);
      });
    }

    function openEditor(it){
      const isNew = !it;
      const s = window._settings || {staff:[],cars:[]};

      // Felder setzen
      $('#f_id').value    = it?.id || '';
      $('#f_title').value = it?.title || '';
      $('#f_date').value  = it?.date || fmtISO(new Date());
      $('#f_days').value  = String(it?.days || 1);

      // Status
      const status = it?.status || 'normal';
      $('#f_status').querySelectorAll('.pill').forEach(p=>{
        p.classList.toggle('active', p.dataset.v===status);
        p.onclick=()=>{ $('#f_status').querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); };
      });

      // Board
      const board = it?.board || (viewSel.value==='365'?'coarse':'fine');
      $('#f_board').querySelectorAll('.pill').forEach(p=>{
        p.classList.toggle('active', p.dataset.v===board);
        p.onclick=()=>{ $('#f_board').querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); };
      });

      // Staff/Cars
      buildSelectable($('#f_staff'), s.staff);
      buildSelectable($('#f_cars'),  s.cars);
      // Vorbelegen
      (it?.staff||[]).forEach(v=>{
        const n=[...$('#f_staff').children].find(x=>x.dataset.v===v); if(n) n.classList.add('active');
      });
      (it?.cars||[]).forEach(v=>{
        const n=[...$('#f_cars').children].find(x=>x.dataset.v===v); if(n) n.classList.add('active');
      });

      // Buttons
      $('#btnDelete').style.display = isNew ? 'none' : 'inline-flex';
      $('#btnDup').style.display    = isNew ? 'none' : 'inline-flex';

      dlg.showModal();
    }

    $('#add').onclick = ()=> openEditor(null);
    $('#fab').onclick = ()=> openEditor(null);

    $('#btnCancel').onclick = ()=> dlg.close();
    $('#btnDelete').onclick = async ()=>{
      const id = $('#f_id').value; if(!id) return;
      if(confirm('Eintrag wirklich lÃ¶schen?')){
        await deleteDoc(doc(db,'entries',id));
        dlg.close();
      }
    };
    $('#btnDup').onclick = async ()=>{
      const id = $('#f_id').value; if(!id) return;
      const it = items.find(x=>x.id===id); if(!it) return;
      const copy = {...it}; delete copy.id;
      copy.title = (copy.title||'')+' (Kopie)';
      copy.created = serverTimestamp(); copy.updated = serverTimestamp();
      await addDoc(collection(db,'entries'), copy);
      dlg.close();
    };

    $('#btnSave').onclick = async ()=>{
      const id   = $('#f_id').value || null;
      const data = {
        title: $('#f_title').value.trim(),
        status: $('#f_status .pill.active')?.dataset.v || 'normal',
        date: $('#f_date').value,
        days: Number($('#f_days').value||1),
        staff: collectPills($('#f_staff')),
        cars:  collectPills($('#f_cars')),
        board: $('#f_board .pill.active')?.dataset.v || 'fine',
        updated: serverTimestamp()
      };
      if(!data.title) { alert('Bitte Titel angeben.'); return; }
      if(!data.date)  { alert('Bitte Datum wÃ¤hlen.'); return; }

      if(id){
        await updateDoc(doc(db,'entries',id), data);
      }else{
        data.created = serverTimestamp();
        await addDoc(collection(db,'entries'), data);
      }
      dlg.close();
    };

    /* Interaktionen oben */
    startInp.value = fmtISO(new Date());
    viewSel.onchange = ()=> attachListener();
    startInp.onchange = ()=> attachListener();
    $('#reload').onclick = ()=> attachListener();
    $('#zoom').oninput = (e)=>{ zoomPx = Number(e.target.value); render(); };

    // Auto-Reload (hart) â€“ optional fÃ¼r Monitoranzeige
    let timer = null;
    $('#autorefresh').onchange = (e)=>{
      if(e.target.checked){ timer = setInterval(()=> location.reload(), 60000); }
      else { clearInterval(timer); timer=null; }
    };

    // Erstinitialisierung
    await loadSettings();
    attachListener();
  </script>
</body>
</html>
