<!DOCTYPE html>
<html lang="de" style="background:#0f172a;color:#fff;">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Plantafel Digital</title>

  <style>
    :root {
      --bg-app: #0f172a;         /* fast schwarz/blau */
      --bg-card: #1e2539;        /* dunkelgrau-blau Kacheln */
      --bg-card-border: #3b415a; /* Rahmen */
      --bg-toolbar: #1e2539;
      --bg-btn: #2563eb;
      --bg-btn-hover: #1d4ed8;
      --text-main: #ffffff;
      --text-dim: #9ca3af;
      --border-radius-lg: 10px;
      --border-radius-sm: 6px;
      --gap: 12px;
      --col-min-width: 260px;
      --header-height: auto;
      --toolbar-padding: 12px;
      --status-urlaub: #ef4444; /* rot */
      --status-normal: #38bdf8; /* blau */
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-app);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.4;
    }

    /* ============ LAYOUT ============ */
    header.toolbar {
      background: var(--bg-toolbar);
      border-bottom: 1px solid #334155;
      padding: var(--toolbar-padding);
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: var(--gap);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    /* linke Spalte in der Toolbar (Statuspunkt + Ansicht + Datum + Reload) */
    .toolbar-left {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--gap);
      flex: 1 1 auto;
      min-width: 220px;
    }

    .cloud-dot {
      display: inline-flex;
      align-items: center;
      gap:6px;
      background:#1f2937;
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      padding:6px 10px;
      font-size:14px;
      font-weight:500;
    }

    .dot-indicator {
      width:10px;
      height:10px;
      border-radius:50%;
      background:#6b7280; /* grau default = offline */
    }
    .dot-online { background:#22c55e; }   /* grün */
    .dot-offline { background:#ef4444; }  /* rot */

    .toolbar-group {
      background:#1f2937;
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      padding:8px 10px;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
      min-height:42px;
    }

    .toolbar-label {
      font-size:14px;
      font-weight:500;
      color:#d1d5db;
    }

    select, input[type="date"] {
      background:#111827;
      color:#fff;
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      padding:6px 8px;
      font-size:14px;
      min-height:32px;
    }

    button.small-btn,
    button.primary-btn,
    button.ghost-btn {
      border-radius: var(--border-radius-sm);
      border:1px solid transparent;
      background:#1f2937;
      color:#fff;
      font-size:14px;
      font-weight:500;
      line-height:1.2;
      min-height:32px;
      padding:6px 10px;
      cursor:pointer;
    }
    button.small-btn:hover,
    button.ghost-btn:hover {
      background:#374151;
    }

    button.primary-btn {
      background:var(--bg-btn);
      border-color:var(--bg-btn);
      color:#fff;
    }
    button.primary-btn:hover {
      background:var(--bg-btn-hover);
      border-color:var(--bg-btn-hover);
    }

    .toolbar-right {
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:var(--gap);
    }

    .check-wrap {
      display:flex;
      align-items:center;
      gap:8px;
      background:#1f2937;
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      padding:8px 10px;
      min-height:42px;
      font-size:14px;
      font-weight:500;
      color:#fff;
    }

    .check-wrap input[type="checkbox"] {
      width:16px;
      height:16px;
      accent-color:#2563eb;
      cursor:pointer;
    }

    /* Stammdaten-Button */
    .stammdaten-btn {
      background:#1f2937;
      border:1px solid #4b5563;
      color:#fff;
      border-radius: var(--border-radius-sm);
      padding:8px 10px;
      min-height:42px;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
    }
    .stammdaten-btn:hover {
      background:#374151;
    }

    /* +Eintrag oben (Desktop) */
    .add-top-btn {
      background:var(--bg-btn);
      border:1px solid var(--bg-btn);
      color:#fff;
      border-radius: var(--border-radius-sm);
      min-height:42px;
      padding:8px 12px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    .add-top-btn:hover {
      background:var(--bg-btn-hover);
      border-color:var(--bg-btn-hover);
    }

    main {
      padding:16px;
    }

    /* Grid: Wochen/Tage */
    .week-row {
      background:var(--bg-app);
      display:flex;
      flex-wrap:wrap;
      gap:var(--gap);
      margin-bottom:24px;
    }

    .day-col {
      background:var(--bg-card);
      border:1px solid var(--bg-card-border);
      border-radius: var(--border-radius-lg);
      min-width:var(--col-min-width);
      flex:1 1 var(--col-min-width);
      display:flex;
      flex-direction:column;
    }

    .day-header {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:10px 12px 6px;
      border-bottom:1px solid #4b5563;
      color:#fff;
      font-size:14px;
      line-height:1.3;
      font-weight:500;
    }

    .day-header-left {
      display:flex;
      flex-direction:column;
    }
    .kwline {
      color:#60a5fa;
      font-size:13px;
      font-weight:600;
    }
    .dateline {
      font-size:12px;
      color:#9ca3af;
      font-weight:400;
    }

    .day-header-right button {
      background:#1f2937;
      color:#fff;
      border:1px solid #4b5563;
      border-radius:var(--border-radius-sm);
      width:24px;
      height:24px;
      line-height:1;
      font-size:16px;
      font-weight:600;
      padding:0;
      cursor:pointer;
    }
    .day-header-right button:hover {
      background:#374151;
    }

    .cards {
      padding:10px 12px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:80px;
    }

    .jobcard {
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      background:rgba(37,99,235,0.12); /* leichte Blautönung */
      color:#fff;
      padding:10px 12px;
      font-size:14px;
      line-height:1.4;
      cursor:pointer;
    }
    .jobcard[data-status="urlaub"] {
      background:rgba(239,68,68,0.12);
      border-color:var(--status-urlaub);
    }
    .jobcard-title {
      font-weight:600;
      margin-bottom:4px;
    }
    .jobcard-row {
      font-size:13px;
      color:#e5e7eb;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    /* Floating Action Button (unten rechts mobil / Desktop) */
    .fab {
      position:fixed;
      right:16px;
      bottom:16px;
      width:48px;
      height:48px;
      border-radius:50%;
      background:var(--bg-btn);
      color:#fff;
      border:1px solid var(--bg-btn);
      font-size:28px;
      line-height:48px;
      font-weight:500;
      text-align:center;
      cursor:pointer;
      box-shadow:0 15px 30px rgba(0,0,0,0.6);
      z-index:2000;
      user-select:none;
    }
    .fab:hover {
      background:var(--bg-btn-hover);
      border-color:var(--bg-btn-hover);
    }

    footer.statusbar {
      font-size:12px;
      color:var(--text-dim);
      padding:12px 16px 64px;
    }

    /* ===== Dialoge ===== */

    dialog {
      background:#1e2539;
      border:1px solid #4b5563;
      border-radius:16px;
      color:#fff;
      max-width:420px;
      width:90vw;
      padding:0;
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
    }

    dialog::backdrop {
      background:rgba(0,0,0,0.6);
    }

    .dlg-head {
      padding:16px;
      border-bottom:1px solid #4b5563;
      font-size:16px;
      font-weight:600;
    }

    .dlg-body {
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:14px;
    }

    .dlg-row {
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .dlg-row label {
      font-size:13px;
      font-weight:500;
      color:#d1d5db;
    }
    .dlg-row input,
    .dlg-row select,
    .dlg-row textarea {
      background:#111827;
      color:#fff;
      border:1px solid #4b5563;
      border-radius: var(--border-radius-sm);
      padding:8px 10px;
      font-size:14px;
      resize:none;
      min-height:36px;
    }
    .hint {
      font-size:12px;
      color:#9ca3af;
    }

    .dlg-foot {
      padding:16px;
      border-top:1px solid #4b5563;
      display:flex;
      flex-wrap:wrap;
      justify-content:flex-end;
      gap:8px;
    }

    .ghost-btn {
      background:#1f2937;
      border:1px solid #4b5563;
      color:#fff;
    }
    .ghost-btn:hover {
      background:#374151;
    }

    /* Kleiner Schalterbereich im Eintrags-Dialog
       (löschen / duplizieren / verschieben kommt später wieder rein wenn nötig) */
    .dlg-inline-note {
      font-size:12px;
      color:#9ca3af;
      border-top:1px solid #4b5563;
      margin-top:8px;
      padding-top:8px;
    }

    /* einfache Helper-Klassen versteckt */
    .hidden { display:none !important; }

    @media (max-width:600px){
      header.toolbar {
        flex-direction:column;
        align-items:stretch;
      }
      .toolbar-left,
      .toolbar-right {
        flex-direction:column;
        align-items:stretch;
        width:100%;
      }
      .toolbar-group,
      .check-wrap,
      .stammdaten-btn,
      .add-top-btn {
        width:100%;
        justify-content:space-between;
      }
    }

  </style>
</head>
<body>

  <!-- ======== TOOLBAR / HEADER ======== -->
  <header class="toolbar">
    <div class="toolbar-left">
      <!-- Online / Offline Punkt + Text -->
      <div class="cloud-dot" id="cloudStatus">
        <span class="dot-indicator dot-offline" id="cloudDot"></span>
        <span id="cloudText">getrennt</span>
      </div>

      <!-- Ansicht + Start-Datum + Neu laden -->
      <div class="toolbar-group">
        <div class="toolbar-col">
          <div class="toolbar-label">Ansicht:</div>
          <select id="viewSel">
            <option value="4w">4 Wochen (Mo–Fr)</option>
            <option value="2w">2 Wochen (Mo–Fr)</option>
            <option value="1w">1 Woche (Mo–Fr)</option>
          </select>
        </div>

        <div class="toolbar-col">
          <div class="toolbar-label">Start:</div>
          <input id="startDate" type="date"/>
        </div>

        <div class="toolbar-col" style="align-self:flex-end;">
          <button class="small-btn" id="btnReload">Neu laden</button>
        </div>
      </div>
    </div>

    <div class="toolbar-right">

      <!-- Urlaub/Krank/Schule checkbox -->
      <div class="check-wrap">
        <input type="checkbox" id="chkStatusFilter"/>
        <label for="chkStatusFilter" style="cursor:pointer;">Urlaub/Krank/Schule</label>
      </div>

      <!-- Auto-Reload -->
      <div class="check-wrap">
        <input type="checkbox" id="chkAutoReload"/>
        <label for="chkAutoReload" style="cursor:pointer;">Auto-Reload</label>
      </div>

      <!-- Stammdaten -->
      <button class="stammdaten-btn" id="btnMaster">Stammdaten</button>

      <!-- +Eintrag -->
      <button class="add-top-btn" id="btnAddTop">+ Eintrag</button>
    </div>
  </header>

  <!-- ======== GRID-BEREICH ======== -->
  <main id="grid"></main>

  <!-- ======== FOOTER STATUS ======== -->
  <footer class="statusbar">
    Status rot = Urlaub/Krank/Schule
  </footer>

  <!-- ======== FLOATING ACTION BUTTON ======== -->
  <div class="fab" id="fabPlus">+</div>

  <!-- ======== DIALOG: EINTRAG ======== -->
  <dialog id="entryDlg">
    <form method="dialog" style="margin:0;padding:0;">
      <div class="dlg-head" id="entryDlgTitle">Neuer Eintrag</div>
      <div class="dlg-body">
        <div class="dlg-row">
          <label for="fDate">Tag</label>
          <input id="fDate" type="date"/>
        </div>
        <div class="dlg-row">
          <label for="fTitle">Projekt / Titel</label>
          <input id="fTitle" type="text" placeholder="z.B. Dachsanierung Müller"/>
        </div>
        <div class="dlg-row">
          <label for="fPeople">Mitarbeiter</label>
          <input id="fPeople" type="text" placeholder="z.B. Herbert; Patrick"/>
          <div class="hint">Mehrere Namen mit Semikolon trennen</div>
        </div>
        <div class="dlg-row">
          <label for="fVehicle">Fahrzeug</label>
          <input id="fVehicle" type="text" placeholder="z.B. Sprinter Bus"/>
        </div>
        <div class="dlg-row">
          <label for="fNote">Notiz</label>
          <textarea id="fNote" rows="2" placeholder="optional"></textarea>
        </div>
        <div class="dlg-row">
          <label for="fStatus">Status</label>
          <select id="fStatus">
            <option value="normal">Einsatz</option>
            <option value="urlaub">Urlaub / Krank / Schule</option>
          </select>
        </div>

        <div class="dlg-inline-note">
          (Verschieben / Duplizieren / Löschen kommt später wieder rein.)
        </div>

        <!-- versteckt ID für Edit -->
        <input type="hidden" id="fId">
      </div>

      <div class="dlg-foot">
        <button class="ghost-btn" id="btnEntryCancel">Abbrechen</button>
        <button class="primary-btn" id="btnEntrySave">Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- ======== DIALOG: STAMMDATEN (Platzhalter) ======== -->
  <dialog id="masterDlg">
    <form method="dialog" style="margin:0;padding:0;">
      <div class="dlg-head">Stammdaten</div>
      <div class="dlg-body">
        <div class="hint">
          Hier später Mitarbeiter, Fahrzeuge, Farben pflegen. <br>
          (Jetzt noch ohne Funktion – nur Platzhalter.)
        </div>
      </div>
      <div class="dlg-foot">
        <button class="primary-btn" id="btnMasterClose">OK</button>
      </div>
    </form>
  </dialog>

  <!-- ============ APP-LOGIK / FIREBASE ============ -->
  <script type="module">
    /* ==========================
       1. Firebase laden
       ========================== */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, doc,
      addDoc, setDoc, updateDoc, deleteDoc,
      getDoc, getDocs, onSnapshot,
      query, where, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // <<< HIER DEINE FIREBASE-KONFIG AUS DER KONSOLE >>>
    // Achtung: das ist die, die du mir gezeigt hast (plantafelfreyl…)
    const firebaseConfig = {
      apiKey: "AIzaSyDpWfP-XnO23Bx-ebCVg6a42D?xm9f4sXDt", // <-- Tippfehler? Bitte echte Werte aus der Konsole einsetzen
      authDomain: "plantafelfreylcich100.firebaseapp.com",
      projectId: "plantafelfreylcich100",
      storageBucket: "plantafelfreylcich100.appspot.com",
      messagingSenderId: "962959139135",
      appId: "1:962959139135:web:e4462794477815c0ef914da",
      measurementId: "G-W5GVSSLTRC"
    };

    // App + DB
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Debug-Helfer im Browser:
    window._db = db;

    /* ==========================
       2. DOM Referenzen
       ========================== */

    const gridEl        = document.getElementById("grid");
    const cloudDot      = document.getElementById("cloudDot");
    const cloudText     = document.getElementById("cloudText");

    const viewSel       = document.getElementById("viewSel");
    const startDateInp  = document.getElementById("startDate");
    const btnReload     = document.getElementById("btnReload");
    const chkStatus     = document.getElementById("chkStatusFilter");
    const chkAuto       = document.getElementById("chkAutoReload");
    const btnMaster     = document.getElementById("btnMaster");
    const btnAddTop     = document.getElementById("btnAddTop");
    const fabPlus       = document.getElementById("fabPlus");

    // Dialoge + Felder
    const entryDlg      = document.getElementById("entryDlg");
    const entryDlgTitle = document.getElementById("entryDlgTitle");
    const fId           = document.getElementById("fId");
    const fDate         = document.getElementById("fDate");
    const fTitle        = document.getElementById("fTitle");
    const fPeople       = document.getElementById("fPeople");
    const fVehicle      = document.getElementById("fVehicle");
    const fNote         = document.getElementById("fNote");
    const fStatus       = document.getElementById("fStatus");
    const btnEntryCancel= document.getElementById("btnEntryCancel");
    const btnEntrySave  = document.getElementById("btnEntrySave");

    const masterDlg     = document.getElementById("masterDlg");
    const btnMasterClose= document.getElementById("btnMasterClose");

    /* ==========================
       3. State / Hilfsfunktionen Datum
       ========================== */

    function todayISO() {
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0,10);
    }

    // Startwert initialisieren
    if (!startDateInp.value) {
      startDateInp.value = todayISO();
    }

    // wie viele Tage anzeigen?
    function getRangeDays() {
      // simple Mapping:
      switch(viewSel.value) {
        case "1w": return 5;    // Mo-Fr 1 Woche
        case "2w": return 10;   // 2 Wochen (Mo-Fr)
        case "4w": default: return 20; // 4 Wochen (Mo-Fr)
      }
    }

    function addDays(baseDateStr, offset) {
      const d = new Date(baseDateStr+"T00:00:00");
      d.setDate(d.getDate()+offset);
      return d.toISOString().slice(0,10);
    }

    function getWeekday(dStr) {
      // 0=So...6=Sa => wir geben "Mo", "Di", ...
      const names = ["So","Mo","Di","Mi","Do","Fr","Sa"];
      const d = new Date(dStr+"T00:00:00");
      return names[d.getDay()];
    }

    function getKW(dStr) {
      // einfache ISO-KW Berechnung
      const d = new Date(dStr+"T00:00:00");
      // Donnerstag Trick:
      const dayNum = (d.getDay()+6) % 7; // Mo=0
      d.setDate(d.getDate() - dayNum + 3); // auf Do
      const firstThursday = new Date(d.getFullYear(),0,4);
      const diff = d - firstThursday;
      const week = 1 + Math.round(diff / (7*24*3600*1000));
      return week;
    }

    /* ==========================
       4. Live-Lesen aus Firestore
       ========================== */

    let unsubListener = null;

    function listenRange() {
      // alten Listener abbauen
      if (unsubListener) {
        unsubListener();
        unsubListener = null;
      }

      const start = startDateInp.value;
      const days  = getRangeDays();
      const endExclusive = addDays(start, days); // Ende (exklusiv)

      // Query: Einträge mit "date" >= start && < endExclusive
      // sortiert nach date, timestamp
      const colRef = collection(db, "plantafel");
      const qRef = query(
        colRef,
        where("date", ">=", start),
        where("date", "<",  endExclusive),
        orderBy("date","asc"),
        orderBy("createdAt","asc")
      );

      unsubListener = onSnapshot(qRef, snap => {
        // wenn das klappt => wir sind online
        setOnline(true);

        // Alle Daten sammeln
        const items = [];
        snap.forEach(docSnap => {
          items.push({ id: docSnap.id, ...docSnap.data() });
        });

        renderGrid(start, days, items);
      }, err => {
        console.warn("onSnapshot error", err);

        // 400 oder permission -> offline markieren / trotzdem Grid zeigen (leer)
        setOnline(false);
        renderGrid(start, days, []);
      });
    }

    /* ==========================
       5. Grid rendern
       ========================== */

    function renderGrid(startIso, daysCount, items) {
      // items ist Array aller Einträge {id, date, title, people[], vehicle,...}

      // wir gruppieren pro Tag
      const byDay = {};
      for (let i=0;i<daysCount;i++) {
        const d = addDays(startIso, i);
        byDay[d] = [];
      }

      for (const it of items) {
        if (byDay[it.date]) {
          byDay[it.date].push(it);
        }
      }

      // HTML bauen:
      // wir machen Wochenblöcke à 5 Tage (Mo-Fr)
      // daysCount ist Vielfaches von 5 in unserem Mapping oben
      const chunkSize = 5;
      const weeksHtml = [];

      for (let base=0;base<daysCount;base+=chunkSize) {
        const colsHtml = [];
        for (let offset=0; offset<chunkSize && (base+offset)<daysCount; offset++) {
          const dayIso = addDays(startIso, base+offset);

          // Kopfzeile dieser Spalte
          const weekday = getWeekday(dayIso); // "Mo",...
          const kw = getKW(dayIso);
          const hdrLeft = `
            <div class="day-header-left">
              <div class="kwline">KW ${kw} ${weekday}</div>
              <div class="dateline">${dayIso}</div>
            </div>
          `;
          const hdrRight = `
            <div class="day-header-right">
              <button data-day="${dayIso}" class="btnAddDay" title="Neuen Eintrag auf diesen Tag setzen">+</button>
            </div>
          `;

          // Karten
          const cards = byDay[dayIso] || [];
          const cardsHtml = cards.map(card => {
            // People als Text
            const peopleText = Array.isArray(card.people) ? card.people.join(", ") : (card.people||"");

            // Fahrzeug
            const vehText = card.vehicle || "";

            // Status-Klasse
            const statusAttr = card.status==="urlaub" ? 'data-status="urlaub"' : '';

            return `
              <div class="jobcard" ${statusAttr} data-id="${card.id}" data-day="${dayIso}">
                <div class="jobcard-title">${esc(card.title||"(ohne Titel)")}</div>
                <div class="jobcard-row">
                  ${peopleText ? `<span>${esc(peopleText)}</span>`:""}
                  ${vehText ? `<span>${esc(vehText)}</span>`:""}
                </div>
              </div>
            `;
          }).join("");

          colsHtml.push(`
            <div class="day-col" data-day="${dayIso}">
              <div class="day-header">
                ${hdrLeft}
                ${hdrRight}
              </div>
              <div class="cards">
                ${cardsHtml || `<div style="color:#9ca3af;font-size:13px;border:1px dashed #4b5563;border-radius:6px;padding:10px;text-align:center;cursor:pointer;" class="emptyHint" data-day="${dayIso}">
                  Klicken zum Eintragen · Drag & Drop möglich
                </div>`}
              </div>
            </div>
          `);
        }

        weeksHtml.push(`
          <section class="week-row">
            ${colsHtml.join("")}
          </section>
        `);
      }

      gridEl.innerHTML = weeksHtml.join("");

      // Klickhandler für + in Tag / leere Fläche / Karten
      gridEl.querySelectorAll(".btnAddDay, .emptyHint").forEach(el=>{
        el.addEventListener("click", e=>{
          const day = el.getAttribute("data-day");
          openEntryDialog({date:day});
        });
      });

      gridEl.querySelectorAll(".jobcard").forEach(el=>{
        el.addEventListener("click", e=>{
          const id   = el.getAttribute("data-id");
          const day  = el.getAttribute("data-day");
          const card = items.find(it=>it.id===id);
          if (card) {
            openEntryDialog({
              id:id,
              date:card.date || day,
              title:card.title||"",
              people:Array.isArray(card.people)?card.people.join("; "):(card.people||""),
              vehicle:card.vehicle||"",
              note:card.note||"",
              status:card.status||"normal"
            });
          }
        });
      });
    }

    /* ==========================
       6. Online/Offline Anzeige
       ========================== */
    function setOnline(isOk){
      if (isOk){
        cloudDot.classList.add("dot-online");
        cloudDot.classList.remove("dot-offline");
        cloudText.textContent="verbunden";
      } else {
        cloudDot.classList.remove("dot-online");
        cloudDot.classList.add("dot-offline");
        cloudText.textContent="getrennt";
      }
    }

    /* ==========================
       7. Eintrags-Dialog öffnen / speichern
       ========================== */

    function openEntryDialog(data={}){
      // data = {id?, date, title, people, vehicle, note, status}
      entryDlgTitle.textContent = data.id ? "Eintrag bearbeiten" : "Neuer Eintrag";

      fId.value      = data.id || "";
      fDate.value    = data.date || todayISO();
      fTitle.value   = data.title || "";
      fPeople.value  = data.people || "";
      fVehicle.value = data.vehicle || "";
      fNote.value    = data.note || "";
      fStatus.value  = data.status || "normal";

      entryDlg.showModal();
    }

    btnEntryCancel.addEventListener("click", e=>{
      e.preventDefault();
      entryDlg.close();
    });

    btnEntrySave.addEventListener("click", async e=>{
      e.preventDefault();

      const payload = {
        date: fDate.value || todayISO(),
        title: fTitle.value.trim(),
        people: fPeople.value
          ? fPeople.value.split(";").map(s=>s.trim()).filter(Boolean)
          : [],
        vehicle: fVehicle.value.trim(),
        note: fNote.value.trim(),
        status: fStatus.value,
        updatedAt: serverTimestamp()
      };

      const idExisting = fId.value.trim();

      try {
        if (idExisting) {
          // Update
          const ref = doc(db, "plantafel", idExisting);
          await updateDoc(ref, payload);
        } else {
          // Neu
          const colRef = collection(db, "plantafel");
          await addDoc(colRef, {
            ...payload,
            createdAt: serverTimestamp()
          });
        }
      } catch(err){
        console.error("Speichern FEHLER:", err);
        alert("Konnte nicht speichern ("+err.message+")");
      }

      entryDlg.close();
    });

    /* ==========================
       8. Stammdaten-Dialog
       ========================== */
    btnMaster.addEventListener("click", ()=>{
      masterDlg.showModal();
    });
    btnMasterClose.addEventListener("click", e=>{
      e.preventDefault();
      masterDlg.close();
    });

    /* ==========================
       9. Toolbar-Interaktionen
       ========================== */
    function reloadNow(){
      listenRange();
    }

    btnReload.addEventListener("click", reloadNow);
    btnAddTop.addEventListener("click", ()=>openEntryDialog({date:startDateInp.value}));
    fabPlus.addEventListener("click", ()=>openEntryDialog({date:todayISO()}));

    startDateInp.addEventListener("change", reloadNow);
    viewSel.addEventListener("change", reloadNow);

    // Auto-Reload alle 30 Sek, wenn Checkbox an
    setInterval(()=>{
      if (chkAuto.checked){
        listenRange();
      }
    }, 30000);

    /* ==========================
       10. Start
       ========================== */

    listenRange(); // initial anhören / rendern

    /* ==========================
       11. Kleine Hilfsfunktion für HTML-Escaping
       ========================== */
    function esc(str){
      return (str||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

  </script>
</body>
</html>
