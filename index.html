<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Plantafel Dachdeckerei Frey – V5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ------------------------------
   GLOBAL DESIGN
--------------------------------*/
:root {
  --blue:#0b63c6;
  --bg:#eef0f5;
  --white:#ffffff;
  --line:#d0d4dd;
  --text:#0f172a;

  /* Statusfarben */
  --urlaub:#facc15;
  --krank:#ef4444;
  --schule:#38bdf8;

  /* Fahrzeuge */
  --vehicle:#cc0000;
}

* {
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body {
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* ------------------------------
   HEADER BAR
--------------------------------*/
header {
  background: var(--blue);
  color: #fff;
  padding: .7rem 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

header h1 {
  font-size:1.25rem;
  margin:0;
  font-weight:600;
}

/* Ansichts-Tabs */
.btn-tabs {
  display:flex;
  gap:.4rem;
}
.btn-tabs button {
  background: rgba(255,255,255,.15);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
  padding:.35rem .7rem;
  font-weight:600;
  border-radius:6px;
  cursor:pointer;
}
.btn-tabs button.active {
  background:#fff;
  color:var(--blue);
}

/* Datum */
input[type="date"] {
  border:1px solid rgba(255,255,255,.3);
  background:rgba(255,255,255,.25);
  color:#fff;
  padding:.25rem .4rem;
  border-radius:6px;
}

/* Buttons */
.btn {
  background:#fff;
  color:var(--blue);
  border:none;
  border-radius:6px;
  padding:.35rem .75rem;
  font-weight:600;
  cursor:pointer;
}
.btn.secondary {
  background:rgba(255,255,255,.25);
  color:#fff;
}

/* Legende */
.legend {
  margin-left:auto;
  padding:.4rem .7rem;
  background:rgba(255,255,255,.2);
  border-radius:6px;
  display:flex;
  flex-direction:column;
  gap:.35rem;
  font-size:.7rem;
}
.legend-row {
  display:flex;
  align-items:center;
  gap:.4rem;
}
.legend-color {
  width:14px;
  height:14px;
  border-radius:3px;
  border:1px solid #fff;
}

/* ------------------------------
   MAIN BEREICH
--------------------------------*/
main {
  padding:1rem;
}

/* Grund-Boxen (Tage & Monate) */
.box-wrapper {
  display:grid;
  gap:1rem;
}

.day-box, .month-box {
  background:var(--white);
  border:1px solid var(--line);
  border-radius:10px;
  display:flex;
  flex-direction:column;
  min-height:170px;
}

.day-head, .month-head {
  background:#f1f5f9;
  padding:.5rem .6rem;
  font-weight:600;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
}

/* Monatsgitter 3x4 */
.months-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:1rem;
}

/* Eintrag-Karte (neu, modern) */
.entry {
  background:#fff;
  border-radius:6px;
  padding:.3rem .5rem;
  font-size:.75rem;
  border:1px solid rgba(0,0,0,.07);
  box-shadow:0 1px 2px rgba(0,0,0,.1);
  cursor:pointer;
  display:flex;
  gap:.5rem;
}

/* Farbleiste links */
.entry-color {
  width:6px;
  border-radius:3px;
}

/* Eintrag Inhalt */
.entry-content {
  flex:1;
}
.entry-title {
  font-weight:600;
  margin-bottom:.15rem;
}
.entry-meta {
  font-size:.68rem;
  line-height:1.3;
}

/* Fahrzeugzeile */
.entry-vehicle {
  color:var(--vehicle);
  font-size:.68rem;
  margin-top:.1rem;
}

/* Buttons in Karten (z.B. verschieben) */
.entry-actions {
  display:flex;
  flex-direction:column;
  gap:.25rem;
}
.entry-actions button {
  font-size:.6rem;
  padding:.15rem .3rem;
  border-radius:5px;
  border:1px solid #bbb;
  background:#f9fafb;
  cursor:pointer;
}

/* Dialog-Design */
dialog {
  border:none;
  border-radius:12px;
  padding:1rem 1.2rem;
  width:min(95vw,500px);
  box-shadow:0 18px 50px rgba(0,0,0,.25);
}
dialog::backdrop {
  background:rgba(0,0,0,.4);
}

label {
  font-size:.8rem;
  font-weight:600;
  margin-top:.7rem;
}
input, textarea, select {
  width:100%;
  border:1px solid #ccd;
  padding:.35rem .4rem;
  border-radius:6px;
}
textarea { min-height:60px; }

.checklist {
  border:1px solid #ccd;
  padding:.35rem;
  border-radius:6px;
  max-height:130px;
  overflow-y:auto;
}
.checklist label {
  display:flex;
  align-items:center;
  gap:.35rem;
  font-weight:500;
}

/* Fußzeile */
footer {
  background:var(--blue);
  color:#fff;
  text-align:center;
  padding:.5rem;
  font-size:.7rem;
  margin-top:2rem;
}
</style>
</head>

<body>

<header>
  <h1>Plantafel Dachdeckerei Frey</h1>

  <div class="btn-tabs" id="viewTabs">
    <button class="active" data-view="14d">14 Tage</button>
    <button data-view="4w">4 Wochen</button>
    <button data-view="12m">12 Monate</button>
  </div>

  <div>
    Start:
    <input type="date" id="startDate">
  </div>

  <button id="prevMonthBtn">&#9664;</button>
  <button id="nextMonthBtn">&#9654;</button>

  <button class="btn secondary" id="reloadBtn">Neu laden</button>
  <button class="btn secondary" id="backupBtn">Backup</button>
  <button class="btn secondary" id="stammBtn">Stammdaten</button>
  <button class="btn" id="newEntryBtn">+ Eintrag</button>

  <div class="legend">
    <div class="legend-row"><div class="legend-color" style="background:var(--urlaub)"></div> Urlaub</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--krank)"></div> Krank</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--schule)"></div> Schule</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--vehicle)"></div> Fahrzeug</div>
  </div>
</header>

<main>
  <div id="boardContainer"></div>
</main>
<!-- ===================================================
     DIALOG: EINTRAG
=================================================== -->
<dialog id="entryDialog">
  <form id="entryForm" method="dialog">

    <h2>Eintrag</h2>

    <label>Baustelle / Auftrag
      <input type="text" id="fTitel" required>
    </label>

    <label>Von
      <input type="date" id="fVon" required>
    </label>

    <label>Bis (optional)
      <input type="date" id="fBis">
    </label>

    <label>Mitarbeiter</label>
    <div id="fMitarbeiterBox" class="checklist"></div>

    <label>Fahrzeuge</label>
    <div id="fFahrzeugeBox" class="checklist"></div>

    <label>Status</label>
    <select id="fStatus">
      <option value="">normal</option>
      <option value="Urlaub">Urlaub</option>
      <option value="Krank">Krank</option>
      <option value="Schule">Schule</option>
    </select>

    <label>Notiz</label>
    <textarea id="fNotiz"></textarea>

    <input type="hidden" id="fId">

    <div style="margin-top:1rem; display:flex; justify-content:space-between;">
      <button type="button" id="entryDeleteBtn"
        style="background:#fee2e2; border:1px solid #fca5a5; padding:.4rem .7rem; border-radius:6px;">
        Löschen
      </button>

      <div>
        <button type="button" id="entryCancelBtn">Abbrechen</button>
        <button class="btn" type="submit">Speichern</button>
      </div>
    </div>

  </form>
</dialog>


<!-- ===================================================
     DIALOG: STAMMDATEN
=================================================== -->
<dialog id="stammDialog">
  <h2>Stammdaten</h2>

  <label>Neuer Mitarbeiter</label>
  <input type="text" id="sMitarbeiter">
  <button class="btn" id="addMitarbeiterBtn">+ hinzufügen</button>
  <div id="listMitarbeiter" style="margin:.6rem 0;"></div>

  <label>Neues Fahrzeug</label>
  <input type="text" id="sFahrzeug">
  <button class="btn" id="addFahrzeugBtn">+ hinzufügen</button>
  <div id="listFahrzeuge" style="margin:.6rem 0;"></div>

  <label>Neue Baustelle (Nur für Grobplanung)</label>
  <input type="text" id="sBaustelle">
  <button class="btn" id="addBaustelleBtn">+ hinzufügen</button>
  <div id="listBaustellen" style="margin:.6rem 0;"></div>

  <div style="text-align:right; margin-top:1rem;">
    <button id="stammCloseBtn">Schließen</button>
  </div>
</dialog>


<!-- ===================================================
     DIALOG: VERSCHIEBEN (DATUM WÄHLEN)
=================================================== -->
<dialog id="moveDialog">
  <form id="moveForm" method="dialog">
    <h2>Verschieben</h2>

    <p style="margin-bottom:.7rem;">Neues Datum wählen:</p>
    <input type="date" id="moveDate" required>
    <input type="hidden" id="moveId">

    <div style="margin-top:1rem; display:flex; justify-content:space-between;">
      <button type="button" id="moveCancelBtn">Abbrechen</button>
      <button class="btn" type="submit">Verschieben</button>
    </div>
  </form>
</dialog>


<!-- ===================================================
     DIALOG: BACKUP
=================================================== -->
<dialog id="backupDialog">
  <h2>Backup</h2>

  <button class="btn" id="downloadBackupBtn">Backup herunterladen</button>

  <label style="margin-top:1rem;">Backup importieren</label>
  <input type="file" id="importFile">

  <div style="text-align:right; margin-top:1rem;">
    <button id="backupCloseBtn">Schließen</button>
  </div>
</dialog>


<!-- ===================================================
     SUPABASE VERBINDUNG
=================================================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* Supabase */
const SUPA_URL  = "https://mtybmrkyhavxpvwysglo.supabase.co";
const SUPA_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
const supa = supabase.createClient(SUPA_URL, SUPA_KEY);

/* Daten-Arrays */
let mitarbeiter = [];
let fahrzeuge   = [];
let baustellen  = [];
let eintraege   = [];
let currentView = "14d"; // 14d, 4w, 12m
/* ===================================================
    HILFSFUNKTIONEN
=================================================== */

/* Zufallsfarbe aus Name (immer gleich) */
function colorFromName(name) {
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360;
  return `hsl(${h}, 70%, 45%)`;
}


/* ===================================================
    DATEN LADEN
=================================================== */

async function loadAll() {
  const m = await supa.from("mitarbeiter").select().order("name");
  mitarbeiter = m.data || [];

  const f = await supa.from("fahrzeuge").select().order("name");
  fahrzeuge = f.data || [];

  const b = await supa.from("baustellen").select().order("name");
  baustellen = b.data || [];

  const e = await supa.from("plantafel").select().order("tag");
  eintraege = e.data || [];

  renderBoard();
  renderStammListen();
}


/* ===================================================
    BOARD RENDERN
=================================================== */

function renderBoard() {
  const cont = document.getElementById("boardContainer");
  cont.innerHTML = "";

  const start = new Date(document.getElementById("startDate").value);
  if (isNaN(start)) return;

  if (currentView === "14d")      render14Days(start);
  if (currentView === "4w")       render4Weeks(start);
  if (currentView === "12m")      render12Months(start);
}


/* ===================================================
    14 TAGE (Mo–Fr)
=================================================== */
function render14Days(start) {
  const wrap = document.createElement("div");
  wrap.className = "box-wrapper";
  wrap.style.gridTemplateColumns = "repeat(7,1fr)";

  let d = new Date(start);
  let count = 0;

  while (count < 14) {
    if (d.getDay() !== 0 && d.getDay() !== 6) {
      wrap.appendChild(buildDayBox(new Date(d)));
      count++;
    }
    d.setDate(d.getDate() + 1);
  }

  document.getElementById("boardContainer").appendChild(wrap);
}


/* ===================================================
    4 WOCHEN (Mo–Fr)
=================================================== */
function render4Weeks(start) {
  const wrap = document.createElement("div");
  wrap.className = "box-wrapper";
  wrap.style.gridTemplateColumns = "repeat(5,1fr)";

  const s = new Date(start);
  const weekday = s.getDay();
  const diff = weekday === 0 ? 6 : weekday - 1;
  s.setDate(s.getDate() - diff);

  for (let w = 0; w < 4; w++) {
    for (let wd = 0; wd < 5; wd++) {
      const d = new Date(s);
      d.setDate(s.getDate() + w * 7 + wd);
      wrap.appendChild(buildDayBox(d));
    }
  }

  document.getElementById("boardContainer").appendChild(wrap);
}


/* ===================================================
    12 MONATE (3×4)
=================================================== */
function render12Months(startDate) {
  const wrap = document.createElement("div");
  wrap.className = "months-grid";

  const year = startDate.getFullYear();

  for (let m = 0; m < 12; m++) {
    const d = new Date(year, m, 1);

    const box = document.createElement("div");
    box.className = "month-box";
    box.dataset.month = d.toISOString().slice(0, 7);

    /* Drag & Drop */
    box.ondragover = ev => ev.preventDefault();
    box.ondrop = ev => {
      ev.preventDefault();
      const id = ev.dataTransfer.getData("entry-id");
      openMoveDialog(id);
    };

    const head = document.createElement("div");
    head.className = "month-head";
    head.textContent = d.toLocaleString("de-DE", { month: "long", year: "numeric" });

    const body = document.createElement("div");
    body.style.padding = ".5rem";
    body.style.display = "flex";
    body.style.flexDirection = "column";
    body.style.gap = ".4rem";

    /* Einträge des Monats */
    eintraege
      .filter(e => {
        const ed = new Date(e.tag);
        return ed.getFullYear() === year && ed.getMonth() === m;
      })
      .forEach(e => body.appendChild(buildEntryCard(e)));

    box.appendChild(head);
    box.appendChild(body);
    wrap.appendChild(box);
  }

  document.getElementById("boardContainer").appendChild(wrap);
}



/* ===================================================
    TAG-KARTE BAUEN
=================================================== */
function buildDayBox(dateObj) {
  const box = document.createElement("div");
  box.className = "day-box";
  const dateStr = dateObj.toISOString().slice(0, 10);

  box.dataset.date = dateStr;

  box.ondragover = ev => ev.preventDefault();
  box.ondrop = ev => {
    ev.preventDefault();
    const id = ev.dataTransfer.getData("entry-id");
    openMoveDialog(id);
  };

  const head = document.createElement("div");
  head.className = "day-head";
  head.innerHTML = dateObj.toLocaleDateString("de-DE", {
    weekday: "short", day: "2-digit", month: "2-digit", year: "numeric"
  });

  /* Klick auf Datum → neuer Eintrag */
  head.style.cursor = "pointer";
  head.onclick = () => openEntryDialog({ tag: dateStr });

  const body = document.createElement("div");
  body.style.padding = ".5rem";
  body.style.display = "flex";
  body.style.flexDirection = "column";
  body.style.gap = ".4rem";

  eintraege
    .filter(e => e.tag === dateStr)
    .forEach(e => body.appendChild(buildEntryCard(e)));

  box.appendChild(head);
  box.appendChild(body);
  return box;
}


/* ===================================================
    EINTRAG-KARTE
=================================================== */
function buildEntryCard(e) {
  const card = document.createElement("div");
  card.className = "entry";
  card.draggable = true;
  card.dataset.id = e.id;

  card.ondragstart = ev => {
    ev.dataTransfer.setData("entry-id", e.id);
  };

  const color = document.createElement("div");
  color.className = "entry-color";

  /* Statusfarben */
  if (e.status === "Urlaub") color.style.background = "var(--urlaub)";
  else if (e.status === "Krank") color.style.background = "var(--krank)";
  else if (e.status === "Schule") color.style.background = "var(--schule)";
  else if (e.mitarbeiter) {
    color.style.background = colorFromName(e.mitarbeiter.split(",")[0]);
  } else {
    color.style.background = "#999";
  }

  const content = document.createElement("div");
  content.className = "entry-content";

  const title = document.createElement("div");
  title.className = "entry-title";
  title.textContent = e.titel;

  const meta = document.createElement("div");
  meta.className = "entry-meta";

  if (e.mitarbeiter)
    meta.innerHTML += e.mitarbeiter + "<br>";

  if (e.fahrzeug)
    meta.innerHTML += `<span class="entry-vehicle">${e.fahrzeug}</span>`;

  const actions = document.createElement("div");
  actions.className = "entry-actions";

  const btnEdit = document.createElement("button");
  btnEdit.textContent = "Bearbeiten";
  btnEdit.onclick = ev => {
    ev.stopPropagation();
    openEntryDialog(e);
  };

  const btnMove = document.createElement("button");
  btnMove.textContent = "Verschieben";
  btnMove.onclick = ev => {
    ev.stopPropagation();
    openMoveDialog(e.id);
  };

  const btnDelete = document.createElement("button");
  btnDelete.textContent = "Löschen";
  btnDelete.onclick = async ev => {
    ev.stopPropagation();
    await deleteEntry(e.id);
  };

  actions.append(btnEdit, btnMove, btnDelete);

  content.append(title, meta);
  card.append(color, content, actions);

  return card;
}


/* ===================================================
    EINTRAG-SPEICHERN UND LÖSCHEN
=================================================== */

async function deleteEntry(id) {
  await supa.from("plantafel").delete().eq("id", id);
  loadAll();
}

async function saveEntry(formData) {
  const id = formData.id;

  if (!id) {
    /* Neuer Eintrag */
    let start = new Date(formData.von);
    let end = formData.bis ? new Date(formData.bis) : new Date(formData.von);

    const rows = [];
    while (start <= end) {
      rows.push({
        titel: formData.titel,
        mitarbeiter: formData.mitarbeiter,
        fahrzeug: formData.fahrzeug,
        status: formData.status,
        notiz: formData.notiz,
        tag: start.toISOString().slice(0, 10)
      });
      start.setDate(start.getDate() + 1);
    }

    await supa.from("plantafel").insert(rows);
  } else {
    /* Bestehender Eintrag aktualisieren */
    await supa.from("plantafel")
      .update({
        titel: formData.titel,
        mitarbeiter: formData.mitarbeiter,
        fahrzeug: formData.fahrzeug,
        status: formData.status,
        notiz: formData.notiz,
        tag: formData.von
      })
      .eq("id", id);
  }

  loadAll();
}


/* ===================================================
    VERSCHIEBEN MIT DATUM
=================================================== */

function openMoveDialog(id) {
  document.getElementById("moveId").value = id;
  document.getElementById("moveDate").value = "";
  moveDialog.showModal();
}

moveForm.onsubmit = async (ev) => {
  ev.preventDefault();
  const id = document.getElementById("moveId").value;
  const newDate = document.getElementById("moveDate").value;

  await supa.from("plantafel").update({ tag: newDate }).eq("id", id);

  moveDialog.close();
  loadAll();
};


/* ===================================================
    STAMMDATEN LISTEN
=================================================== */

function renderStammListen() {
  const lm = document.getElementById("listMitarbeiter");
  const lf = document.getElementById("listFahrzeuge");
  const lb = document.getElementById("listBaustellen");

  lm.innerHTML = "";
  lf.innerHTML = "";
  lb.innerHTML = "";

  mitarbeiter.forEach(m => {
    const d = document.createElement("div");
    d.innerHTML =
      `<span>${m.name}</span> 
       <button onclick="delStamm('mitarbeiter', ${m.id})">x</button>`;
    lm.appendChild(d);
  });

  fahrzeuge.forEach(f => {
    const d = document.createElement("div");
    d.innerHTML =
      `<span>${f.name}</span> 
       <button onclick="delStamm('fahrzeuge', ${f.id})">x</button>`;
    lf.appendChild(d);
  });

  baustellen.forEach(b => {
    const d = document.createElement("div");
    d.innerHTML =
      `<span>${b.name}</span> 
       <button onclick="delStamm('baustellen', ${b.id})">x</button>`;
    lb.appendChild(d);
  });
}

async function delStamm(table, id) {
  await supa.from(table).delete().eq("id", id);
  loadAll();
}


/* ===================================================
    BACKUP
=================================================== */

downloadBackupBtn.onclick = () => {
  const data = JSON.stringify(eintraege, null, 2);
  const blob = new Blob([data], { type: "application/json" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plantafel_backup.json";
  a.click();
};

importFile.onchange = async () => {
  const file = importFile.files[0];
  const text = await file.text();
  const arr = JSON.parse(text);

  await supa.from("plantafel").delete().neq("id", -1);
  await supa.from("plantafel").insert(arr);

  loadAll();
};


/* ===================================================
    PDF (nur 14 & 4 Wochen)
=================================================== */

function exportPDF() {
  window.print();
}


/* ===================================================
    BUTTON-EVENTS
=================================================== */

document.getElementById("newEntryBtn").onclick = () =>
  openEntryDialog({});

document.getElementById("stammBtn").onclick = () =>
  stammDialog.showModal();

document.getElementById("entryCancelBtn").onclick = () =>
  entryDialog.close();

document.getElementById("stammCloseBtn").onclick = () =>
  stammDialog.close();

document.getElementById("backupBtn").onclick = () =>
  backupDialog.showModal();

document.getElementById("backupCloseBtn").onclick = () =>
  backupDialog.close();

document.getElementById("entryDeleteBtn").onclick = async () => {
  const id = document.getElementById("fId").value;
  if (id) {
    await deleteEntry(id);
    entryDialog.close();
  }
};

document.getElementById("prevMonthBtn").onclick = () => {
  const d = new Date(startDate.value);
  d.setMonth(d.getMonth() - 1);
  startDate.value = d.toISOString().slice(0, 10);
  renderBoard();
};

document.getElementById("nextMonthBtn").onclick = () => {
  const d = new Date(startDate.value);
  d.setMonth(d.getMonth() + 1);
  startDate.value = d.toISOString().slice(0, 10);
  renderBoard();
};


/* Wechsel der Ansicht */
document.getElementById("viewTabs").onclick = (e) => {
  if (e.target.tagName !== "BUTTON") return;

  viewTabs.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  e.target.classList.add("active");

  currentView = e.target.dataset.view;
  renderBoard();
};


/* Form speichern */
entryForm.onsubmit = (ev) => {
  ev.preventDefault();

  const data = {
    id: document.getElementById("fId").value || null,
    titel: document.getElementById("fTitel").value,
    von: document.getElementById("fVon").value,
    bis: document.getElementById("fBis").value,
    status: document.getElementById("fStatus").value,
    notiz: document.getElementById("fNotiz").value,
    mitarbeiter: getChecklist("fMitarbeiterBox"),
    fahrzeug: getChecklist("fFahrzeugeBox")
  };

  entryDialog.close();
  saveEntry(data);
};


/* Checklisten */
function getChecklist(id) {
  return Array.from(document.querySelectorAll(`#${id} input:checked`))
    .map(x => x.value)
    .join(", ");
}


/* Start */
loadAll();

</script>

<footer>
  © 2025 Dachdeckerei Frey – Digitale Plantafel V5
</footer>

</body>
</html>
