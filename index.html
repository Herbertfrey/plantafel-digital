<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Plantafel Dachdeckerei Frey – V5</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* --------------------------------------------------------
   GLOBAL DESIGN
-------------------------------------------------------- */
:root {
  --blue:#0b63c6;
  --bg:#eef0f5;
  --white:#ffffff;
  --line:#d0d4dd;
  --text:#0f172a;

  /* Statusfarben */
  --urlaub:#facc15;
  --krank:#ef4444;
  --schule:#38bdf8;

  /* Fahrzeuge */
  --vehicle:#cc0000;
}

* {
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body {
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* --------------------------------------------------------
   HEADER
-------------------------------------------------------- */
header {
  background: var(--blue);
  color: #fff;
  padding: .7rem 1rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

header h1 {
  font-size:1.25rem;
  margin:0;
  font-weight:600;
}

/* Tabs */
.btn-tabs {
  display:flex;
  gap:.4rem;
}
.btn-tabs button {
  background: rgba(255,255,255,.15);
  color:#fff;
  border:1px solid rgba(255,255,255,.3);
  padding:.35rem .7rem;
  font-weight:600;
  border-radius:6px;
  cursor:pointer;
}
.btn-tabs button.active {
  background:#fff;
  color:var(--blue);
}

/* Datum */
input[type="date"] {
  border:1px solid rgba(255,255,255,.3);
  background:rgba(255,255,255,.25);
  color:#fff;
  padding:.25rem .4rem;
  border-radius:6px;
}

/* Buttons */
.btn {
  background:#fff;
  color:var(--blue);
  border:none;
  border-radius:6px;
  padding:.35rem .75rem;
  font-weight:600;
  cursor:pointer;
}
.btn.secondary {
  background:rgba(255,255,255,.25);
  color:#fff;
}

/* Legende */
.legend {
  margin-left:auto;
  padding:.4rem .7rem;
  background:rgba(255,255,255,.2);
  border-radius:6px;
  display:flex;
  flex-direction:column;
  gap:.35rem;
  font-size:.7rem;
}
.legend-row {
  display:flex;
  align-items:center;
  gap:.4rem;
}
.legend-color {
  width:14px;
  height:14px;
  border-radius:3px;
  border:1px solid #fff;
}

/* --------------------------------------------------------
   MAIN
-------------------------------------------------------- */
main {
  padding:1rem;
}

/* Grundboxen */
.box-wrapper {
  display:grid;
  gap:1rem;
}

.day-box, .month-box {
  background:var(--white);
  border:1px solid var(--line);
  border-radius:10px;
  display:flex;
  flex-direction:column;
  min-height:170px;
}

.day-head, .month-head {
  background:#f1f5f9;
  padding:.5rem .6rem;
  font-weight:600;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
}

/* Monatsgitter 3x4 */
.months-grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:1rem;
}

/* Eintrag-Karte */
.entry {
  background:#fff;
  border-radius:6px;
  padding:.3rem .5rem;
  font-size:.75rem;
  border:1px solid rgba(0,0,0,.07);
  box-shadow:0 1px 2px rgba(0,0,0,.1);
  cursor:pointer;
  display:flex;
  gap:.5rem;
  margin:.35rem;
}

.entry-color {
  width:6px;
  border-radius:3px;
}

.entry-content {
  flex:1;
}
.entry-title {
  font-weight:600;
  margin-bottom:.15rem;
}
.entry-meta {
  font-size:.68rem;
  line-height:1.3;
}
.entry-vehicle {
  color:var(--vehicle);
  font-size:.68rem;
  margin-top:.1rem;
}

/* Button-Spalte in Kärtchen */
.entry-actions {
  display:flex;
  flex-direction:column;
  gap:.25rem;
}
.entry-actions button {
  font-size:.6rem;
  padding:.15rem .3rem;
  border-radius:5px;
  border:1px solid #bbb;
  background:#f9fafb;
  cursor:pointer;
}

/* Dialog */
dialog {
  border:none;
  border-radius:12px;
  padding:1rem 1.2rem;
  width:min(95vw,500px);
  box-shadow:0 18px 50px rgba(0,0,0,.25);
}
dialog::backdrop {
  background:rgba(0,0,0,.4);
}

label {
  font-size:.8rem;
  font-weight:600;
  margin-top:.7rem;
}
input, textarea, select {
  width:100%;
  border:1px solid #ccd;
  padding:.35rem .4rem;
  border-radius:6px;
}
textarea { min-height:60px; }

.checklist {
  border:1px solid #ccd;
  padding:.35rem;
  border-radius:6px;
  max-height:130px;
  overflow-y:auto;
}
.checklist label {
  display:flex;
  align-items:center;
  gap:.35rem;
  font-weight:500;
}

/* Footer */
footer {
  background:var(--blue);
  color:#fff;
  text-align:center;
  padding:.5rem;
  font-size:.7rem;
  margin-top:2rem;
}
</style>
</head>

<body>

<header>
  <h1>Plantafel Dachdeckerei Frey</h1>

  <div class="btn-tabs" id="viewTabs">
    <button class="active" data-view="14d">14 Tage</button>
    <button data-view="4w">4 Wochen</button>
    <button data-view="12m">12 Monate</button>
  </div>

  <div>
    Start:
    <input type="date" id="startDate">
  </div>

  <button id="prevMonthBtn">&#9664;</button>
  <button id="nextMonthBtn">&#9654;</button>

  <button class="btn secondary" id="reloadBtn">Neu laden</button>
  <button class="btn secondary" id="backupBtn">Backup</button>
  <button class="btn secondary" id="stammBtn">Stammdaten</button>
  <button class="btn" id="newEntryBtn">+ Eintrag</button>

  <div class="legend">
    <div class="legend-row"><div class="legend-color" style="background:var(--urlaub)"></div> Urlaub</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--krank)"></div> Krank</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--schule)"></div> Schule</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--vehicle)"></div> Fahrzeug</div>
  </div>
</header>

<main>
  <div id="boardContainer"></div>
</main>
<!-- --------------------------------------------------------
     DIALOGE – EINTRAG, STAMMDATEN, BACKUP, PDF, VERSCHIEBEN
--------------------------------------------------------- -->

<!-- EINTRAG DIALOG -->
<dialog id="entryDialog">
  <form id="entryForm" method="dialog">
    <h3>Eintrag bearbeiten / neu</h3>

    <label>Baustelle / Auftrag
      <input type="text" id="fBaustelle" required>
    </label>

    <label>Von
      <input type="date" id="fVon" required>
    </label>

    <label>Bis (optional)
      <input type="date" id="fBis">
    </label>

    <label>Mitarbeiter</label>
    <div class="checklist" id="fMitarbeiterBox"></div>

    <label>Fahrzeuge</label>
    <div class="checklist" id="fFahrzeugeBox"></div>

    <label>Status
      <select id="fStatus">
        <option value="">normal</option>
        <option>Urlaub</option>
        <option>Krank</option>
        <option>Schule</option>
      </select>
    </label>

    <label>Notiz
      <textarea id="fNotiz"></textarea>
    </label>

    <input type="hidden" id="fId">

    <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end;">
      <button type="button" id="deleteEntryBtn"
        style="background:#fee2e2;border:1px solid #fca5a5;border-radius:6px;padding:.35rem .6rem;display:none;">
        Löschen
      </button>

      <button type="button" onclick="entryDialog.close()">Abbrechen</button>
      <button class="btn">Speichern</button>
    </div>
  </form>
</dialog>

<!-- STAMMDATEN DIALOG -->
<dialog id="stammDialog">
  <h3>Stammdaten</h3>

  <label>Neuer Mitarbeiter
    <input type="text" id="sMitarbeiter">
  </label>
  <button class="btn" type="button" onclick="addStamm('mitarbeiter')">+ hinzufügen</button>
  <div id="listMitarbeiter" style="margin:.5rem 0;"></div>

  <label>Neues Fahrzeug
    <input type="text" id="sFahrzeug">
  </label>
  <button class="btn" type="button" onclick="addStamm('fahrzeuge')">+ hinzufügen</button>
  <div id="listFahrzeuge" style="margin:.5rem 0;"></div>

  <label>Neue Baustelle
    <input type="text" id="sBaustelle">
  </label>
  <button class="btn" type="button" onclick="addStamm('baustellen')">+ hinzufügen</button>
  <div id="listBaustellen" style="margin:.5rem 0;"></div>

  <button style="margin-top:1rem;" onclick="stammDialog.close()">Schließen</button>
</dialog>

<!-- VERSCHIEBEN MIT DATUM -->
<dialog id="moveDialog">
  <h3>Verschieben auf neues Datum</h3>

  <label>Datum wählen
    <input type="date" id="moveDate">
  </label>

  <input type="hidden" id="moveEntryId">

  <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end;">
    <button onclick="moveDialog.close()">Abbrechen</button>
    <button class="btn" onclick="confirmMove()">Verschieben</button>
  </div>
</dialog>

<!-- BACKUP DIALOG -->
<dialog id="backupDialog">
  <h3>Backup</h3>

  <button class="btn" id="exportBackupBtn">Backup herunterladen</button>

  <label style="margin-top:1rem;">Backup importieren
    <input type="file" id="backupFileInput" accept=".json">
  </label>

  <button class="btn" id="importBackupBtn" style="margin-top:.7rem;">Import starten</button>

  <button style="margin-top:1rem;" onclick="backupDialog.close()">Schließen</button>
</dialog>

<!-- PDF DIALOG -->
<dialog id="pdfDialog">
  <h3>PDF Export</h3>
  <p>Wähle die Ansicht:</p>

  <button class="btn" id="pdf14Btn">PDF – 14 Tage</button>
  <button class="btn" id="pdf4wBtn" style="margin-top:.5rem;">PDF – 4 Wochen</button>

  <button style="margin-top:1rem;" onclick="pdfDialog.close()">Schließen</button>
</dialog>


<!-- --------------------------------------------------------
     SCRIPT IMPORTS
-------------------------------------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* --------------------------------------------------------
   DOM ELEMENTE
-------------------------------------------------------- */
const boardContainer = document.getElementById("boardContainer");
const viewTabs = document.getElementById("viewTabs");
const startDateInput = document.getElementById("startDate");

const prevMonthBtn = document.getElementById("prevMonthBtn");
const nextMonthBtn = document.getElementById("nextMonthBtn");

const reloadBtn = document.getElementById("reloadBtn");
const backupBtn = document.getElementById("backupBtn");
const stammBtn = document.getElementById("stammBtn");
const newEntryBtn = document.getElementById("newEntryBtn");

const entryDialog = document.getElementById("entryDialog");
const entryForm = document.getElementById("entryForm");
const deleteEntryBtn = document.getElementById("deleteEntryBtn");

const stammDialog = document.getElementById("stammDialog");
const backupDialog = document.getElementById("backupDialog");
const pdfDialog = document.getElementById("pdfDialog");

const moveDialog = document.getElementById("moveDialog");
const moveDateInput = document.getElementById("moveDate");
const moveEntryIdInput = document.getElementById("moveEntryId");

const exportBackupBtn = document.getElementById("exportBackupBtn");
const importBackupBtn = document.getElementById("importBackupBtn");
const backupFileInput = document.getElementById("backupFileInput");

const pdf14Btn = document.getElementById("pdf14Btn");
const pdf4wBtn = document.getElementById("pdf4wBtn");

/* --------------------------------------------------------
   SUPABASE VERBINDUNG
-------------------------------------------------------- */
const supa = supabase.createClient(
  "https://mtybmrkyhavxpvwysglo.supabase.co",
  "sb_publishable_0w8pZSpEAxxlv9Ke6dcurg_OuAl4q7r"
);

/* --------------------------------------------------------
   DATEN ARRAYS
-------------------------------------------------------- */
let mitarbeiter = [];
let fahrzeuge = [];
let baustellen = [];
let eintraege = [];

let currentView = "14d";
let currentStart = new Date();

/* --------------------------------------------------------
   HELFER – FARBEN
-------------------------------------------------------- */
function colorFromName(name) {
  if (!name) return "#999";
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360;
  return `hsl(${h}, 70%, 45%)`;
}

/* --------------------------------------------------------
   DATEN LADEN
-------------------------------------------------------- */
async function loadAll() {
  const m = await supa.from("mitarbeiter").select().order("name");
  const f = await supa.from("fahrzeuge").select().order("name");
  const b = await supa.from("baustellen").select().order("name");
  const e = await supa.from("plantafel").select().order("tag");

  mitarbeiter = m.data || [];
  fahrzeuge = f.data || [];
  baustellen = b.data || [];
  eintraege = e.data || [];

  renderBoard();
}

/* --------------------------------------------------------
   BACKUP EXPORT
-------------------------------------------------------- */
exportBackupBtn.onclick = () => {
  const data = {
    mitarbeiter,
    fahrzeuge,
    baustellen,
    eintraege
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plantafel-backup.json";
  a.click();
};

/* --------------------------------------------------------
   BACKUP IMPORT
-------------------------------------------------------- */
importBackupBtn.onclick = async () => {
  const file = backupFileInput.files[0];
  if (!file) return alert("Bitte Datei wählen.");

  const text = await file.text();
  const data = JSON.parse(text);

  await supa.from("mitarbeiter").delete().neq("id", 0);
  await supa.from("fahrzeuge").delete().neq("id", 0);
  await supa.from("baustellen").delete().neq("id", 0);
  await supa.from("plantafel").delete().neq("id", 0);

  await supa.from("mitarbeiter").insert(data.mitarbeiter);
  await supa.from("fahrzeuge").insert(data.fahrzeuge);
  await supa.from("baustellen").insert(data.baustellen);
  await supa.from("plantafel").insert(data.eintraege);

  backupDialog.close();
  loadAll();
};

/* --------------------------------------------------------
   STAMMDATEN
-------------------------------------------------------- */
function renderStamm() {
  renderList("listMitarbeiter", mitarbeiter, "mitarbeiter");
  renderList("listFahrzeuge", fahrzeuge, "fahrzeuge");
  renderList("listBaustellen", baustellen, "baustellen");
}

function renderList(id, list, table) {
  const box = document.getElementById(id);
  box.innerHTML = "";
  list.forEach(item => {
    const div = document.createElement("div");
    div.style.margin = ".3rem 0";
    div.innerHTML = `
      <span style="background:#eef;padding:.25rem .4rem;border-radius:4px;">${item.name}</span>
      <button onclick="delStamm('${table}', ${item.id})" style="margin-left:.5rem;">x</button>
    `;
    box.appendChild(div);
  });
}

async function addStamm(type) {
  let value = "";
  if (type === "mitarbeiter") value = document.getElementById("sMitarbeiter").value.trim();
  if (type === "fahrzeuge") value = document.getElementById("sFahrzeug").value.trim();
  if (type === "baustellen") value = document.getElementById("sBaustelle").value.trim();

  if (!value) return;

  await supa.from(type).insert({ name: value });
  loadAll();
}

async function delStamm(type, id) {
  await supa.from(type).delete().eq("id", id);
  loadAll();
}

/* --------------------------------------------------------
  TEIL 2 ENDE
  (JETZT WICHTIG: TEIL 3 LADEN!)
-------------------------------------------------------- */
</script>
<script>
/* --------------------------------------------------------
   RENDER BOARD
-------------------------------------------------------- */
function renderBoard() {
  boardContainer.innerHTML = "";

  if (currentView === "14d") render14Days();
  else if (currentView === "4w") render4Weeks();
  else render12Months();
}

/* --------------------------------------------------------
   14 TAGE
-------------------------------------------------------- */
function render14Days() {
  const wrap = document.createElement("div");
  wrap.className = "box-wrapper";
  wrap.style.gridTemplateColumns = "repeat(auto-fit,minmax(220px,1fr))";

  let d = new Date(currentStart);
  let added = 0;

  while (added < 14) {
    const w = d.getDay();
    if (w !== 0 && w !== 6) {
      wrap.appendChild(buildDayBox(d));
      added++;
    }
    d.setDate(d.getDate() + 1);
  }

  boardContainer.appendChild(wrap);
}

/* --------------------------------------------------------
   4 WOCHEN
-------------------------------------------------------- */
function render4Weeks() {
  const wrap = document.createElement("div");
  wrap.className = "box-wrapper";
  wrap.style.gridTemplateColumns = "repeat(5,1fr)";

  const start = new Date(currentStart);
  const dow = start.getDay();
  const offset = (dow === 0 ? 6 : dow - 1);

  start.setDate(start.getDate() - offset);

  for (let w = 0; w < 4; w++) {
    for (let d = 0; d < 5; d++) {
      const day = new Date(start);
      day.setDate(start.getDate() + w * 7 + d);
      wrap.appendChild(buildDayBox(day));
    }
  }

  boardContainer.appendChild(wrap);
}

/* --------------------------------------------------------
   12 MONATE (3×4)
-------------------------------------------------------- */
function render12Months() {
  const wrap = document.createElement("div");
  wrap.className = "months-grid";

  const base = new Date(currentStart);
  base.setDate(1);

  for (let i = 0; i < 12; i++) {
    const d = new Date(base);
    d.setMonth(base.getMonth() + i);

    wrap.appendChild(buildMonthBox(d));
  }

  boardContainer.appendChild(wrap);
}

/* --------------------------------------------------------
   TAG-BOX (14 & 4 Wochen)
-------------------------------------------------------- */
function buildDayBox(dateObj) {
  const box = document.createElement("div");
  box.className = "day-box";

  const dateStr = dateObj.toISOString().slice(0, 10);

  const head = document.createElement("div");
  head.className = "day-head";
  head.textContent = dateObj.toLocaleString("de-DE", {
    weekday: "short",
    day: "2-digit",
    month: "2-digit"
  });

  // Klick auf Tag → neuer Eintrag
  head.style.cursor = "pointer";
  head.onclick = () => openEntryDialog({ tag: dateStr });

  const body = document.createElement("div");
  body.className = "month-body";

  const items = eintraege.filter(e => e.tag === dateStr);

  items.forEach(e => body.appendChild(buildEntryCard(e)));

  box.dataset.date = dateStr;

  box.ondragover = ev => ev.preventDefault();
  box.ondrop = ev => {
    ev.preventDefault();
    const id = ev.dataTransfer.getData("entry-id");
    moveEntryToDate(id, dateStr);
  };

  box.appendChild(head);
  box.appendChild(body);
  return box;
}

/* --------------------------------------------------------
   MONATS-BOX
-------------------------------------------------------- */
function buildMonthBox(dateObj) {
  const box = document.createElement("div");
  box.className = "month-box";

  const head = document.createElement("div");
  head.className = "month-head";
  head.textContent = dateObj.toLocaleString("de-DE", {
    month: "long",
    year: "numeric"
  });

  const body = document.createElement("div");
  body.className = "month-body";

  const month = dateObj.getMonth();
  const year = dateObj.getFullYear();

  const items = eintraege.filter(e => {
    const t = new Date(e.tag);
    return t.getMonth() === month && t.getFullYear() === year;
  });

  items.forEach(e => body.appendChild(buildEntryCard(e)));

  box.ondragover = ev => ev.preventDefault();
  box.ondrop = ev => {
    ev.preventDefault();
    const id = ev.dataTransfer.getData("entry-id");
    showMoveDialog(id);
  };

  box.appendChild(head);
  box.appendChild(body);

  return box;
}

/* --------------------------------------------------------
   EINTRAG-KARTE
-------------------------------------------------------- */
function buildEntryCard(e) {
  const card = document.createElement("div");
  card.className = "entry";
  card.dataset.id = e.id;
  card.draggable = true;

  /* Drag Start */
  card.ondragstart = ev => {
    ev.dataTransfer.setData("entry-id", e.id);
  };

  /* Klick öffnet Dialog */
  card.onclick = () => openEntryDialog(e);

  /* Farb-Leiste (Mitarbeiterfarbe) */
  const col = document.createElement("div");
  col.className = "entry-color";

  if (e.status === "Urlaub") col.style.background = "var(--urlaub)";
  else if (e.status === "Krank") col.style.background = "var(--krank)";
  else if (e.status === "Schule") col.style.background = "var(--schule)";
  else col.style.background = colorFromName((e.mitarbeiter || "").split(",")[0]);

  /* Inhalt */
  const content = document.createElement("div");
  content.className = "entry-content";

  const title = document.createElement("div");
  title.className = "entry-title";
  title.textContent = e.titel;

  const meta = document.createElement("div");
  meta.className = "entry-meta";
  meta.textContent = e.mitarbeiter || "";

  const veh = document.createElement("div");
  veh.className = "entry-vehicle";
  veh.textContent = e.fahrzeug || "";

  content.append(title, meta, veh);

  /* Aktionen */
  const actions = document.createElement("div");
  actions.className = "entry-actions";

  const btnMove = document.createElement("button");
  btnMove.textContent = "→ Datum";
  btnMove.onclick = ev => {
    ev.stopPropagation();
    showMoveDialog(e.id);
  };

  actions.appendChild(btnMove);

  card.append(col, content, actions);

  return card;
}

/* --------------------------------------------------------
   EINTRAG VERSCHIEBEN (DATUM)
-------------------------------------------------------- */
function showMoveDialog(id) {
  moveEntryIdInput.value = id;
  moveDateInput.value = "";
  moveDialog.showModal();
}

async function confirmMove() {
  const id = moveEntryIdInput.value;
  const date = moveDateInput.value;

  if (!date) return alert("Bitte Datum wählen");

  await supa.from("plantafel").update({ tag: date }).eq("id", id);

  moveDialog.close();
  loadAll();
}

/* --------------------------------------------------------
   DRAG & DROP – DATUM ÄNDERN
-------------------------------------------------------- */
async function moveEntryToDate(id, dateStr) {
  await supa.from("plantafel").update({ tag: dateStr }).eq("id", id);
  loadAll();
}

/* --------------------------------------------------------
   EINTRAG DIALOG ÖFFNEN
-------------------------------------------------------- */
function openEntryDialog(e) {
  const isNew = !e.id;

  deleteEntryBtn.style.display = isNew ? "none" : "inline-block";

  document.getElementById("fId").value = e.id || "";
  document.getElementById("fBaustelle").value = e.titel || "";
  document.getElementById("fVon").value = e.tag || startDateInput.value;
  document.getElementById("fBis").value = e.tag || "";
  document.getElementById("fStatus").value = e.status || "";
  document.getElementById("fNotiz").value = e.notiz || "";

  buildChecklist("fMitarbeiterBox", mitarbeiter, e.mitarbeiter);
  buildChecklist("fFahrzeugeBox", fahrzeuge, e.fahrzeug);

  entryDialog.showModal();
}

/* CHECKLISTE AUFBAUEN */
function buildChecklist(boxId, list, selectedCSV) {
  const box = document.getElementById(boxId);
  box.innerHTML = "";

  const selected = (selectedCSV || "")
    .split(",")
    .map(x => x.trim())
    .filter(x => x.length > 0);

  list.forEach(item => {
    const lbl = document.createElement("label");
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = item.name;

    if (selected.includes(item.name)) cb.checked = true;

    lbl.append(cb, item.name);
    box.appendChild(lbl);
  });
}

/* --------------------------------------------------------
   EINTRAG SPEICHERN
-------------------------------------------------------- */
entryForm.onsubmit = async ev => {
  ev.preventDefault();

  const id = document.getElementById("fId").value;
  const titel = document.getElementById("fBaustelle").value.trim();
  const von = document.getElementById("fVon").value;
  const bis = document.getElementById("fBis").value || von;
  const status = document.getElementById("fStatus").value;
  const notiz = document.getElementById("fNotiz").value.trim();

  const mit = Array.from(document.querySelectorAll("#fMitarbeiterBox input:checked"))
    .map(cb => cb.value).join(", ");

  const fahr = Array.from(document.querySelectorAll("#fFahrzeugeBox input:checked"))
    .map(cb => cb.value).join(", ");

  if (id) {
    await supa.from("plantafel").update({
      titel, tag: von, status, notiz,
      mitarbeiter: mit, fahrzeug: fahr
    }).eq("id", id);
  } else {
    const start = new Date(von);
    const end = new Date(bis);

    let rows = [];
    let cur = new Date(start);

    while (cur <= end) {
      rows.push({
        titel,
        tag: cur.toISOString().slice(0, 10),
        status,
        notiz,
        mitarbeiter: mit,
        fahrzeug: fahr
      });
      cur.setDate(cur.getDate() + 1);
    }

    await supa.from("plantafel").insert(rows);
  }

  entryDialog.close();
  loadAll();
};

/* --------------------------------------------------------
   EINTRAG LÖSCHEN
-------------------------------------------------------- */
deleteEntryBtn.onclick = async () => {
  const id = document.getElementById("fId").value;
  await supa.from("plantafel").delete().eq("id", id);
  entryDialog.close();
  loadAll();
};

/* --------------------------------------------------------
   PDF EXPORT
-------------------------------------------------------- */
pdf14Btn.onclick = () => generatePDF("14d");
pdf4wBtn.onclick = () => generatePDF("4w");

async function generatePDF(view) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text("Plantafel – " + (view === "14d" ? "14 Tage" : "4 Wochen"), 10, 10);

  let text = "";

  eintraege.forEach(e => {
    text += `${e.tag}: ${e.titel} – ${e.mitarbeiter} ${e.fahrzeug}\n`;
  });

  const lines = doc.splitTextToSize(text, 180);
  doc.text(lines, 10, 20);
  doc.save("plantafel-" + view + ".pdf");
}

/* --------------------------------------------------------
   NAVIGATION & EVENTS
-------------------------------------------------------- */
viewTabs.onclick = ev => {
  if (ev.target.tagName !== "BUTTON") return;

  viewTabs.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  ev.target.classList.add("active");

  currentView = ev.target.dataset.view;
  renderBoard();
};

startDateInput.onchange = () => {
  currentStart = new Date(startDateInput.value);
  renderBoard();
};

prevMonthBtn.onclick = () => {
  currentStart.setMonth(currentStart.getMonth() - 1);
  startDateInput.value = currentStart.toISOString().slice(0, 10);
  renderBoard();
};

nextMonthBtn.onclick = () => {
  currentStart.setMonth(currentStart.getMonth() + 1);
  startDateInput.value = currentStart.toISOString().slice(0, 10);
  renderBoard();
};

backupBtn.onclick = () => backupDialog.showModal();
stammBtn.onclick = () => {
  renderStamm();
  stammDialog.showModal();
};
newEntryBtn.onclick = () => openEntryDialog({ tag: startDateInput.value });

reloadBtn.onclick = () => loadAll();

/* --------------------------------------------------------
   INIT
-------------------------------------------------------- */
const today = new Date();
startDateInput.value = today.toISOString().slice(0, 10);
currentStart = new Date(startDateInput.value);

loadAll();
</script>

<footer>© 2025 Dachdeckerei Frey – Digitale Plantafel V5</footer>

</body>
</html>
