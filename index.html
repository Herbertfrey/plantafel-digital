<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plantafel Digital (Supabase)</title>
  <style>
    :root {
      --bg: #121820;
      --panel: #1b222b;
      --panel2: #202833;
      --card: #273242;
      --accent: #2f6dff;
      --danger: #d64545;
      --text: #fff;
      --text-dim: #aab5c7;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px 6px;
      background: var(--panel);
      border-bottom: 1px solid #0004;
      flex-wrap: wrap;
      z-index: 2;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #39d353;
      display: inline-block;
      margin-right: 6px;
    }
    select, input[type="date"] {
      background: #0000;
      border: 1px solid #ffffff22;
      color: inherit;
      padding: 4px 8px;
      border-radius: 6px;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 500;
    }
    button.ghost {
      background: #ffffff0f;
    }
    button.danger {
      background: var(--danger);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #board {
      flex: 1;
      overflow: auto;
      padding: 10px 10px 60px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .col {
      background: var(--panel2);
      border-radius: var(--radius);
      min-width: 180px;
      flex: 0 0 180px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 140px);
    }
    .col-header {
      padding: 8px 10px 6px;
      border-bottom: 1px solid #ffffff11;
      font-size: 13px;
    }
    .col-header small { color: var(--text-dim); }
    .col-body {
      padding: 8px;
      gap: 6px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .entry {
      background: var(--card);
      border: 1px solid #ffffff11;
      border-radius: 8px;
      padding: 6px 7px 4px;
      font-size: 13px;
      cursor: grab;
    }
    .entry:active { cursor: grabbing; }
    .entry-title { font-weight: 600; margin-bottom: 2px; }
    .entry-meta { font-size: 11px; color: var(--text-dim); }
    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 6px 25px #0005;
      z-index: 50;
    }
    dialog {
      border: none;
      border-radius: 10px;
      background: #19202a;
      color: #fff;
      width: min(460px, 96vw);
      padding: 14px 16px 12px;
    }
    .dlg-row { margin-bottom: 10px; display: flex; flex-direction: column; gap: 3px; }
    .dlg-row label { font-size: 13px; color: #d4d8de; }
    .dlg-row input, .dlg-row select, .dlg-row textarea {
      background: #0000;
      border: 1px solid #ffffff22;
      border-radius: 6px;
      padding: 5px 7px;
      color: inherit;
    }
    textarea { min-height: 70px; }
    .dlg-foot { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
    .badge {
      display: inline-block;
      background: #ffffff0f;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .hidden { display: none; }
    @media (max-width: 780px) {
      header { flex-direction: column; align-items: flex-start; }
      #board { flex-wrap: nowrap; }
    }
  </style>
</head>
<body>
  <header>
    <div><span class="dot" id="connDot"></span><strong>verbunden</strong></div>
    <div>
      <label for="viewSel">Ansicht:</label>
      <select id="viewSel">
        <option value="14d">14 Tage</option>
        <option value="4w" selected>4 Wochen (Moâ€“Fr)</option>
        <option value="12m">12 Monate</option>
      </select>
    </div>
    <div>
      <label for="startDate">Start:</label>
      <input type="date" id="startDate" />
      <button id="btnReload" class="ghost">Neu laden</button>
    </div>
    <div>
      <label><input type="checkbox" id="chkUrlaub" /> Urlaub/Krank/Schule</label>
      <label><input type="checkbox" id="chkAuto" checked /> Auto-Reload</label>
    </div>
    <div>
      <button id="btnMaster" class="ghost">Stammdaten</button>
    </div>
  </header>
  <main>
    <div id="board"></div>
  </main>
  <div class="fab" id="btnAdd">+</div>

  <!-- Neuer / Bearbeiten -->
  <dialog id="entryDlg">
    <h3 id="dlgTitle">Eintrag</h3>
    <div class="dlg-row">
      <label for="eDate">Datum</label>
      <input type="date" id="eDate" />
    </div>
    <div class="dlg-row">
      <label for="eTitle">Titel / Baustelle</label>
      <input id="eTitle" />
    </div>
    <div class="dlg-row">
      <label for="eMa">Mitarbeiter</label>
      <select id="eMa">
        <option value="">â€“ keiner â€“</option>
      </select>
    </div>
    <div class="dlg-row">
      <label for="eCar">Fahrzeug</label>
      <select id="eCar">
        <option value="">â€“ keines â€“</option>
      </select>
    </div>
    <div class="dlg-row">
      <label for="eStatus">Status</label>
      <select id="eStatus">
        <option value="">â€“</option>
        <option value="urlaub">Urlaub</option>
        <option value="krank">Krank</option>
        <option value="schule">Schule</option>
      </select>
    </div>
    <div class="dlg-row">
      <label for="eNote">Notiz</label>
      <textarea id="eNote" placeholder="optional"></textarea>
    </div>
    <div class="dlg-foot">
      <button id="btnEntryCancel" class="ghost">Abbrechen</button>
      <button id="btnEntryDelete" class="danger hidden">LÃ¶schen</button>
      <button id="btnEntrySave">Speichern</button>
    </div>
  </dialog>

  <!-- Stammdaten -->
  <dialog id="masterDlg">
    <h3>Stammdaten</h3>
    <p class="badge">Mitarbeiter</p>
    <div class="dlg-row">
      <input id="mNewMa" placeholder="Mitarbeitername" />
      <button id="btnAddMa">+ HinzufÃ¼gen</button>
    </div>
    <ul id="mMaList"></ul>
    <p class="badge" style="margin-top:10px;">Fahrzeuge</p>
    <div class="dlg-row">
      <input id="mNewCar" placeholder="Fahrzeug" />
      <button id="btnAddCar">+ HinzufÃ¼gen</button>
    </div>
    <ul id="mCarList"></ul>
    <p class="badge" style="margin-top:10px;">Baustellen</p>
    <div class="dlg-row">
      <input id="mNewSite" placeholder="Baustelle" />
      <button id="btnAddSite">+ HinzufÃ¼gen</button>
    </div>
    <ul id="mSiteList"></ul>
    <div class="dlg-foot">
      <button id="btnMasterClose" class="ghost">SchlieÃŸen</button>
    </div>
  </dialog>

  <script type="module">
    // ---------------------------------------------------------
    // 1. Supabase verbinden
    // ---------------------------------------------------------
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const SUPABASE_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM
    const board = document.getElementById("board");
    const viewSel = document.getElementById("viewSel");
    const startDate = document.getElementById("startDate");
    const btnReload = document.getElementById("btnReload");
    const btnAdd = document.getElementById("btnAdd");
    const chkAuto = document.getElementById("chkAuto");
    const chkUrlaub = document.getElementById("chkUrlaub");
    const btnMaster = document.getElementById("btnMaster");
    const connDot = document.getElementById("connDot");

    // Dialog DOM
    const entryDlg = document.getElementById("entryDlg");
    const eDate = document.getElementById("eDate");
    const eTitle = document.getElementById("eTitle");
    const eMa = document.getElementById("eMa");
    const eCar = document.getElementById("eCar");
    const eStatus = document.getElementById("eStatus");
    const eNote = document.getElementById("eNote");
    const btnEntryCancel = document.getElementById("btnEntryCancel");
    const btnEntrySave = document.getElementById("btnEntrySave");
    const btnEntryDelete = document.getElementById("btnEntryDelete");
    const dlgTitle = document.getElementById("dlgTitle");

    // Stammdaten DOM
    const masterDlg = document.getElementById("masterDlg");
    const mMaList = document.getElementById("mMaList");
    const mCarList = document.getElementById("mCarList");
    const mSiteList = document.getElementById("mSiteList");
    const mNewMa = document.getElementById("mNewMa");
    const mNewCar = document.getElementById("mNewCar");
    const mNewSite = document.getElementById("mNewSite");
    const btnAddMa = document.getElementById("btnAddMa");
    const btnAddCar = document.getElementById("btnAddCar");
    const btnAddSite = document.getElementById("btnAddSite");
    const btnMasterClose = document.getElementById("btnMasterClose");

    let allEntries = [];
    let allMa = [];
    let allCars = [];
    let allSites = [];
    let editId = null;
    let autoTimer = null;

    // Startdatum heute setzen
    startDate.value = new Date().toISOString().split("T")[0];

    // ---------------------------------------------------------
    // Daten laden
    // ---------------------------------------------------------
    async function loadEntries() {
      try {
        const { data, error } = await supabase.from("plantafel").select("*").order("tag", { ascending: true });
        if (error) throw error;
        allEntries = data || [];
        renderBoard();
        connDot.style.background = "#39d353";
      } catch (err) {
        console.error("EintrÃ¤ge laden:", err.message);
        connDot.style.background = "#ff6b6b";
      }
    }
    async function loadMasters() {
      // Mitarbeiter
      try {
        const { data } = await supabase.from("mitarbeiter").select("*").order("name", { ascending: true });
        allMa = data || [];
      } catch (err) { allMa = []; }
      // Fahrzeuge
      try {
        const { data } = await supabase.from("fahrzeuge").select("*").order("name", { ascending: true });
        allCars = data || [];
      } catch (err) { allCars = []; }
      // Baustellen
      try {
        const { data } = await supabase.from("baustellen").select("*").order("name", { ascending: true });
        allSites = data || [];
      } catch (err) { allSites = []; }

      // Auswahllisten fÃ¼llen
      eMa.innerHTML = `<option value="">â€“ keiner â€“</option>` + allMa.map(m => `<option value="${m.name}">${m.name}</option>`).join("");
      eCar.innerHTML = `<option value="">â€“ keines â€“</option>` + allCars.map(m => `<option value="${m.name}">${m.name}</option>`).join("");

      // Stammdaten-Listen
      mMaList.innerHTML = allMa.map(m => `<li>${m.name}</li>`).join("") || "<li>Keine Mitarbeiter</li>";
      mCarList.innerHTML = allCars.map(m => `<li>${m.name}</li>`).join("") || "<li>Keine Fahrzeuge</li>";
      mSiteList.innerHTML = allSites.map(m => `<li>${m.name}</li>`).join("") || "<li>Keine Baustellen</li>";
    }

    // ---------------------------------------------------------
    // Board rendern
    // ---------------------------------------------------------
    function renderBoard() {
      const view = viewSel.value;
      const start = new Date(startDate.value);
      if (isNaN(start.getTime())) return;
      board.innerHTML = "";

      if (view === "12m") {
        // 12 Monate grob
        for (let i = 0; i < 12; i++) {
          const d = new Date(start);
          d.setMonth(d.getMonth() + i);
          const monthCol = document.createElement("div");
          monthCol.className = "col";
          const monthName = d.toLocaleDateString("de-DE", { month: "long", year: "numeric" });
          monthCol.innerHTML = `<div class="col-header"><strong>${monthName}</strong></div><div class="col-body" data-col-type="month" data-month="${d.getFullYear()}-${d.getMonth()+1}"></div>`;
          board.appendChild(monthCol);
        }
        // EintrÃ¤ge rein
        const bodies = board.querySelectorAll(".col-body");
        allEntries.forEach(e => {
          const ed = new Date(e.tag);
          const key = `${ed.getFullYear()}-${ed.getMonth()+1}`;
          bodies.forEach(body => {
            if (body.dataset.month === key) {
              body.appendChild(makeEntryNode(e));
            }
          });
        });
      } else {
        // Tage
        const days = (view === "14d") ? 14 : 20; // 4 Wochen Mo-Fr ~ 20 Tage
        for (let i = 0; i < days; i++) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          // bei 4w Moâ€“Fr: Wochenenden weglassen
          if (view === "4w") {
            const wd = d.getDay();
            if (wd === 0 || wd === 6) { // So oder Sa
              continue;
            }
          }
          const iso = d.toISOString().split("T")[0];
          const col = document.createElement("div");
          col.className = "col";
          col.innerHTML = `
            <div class="col-header">
              <strong>${d.toLocaleDateString("de-DE", { weekday: "short" })}</strong>
              <small>${d.toLocaleDateString("de-DE")}</small>
            </div>
            <div class="col-body" data-date="${iso}"></div>
          `;
          board.appendChild(col);
        }
        // EintrÃ¤ge einsortieren
        const bodies = board.querySelectorAll(".col-body");
        allEntries.forEach(e => {
          if (!e.tag) return;
          const ed = e.tag.slice(0, 10);
          bodies.forEach(body => {
            if (body.dataset.date === ed) {
              // Filter Urlaub
              if (!chkUrlaub.checked && (e.status === "urlaub" || e.status === "krank" || e.status === "schule")) {
                return;
              }
              body.appendChild(makeEntryNode(e));
            }
          });
        });
      }
    }

    function makeEntryNode(e) {
      const div = document.createElement("div");
      div.className = "entry";
      div.draggable = true;
      div.dataset.id = e.id;
      div.innerHTML = `
        <div class="entry-title">${e.titel || "(ohne Titel)"}</div>
        <div class="entry-meta">
          ${e.mitarbeiter ? "ðŸ‘· " + e.mitarbeiter : ""}
          ${e.fahrzeug ? " ðŸšš " + e.fahrzeug : ""}
          ${e.status ? " | " + e.status : ""}
        </div>
      `;
      div.addEventListener("click", ev => {
        ev.stopPropagation();
        openEdit(e);
      });
      // Drag
      div.addEventListener("dragstart", ev => {
        ev.dataTransfer.setData("text/plain", e.id);
      });
      return div;
    }

    // Drop-Zonen aktivieren
    board.addEventListener("dragover", ev => {
      if (ev.target.classList.contains("col-body")) {
        ev.preventDefault();
      }
    });
    board.addEventListener("drop", async ev => {
      if (!ev.target.classList.contains("col-body")) return;
      ev.preventDefault();
      const id = ev.dataTransfer.getData("text/plain");
      const targetDate = ev.target.dataset.date;
      if (!id || !targetDate) return;
      // Update in DB
      await supabase.from("plantafel").update({ tag: targetDate }).eq("id", id);
      loadEntries();
    });

    // ---------------------------------------------------------
    // Dialog-Funktionen
    // ---------------------------------------------------------
    function openNew() {
      editId = null;
      eDate.value = startDate.value;
      eTitle.value = "";
      eMa.value = "";
      eCar.value = "";
      eStatus.value = "";
      eNote.value = "";
      btnEntryDelete.classList.add("hidden");
      dlgTitle.textContent = "Neuer Eintrag";
      entryDlg.showModal();
    }
    function openEdit(e) {
      editId = e.id;
      eDate.value = e.tag ? e.tag.slice(0,10) : startDate.value;
      eTitle.value = e.titel || "";
      eMa.value = e.mitarbeiter || "";
      eCar.value = e.fahrzeug || "";
      eStatus.value = e.status || "";
      eNote.value = e.notiz || "";
      btnEntryDelete.classList.remove("hidden");
      dlgTitle.textContent = "Eintrag bearbeiten";
      entryDlg.showModal();
    }

    btnEntryCancel.onclick = () => entryDlg.close();
    btnEntrySave.onclick = async () => {
      const payload = {
        tag: eDate.value,
        titel: eTitle.value,
        mitarbeiter: eMa.value,
        fahrzeug: eCar.value,
        status: eStatus.value,
        notiz: eNote.value,
      };
      if (editId) {
        await supabase.from("plantafel").update(payload).eq("id", editId);
      } else {
        await supabase.from("plantafel").insert([payload]);
      }
      entryDlg.close();
      loadEntries();
    };
    btnEntryDelete.onclick = async () => {
      if (!editId) return;
      await supabase.from("plantafel").delete().eq("id", editId);
      entryDlg.close();
      loadEntries();
    };

    // Stammdaten
    btnMaster.onclick = () => {
      masterDlg.showModal();
    };
    btnMasterClose.onclick = () => masterDlg.close();
    btnAddMa.onclick = async () => {
      if (!mNewMa.value.trim()) return;
      await supabase.from("mitarbeiter").insert([{ name: mNewMa.value.trim() }]);
      mNewMa.value = "";
      loadMasters();
    };
    btnAddCar.onclick = async () => {
      if (!mNewCar.value.trim()) return;
      await supabase.from("fahrzeuge").insert([{ name: mNewCar.value.trim() }]);
      mNewCar.value = "";
      loadMasters();
    };
    btnAddSite.onclick = async () => {
      if (!mNewSite.value.trim()) return;
      await supabase.from("baustellen").insert([{ name: mNewSite.value.trim() }]);
      mNewSite.value = "";
      loadMasters();
    };

    // ---------------------------------------------------------
    // Events
    // ---------------------------------------------------------
    btnAdd.onclick = openNew;
    btnReload.onclick = () => { loadEntries(); loadMasters(); };
    viewSel.onchange = renderBoard;
    startDate.onchange = renderBoard;
    chkUrlaub.onchange = renderBoard;
    chkAuto.onchange = () => {
      if (chkAuto.checked) startAuto();
      else stopAuto();
    };

    function startAuto() {
      stopAuto();
      autoTimer = setInterval(loadEntries, 10000);
    }
    function stopAuto() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = null;
    }

    // ---------------------------------------------------------
    // Init
    // ---------------------------------------------------------
    (async function init() {
      await loadMasters();
      await loadEntries();
      startAuto();
      // optional: realtime, falls supabase aktiviert
      try {
        supabase.channel('plantafel-ch')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'plantafel' }, payload => {
            loadEntries();
          })
          .subscribe();
      } catch (err) {
        console.log("Realtime nicht aktiv:", err.message);
      }
    })();
  </script>
</body>
</html>
