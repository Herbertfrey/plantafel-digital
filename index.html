<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Plantafel Dachdeckerei Frey</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --blau: #0b63c7;
      --hell: #eef1f4;
      --panel: #ffffff;
      --rand: #cfd4dc;
      --txt: #1f2933;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      background:var(--hell);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      color:var(--txt);
    }
    header {
      background:var(--blau);
      color:#fff;
      padding:10px 14px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    header h1 { margin:0; font-size:15px; font-weight:600; }
    .btn {
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);
      color:#fff;
      border-radius:6px;
      padding:4px 9px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.active { background:#fff; color:var(--blau); }
    main { flex:1; padding:12px 14px 70px; }
    #board {
      display:grid;
      grid-template-columns:repeat(5,minmax(140px,1fr));
      gap:10px;
    }
    .day {
      background:var(--panel);
      border:1px solid var(--rand);
      border-radius:10px;
      display:flex;
      flex-direction:column;
      min-height:120px;
    }
    .day-head {
      padding:6px 8px 5px;
      border-bottom:1px solid #e5e7eb;
      font-size:11.5px;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .day-body {
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:5px;
      min-height:50px;
    }
    .entry {
      background:#dbeafe;
      border-radius:8px;
      padding:3px 5px 6px;
      font-size:11px;
      cursor:grab;
      position:relative;
    }
    .entry-title { font-weight:600; margin-bottom:2px; }
    .chip { background:rgba(255,255,255,.23); border-radius:999px; padding:1px 7px 2px; font-size:10px; color:#fff; display:inline-block; margin-right:3px; }
    .entry-del {
      position:absolute; top:2px; right:2px;
      background:rgba(255,255,255,.8);
      border:none; border-radius:999px;
      width:16px; height:16px; text-align:center;
      font-size:11px; cursor:pointer; color:#000;
    }
    dialog {
      border:none;
      border-radius:10px;
      max-width:420px;
      width:95vw;
      padding:14px 14px 12px;
    }
    dialog h3 { margin:0 0 8px; font-size:14px; }
    .fg { margin-bottom:6px; display:flex; flex-direction:column; gap:3px; }
    label { font-size:11px; font-weight:600; }
    input[type="text"],input[type="date"],select,textarea {
      border:1px solid #cbd5e1;
      border-radius:6px;
      padding:4px 5px;
      font-size:12px;
    }
    select[multiple]{ min-height:70px; }
    .dlg-actions { display:flex; justify-content:flex-end; gap:6px; margin-top:6px; }
    .btn-sm { padding:4px 9px; font-size:11px; border-radius:6px; border:none; cursor:pointer; }
    .statusbar {
      position:fixed; bottom:0; left:0; right:0;
      background:var(--blau);
      color:#fff;
      display:flex; justify-content:space-between; align-items:center;
      padding:4px 10px;
      font-size:11px;
    }
    #debug { color:#fecaca; font-size:11px; }
    @media (max-width:950px){
      #board { grid-template-columns:repeat(2,minmax(140px,1fr)); }
      header { flex-direction:column; align-items:flex-start; }
    }
  </style>
</head>
<body>
<header>
  <h1>Plantafel Dachdeckerei Frey</h1>
  <div style="display:flex;gap:6px;flex-wrap:wrap;">
    <button class="btn active" id="btn4w">4 Wochen</button>
    <button class="btn" id="btn14">14 Tage</button>
    <button class="btn" id="btn12">12 Monate</button>
    <label style="font-size:11px;">Start:
      <input type="date" id="startDate" style="font-size:11px;">
    </label>
    <button class="btn" id="btnReload">Neu laden</button>
    <button class="btn" id="btnStamm">Stammdaten</button>
    <button class="btn" id="btnNeu">+ Eintrag</button>
  </div>
  <div style="display:flex;gap:4px;align-items:center;font-size:11px;">
    <span id="connDot" style="width:8px;height:8px;border-radius:999px;background:#ef4444;display:inline-block;"></span>
    <span id="connText">offline</span>
  </div>
</header>

<main>
  <div id="board"></div>
</main>

<div class="statusbar">
  <span>Stammdaten über „Stammdaten“ · Drag & Drop zwischen Tagen</span>
  <span id="debug"></span>
</div>

<!-- Eintrag -->
<dialog id="dlgEntry">
  <h3>Eintrag</h3>
  <div class="fg">
    <label>Baustelle / Auftrag</label>
    <input id="f_titel" type="text">
  </div>
  <div class="fg">
    <label>Von</label>
    <input id="f_von" type="date">
  </div>
  <div class="fg">
    <label>Bis (optional, sonst 1 Tag)</label>
    <input id="f_bis" type="date">
  </div>
  <div class="fg">
    <label>Mitarbeiter (mehrere möglich)</label>
    <select id="f_mitarbeiter" multiple></select>
  </div>
  <div class="fg">
    <label>Fahrzeuge (mehrere möglich)</label>
    <select id="f_fahrzeuge" multiple></select>
  </div>
  <div class="fg">
    <label>Status</label>
    <select id="f_status">
      <option value="normal">normal</option>
      <option value="urlaub">Urlaub</option>
      <option value="krank">Krank</option>
      <option value="schule">Schule</option>
    </select>
  </div>
  <div class="fg">
    <label>Notiz</label>
    <textarea id="f_notiz" rows="2"></textarea>
  </div>
  <div class="dlg-actions">
    <button class="btn-sm" type="button" onclick="dlgEntry.close()">Abbrechen</button>
    <button class="btn-sm" type="button" id="btnSave" style="background:#0b63c7;color:#fff;">Speichern</button>
  </div>
</dialog>

<!-- Stammdaten -->
<dialog id="dlgStamm">
  <h3>Stammdaten</h3>
  <div class="fg">
    <label>Neuer Mitarbeiter</label>
    <div style="display:flex;gap:5px;">
      <input id="sd_mit" type="text" placeholder="Name">
      <button class="btn-sm" id="sd_mit_add" style="background:#0b63c7;color:#fff;">+</button>
    </div>
    <div id="sd_mit_list" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;"></div>
  </div>
  <div class="fg">
    <label>Neues Fahrzeug</label>
    <div style="display:flex;gap:5px;">
      <input id="sd_fzg" type="text" placeholder="z. B. Bus">
      <button class="btn-sm" id="sd_fzg_add" style="background:#0b63c7;color:#fff;">+</button>
    </div>
    <div id="sd_fzg_list" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;"></div>
  </div>
  <div style="text-align:right;">
    <button class="btn-sm" type="button" onclick="dlgStamm.close()">Schließen</button>
  </div>
</dialog>

<script>
const SUPA_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

let view = "4w";
let startDate = new Date();
let mitarbeiter = [];
let fahrzeuge = [];
let eintraege = [];

function iso(d){ return d.toISOString().slice(0,10); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function colorFor(name){
  const colors=["#f97316","#22c55e","#0ea5e9","#a855f7","#ef4444","#14b8a6","#facc15","#6366f1","#f43f5e","#0f766e"];
  if(!name) return "#d1d5db";
  let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0;
  return colors[h % colors.length];
}
function showDebug(msg){
  document.getElementById("debug").textContent = msg;
}

function renderBoard(){
  const board = document.getElementById("board");
  board.innerHTML = "";
  if(view==="4w" || view==="14"){
    const days = (view==="14") ? 14 : 20; // 4 Wochen Mo-Fr = 20 Tage
    let added = 0;
    let d = new Date(startDate);
    while(added < days){
      const weekday = d.getDay();
      if(weekday!==0 && weekday!==6){
        const col = document.createElement("div");
        col.className = "day";
        col.dataset.date = iso(d);
        col.addEventListener("dragover", e=>e.preventDefault());
        col.addEventListener("drop", dropDay);
        const head = document.createElement("div");
        head.className = "day-head";
        head.textContent = d.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"});
        const plus = document.createElement("button");
        plus.textContent="+";
        plus.style.fontSize="10px";
        plus.onclick=()=>openEntry(iso(d));
        head.appendChild(plus);
        col.appendChild(head);
        const body = document.createElement("div");
        body.className="day-body";
        const todays = eintraege.filter(e=>e.tag===iso(d));
        todays.forEach(e=>body.appendChild(renderEntry(e)));
        col.appendChild(body);
        board.appendChild(col);
        added++;
      }
      d.setDate(d.getDate()+1);
    }
  } else {
    // 12 Monate: einfach 12 Spalten untereinander? – hier: 4 x 3
    board.style.gridTemplateColumns = "repeat(4, minmax(140px,1fr))";
    const base = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    for(let i=0;i<12;i++){
      const m = new Date(base.getFullYear(), base.getMonth()+i, 1);
      const col = document.createElement("div");
      col.className="day";
      col.dataset.month = m.getFullYear()+"-"+String(m.getMonth()+1).padStart(2,"0");
      col.addEventListener("dragover", e=>e.preventDefault());
      col.addEventListener("drop", dropMonth);
      const head=document.createElement("div");
      head.className="day-head";
      head.textContent=m.toLocaleDateString("de-DE",{month:"long",year:"numeric"});
      const plus=document.createElement("button");
      plus.textContent="+";
      plus.style.fontSize="10px";
      plus.onclick=()=>openEntry(iso(m));
      head.appendChild(plus);
      col.appendChild(head);
      const body=document.createElement("div");
      body.className="day-body";
      const mm = eintraege.filter(e=>{
        const dt = new Date(e.tag);
        return dt.getFullYear()===m.getFullYear() && dt.getMonth()===m.getMonth();
      });
      mm.forEach(e=>body.appendChild(renderEntry(e)));
      col.appendChild(body);
      board.appendChild(col);
    }
    // nach 12m wieder auf 5 Spalten setzen falls umgeschaltet wird
    board.style.gridTemplateColumns = "";
  }
}

function renderEntry(e){
  const div=document.createElement("div");
  div.className="entry";
  div.draggable=true;
  div.dataset.id=e.id;
  div.addEventListener("dragstart", dragStart);
  div.onclick=()=>openEntry(null,e);
  // farbe
  if(e.status==="urlaub") div.style.background="#fed7aa";
  else if(e.status==="krank") div.style.background="#fecaca";
  else if(e.mitarbeiter){
    const first = e.mitarbeiter.split(",")[0].trim();
    div.style.background = colorFor(first);
    div.style.color = "#fff";
  }

  const t=document.createElement("div");
  t.className="entry-title";
  t.textContent=e.titel || "(ohne Titel)";
  div.appendChild(t);

  if(e.mitarbeiter){
    const ms=e.mitarbeiter.split(",").map(s=>s.trim()).filter(Boolean);
    ms.forEach(m=>{
      const c=document.createElement("span");
      c.className="chip";
      c.style.background=colorFor(m);
      c.textContent=m;
      div.appendChild(c);
    });
  }
  if(e.fahrzeuge){
    const fs=e.fahrzeuge.split(",").map(s=>s.trim()).filter(Boolean);
    fs.forEach(f=>{
      const c=document.createElement("span");
      c.className="chip";
      c.style.background="rgba(0,0,0,.35)";
      c.textContent=f;
      div.appendChild(c);
    });
  }
  const del=document.createElement("button");
  del.className="entry-del";
  del.textContent="×";
  del.onclick=(ev)=>{ev.stopPropagation(); deleteEntry(e.id);};
  div.appendChild(del);
  return div;
}

// Drag & Drop
let dragId=null;
function dragStart(ev){ dragId = ev.currentTarget.dataset.id; }
async function dropDay(ev){
  ev.preventDefault();
  if(!dragId) return;
  const date = ev.currentTarget.dataset.date;
  await supa.from("plantafel").update({tag:date}).eq("id",dragId);
  await loadEntries();
}
async function dropMonth(ev){
  ev.preventDefault();
  if(!dragId) return;
  const date = ev.currentTarget.dataset.month + "-01";
  await supa.from("plantafel").update({tag:date}).eq("id",dragId);
  await loadEntries();
}

// Dialog
const dlgEntry = document.getElementById("dlgEntry");
function fillSelects(){
  const selM = document.getElementById("f_mitarbeiter");
  selM.innerHTML="";
  mitarbeiter.forEach(m=>{
    const o=document.createElement("option");
    o.value=m.name; o.textContent=m.name;
    selM.appendChild(o);
  });
  const selF = document.getElementById("f_fahrzeuge");
  selF.innerHTML="";
  fahrzeuge.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.name; o.textContent=f.name;
    selF.appendChild(o);
  });
}
let editingId=null;
function openEntry(prefillDate, data){
  fillSelects();
  editingId = data ? data.id : null;
  document.getElementById("f_titel").value = data ? (data.titel||"") : "";
  document.getElementById("f_von").value = data ? data.tag : (prefillDate || iso(new Date()));
  document.getElementById("f_bis").value = data ? (data.bis||"") : "";
  document.getElementById("f_status").value = data ? (data.status||"normal") : "normal";
  document.getElementById("f_notiz").value = data ? (data.notiz||"") : "";
  // mehrfach setzen
  const selM = document.getElementById("f_mitarbeiter");
  Array.from(selM.options).forEach(o=>o.selected=false);
  if(data && data.mitarbeiter){
    const arr=data.mitarbeiter.split(",").map(s=>s.trim());
    Array.from(selM.options).forEach(o=>{ if(arr.includes(o.value)) o.selected=true; });
  }
  const selF = document.getElementById("f_fahrzeuge");
  Array.from(selF.options).forEach(o=>o.selected=false);
  if(data && data.fahrzeuge){
    const arr=data.fahrzeuge.split(",").map(s=>s.trim());
    Array.from(selF.options).forEach(o=>{ if(arr.includes(o.value)) o.selected=true; });
  }
  dlgEntry.showModal();
}
document.getElementById("btnSave").onclick = async ()=>{
  const titel=document.getElementById("f_titel").value.trim();
  const von=document.getElementById("f_von").value;
  const bis=document.getElementById("f_bis").value;
  const status=document.getElementById("f_status").value;
  const notiz=document.getElementById("f_notiz").value.trim();
  const mits=Array.from(document.getElementById("f_mitarbeiter").selectedOptions).map(o=>o.value);
  const fzgs=Array.from(document.getElementById("f_fahrzeuge").selectedOptions).map(o=>o.value);
  if(!von){ alert("Datum fehlt"); return; }
  if(editingId){
    await supa.from("plantafel").update({
      titel: titel || status,
      tag: von,
      bis: bis || null,
      status,
      notiz,
      mitarbeiter: mits.join(", "),
      fahrzeuge: fzgs.join(", ")
    }).eq("id",editingId);
  } else {
    // von-bis in einzelne arbeitstage
    let dates=[von];
    if(bis && bis>von){
      dates=[];
      let d=new Date(von), e=new Date(bis);
      while(d<=e){
        const wd=d.getDay();
        if(wd!==0 && wd!==6) dates.push(iso(d));
        d.setDate(d.getDate()+1);
      }
    }
    const rows = dates.map(d=>({
      tag:d,
      titel: titel || status,
      bis:null,
      status,
      notiz,
      mitarbeiter: mits.join(", "),
      fahrzeuge: fzgs.join(", ")
    }));
    await supa.from("plantafel").insert(rows);
  }
  dlgEntry.close();
  await loadEntries();
};

// Stammdaten-Dialog
const dlgStamm=document.getElementById("dlgStamm");
document.getElementById("btnStamm").onclick = ()=>{ renderStamm(); dlgStamm.showModal(); };
document.getElementById("sd_mit_add").onclick = async ()=>{
  const name=document.getElementById("sd_mit").value.trim();
  if(!name) return;
  await supa.from("mitarbeiter").insert({name});
  document.getElementById("sd_mit").value="";
  await loadStamm();
  renderStamm();
};
document.getElementById("sd_fzg_add").onclick = async ()=>{
  const name=document.getElementById("sd_fzg").value.trim();
  if(!name) return;
  await supa.from("fahrzeuge").insert({name});
  document.getElementById("sd_fzg").value="";
  await loadStamm();
  renderStamm();
};
function renderStamm(){
  const mitEl=document.getElementById("sd_mit_list");
  mitEl.innerHTML="";
  mitarbeiter.forEach(m=>{
    const span=document.createElement("span");
    span.style.background="#e2e8f0";
    span.style.borderRadius="999px";
    span.style.padding="1px 6px 2px";
    span.style.fontSize="10px";
    span.style.display="flex";
    span.style.alignItems="center";
    span.style.gap="4px";
    span.innerHTML=`<span style="width:9px;height:9px;border-radius:999px;background:${colorFor(m.name)};display:inline-block;"></span>${m.name}`;
    const del=document.createElement("button");
    del.textContent="x";
    del.style.border="none";
    del.style.background="transparent";
    del.style.cursor="pointer";
    del.style.fontSize="11px";
    del.onclick=async()=>{ await supa.from("mitarbeiter").delete().eq("id",m.id); await loadStamm(); renderStamm(); };
    span.appendChild(del);
    mitEl.appendChild(span);
  });
  const fzEl=document.getElementById("sd_fzg_list");
  fzEl.innerHTML="";
  fahrzeuge.forEach(f=>{
    const span=document.createElement("span");
    span.style.background="#e2e8f0";
    span.style.borderRadius="999px";
    span.style.padding="1px 6px 2px";
    span.style.fontSize="10px";
    span.style.display="flex";
    span.style.alignItems="center";
    span.style.gap="4px";
    span.textContent=f.name;
    const del=document.createElement("button");
    del.textContent="x";
    del.style.border="none";
    del.style.background="transparent";
    del.style.cursor="pointer";
    del.style.fontSize="11px";
    del.onclick=async()=>{ await supa.from("fahrzeuge").delete().eq("id",f.id); await loadStamm(); renderStamm(); };
    span.appendChild(del);
    fzEl.appendChild(span);
  });
}

// Buttons oben
document.getElementById("btn4w").onclick = async ()=>{
  view="4w";
  document.getElementById("btn4w").classList.add("active");
  document.getElementById("btn14").classList.remove("active");
  document.getElementById("btn12").classList.remove("active");
  renderBoard();
  await loadEntries();
};
document.getElementById("btn14").onclick = async ()=>{
  view="14";
  document.getElementById("btn14").classList.add("active");
  document.getElementById("btn4w").classList.remove("active");
  document.getElementById("btn12").classList.remove("active");
  renderBoard();
  await loadEntries();
};
document.getElementById("btn12").onclick = async ()=>{
  view="12";
  document.getElementById("btn12").classList.add("active");
  document.getElementById("btn4w").classList.remove("active");
  document.getElementById("btn14").classList.remove("active");
  renderBoard();
  await loadEntries();
};
document.getElementById("btnNeu").onclick = ()=>openEntry();
document.getElementById("btnReload").onclick = async ()=>{ await loadEverything(); };
document.getElementById("startDate").onchange = async (e)=>{
  startDate = new Date(e.target.value);
  renderBoard();
  await loadEntries();
};

// Daten laden
async function loadStamm(){
  const [m,f] = await Promise.all([
    supa.from("mitarbeiter").select("*").order("name",{ascending:true}),
    supa.from("fahrzeuge").select("*").order("name",{ascending:true})
  ]);
  mitarbeiter = m.data || [];
  fahrzeuge = f.data || [];
}
async function loadEntries(){
  try{
    let {data,error} = await supa.from("plantafel").select("*").order("tag",{ascending:true});
    if(error) throw error;
    eintraege = data || [];
    renderBoard();
    document.getElementById("connDot").style.background="#22c55e";
    document.getElementById("connText").textContent="verbunden";
    showDebug("");
  }catch(err){
    // wenn Fehler → Beispiel-Daten anzeigen
    document.getElementById("connDot").style.background="#ef4444";
    document.getElementById("connText").textContent="offline";
    showDebug("Supabase offline – Demo-Daten");
    if(eintraege.length===0){
      eintraege = [
        {id:"d1",tag:iso(startDate),titel:"Muster: Baustelle A",mitarbeiter:"Thomas, Udo",fahrzeuge:"Crafter",status:"normal"},
        {id:"d2",tag:iso(addDays(startDate,1)),titel:"Muster: Urlaub",mitarbeiter:"Kevin",fahrzeuge:"",status:"urlaub"},
        {id:"d3",tag:iso(addDays(startDate,2)),titel:"Muster: Krank",mitarbeiter:"Patrick",fahrzeuge:"",status:"krank"}
      ];
    }
    renderBoard();
  }
}
async function loadEverything(){
  try{
    await loadStamm();
  }catch(e){/* egal */}
  await loadEntries();
}

// INIT
(function init(){
  document.getElementById("startDate").value = iso(startDate);
  renderBoard();        // zuerst rendern → nie leer
  loadEverything();     // dann Daten versuchen
})();
</script>
</body>
</html>
