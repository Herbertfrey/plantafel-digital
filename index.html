<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Plantafel Digital</title>

<style>
  :root {
    --bg-main: #121212;
    --bg-card: #1f1f1f;
    --bg-toolbar: #1f1f1f;
    --bg-border: #333;
    --txt-main: #fff;
    --txt-dim: #aaa;
    --accent: #2962ff;
    --danger: #d32f2f;
    --radius-card: 8px;
    --radius-btn: 6px;
    --gap: 8px;
    --col-border: 1px solid #333;
    --card-border: 1px solid #444;
  }

  body {
    margin: 0;
    background: var(--bg-main);
    color: var(--txt-main);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header.toolbar {
    background: var(--bg-toolbar);
    color: var(--txt-main);
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    gap: var(--gap);
    padding: 10px;
    border-bottom: var(--col-border);
  }

  header .row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--gap);
  }

  .statusDot {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #2a2a2a;
    border: var(--col-border);
    border-radius: var(--radius-btn);
    padding: 6px 10px;
    font-size: 14px;
    font-weight: 500;
  }

  .statusDot .dot {
    width: 10px;
    height: 10px;
    background: #4caf50; /* grÃ¼n verbunden */
    border-radius: 50%;
  }

  label {
    font-size: 13px;
    color: var(--txt-dim);
    display: block;
    line-height: 1.2;
  }

  .ctrl-block {
    background: #2a2a2a;
    border: var(--col-border);
    border-radius: var(--radius-btn);
    padding: 6px 10px;
    display: flex;
    flex-direction: column;
  }

  .ctrl-inline {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  select,
  input[type="date"],
  input[type="text"],
  input[type="checkbox"] {
    background: #1e1e1e;
    border: var(--col-border);
    border-radius: var(--radius-btn);
    color: var(--txt-main);
    font-size: 14px;
    padding: 6px 8px;
  }

  button.btn {
    background: #2a2a2a;
    color: var(--txt-main);
    border: var(--col-border);
    border-radius: var(--radius-btn);
    font-size: 14px;
    padding: 8px 10px;
    cursor: pointer;
  }

  button.btn.primary {
    background: var(--accent);
    color: #fff;
    border: none;
  }

  button.btn.danger {
    background: var(--danger);
    color: #fff;
    border: none;
  }

  main#boardWrapper {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .boardHint {
    color: var(--txt-dim);
    font-size: 13px;
    margin-bottom: 10px;
  }

  /* Kalender-GRID */
  .weekRow {
    background: #181818;
    border: var(--col-border);
    border-radius: var(--radius-card);
    margin-bottom: 12px;
    padding: 10px;
  }

  .weekHeader {
    color: var(--txt-main);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .daysRow {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap: 10px;
  }

  .dayCol {
    background: var(--bg-card);
    border: var(--card-border);
    border-radius: var(--radius-card);
    display: flex;
    flex-direction: column;
  }

  .dayHeader {
    border-bottom: var(--col-border);
    padding: 8px 10px;
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    flex-wrap: wrap;
    gap:4px;
  }

  .dayHeaderTitle {
    font-weight: 600;
    color: var(--accent);
    font-size: 13px;
  }

  .dayHeaderDate {
    color: var(--txt-dim);
    font-size: 12px;
  }

  .dayBody {
    padding: 8px 10px;
    flex: 1;
    min-height: 80px;
    font-size: 13px;
  }

  /* einzelne Karten (EinsÃ¤tze) */
  .jobCard {
    background: #1e1e2a;
    border: 1px solid #3a3a5a;
    border-radius: var(--radius-card);
    padding: 8px;
    margin-bottom: 8px;
    cursor: grab;
  }
  .jobCard.urlaub {
    background: rgba(211,47,47,0.15);
    border: 1px solid #d32f2f;
  }

  .jobTitleRow {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    font-size: 13px;
    font-weight: 600;
    color: #fff;
  }

  .jobClose {
    cursor: pointer;
    color: var(--txt-dim);
    font-size: 12px;
    padding-left: 6px;
  }

  .jobMeta {
    font-size: 12px;
    margin-top: 4px;
    color: var(--txt-dim);
    line-height: 1.4;
  }

  .fabPlus {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 52px;
    height: 52px;
    background: var(--accent);
    color: #fff;
    border-radius: 50%;
    font-size: 30px;
    line-height: 52px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  }

  footer {
    background: var(--bg-toolbar);
    color: var(--txt-dim);
    border-top: var(--col-border);
    font-size: 12px;
    padding: 8px 10px;
    text-align: left;
  }

  /* Dialoge */
  dialog {
    background: #1f1f1f;
    color: var(--txt-main);
    border: var(--col-border);
    border-radius: var(--radius-card);
    padding: 16px;
    max-width: 360px;
    width: 90%;
  }

  dialog::backdrop {
    background: rgba(0,0,0,0.6);
  }

  .dlg-head {
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 15px;
  }

  .dlg-row {
    display: flex;
    flex-direction: column;
    margin-bottom: 10px;
  }

  .dlg-row label {
    font-size: 12px;
    color: var(--txt-dim);
    margin-bottom: 4px;
  }

  .dlg-row input,
  .dlg-row textarea,
  .dlg-row select {
    width: 100%;
    background: #2a2a2a;
    border: var(--col-border);
    border-radius: var(--radius-btn);
    color: var(--txt-main);
    font-size: 14px;
    padding: 6px 8px;
  }

  .dlg-foot {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 12px;
  }

  .ghost {
    background: transparent;
    border: var(--col-border);
    color: var(--txt-main);
  }

  /* kleine Infoleisten */
  .infoRow {
    font-size: 12px;
    color: var(--txt-dim);
    margin-top:4px;
  }

</style>
</head>
<body>

<header class="toolbar">
  <div class="row" style="flex-wrap:wrap;gap:10px;">
    <div class="statusDot">
      <span class="dot" id="cloudDot"></span>
      <span id="cloudTxt">verbunden</span>
    </div>

    <div class="ctrl-block">
      <label>Ansicht</label>
      <select id="viewSel">
        <option value="4w" selected>4 Wochen (Moâ€“Fr)</option>
        <option value="14t">14 Tage</option>
        <option value="12m">12 Monate</option>
      </select>
    </div>

    <div class="ctrl-block">
      <label>Start</label>
      <input id="startDate" type="date" />
      <button class="btn" id="btnReload">Neu laden</button>
    </div>

    <div class="ctrl-inline ctrl-block" style="flex-direction:row;align-items:center;">
      <input id="chkUrlaub" type="checkbox" />
      <label for="chkUrlaub" style="margin:0;">Urlaub/Krank/Schule</label>
    </div>

    <div class="ctrl-inline ctrl-block" style="flex-direction:row;align-items:center;">
      <input id="chkAuto" type="checkbox" />
      <label for="chkAuto" style="margin:0;">Auto-Reload</label>
    </div>

    <button class="btn" id="btnMaster">Stammdaten</button>
    <button class="btn primary" id="btnAdd">+ Eintrag</button>
  </div>

  <div class="row" style="flex-wrap:wrap;gap:10px;">
    <div class="ctrl-block">
      <label>Zoom</label>
      <input id="zoomRange" type="range" min="0.8" max="1.4" step="0.05" value="1.0" />
    </div>
  </div>
</header>

<main id="boardWrapper">
  <div class="boardHint">
    Drag &amp; Drop: Karte auf Ziel ziehen â†’ â€žVerschiebenâ€œ oder â€žDuplizierenâ€œ. Klick auf Karte = bearbeiten, X = lÃ¶schen.
    <br/>
    Status rot = Urlaub/Krank/Schule
  </div>

  <div id="weeksContainer"></div>
</main>

<footer>
  Â© Plantafel Frey â€” Live Sync mit Firestore â€¢ Keine Winter-Kurzarbeit ðŸ˜‰
</footer>

<!-- schwebender + Button -->
<div class="fabPlus" id="fabPlus">+</div>

<!-- Dialog Neuer / Bearbeiten -->
<dialog id="entryDlg">
  <div class="dlg-head" id="dlgTitle">Neuer Eintrag</div>

  <div class="dlg-row">
    <label for="fTitle">Titel / Projekt</label>
    <input id="fTitle" type="text" placeholder="z.B. Dachsanierung MÃ¼ller"/>
  </div>

  <div class="dlg-row">
    <label for="fWho">Mitarbeiter / Fahrzeug</label>
    <input id="fWho" type="text" placeholder="z.B. Patrick, Mercedes Bus"/>
  </div>

  <div class="dlg-row">
    <label for="fDay">Tag (YYYY-MM-DD)</label>
    <input id="fDay" type="date"/>
  </div>

  <div class="dlg-row">
    <label for="fNote">Team-Notiz</label>
    <textarea id="fNote" rows="2" placeholder="optional"></textarea>
  </div>

  <div class="dlg-row ctrl-inline" style="justify-content:flex-start;">
    <input type="checkbox" id="fIsUrlaub"/>
    <label for="fIsUrlaub" style="margin:0;">Urlaub/Krank/Schule (rot)</label>
  </div>

  <div class="infoRow" id="fInfoRow" style="display:none;"></div>

  <div class="dlg-foot">
    <button class="btn ghost" id="btnCancel">Abbrechen</button>
    <button class="btn danger" id="btnDelete" style="display:none;">LÃ¶schen</button>
    <button class="btn primary" id="btnSave">Speichern</button>
  </div>
</dialog>

<!-- Dialog Stammdaten -->
<dialog id="masterDlg">
  <div class="dlg-head">Stammdaten</div>

  <div class="dlg-row">
    <label>Mitarbeiter / Fahrzeuge verwalten</label>
    <div class="infoRow">
      (In dieser Version nur Anzeige/Notiz â€“ Erweiterung mÃ¶glich)
    </div>
  </div>

  <div class="dlg-foot">
    <button class="btn ghost" id="btnMasterCancel">SchlieÃŸen</button>
  </div>
</dialog>

<script type="module">
/*
  Import Firebase SDK (ohne AppCheck, stabil)
*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc,
  doc, getDocs, onSnapshot, query, where, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/*
  Deine Firebase-Konfiguration
*/
const firebaseConfig = {
  apiKey: "AIzaSyDPWf-Xn023Bx-ebCvg6a42Drxm9f4SxDI",
  authDomain: "plantafelfreyllich100.firebaseapp.com",
  projectId: "plantafelfreyllich100",
  storageBucket: "plantafelfreyllich100.appspot.com",
  messagingSenderId: "96295193135",
  appId: "1:96295193135:web:e44627944781c5e0ef914da",
  measurementId: "G-W5VGSLTRC"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// UI-Elemente holen
const weeksContainer = document.getElementById("weeksContainer");
const cloudDot = document.getElementById("cloudDot");
const cloudTxt = document.getElementById("cloudTxt");

const viewSel = document.getElementById("viewSel");
const startDateInput = document.getElementById("startDate");
const btnReload = document.getElementById("btnReload");
const chkUrlaub = document.getElementById("chkUrlaub");
const chkAuto = document.getElementById("chkAuto");
const btnMaster = document.getElementById("btnMaster");
const btnAdd = document.getElementById("btnAdd");
const zoomRange = document.getElementById("zoomRange");
const fabPlus = document.getElementById("fabPlus");

// Dialog + Felder
const entryDlg = document.getElementById("entryDlg");
const dlgTitle = document.getElementById("dlgTitle");
const fTitle = document.getElementById("fTitle");
const fWho = document.getElementById("fWho");
const fDay = document.getElementById("fDay");
const fNote = document.getElementById("fNote");
const fIsUrlaub = document.getElementById("fIsUrlaub");
const fInfoRow = document.getElementById("fInfoRow");
const btnCancel = document.getElementById("btnCancel");
const btnDelete = document.getElementById("btnDelete");
const btnSave = document.getElementById("btnSave");

// Stammdaten-Dialog
const masterDlg = document.getElementById("masterDlg");
const btnMasterCancel = document.getElementById("btnMasterCancel");

// interner Zustand
let allItems = [];     // alle EinsÃ¤tze aus Firestore
let editId = null;     // welche Karte wird gerade editiert?
let autoReloadTimer = null;

// Hilfsfunktionen Datum
function fmtDateISO(d) {
  // d = Date
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseISO(s) {
  // "2025-10-30" -> Date
  const [yy,mm,dd] = s.split("-");
  return new Date(Number(yy), Number(mm)-1, Number(dd));
}

function getStartDate() {
  const v = startDateInput.value;
  if (!v) {
    const today = new Date();
    startDateInput.value = fmtDateISO(today);
    return today;
  }
  return parseISO(v);
}

// baue die Wochenansicht (4 Wochen standard)
function buildView() {
  weeksContainer.innerHTML = "";

  // Zoom auf Karten anwenden
  weeksContainer.style.fontSize = (zoomRange.value || "1.0") + "rem";

  const start = getStartDate(); // Date
  const mode = viewSel.value;   // "4w", "14t", "12m"
  // Wir zeigen aktuell immer 4 Wochen Moâ€“Fr in Spalten
  // (wir lassen die anderen Optionen erstmal gleich rendern -> spÃ¤ter ausbauen)

  // Wir generieren 4 Wochen (28 Tage) ab Start
  const daysToShow = (mode==="14t") ? 14 : (mode==="12m"? 365 : 28);

  // Wir gruppieren nach Kalenderwoche
  // Map<KW, {kwLabel, days:[{date,title}]}>
  const cal = new Map();

  for (let i=0;i<daysToShow;i++){
    const d = new Date(start.getTime());
    d.setDate(d.getDate()+i);

    const iso = fmtDateISO(d);
    const weekday = d.toLocaleDateString("de-DE",{weekday:"short"});
    const dateLabel = d.toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit"});

    // KW berechnen (vereinfachte Variante)
    const tmp = new Date(d.getTime());
    // ISO-Wochen-Nr grob
    const dayNum = (tmp.getDay()+6)%7 + 1;
    tmp.setDate(tmp.getDate() + (4-dayNum));
    const yearStart = new Date(tmp.getFullYear(),0,1);
    const weekNo = Math.floor((((tmp - yearStart)/86400000)+1)/7)+1;
    const kwKey = `KW ${weekNo} ${weekday}`;

    if (!cal.has(weekNo)) {
      cal.set(weekNo, {
        weekNo,
        label: `KW ${weekNo}`,
        days: []
      });
    }

    cal.get(weekNo).days.push({
      iso,
      weekday,
      dateLabel
    });
  }

  // Jetzt jede KW rendern
  for (const {weekNo,label,days} of cal.values()) {
    const weekDiv = document.createElement("div");
    weekDiv.className = "weekRow";

    const head = document.createElement("div");
    head.className = "weekHeader";
    head.innerHTML = `
      <div>${label}</div>
      <div style="font-size:12px;color:#888;">Klicken zum Eintragen Â· Drag & Drop mÃ¶glich</div>
    `;
    weekDiv.appendChild(head);

    const daysGrid = document.createElement("div");
    daysGrid.className = "daysRow";

    // pro Tag: Spalte
    for (const day of days) {
      const col = document.createElement("div");
      col.className = "dayCol";
      col.dataset.day = day.iso; // wichtig fÃ¼r Zuordnung

      const h = document.createElement("div");
      h.className = "dayHeader";
      h.innerHTML = `
        <div class="dayHeaderTitle">${day.weekday}</div>
        <div class="dayHeaderDate">${day.dateLabel}</div>
        <div style="font-size:12px;color:#888;cursor:pointer;" data-plus="${day.iso}">+</div>
      `;
      col.appendChild(h);

      const body = document.createElement("div");
      body.className = "dayBody";
      body.innerHTML = `<div style="color:#666;">Klicken zum Eintragen Â· Drag & Drop mÃ¶glich</div>`;
      col.appendChild(body);

      daysGrid.appendChild(col);
    }

    weekDiv.appendChild(daysGrid);
    weeksContainer.appendChild(weekDiv);
  }

  // Jetzt Karten reinsetzen
  renderCardsIntoColumns();
}

// EinsÃ¤tze filtern + in die Spalten schreiben
function renderCardsIntoColumns() {
  // alle Day-Container leeren
  document.querySelectorAll(".dayCol .dayBody").forEach(b=>{
    b.innerHTML = ""; 
  });

  const showUrlaub = chkUrlaub.checked;

  // sortiere allItems nach timestamp (falls vorhanden)
  const itemsSorted = [...allItems].sort((a,b)=>{
    const da = a.day || "";
    const db = b.day || "";
    if (da<db) return -1;
    if (da>db) return 1;
    return 0;
  });

  for (const it of itemsSorted) {
    if (!it.day) continue;
    const dayCol = document.querySelector(`.dayCol[data-day="${it.day}"] .dayBody`);
    if (!dayCol) continue;

    if (it.isUrlaub && !showUrlaub) {
      // Urlaub verstecken wenn Schalter aus
      continue;
    }

    const card = document.createElement("div");
    card.className = "jobCard" + (it.isUrlaub ? " urlaub":"");
    card.dataset.id = it.id || "";

    card.innerHTML = `
      <div class="jobTitleRow">
        <div>${escapeHTML(it.title || "(ohne Titel)")}</div>
        <div class="jobClose" data-del="${it.id}">âœ•</div>
      </div>
      <div class="jobMeta">
        ${escapeHTML(it.who || "")}<br/>
        ${escapeHTML(it.note || "")}
      </div>
    `;

    // Klick auf Karte -> bearbeiten
    card.addEventListener("click", (ev)=>{
      // wenn auf das X geklickt wird, nicht Ã¶ffnen
      if (ev.target && ev.target.dataset && ev.target.dataset.del) return;
      openEditDialog(it);
      ev.stopPropagation();
    });

    // Klick auf X -> lÃ¶schen
    card.querySelector("[data-del]").addEventListener("click", async(ev)=>{
      ev.stopPropagation();
      if (it.id) {
        const ok = confirm("Diesen Eintrag lÃ¶schen?");
        if (ok) {
          await deleteDoc(doc(db,"plantafel",it.id));
        }
      }
    });

    dayCol.appendChild(card);
  }
}

// Escaping damit keine HTML-Injection passiert wenn du z.B. Sonderzeichen eingibst
function escapeHTML(str="") {
  return str.replace(/[&<>"']/g, (c)=>{
    switch(c){
      case "&": return "&amp;";
      case "<": return "&lt;";
      case ">": return "&gt;";
      case "\"": return "&quot;";
      case "'": return "&#039;";
    }
    return c;
  });
}

// Dialog zum Neuerstellen
function openNewDialog(prefillDay) {
  editId = null;
  dlgTitle.textContent = "Neuer Eintrag";
  fTitle.value = "";
  fWho.value = "";
  fDay.value = prefillDay || fmtDateISO(getStartDate());
  fNote.value = "";
  fIsUrlaub.checked = false;
  btnDelete.style.display = "none";
  fInfoRow.style.display = "none";
  entryDlg.showModal();
}

function openEditDialog(item) {
  editId = item.id || null;
  dlgTitle.textContent = "Eintrag bearbeiten";
  fTitle.value = item.title || "";
  fWho.value = item.who || "";
  fDay.value = item.day || fmtDateISO(getStartDate());
  fNote.value = item.note || "";
  fIsUrlaub.checked = !!item.isUrlaub;
  btnDelete.style.display = "inline-block";
  fInfoRow.style.display = "block";
  fInfoRow.textContent = "ID: " + (item.id || "neu") + " â€¢ zuletzt geÃ¤ndert: " + (item.updated || "");
  entryDlg.showModal();
}

// Speichern (neu oder update)
async function saveEntry() {
  const data = {
    title: fTitle.value.trim(),
    who: fWho.value.trim(),
    day: fDay.value,
    note: fNote.value.trim(),
    isUrlaub: fIsUrlaub.checked,
    updated: new Date().toISOString(),
    ts: serverTimestamp()
  };

  if (!data.title || !data.day) {
    alert("Titel und Tag sind Pflicht.");
    return;
  }

  if (editId) {
    // update
    await updateDoc(doc(db,"plantafel",editId), data);
  } else {
    // neu
    await addDoc(collection(db,"plantafel"), data);
  }

  entryDlg.close();
}

// LÃ¶schen aus Dialog
async function deleteEntry() {
  if (!editId) return;
  const ok = confirm("Wirklich lÃ¶schen?");
  if (!ok) return;
  await deleteDoc(doc(db,"plantafel",editId));
  entryDlg.close();
}

// Stammdaten-Dialog
function openMasterDialog() {
  masterDlg.showModal();
}

// === LIVE FIRESTORE ===
// wir hÃ¶ren live auf die Collection "plantafel"
function startLiveListener() {
  cloudDot.style.background = "#4caf50";
  cloudTxt.textContent = "verbunden";

  const qRef = query(collection(db,"plantafel"), orderBy("day","asc"));
  onSnapshot(qRef, (snap)=>{
    const items = [];
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      items.push({
        id: docSnap.id,
        title: d.title || "",
        who: d.who || "",
        day: d.day || "",
        note: d.note || "",
        isUrlaub: !!d.isUrlaub,
        updated: d.updated || ""
      });
    });
    allItems = items;
    buildView();
  }, (err)=>{
    console.error("onSnapshot error", err);
    cloudDot.style.background = "#d32f2f";
    cloudTxt.textContent = "Fehler";
  });
}

// Manueller Reload
async function manualReload() {
  cloudDot.style.background = "#ffa000"; // orange
  cloudTxt.textContent = "lÃ¤dt...";

  const qRef = query(collection(db,"plantafel"), orderBy("day","asc"));
  const snap = await getDocs(qRef);
  const items = [];
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    items.push({
      id: docSnap.id,
      title: d.title || "",
      who: d.who || "",
      day: d.day || "",
      note: d.note || "",
      isUrlaub: !!d.isUrlaub,
      updated: d.updated || ""
    });
  });
  allItems = items;
  buildView();

  cloudDot.style.background = "#4caf50";
  cloudTxt.textContent = "verbunden";
}

// Auto-Reload an/aus
function handleAutoReloadToggle() {
  if (chkAuto.checked) {
    // alle 20 Sekunden neu laden (fallback zusÃ¤tzlich zu onSnapshot)
    autoReloadTimer = setInterval(manualReload, 20000);
  } else {
    if (autoReloadTimer) {
      clearInterval(autoReloadTimer);
      autoReloadTimer = null;
    }
  }
}

// Klick-Listener fÃ¼r + im jeweiligen Tag
weeksContainer.addEventListener("click", (ev)=>{
  const plusDay = ev.target?.dataset?.plus;
  if (plusDay) {
    openNewDialog(plusDay);
  }
});

// Buttons / Controls
btnAdd.addEventListener("click", ()=>openNewDialog());
fabPlus.addEventListener("click", ()=>openNewDialog());
btnMaster.addEventListener("click", openMasterDialog);
btnMasterCancel.addEventListener("click", ()=>masterDlg.close());

btnCancel.addEventListener("click", ()=>entryDlg.close());
btnDelete.addEventListener("click", deleteEntry);
btnSave.addEventListener("click", saveEntry);

btnReload.addEventListener("click", manualReload);
chkUrlaub.addEventListener("change", buildView);
chkAuto.addEventListener("change", handleAutoReloadToggle);
zoomRange.addEventListener("input", buildView);
viewSel.addEventListener("change", buildView);
startDateInput.addEventListener("change", buildView);

// Start
(function init(){
  // Startdatum auf heute setzen falls leer
  if (!startDateInput.value) {
    startDateInput.value = fmtDateISO(new Date());
  }
  // Erste Ansicht
  buildView();
  // Live Sync starten
  startLiveListener();
})();
</script>

</body>
</html>
