<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Plantafel Dachdeckerei Frey</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --blue: #0b63c7;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #d1d5db;
      --text: #1f2933;
      --muted: #6b7280;
      --danger: #ef4444;
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: var(--blue);
      color: #fff;
      padding: .65rem 1.2rem .55rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    header h1 {
      font-size: 1rem;
      margin: 0;
      white-space: nowrap;
    }
    .top-controls {
      display: flex;
      gap: .4rem;
      align-items: center;
      flex-wrap: wrap;
    }
    button, select, input[type="date"] {
      border: 1px solid #cbd5e1;
      background: #fff;
      border-radius: 6px;
      padding: .35rem .7rem;
      font-size: .78rem;
    }
    button.primary {
      background: #0b63c7;
      color: #fff;
      border-color: #0b63c7;
      font-weight: 600;
    }
    button.danger {
      background: #ef4444;
      border-color: #ef4444;
      color: #fff;
    }

    main {
      padding: 1rem;
    }
    /* Grid fÃ¼r Tage */
    #board {
      display: grid;
      gap: .8rem;
    }
    .day-column, .month-column {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-height: 140px;
      display: flex;
      flex-direction: column;
    }
    .day-header, .month-header {
      font-size: .72rem;
      font-weight: 600;
      padding: .45rem .6rem .35rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      gap: .5rem;
      align-items: center;
    }
    .day-body, .month-body {
      padding: .4rem .4rem .5rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    .entry {
      background: #e5e7eb;
      border-radius: 10px;
      padding: .35rem .4rem .3rem;
      font-size: .65rem;
      border-left: 5px solid #94a3b8;
      display: flex;
      flex-direction: column;
      gap: .25rem;
      cursor: grab;
      position: relative;
    }
    .entry:hover { filter: brightness(.98); }
    .entry-title {
      font-weight: 600;
      font-size: .69rem;
      word-break: break-word;
    }
    .entry-line {
      display: flex;
      gap: .25rem;
      flex-wrap: wrap;
    }
    .pill {
      background: rgba(255,255,255,.55);
      border-radius: 999px;
      padding: .05rem .45rem .15rem;
      font-size: .6rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
    }
    .pill.vehicle {
      background: rgba(0,0,0,.05);
    }
    .badge-status {
      font-size: .55rem;
      padding: .1rem .35rem .15rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: lowercase;
    }
    .s-urlaub { background: #fef3c7; color: #92400e; }
    .s-krank { background: #fee2e2; color: #991b1b; }
    .s-schule { background: #dbeafe; color: #1d4ed8; }

    .entry-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255,255,255,.7);
      border: none;
      border-radius: 999px;
      width: 18px;
      height: 18px;
      font-size: .55rem;
      cursor: pointer;
    }

    dialog {
      border: none;
      border-radius: 14px;
      padding: 1rem 1.2rem 1.2rem;
      background: #fff;
      min-width: 320px;
      max-width: 420px;
    }
    dialog::backdrop { background: rgba(0,0,0,.25); }

    .form-group { margin-bottom: .55rem; display: flex; flex-direction: column; gap: .25rem; }
    label { font-size: .7rem; font-weight: 600; }
    input[type="text"], textarea, select, input[type="date"] {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: .35rem .5rem;
      font-size: .72rem;
    }
    select[multiple] {
      min-height: 90px;
    }

    /* Responsive Spalten */
    @media (min-width: 1100px) {
      #board.four-weeks {
        grid-template-columns: repeat(5, minmax(150px, 1fr));
      }
      #board.fourteen-days {
        grid-template-columns: repeat(7, minmax(150px,1fr));
      }
      #board.twelve-months {
        grid-template-columns: repeat(4, minmax(180px,1fr));
      }
    }
    @media (max-width: 1099px) {
      #board { grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); }
    }

    .footer {
      text-align: center;
      font-size: .65rem;
      color: #94a3b8;
      padding: .5rem 0 1rem;
    }
  </style>
</head>
<body>
<header>
  <h1>Plantafel Dachdeckerei Frey</h1>
  <div class="top-controls">
    <button id="btn14">14 Tage</button>
    <button id="btn4w" class="primary">4 Wochen (Moâ€“Fr)</button>
    <button id="btn12m">12 Monate</button>
    <label style="color:white;font-size:.7rem;">Start:
      <input type="date" id="startDate">
    </label>
    <button id="btnReload">Neu laden</button>
    <label style="color:white;font-size:.7rem;display:flex;align-items:center;gap:.25rem;">
      <input type="checkbox" id="chkUrlaub" checked> Urlaub/Krank/Schule
    </label>
    <button id="btnStammdaten">Stammdaten</button>
    <button id="btnNew" class="primary">+ Eintrag</button>
    <span id="statusDot" title="nicht verbunden">ðŸ”´</span>
  </div>
</header>

<main>
  <div id="board" class="four-weeks"></div>
</main>

<div class="footer">Â© 2025 Dachdeckerei Frey â€¢ Digitale Plantafel</div>

<!-- Dialog Neuer Eintrag -->
<dialog id="dlgNew">
  <form id="frmNew">
    <h3>Neuer Eintrag</h3>
    <div class="form-group">
      <label for="neubau">Baustelle / Auftrag</label>
      <input id="neubau" type="text" maxlength="120" placeholder="z. B. MÃ¼ller Dach" required>
    </div>
    <div class="form-group">
      <label>Von / Bis (bis optional â€“ wenn leer, 1 Tag)</label>
      <input type="date" id="von" required>
      <input type="date" id="bis">
    </div>
    <div class="form-group">
      <label>Mitarbeiter (Mehrfach)</label>
      <select id="selMitarbeiter" multiple></select>
      <small style="font-size:.58rem;color:#6b7280;">STRG / CTRL oder mehrfach tippen</small>
    </div>
    <div class="form-group">
      <label>Fahrzeuge (Mehrfach)</label>
      <select id="selFahrzeuge" multiple></select>
    </div>
    <div class="form-group">
      <label>Status</label>
      <select id="selStatus">
        <option value="normal">normal</option>
        <option value="urlaub">Urlaub</option>
        <option value="krank">Krank</option>
        <option value="schule">Schule</option>
      </select>
    </div>
    <div class="form-group">
      <label>Notiz</label>
      <textarea id="txtNotiz" rows="2" placeholder="optional"></textarea>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem;">
      <button type="button" onclick="document.getElementById('dlgNew').close()">Abbrechen</button>
      <button type="submit" class="primary">Speichern</button>
    </div>
  </form>
</dialog>

<!-- Dialog Stammdaten -->
<dialog id="dlgStamm">
  <h3>Stammdaten</h3>
  <div class="form-group">
    <label>Neuer Mitarbeiter</label>
    <div style="display:flex;gap:.4rem;">
      <input type="text" id="inNewMit" placeholder="Name">
      <button type="button" onclick="addMitarbeiter()">+</button>
    </div>
  </div>
  <ul id="listMit" style="list-style:none;padding-left:0;margin-top:.25rem;margin-bottom:.75rem;"></ul>

  <div class="form-group">
    <label>Neues Fahrzeug</label>
    <div style="display:flex;gap:.4rem;">
      <input type="text" id="inNewFzg" placeholder="z. B. Crafter Bus">
      <button type="button" onclick="addFahrzeug()">+</button>
    </div>
  </div>
  <ul id="listFzg" style="list-style:none;padding-left:0;margin-top:.25rem;margin-bottom:.75rem;"></ul>

  <div style="text-align:right;">
    <button type="button" onclick="document.getElementById('dlgStamm').close()">SchlieÃŸen</button>
  </div>
</dialog>

<script>
  // === 1. Supabase einrichten =========================================================
  const SUPA_URL = "https://mtybmrkyhavxpvwysglo.supabase.co";
  const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo";
  const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

  // === 2. Lokale Daten ================================================================
  let mitarbeiter = [];   // {id,name}
  let fahrzeuge = [];
  let baustellen = [];
  let eintraege = [];
  let currentView = "4w"; // 14, 4w, 12m
  let startDate = new Date(2025,10,3); // wird beim Laden Ã¼berschrieben
  const board = document.getElementById("board");
  const statusDot = document.getElementById("statusDot");

  // deterministische Farbe pro Mitarbeiter
  const COLOR_POOL = ["#f97316","#22c55e","#0ea5e9","#a855f7","#facc15","#f43f5e","#14b8a6","#6366f1","#ef4444","#10b981"];
  function colorForName(name){
    if(!name) return "#e5e7eb";
    let h = 0;
    for (let i=0;i<name.length;i++){
      h = (h*31 + name.charCodeAt(i)) >>> 0;
    }
    return COLOR_POOL[h % COLOR_POOL.length];
  }

  // === 3. Helfer ======================================================================
  function fmtDate(d){
    return d.toISOString().slice(0,10);
  }
  function addDays(d,days){
    const nd = new Date(d);
    nd.setDate(nd.getDate()+days);
    return nd;
  }

  // === 4. Laden von Supabase ==========================================================
  async function loadStammdaten(){
    const [mitRes, fzgRes, bauRes] = await Promise.all([
      supa.from('mitarbeiter').select().order('name',{ascending:true}),
      supa.from('fahrzeuge').select().order('name',{ascending:true}),
      supa.from('baustellen').select().order('name',{ascending:true})
    ]);
    mitarbeiter = mitRes.data || [];
    fahrzeuge = fzgRes.data || [];
    baustellen = bauRes.data || [];
    statusDot.textContent = "ðŸŸ¢";
  }

  async function loadEintraege(){
    let from, to;
    if (currentView === "14"){
      from = fmtDate(startDate);
      to = fmtDate(addDays(startDate,13));
    } else if (currentView === "4w"){
      // 4 Wochen Moâ€“Fr = 20 Tage
      from = fmtDate(startDate);
      to = fmtDate(addDays(startDate,27)); // reicht
    } else {
      // 12 Monate: hol einfach viel
      const startMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      const endMonth = new Date(startMonth.getFullYear(), startMonth.getMonth()+12, 0);
      from = fmtDate(startMonth);
      to = fmtDate(endMonth);
    }
    const {data, error} = await supa
      .from('plantafel')
      .select()
      .gte('tag', from)
      .lte('tag', to)
      .order('tag',{ascending:true})
      .order('sort',{ascending:true});
    eintraege = data || [];
  }

  // === 5. Rendern =====================================================================
  function render(){
    board.innerHTML = "";
    if (currentView === "14") render14();
    else if (currentView === "4w") render4w();
    else render12m();
  }

  function makeDayColumn(date){
    const col = document.createElement("div");
    col.className = "day-column";
    col.dataset.date = fmtDate(date);
    col.addEventListener("dragover", e => e.preventDefault());
    col.addEventListener("drop", onDropDay);
    const head = document.createElement("div");
    head.className = "day-header";
    const optBtn = document.createElement("button");
    optBtn.textContent = "+";
    optBtn.style.fontSize = ".6rem";
    optBtn.onclick = () => openNew(fmtDate(date));
    head.innerHTML = new Intl.DateTimeFormat("de-DE",{weekday:"short", day:"2-digit", month:"2-digit", year:"numeric"}).format(date);
    head.appendChild(optBtn);
    const body = document.createElement("div");
    body.className = "day-body";
    col.appendChild(head);
    col.appendChild(body);
    return col;
  }

  function entryMatchesView(e){
    if (!document.getElementById("chkUrlaub").checked) {
      if (e.status === "urlaub" || e.status === "krank" || e.status === "schule") return false;
    }
    return true;
  }

  function renderEntriesInto(container, dateStr){
    const list = eintraege.filter(e => e.tag === dateStr).filter(entryMatchesView);
    for (const e of list){
      const card = makeEntryCard(e);
      container.appendChild(card);
    }
  }

  function makeEntryCard(e){
    const div = document.createElement("div");
    div.className = "entry";
    div.draggable = true;
    div.dataset.id = e.id;
    div.addEventListener("dragstart", onDragStart);
    // Titel
    const t = document.createElement("div");
    t.className = "entry-title";
    t.textContent = e.titel || "(ohne Titel)";
    div.appendChild(t);

    // Mitarbeiter
    if (e.mitarbeiter){
      const names = e.mitarbeiter.split(",").map(s=>s.trim()).filter(Boolean);
      const line = document.createElement("div");
      line.className = "entry-line";
      for (const n of names){
        const p = document.createElement("span");
        p.className = "pill";
        p.textContent = n;
        p.style.background = colorForName(n);
        p.style.color = "#fff";
        line.appendChild(p);
      }
      div.appendChild(line);
    }
    // Fahrzeuge
    if (e.fahrzeug){
      const fz = e.fahrzeug.split(",").map(s=>s.trim()).filter(Boolean);
      const line = document.createElement("div");
      line.className = "entry-line";
      for (const f of fz){
        const p = document.createElement("span");
        p.className = "pill vehicle";
        p.textContent = f;
        line.appendChild(p);
      }
      div.appendChild(line);
    }
    // Status
    if (e.status && e.status !== "normal"){
      const s = document.createElement("span");
      s.className = "badge-status " + (e.status === "urlaub" ? "s-urlaub" : e.status==="krank" ? "s-krank" : "s-schule");
      s.textContent = e.status;
      div.appendChild(s);
    }

    // delete
    const del = document.createElement("button");
    del.className = "entry-delete";
    del.textContent = "Ã—";
    del.onclick = () => deleteEntry(e.id);
    div.appendChild(del);

    return div;
  }

  function render14(){
    board.className = "fourteen-days";
    for (let i=0;i<14;i++){
      const d = addDays(startDate, i);
      const col = makeDayColumn(d);
      board.appendChild(col);
      renderEntriesInto(col.querySelector(".day-body"), fmtDate(d));
    }
  }

  function render4w(){
    board.className = "four-weeks";
    // 4 Reihen Ã  5 Tage (Moâ€“Fr)
    for (let w=0; w<4; w++){
      for (let d=0; d<5; d++){
        const idx = w*7 + d; // Ã¼berspringt Wochenende
        const date = addDays(startDate, idx);
        const col = makeDayColumn(date);
        board.appendChild(col);
        renderEntriesInto(col.querySelector(".day-body"), fmtDate(date));
      }
    }
  }

  function render12m(){
    board.className = "twelve-months";
    const base = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    for (let m=0;m<12;m++){
      const dt = new Date(base.getFullYear(), base.getMonth()+m, 1);
      const col = document.createElement("div");
      col.className = "month-column";
      col.dataset.month = dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");
      col.addEventListener("dragover", e=>e.preventDefault());
      col.addEventListener("drop", onDropMonth);
      const head = document.createElement("div");
      head.className = "month-header";
      head.textContent = new Intl.DateTimeFormat("de-DE",{month:"long",year:"numeric"}).format(dt);
      const body = document.createElement("div");
      body.className = "month-body";
      col.appendChild(head);
      col.appendChild(body);
      board.appendChild(col);

      // EintrÃ¤ge: alle, deren tag im Monat ist UND exakt auf 1. liegt â†’ "grob"
      const monthEntries = eintraege.filter(e=>{
        const t = new Date(e.tag);
        return t.getFullYear()===dt.getFullYear() && t.getMonth()===dt.getMonth();
      }).filter(entryMatchesView);
      for (const e of monthEntries){
        const card = makeEntryCard(e);
        body.appendChild(card);
      }
    }
  }

  // === 6. Drag & Drop =================================================================
  let dragId = null;
  function onDragStart(e){
    dragId = e.target.dataset.id;
  }
  async function onDropDay(ev){
    ev.preventDefault();
    if (!dragId) return;
    const dateStr = ev.currentTarget.dataset.date;
    await supa.from('plantafel').update({tag: dateStr}).eq('id', dragId);
    await loadEintraege();
    render();
    dragId = null;
  }
  async function onDropMonth(ev){
    ev.preventDefault();
    if (!dragId) return;
    // setze Tag = 1. des Monats
    const [y,m] = ev.currentTarget.dataset.month.split("-");
    const dateStr = y+"-"+m+"-01";
    await supa.from('plantafel').update({tag: dateStr}).eq('id', dragId);
    await loadEintraege();
    render();
    dragId = null;
  }

  // === 7. CRUD EintrÃ¤ge ===============================================================
  function openNew(prefillDate){
    const dlg = document.getElementById("dlgNew");
    document.getElementById("frmNew").reset();
    document.getElementById("von").value = prefillDate || fmtDate(startDate);
    document.getElementById("bis").value = "";
    // lists fÃ¼llen
    fillSelects();
    dlg.showModal();
  }

  function fillSelects(){
    const selM = document.getElementById("selMitarbeiter");
    const selF = document.getElementById("selFahrzeuge");
    selM.innerHTML = "";
    selF.innerHTML = "";
    for (const m of mitarbeiter){
      const opt = document.createElement("option");
      opt.value = m.name;
      opt.textContent = m.name;
      selM.appendChild(opt);
    }
    for (const f of fahrzeuge){
      const opt = document.createElement("option");
      opt.value = f.name;
      opt.textContent = f.name;
      selF.appendChild(opt);
    }
  }

  document.getElementById("frmNew").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const titel = document.getElementById("neubau").value.trim();
    const von = document.getElementById("von").value;
    const bis = document.getElementById("bis").value;
    const status = document.getElementById("selStatus").value;
    const notiz = document.getElementById("txtNotiz").value.trim();
    const selM = Array.from(document.getElementById("selMitarbeiter").selectedOptions).map(o=>o.value);
    const selF = Array.from(document.getElementById("selFahrzeuge").selectedOptions).map(o=>o.value);

    // wenn bis leer â†’ 1 Tag
    const dates = [];
    if (!bis){
      dates.push(von);
    } else {
      let cur = new Date(von);
      const end = new Date(bis);
      while (cur <= end){
        dates.push(fmtDate(cur));
        cur = addDays(cur,1);
      }
    }
    for (const d of dates){
      await supa.from('plantafel').insert({
        tag: d,
        titel: titel || "(ohne Titel)",
        mitarbeiter: selM.join(", "),
        fahrzeug: selF.join(", "),
        status: status,
        notiz: notiz,
        sort: 0
      });
    }
    document.getElementById("dlgNew").close();
    await loadEintraege();
    render();
  });

  async function deleteEntry(id){
    if (!confirm("Eintrag wirklich lÃ¶schen?")) return;
    await supa.from('plantafel').delete().eq('id', id);
    await loadEintraege();
    render();
  }

  // === 8. Stammdaten-UI ===============================================================
  function openStammdaten(){
    const dlg = document.getElementById("dlgStamm");
    redrawStammLists();
    dlg.showModal();
  }
  function redrawStammLists(){
    const lm = document.getElementById("listMit");
    const lf = document.getElementById("listFzg");
    lm.innerHTML = "";
    lf.innerHTML = "";
    for (const m of mitarbeiter){
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.alignItems = "center";
      li.style.gap = ".5rem";
      li.style.marginBottom = ".25rem";
      li.innerHTML = `<span style="display:flex;align-items:center;gap:.35rem;">
          <span style="width:12px;height:12px;border-radius:999px;background:${colorForName(m.name)};"></span>
          ${m.name}
        </span>`;
      const btn = document.createElement("button");
      btn.textContent = "Ã—";
      btn.className = "danger";
      btn.style.padding = "0 .4rem";
      btn.style.fontSize = ".6rem";
      btn.onclick = ()=>removeMitarbeiter(m.id);
      li.appendChild(btn);
      lm.appendChild(li);
    }
    for (const f of fahrzeuge){
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.alignItems = "center";
      li.style.marginBottom = ".25rem";
      li.textContent = f.name;
      const btn = document.createElement("button");
      btn.textContent = "Ã—";
      btn.className = "danger";
      btn.style.padding = "0 .4rem";
      btn.style.fontSize = ".6rem";
      btn.onclick = ()=>removeFahrzeug(f.id);
      li.appendChild(btn);
      lf.appendChild(li);
    }
  }

  async function addMitarbeiter(){
    const name = document.getElementById("inNewMit").value.trim();
    if (!name) return;
    await supa.from('mitarbeiter').insert({name});
    document.getElementById("inNewMit").value = "";
    await loadStammdaten();
    redrawStammLists();
  }
  async function addFahrzeug(){
    const name = document.getElementById("inNewFzg").value.trim();
    if (!name) return;
    await supa.from('fahrzeuge').insert({name});
    document.getElementById("inNewFzg").value = "";
    await loadStammdaten();
    redrawStammLists();
  }
  async function removeMitarbeiter(id){
    if (!confirm("Mitarbeiter lÃ¶schen?")) return;
    await supa.from('mitarbeiter').delete().eq('id', id);
    await loadStammdaten();
    redrawStammLists();
  }
  async function removeFahrzeug(id){
    if (!confirm("Fahrzeug lÃ¶schen?")) return;
    await supa.from('fahrzeuge').delete().eq('id', id);
    await loadStammdaten();
    redrawStammLists();
  }

  // === 9. Events ======================================================================
  document.getElementById("btn14").onclick = async ()=>{
    currentView = "14";
    await loadEintraege();
    render();
  };
  document.getElementById("btn4w").onclick = async ()=>{
    currentView = "4w";
    await loadEintraege();
    render();
  };
  document.getElementById("btn12m").onclick = async ()=>{
    currentView = "12m";
    await loadEintraege();
    render();
  };
  document.getElementById("btnNew").onclick = ()=>openNew();
  document.getElementById("btnStammdaten").onclick = ()=>openStammdaten();
  document.getElementById("btnReload").onclick = async ()=>{
    await loadStammdaten();
    await loadEintraege();
    render();
  };
  document.getElementById("chkUrlaub").onchange = ()=>render();
  document.getElementById("startDate").onchange = async (e)=>{
    startDate = new Date(e.target.value);
    await loadEintraege();
    render();
  };

  // === 10. Start ======================================================================
  (async function init(){
    // Start-Datum auf heute, aber du kannst 03.11.2025 nehmen
    const d = new Date();
    document.getElementById("startDate").value = fmtDate(d);
    startDate = d;
    await loadStammdaten();
    await loadEintraege();
    render();
  })();
</script>

</body>
</html>
