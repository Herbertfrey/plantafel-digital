<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plantafel Dachdeckerei Frey</title>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --blue: #0075c9;
      --blue-dark: #005a99;
      --bg: #f0f0f0;
      --card-border: #000000;
      --text-main: #222;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      background: var(--blue);
      color: #fff;
      padding: 14px 18px;
      font-size: 22px;
      font-weight: bold;
    }

    #page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 10px 10px 40px;
    }

    h1, h2, h3 {
      margin: 0 0 10px;
      font-weight: bold;
    }

    .section {
      background: #ffffff;
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .small-text {
      font-size: 12px;
      color: #666;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 5px 6px;
      vertical-align: top;
    }

    th {
      background: #e7e7e7;
      font-weight: 600;
      text-align: left;
    }

    .btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: var(--blue);
      color: #fff;
      margin-right: 4px;
      margin-top: 4px;
    }
    .btn.secondary { background: #777; }
    .btn.danger { background: #b00020; }

    .btn:hover { background: var(--blue-dark); }
    .btn.secondary:hover { background: #555; }
    .btn.danger:hover { background: #870018; }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    input[type="color"],
    textarea {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 3px;
      border: 1px solid #bbb;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 16px;
    }

    .form-actions { margin-top: 8px; }

    .status-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 10px;
      border: 1px solid #555;
      font-size: 11px;
      margin-top: 2px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      margin: 10px 0 14px;
      border-bottom: 2px solid #ddd;
    }
    .tab-btn {
      border: none;
      background: #e0e0e0;
      padding: 8px 14px;
      border-radius: 6px 6px 0 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #ffffff;
      border-bottom: 2px solid #ffffff;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Karten */
    .card {
      border: 2px solid var(--card-border);
      background: #ffffff;
      padding: 3px 4px;
      margin-bottom: 4px;
      font-size: 11px;
      line-height: 1.2;
      min-height: 40px;
    }

    .card-inner {
      display: flex;
    }

    .card-color-strip {
      width: 5px;
      background: transparent;
      margin-right: 4px;
    }

    .card-content { flex: 1; }

    .card-title {
      font-weight: bold;
      text-transform: uppercase;
      border-bottom: 1px solid #000;
      margin-bottom: 2px;
      padding-bottom: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-line,
    .card-meta {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 10px;
    }

    /* Wochenbrett */
    .week-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
    }

    .week-table th,
    .week-table td {
      border: 2px solid #777;
      vertical-align: top;
      padding: 3px;
    }

    .week-head {
      background: #f3f3f3;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
    }

    .week-day-label {
      font-weight: bold;
      width: 60px;
      text-align: center;
      background: #f7f7f7;
    }

    .week-cell {
      min-height: 80px;
      background: #fff;
    }

    .week-cell.dragover {
      outline: 2px dashed #0075c9;
    }

    .week-controls { margin-bottom: 8px; }

    /* Jahresübersicht */
    .year-layout {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .year-table {
      border-collapse: collapse;
      font-size: 12px;
      min-width: 750px;
    }

    .year-table th,
    .year-table td {
      border: 2px solid #777;
      padding: 6px;
      vertical-align: top;
    }

    .year-kw-cell {
      width: 110px;
      text-align: center;
      font-weight: bold;
      background: #f3f3f3;
      font-size: 11px;
      line-height: 1.3;
    }

    .year-kw-main {
      font-weight: bold;
    }
    .year-kw-sub {
      font-size: 11px;
    }

    .year-month-header {
      text-align: center;
      font-weight: bold;
      background: #e7e7e7;
      font-size: 13px;
    }

    .year-month-cell {
      min-height: 130px;
      background: #fff;
    }

    .year-month-title {
      font-weight: bold;
      font-size: 12px;
      text-align: center;
      margin-bottom: 4px;
    }

    .year-month-drop {
      min-height: 90px;
    }

    .year-month-drop.dragover {
      outline: 2px dashed #0075c9;
    }

    .year-right-cols {
      min-width: 220px;
    }

    .year-cat-box {
      border: 2px solid #777;
      border-radius: 4px;
      padding: 4px;
      margin-bottom: 8px;
      background: #fafafa;
    }

    .year-cat-title {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
      text-align: center;
    }

    .year-cat-drop {
      min-height: 80px;
      background: #fff;
      padding: 2px;
    }

    .year-cat-drop.dragover {
      outline: 2px dashed #0075c9;
    }

    /* Urlaubsliste */
    .urlaub-list table { font-size: 12px; }

    /* Stammdaten */
    .stamm-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }

    .stamm-table {
      font-size: 12px;
      margin-top: 6px;
    }

    .stamm-table th,
    .stamm-table td {
      padding: 3px 4px;
    }

    .stamm-table tr:hover {
      background: #f0f8ff;
      cursor: pointer;
    }

    .color-dot {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #555;
      margin-right: 4px;
      vertical-align: middle;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
      header { font-size: 18px; padding: 12px; }
      .week-table { font-size: 10px; }
      .card { font-size: 10px; }
      .year-layout { flex-direction: column; }
    }
  </style>
</head>
<body>
<header>Plantafel Dachdeckerei Frey</header>

<div id="page">

  <!-- Tabs -->
  <nav class="tabs">
    <button class="tab-btn active" data-tab="jahr">Jahresplanung</button>
    <button class="tab-btn" data-tab="woche">Wochenplanung</button>
  </nav>

  <!-- TAB: JAHRESPLANUNG -->
  <div id="tab-jahr" class="tab-content active">
    <div class="section">
      <div class="section-header">
        <h2>Jahresübersicht (wie großes Board)</h2>
        <span class="small-text">Karten per Drag & Drop verschieben – Datum wird nicht verändert.</span>
      </div>

      <div class="year-layout">
        <!-- Raster 4x3 Monate -->
        <table class="year-table" id="yearTable"></table>

        <!-- Rechte Kategorien-Spalte -->
        <div class="year-right-cols" id="yearCategories"></div>
      </div>
    </div>
  </div>

  <!-- TAB: WOCHENPLANUNG -->
  <div id="tab-woche" class="tab-content">

    <!-- LISTE -->
    <div class="section">
      <div class="section-header">
        <h2>Einträge (Liste)</h2>
        <span class="small-text">Klick auf eine Zeile lädt den Eintrag ins Formular.</span>
      </div>
      <div style="overflow-x:auto;">
        <table id="listTable">
          <thead>
          <tr>
            <th>Tag/Von</th>
            <th>Bis</th>
            <th>Titel</th>
            <th>Baustelle</th>
            <th>Mitarbeiter</th>
            <th>Fahrzeug</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- FORMULAR -->
    <div class="section">
      <h2>Eintrag bearbeiten / neu anlegen</h2>
      <p class="small-text">
        KW + Wochentag steuern das Wochen-Board. Bereich steuert das Jahresbrett (Monat / Kategorie).
      </p>
      <div class="form-grid">
        <div>
          <label>Tag (optional, nur Info):
            <input type="date" id="tagInput">
          </label>
        </div>
        <div>
          <label>Bereich (für Jahresbrett):
            <input type="text" id="bereichInput" placeholder="z.B. jan, pv, kleinigkeiten">
          </label>
        </div>

        <div>
          <label>Von (optional):
            <input type="date" id="vonInput">
          </label>
        </div>
        <div>
          <label>Bis (optional):
            <input type="date" id="bisInput">
          </label>
        </div>

        <div>
          <label>KW (für Wochenbrett):
            <input type="number" id="kwInput" min="1" max="53" placeholder="z.B. 49">
          </label>
        </div>
        <div>
          <label>Wochentag (für Wochenbrett):
            <select id="weekdayInput">
              <option value="">– bitte wählen –</option>
              <option value="mo">Montag</option>
              <option value="di">Dienstag</option>
              <option value="mi">Mittwoch</option>
              <option value="do">Donnerstag</option>
              <option value="fr">Freitag</option>
            </select>
          </label>
        </div>

        <div>
          <label>Titel:
            <input type="text" id="titelInput" placeholder="z.B. Dachsanierung Muster">
          </label>
        </div>
        <div>
          <label>Baustelle:
            <input type="text" id="baustelleInput" placeholder="Adresse / Kunde">
          </label>
        </div>

        <div>
          <label>Mitarbeiter:
            <input type="text" id="mitarbeiterInput" placeholder="z.B. Thomas, Kevin">
          </label>
        </div>
        <div>
          <label>Fahrzeug:
            <input type="text" id="fahrzeugInput" placeholder="z.B. Crafter Bus">
          </label>
        </div>

        <div>
          <label>Status:
            <input type="text" id="statusInput" placeholder="normal / Urlaub / krank / Schule / Fahr / ...">
          </label>
        </div>
        <div>
          <label>Notiz:
            <textarea id="notizInput" placeholder="Optionale Zusatzinfos"></textarea>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn" id="saveBtn">Speichern</button>
        <button class="btn danger" id="deleteBtn">Löschen</button>
        <button class="btn secondary" id="resetBtn">Formular leeren</button>
        <span class="small-text" id="statusInfo"></span>
      </div>
    </div>

    <!-- WOCHENBRETT -->
    <div class="section">
      <div class="section-header">
        <h2>Feinplanung – Magnettafel (KW / Mo–Fr)</h2>
        <span class="small-text">Drag & Drop verschiebt die Karte – KW / Wochentag werden gespeichert, Datum bleibt unverändert.</span>
      </div>
      <div class="week-controls">
        <button class="btn secondary" id="weekPrevBtn">Zurück</button>
        <button class="btn secondary" id="weekTodayBtn">Diese KW</button>
        <button class="btn secondary" id="weekNextBtn">Weiter</button>
        <span class="small-text" id="weekCaption"></span>
      </div>
      <div style="overflow-x:auto;">
        <table class="week-table" id="weekTable"></table>
      </div>
    </div>

    <!-- URLAUB -->
    <div class="section">
      <div class="section-header">
        <h2>Urlaubsübersicht</h2>
        <span class="small-text">Status enthält „Urlaub“ → erscheint hier.</span>
      </div>
      <div id="urlaubView" class="urlaub-list"></div>
    </div>

    <!-- STAMMDATEN -->
    <div class="section">
      <div class="section-header">
        <h2>Stammdaten</h2>
        <span class="small-text">Farben steuern Farbstreifen auf den Magnetkarten.</span>
      </div>
      <div class="stamm-grid">
        <!-- Mitarbeiter -->
        <div>
          <h3>Mitarbeiter</h3>
          <div class="form-grid">
            <div>
              <label>Name:
                <input type="text" id="maNameInput" placeholder="z.B. Thomas">
              </label>
            </div>
            <div>
              <label>Farbe:
                <input type="color" id="maColorInput" value="#ffcc00">
              </label>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn" id="maSaveBtn">Mitarbeiter speichern</button>
            <button class="btn secondary" id="maNewBtn">Neu</button>
            <button class="btn danger" id="maDeleteBtn">Löschen</button>
            <input type="hidden" id="maIdHidden">
          </div>

          <table class="stamm-table" id="maTable">
            <thead>
            <tr><th>Name</th><th>Farbe</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Fahrzeuge -->
        <div>
          <h3>Fahrzeuge</h3>
          <div class="form-grid">
            <div>
              <label>Bezeichnung:
                <input type="text" id="fzNameInput" placeholder="z.B. Crafter Bus">
              </label>
            </div>
            <div>
              <label>Kennzeichen:
                <input type="text" id="fzKennzInput" placeholder="z.B. EI-XY 123">
              </label>
            </div>
            <div>
              <label>Farbe:
                <input type="color" id="fzColorInput" value="#ff0000">
              </label>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn" id="fzSaveBtn">Fahrzeug speichern</button>
            <button class="btn secondary" id="fzNewBtn">Neu</button>
            <button class="btn danger" id="fzDeleteBtn">Löschen</button>
            <input type="hidden" id="fzIdHidden">
          </div>

          <table class="stamm-table" id="fzTable">
            <thead>
            <tr><th>Bezeichnung</th><th>Kennzeichen</th><th>Farbe</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /tab-woche -->

</div><!-- /page -->

<script>
  // -------------------------------------------------------------------
  //  SUPABASE – URL + API KEY
  // -------------------------------------------------------------------
  const SUPABASE_URL = "https://yzfmviddzhghvcxowbjl.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_dacXIaV9sWHEN0ysSeoFuw_88UaV5tn";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Globale Daten
  let allEntries = [];
  let allMitarbeiter = [];
  let allFahrzeuge = [];
  let currentEditId = null;

  // Wochenbrett: Basis-KW und wie viele KW-Spalten
  let baseKw = isoWeek(new Date());
  const weekSpan = 3; // 3 KW nebeneinander wie auf deinem Brett

  // Drag & Drop
  let draggedEntryId = null;

  // -------------------------------------------------------------------
  //  Tabs
  // -------------------------------------------------------------------
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabContents = document.querySelectorAll(".tab-content");

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      tabContents.forEach(c => c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
    });
  });

  // -------------------------------------------------------------------
  //  Helfer
  // -------------------------------------------------------------------
  function formatDate(d) {
    if (!d) return "";
    const dt = (d instanceof Date) ? d : new Date(d);
    if (isNaN(dt)) return "";
    return dt.toLocaleDateString("de-DE");
  }

  function toISODate(str) {
    if (!str) return null;
    return str;
  }

  function isoWeek(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }

  function dateFromIsoWeek(week, year) {
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4 && dow > 0)
      ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
      ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    ISOweekStart.setHours(0,0,0,0);
    return ISOweekStart;
  }

  function addDays(d, days) {
    const dt = new Date(d.getTime());
    dt.setDate(dt.getDate() + days);
    return dt;
  }

  function normalizeName(name) {
    if (!name) return "";
    return name.trim().toLowerCase();
  }

  function normalizeFirstFromList(listStr) {
    if (!listStr) return "";
    const first = listStr.split(",")[0];
    return normalizeName(first);
  }

  // -------------------------------------------------------------------
  //  Stammdaten
  // -------------------------------------------------------------------
  async function loadMitarbeiter() {
    const { data, error } = await supabase
      .from("mitarbeiter")
      .select("*")
      .order("name", { ascending: true });

    if (error) {
      console.warn("Fehler beim Laden Mitarbeiter:", error.message);
      allMitarbeiter = [];
    } else {
      allMitarbeiter = data || [];
    }
    renderMitarbeiterTable();
  }

  async function loadFahrzeuge() {
    const { data, error } = await supabase
      .from("fahrzeuge")
      .select("*")
      .order("name", { ascending: true });

    if (error) {
      console.warn("Fehler beim Laden Fahrzeuge:", error.message);
      allFahrzeuge = [];
    } else {
      allFahrzeuge = data || [];
    }
    renderFahrzeugTable();
  }

  function renderMitarbeiterTable() {
    const tbody = document.querySelector("#maTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    allMitarbeiter.forEach(ma => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ma.name || ""}</td>
        <td>
          <span class="color-dot" style="background:${ma.color || "#ffffff"}"></span>
          ${ma.color || ""}
        </td>`;
      tr.addEventListener("click", () => fillMitarbeiterForm(ma));
      tbody.appendChild(tr);
    });
  }

  function renderFahrzeugTable() {
    const tbody = document.querySelector("#fzTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    allFahrzeuge.forEach(fz => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${fz.name || ""}</td>
        <td>${fz.kennzeichen || ""}</td>
        <td>
          <span class="color-dot" style="background:${fz.color || "#ffffff"}"></span>
          ${fz.color || ""}
        </td>`;
      tr.addEventListener("click", () => fillFahrzeugForm(fz));
      tbody.appendChild(tr);
    });
  }

  function fillMitarbeiterForm(ma) {
    document.getElementById("maIdHidden").value = ma.id || "";
    document.getElementById("maNameInput").value = ma.name || "";
    document.getElementById("maColorInput").value = ma.color || "#ffcc00";
  }

  function clearMitarbeiterForm() {
    document.getElementById("maIdHidden").value = "";
    document.getElementById("maNameInput").value = "";
    document.getElementById("maColorInput").value = "#ffcc00";
  }

  async function saveMitarbeiter() {
    const id = document.getElementById("maIdHidden").value || null;
    const name = document.getElementById("maNameInput").value.trim();
    const color = document.getElementById("maColorInput").value;

    if (!name) {
      alert("Name darf nicht leer sein.");
      return;
    }

    let error;
    if (id) {
      ({ error } = await supabase.from("mitarbeiter").update({ name, color }).eq("id", id));
    } else {
      ({ error } = await supabase.from("mitarbeiter").insert({ name, color }));
    }

    if (error) {
      console.error("Fehler beim Speichern Mitarbeiter:", error);
      alert("Fehler beim Speichern Mitarbeiter.");
      return;
    }

    await loadMitarbeiter();
    renderWeekView();
    renderYearView();
  }

  async function deleteMitarbeiter() {
    const id = document.getElementById("maIdHidden").value;
    if (!id) {
      alert("Kein Mitarbeiter ausgewählt.");
      return;
    }
    if (!confirm("Mitarbeiter wirklich löschen?")) return;

    const { error } = await supabase.from("mitarbeiter").delete().eq("id", id);
    if (error) {
      console.error("Fehler beim Löschen Mitarbeiter:", error);
      alert("Fehler beim Löschen.");
      return;
    }

    clearMitarbeiterForm();
    await loadMitarbeiter();
    renderWeekView();
    renderYearView();
  }

  function fillFahrzeugForm(fz) {
    document.getElementById("fzIdHidden").value = fz.id || "";
    document.getElementById("fzNameInput").value = fz.name || "";
    document.getElementById("fzKennzInput").value = fz.kennzeichen || "";
    document.getElementById("fzColorInput").value = fz.color || "#ff0000";
  }

  function clearFahrzeugForm() {
    document.getElementById("fzIdHidden").value = "";
    document.getElementById("fzNameInput").value = "";
    document.getElementById("fzKennzInput").value = "";
    document.getElementById("fzColorInput").value = "#ff0000";
  }

  async function saveFahrzeug() {
    const id = document.getElementById("fzIdHidden").value || null;
    const name = document.getElementById("fzNameInput").value.trim();
    const kennzeichen = document.getElementById("fzKennzInput").value.trim();
    const color = document.getElementById("fzColorInput").value;

    if (!name) {
      alert("Bezeichnung darf nicht leer sein.");
      return;
    }

    let error;
    if (id) {
      ({ error } = await supabase
        .from("fahrzeuge")
        .update({ name, kennzeichen, color })
        .eq("id", id));
    } else {
      ({ error } = await supabase
        .from("fahrzeuge")
        .insert({ name, kennzeichen, color }));
    }

    if (error) {
      console.error("Fehler beim Speichern Fahrzeug:", error);
      alert("Fehler beim Speichern Fahrzeug.");
      return;
    }

    await loadFahrzeuge();
    renderWeekView();
    renderYearView();
  }

  async function deleteFahrzeug() {
    const id = document.getElementById("fzIdHidden").value;
    if (!id) {
      alert("Kein Fahrzeug ausgewählt.");
      return;
    }
    if (!confirm("Fahrzeug wirklich löschen?")) return;

    const { error } = await supabase.from("fahrzeuge").delete().eq("id", id);
    if (error) {
      console.error("Fehler beim Löschen Fahrzeug:", error);
      alert("Fehler beim Löschen.");
      return;
    }

    clearFahrzeugForm();
    await loadFahrzeuge();
    renderWeekView();
    renderYearView();
  }

  function getMitarbeiterColor(mitarbeiterStr) {
    const name = normalizeFirstFromList(mitarbeiterStr);
    if (!name) return null;
    const found = allMitarbeiter.find(ma => normalizeName(ma.name) === name);
    return found ? found.color : null;
  }

  function getFahrzeugColor(fahrzeugStr) {
    if (!fahrzeugStr) return null;
    const val = normalizeName(fahrzeugStr);
    if (!val) return null;
    const found = allFahrzeuge.find(fz =>
      normalizeName(fz.name) === val ||
      normalizeName(fz.kennzeichen || "") === val
    );
    return found ? found.color : null;
  }

  // -------------------------------------------------------------------
  //  Plantafel-Einträge
  // -------------------------------------------------------------------
  async function loadEntries() {
    const { data, error } = await supabase
      .from("plantafel")
      .select("*")
      .order("von", { ascending: true });

    if (error) {
      console.error("Supabase Fehler (loadEntries):", error);
      const si = document.getElementById("statusInfo");
      if (si) si.textContent = "Fehler beim Laden der Einträge.";
      return;
    }

    allEntries = data || [];
    renderList();
    renderWeekView();
    renderYearView();
    renderUrlaub();

    const si = document.getElementById("statusInfo");
    if (si) si.textContent = "Einträge geladen.";
  }

  function renderList() {
    const tbody = document.querySelector("#listTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    allEntries.forEach(entry => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDate(entry.tag || entry.von)}</td>
        <td>${formatDate(entry.bis)}</td>
        <td>${entry.titel || ""}</td>
        <td>${entry.baustelle || ""}</td>
        <td>${entry.mitarbeiter || ""}</td>
        <td>${entry.fahrzeug || ""}</td>
        <td>${entry.status || ""}</td>
      `;
      tr.addEventListener("click", () => fillForm(entry));
      tbody.appendChild(tr);
    });
  }

  function fillForm(entry) {
    currentEditId = entry.id;

    document.getElementById("tagInput").value = entry.tag || "";
    document.getElementById("bereichInput").value = entry.bereich || "";
    document.getElementById("vonInput").value = entry.von || "";
    document.getElementById("bisInput").value = entry.bis || "";
    document.getElementById("kwInput").value = entry.kw || "";
    document.getElementById("weekdayInput").value = entry.weekday || "";
    document.getElementById("titelInput").value = entry.titel || "";
    document.getElementById("baustelleInput").value = entry.baustelle || "";
    document.getElementById("mitarbeiterInput").value = entry.mitarbeiter || "";
    document.getElementById("fahrzeugInput").value = entry.fahrzeug || "";
    document.getElementById("statusInput").value = entry.status || "";
    document.getElementById("notizInput").value = entry.notiz || "";

    document.getElementById("statusInfo").textContent =
      "Eintrag geladen – Änderungen nicht vergessen zu speichern.";
  }

  function resetForm() {
    currentEditId = null;
    document.getElementById("tagInput").value = "";
    document.getElementById("bereichInput").value = "";
    document.getElementById("vonInput").value = "";
    document.getElementById("bisInput").value = "";
    document.getElementById("kwInput").value = "";
    document.getElementById("weekdayInput").value = "";
    document.getElementById("titelInput").value = "";
    document.getElementById("baustelleInput").value = "";
    document.getElementById("mitarbeiterInput").value = "";
    document.getElementById("fahrzeugInput").value = "";
    document.getElementById("statusInput").value = "";
    document.getElementById("notizInput").value = "";
    const si = document.getElementById("statusInfo");
    if (si) si.textContent = "Neuer Eintrag.";
  }

  async function saveEntry() {
    const tag = toISODate(document.getElementById("tagInput").value);
    let kw = parseInt(document.getElementById("kwInput").value, 10);
    let weekday = document.getElementById("weekdayInput").value || null;
    const bereich = document.getElementById("bereichInput").value.trim() || null;
    const von = toISODate(document.getElementById("vonInput").value);
    const bis = toISODate(document.getElementById("bisInput").value);
    const titel = document.getElementById("titelInput").value.trim();
    const baustelle = document.getElementById("baustelleInput").value.trim();
    const mitarbeiter = document.getElementById("mitarbeiterInput").value.trim();
    const fahrzeug = document.getElementById("fahrzeugInput").value.trim();
    const status = document.getElementById("statusInput").value.trim();
    const notiz = document.getElementById("notizInput").value.trim();

    // Wenn KW/Wochentag leer, aber Tag gesetzt → automatisch berechnen
    if ((!kw || kw < 1 || kw > 53) && tag) {
      kw = isoWeek(new Date(tag));
      document.getElementById("kwInput").value = kw;
    }
    if (!weekday && tag) {
      const d = new Date(tag);
      const wd = d.getDay(); // So = 0, Mo=1...
      const map = ["so","mo","di","mi","do","fr","sa"];
      weekday = map[wd];
      if (["mo","di","mi","do","fr"].includes(weekday)) {
        document.getElementById("weekdayInput").value = weekday;
      } else {
        weekday = null; // Wochenende → kein Wochentag
      }
    }

    const payload = {
      tag, bereich, von, bis, kw: kw || null, weekday,
      titel, baustelle, mitarbeiter, fahrzeug, status, notiz
    };

    let error;
    if (currentEditId) {
      ({ error } = await supabase.from("plantafel").update(payload).eq("id", currentEditId));
    } else {
      ({ error } = await supabase.from("plantafel").insert(payload));
    }

    if (error) {
      console.error("Supabase Fehler (saveEntry):", error);
      alert("Fehler beim Speichern.");
      return;
    }

    document.getElementById("statusInfo").textContent = "Gespeichert.";
    await loadEntries();
    resetForm();
  }

  async function deleteEntry() {
    if (!currentEditId) {
      alert("Kein Eintrag ausgewählt.");
      return;
    }
    if (!confirm("Diesen Eintrag wirklich löschen?")) return;

    const { error } = await supabase.from("plantafel").delete().eq("id", currentEditId);

    if (error) {
      console.error("Supabase Fehler (deleteEntry):", error);
      alert("Fehler beim Löschen.");
      return;
    }

    document.getElementById("statusInfo").textContent = "Eintrag gelöscht.";
    await loadEntries();
    resetForm();
  }

  // -------------------------------------------------------------------
  //  Karten-Erzeugung (für beide Boards)
  // -------------------------------------------------------------------
  function createCardElement(entry) {
    const card = document.createElement("div");
    card.className = "card";
    card.draggable = true;
    card.dataset.entryId = entry.id;

    card.addEventListener("dragstart", () => { draggedEntryId = entry.id; });
    card.addEventListener("dragend", () => { draggedEntryId = null; });
    card.addEventListener("click", () => fillForm(entry));

    const title = entry.baustelle || entry.titel || "Ohne Titel";
    const fahr = entry.fahrzeug || "";
    const mit = entry.mitarbeiter || "";
    const stat = (entry.status || "").toLowerCase();

    const maColor = getMitarbeiterColor(mit);
    const fzColor = getFahrzeugColor(fahr);
    const stripeColor = maColor || fzColor || null;

    const inner = document.createElement("div");
    inner.className = "card-inner";

    const strip = document.createElement("div");
    strip.className = "card-color-strip";
    if (stripeColor) strip.style.background = stripeColor;

    const content = document.createElement("div");
    content.className = "card-content";
    content.innerHTML = `
      <div class="card-title">${title}</div>
      <div class="card-line card-meta">Fahrzeug: ${fahr}</div>
      <div class="card-line card-meta">MA: ${mit}</div>
      ${stat ? `<div class="card-line"><span class="status-badge">${stat}</span></div>` : ""}`;

    inner.appendChild(strip);
    inner.appendChild(content);
    card.appendChild(inner);
    return card;
  }

  // -------------------------------------------------------------------
  //  WOCHENBRETT – KW & Mo–Fr, rein visuell
  // -------------------------------------------------------------------
  function renderWeekView() {
    const table = document.getElementById("weekTable");
    if (!table) return;
    table.innerHTML = "";

    // Caption
    const cap = document.getElementById("weekCaption");
    const kwList = [];
    for (let i = 0; i < weekSpan; i++) kwList.push(baseKw + i);
    cap.textContent = "KW " + kwList.join(", ");

    const year = new Date().getFullYear();

    const weekdays = [
      { key: "mo", label: "Mo" },
      { key: "di", label: "Di" },
      { key: "mi", label: "Mi" },
      { key: "do", label: "Do" },
      { key: "fr", label: "Fr" }
    ];

    // Kopfzeile
    const thead = document.createElement("thead");
    const headRow = document.createElement("tr");
    const emptyTh = document.createElement("th");
    emptyTh.textContent = "Tag / KW";
    headRow.appendChild(emptyTh);

    for (let i = 0; i < weekSpan; i++) {
      const kw = baseKw + i;
      const th = document.createElement("th");
      th.className = "week-head";
      const startDate = dateFromIsoWeek(kw, year);
      const endDate = addDays(startDate, 4);
      th.innerHTML = `KW ${kw}<br>${formatDate(startDate)} – ${formatDate(endDate)}`;
      headRow.appendChild(th);
    }

    thead.appendChild(headRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    weekdays.forEach(wd => {
      const tr = document.createElement("tr");

      const labelTd = document.createElement("td");
      labelTd.className = "week-day-label";
      labelTd.textContent = wd.label;
      tr.appendChild(labelTd);

      for (let i = 0; i < weekSpan; i++) {
        const kw = baseKw + i;
        const td = document.createElement("td");
        td.className = "week-cell";
        td.dataset.kw = kw;
        td.dataset.weekday = wd.key;

        td.addEventListener("dragover", ev => {
          ev.preventDefault();
          td.classList.add("dragover");
        });
        td.addEventListener("dragleave", () => {
          td.classList.remove("dragover");
        });
        td.addEventListener("drop", async ev => {
          ev.preventDefault();
          td.classList.remove("dragover");
          if (draggedEntryId) {
            await moveEntryToKwWeekday(draggedEntryId, kw, wd.key);
          }
        });

        // Einträge für diese KW + Wochentag
        const entries = allEntries.filter(e => e.kw === kw && e.weekday === wd.key);
        entries.forEach(e => td.appendChild(createCardElement(e)));

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
  }

  async function moveEntryToKwWeekday(entryId, kw, weekday) {
    const { error } = await supabase
      .from("plantafel")
      .update({ kw, weekday })
      .eq("id", entryId);

    if (error) {
      console.error("Fehler beim Verschieben im Wochenbrett:", error);
      alert("Fehler beim Verschieben.");
      return;
    }
    await loadEntries();
  }

  // -------------------------------------------------------------------
  //  JAHRESÜBERSICHT (wie dein Board)
  // -------------------------------------------------------------------
  const monthsDef = [
    { key: "jan", label: "Jan" },
    { key: "feb", label: "Feb" },
    { key: "mar", label: "Mär" },
    { key: "apr", label: "Apr" },
    { key: "mai", label: "Mai" },
    { key: "jun", label: "Jun" },
    { key: "jul", label: "Jul" },
    { key: "aug", label: "Aug" },
    { key: "sep", label: "Sep" },
    { key: "okt", label: "Okt" },
    { key: "nov", label: "Nov" },
    { key: "dez", label: "Dez" }
  ];

  const yearCategoriesDef = [
    { key: "kleinigkeiten", label: "Kleinigkeiten" },
    { key: "sanierung", label: "Sanierungen" },
    { key: "pv", label: "PV" },
    { key: "flachdach", label: "Flachdach" },
    { key: "sonst", label: "Sonstiges" }
  ];

  function renderYearView() {
    const yearTable = document.getElementById("yearTable");
    const catContainer = document.getElementById("yearCategories");
    if (!yearTable || !catContainer) return;

    yearTable.innerHTML = "";

    const year = new Date().getFullYear();

    for (let r = 0; r < 4; r++) {
      const headerRow = document.createElement("tr");
      const row = document.createElement("tr");

      const firstMonthIndex = r * 3;
      const lastMonthIndex = r * 3 + 2;

      const monthStart = new Date(year, firstMonthIndex, 1);
      const monthEnd = new Date(year, lastMonthIndex + 1, 0);

      const kwStart = isoWeek(monthStart);
      const kwEnd = isoWeek(monthEnd);

      const kwCellHeader = document.createElement("th");
      kwCellHeader.className = "year-kw-cell";
      kwCellHeader.innerHTML = `
        <div class="year-kw-main">KW ${kwStart} – ${kwEnd}</div>
        <div class="year-kw-sub">${formatDate(monthStart)} – ${formatDate(monthEnd)}</div>
      `;
      headerRow.appendChild(kwCellHeader);

      const kwCellRow = document.createElement("td");
      kwCellRow.className = "year-kw-cell";
      row.appendChild(kwCellRow);

      for (let c = 0; c < 3; c++) {
        const monthIndex = r * 3 + c;
        const mDef = monthsDef[monthIndex];

        const th = document.createElement("th");
        th.className = "year-month-header";
        th.textContent = mDef.label;
        headerRow.appendChild(th);

        const td = document.createElement("td");
        td.className = "year-month-cell";

        const title = document.createElement("div");
        title.className = "year-month-title";
        title.textContent = mDef.label;

        const drop = document.createElement("div");
        drop.className = "year-month-drop";
        drop.dataset.bereich = mDef.key;

        makeYearDropTarget(drop, mDef.key);

        const entries = allEntries.filter(e => (e.bereich || "").toLowerCase() === mDef.key);
        entries.forEach(e => drop.appendChild(createCardElement(e)));

        td.appendChild(title);
        td.appendChild(drop);
        row.appendChild(td);
      }

      yearTable.appendChild(headerRow);
      yearTable.appendChild(row);
    }

    catContainer.innerHTML = "";
    yearCategoriesDef.forEach(cat => {
      const box = document.createElement("div");
      box.className = "year-cat-box";

      const title = document.createElement("div");
      title.className = "year-cat-title";
      title.textContent = cat.label;
      box.appendChild(title);

      const drop = document.createElement("div");
      drop.className = "year-cat-drop";
      drop.dataset.bereich = cat.key;

      makeYearDropTarget(drop, cat.key);

      const entries = allEntries.filter(e => (e.bereich || "").toLowerCase() === cat.key);
      entries.forEach(e => drop.appendChild(createCardElement(e)));

      box.appendChild(drop);
      catContainer.appendChild(box);
    });
  }

  function makeYearDropTarget(el, bereichKey) {
    el.addEventListener("dragover", ev => {
      ev.preventDefault();
      el.classList.add("dragover");
    });
    el.addEventListener("dragleave", () => {
      el.classList.remove("dragover");
    });
    el.addEventListener("drop", async ev => {
      ev.preventDefault();
      el.classList.remove("dragover");
      if (draggedEntryId) {
        await moveEntryToBereich(draggedEntryId, bereichKey);
      }
    });
  }

  async function moveEntryToBereich(entryId, bereichKey) {
    const { error } = await supabase
      .from("plantafel")
      .update({ bereich: bereichKey })
      .eq("id", entryId);

    if (error) {
      console.error("Fehler beim Verschieben in Bereich:", error);
      alert("Fehler beim Verschieben.");
      return;
    }
    await loadEntries();
  }

  // -------------------------------------------------------------------
  //  Urlaubsübersicht
  // -------------------------------------------------------------------
  function renderUrlaub() {
    const container = document.getElementById("urlaubView");
    if (!container) return;
    container.innerHTML = "";

    const urlaubEntries = allEntries.filter(e =>
      (e.status || "").toLowerCase().includes("urlaub")
    );

    if (urlaubEntries.length === 0) {
      container.textContent = "Noch keine Urlaube erfasst.";
      return;
    }

    const byMA = {};
    urlaubEntries.forEach(e => {
      const name = (e.mitarbeiter || "Unbekannt").trim() || "Unbekannt";
      if (!byMA[name]) byMA[name] = [];
      byMA[name].push(e);
    });

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr>
        <th>Mitarbeiter</th>
        <th>Von</th>
        <th>Bis</th>
        <th>Titel / Baustelle</th>
      </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    Object.keys(byMA).sort().forEach(name => {
      byMA[name].forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${name}</td>
          <td>${formatDate(e.von || e.tag)}</td>
          <td>${formatDate(e.bis || e.von || e.tag)}</td>
          <td>${(e.baustelle || e.titel || "").slice(0,60)}</td>
        `;
        tbody.appendChild(tr);
      });
    });
    table.appendChild(tbody);
    container.appendChild(table);
  }

  // -------------------------------------------------------------------
  //  Events
  // -------------------------------------------------------------------
  document.getElementById("saveBtn").addEventListener("click", e => {
    e.preventDefault();
    saveEntry();
  });
  document.getElementById("deleteBtn").addEventListener("click", e => {
    e.preventDefault();
    deleteEntry();
  });
  document.getElementById("resetBtn").addEventListener("click", e => {
    e.preventDefault();
    resetForm();
  });

  // Wochenbrett Buttons
  document.getElementById("weekPrevBtn").addEventListener("click", () => {
    baseKw = Math.max(1, baseKw - weekSpan);
    renderWeekView();
  });
  document.getElementById("weekNextBtn").addEventListener("click", () => {
    baseKw = baseKw + weekSpan;
    if (baseKw > 53) baseKw = 53;
    renderWeekView();
  });
  document.getElementById("weekTodayBtn").addEventListener("click", () => {
    baseKw = isoWeek(new Date());
    renderWeekView();
  });

  // Stammdaten-Buttons
  document.getElementById("maSaveBtn").addEventListener("click", e => {
    e.preventDefault();
    saveMitarbeiter();
  });
  document.getElementById("maNewBtn").addEventListener("click", e => {
    e.preventDefault();
    clearMitarbeiterForm();
  });
  document.getElementById("maDeleteBtn").addEventListener("click", e => {
    e.preventDefault();
    deleteMitarbeiter();
  });

  document.getElementById("fzSaveBtn").addEventListener("click", e => {
    e.preventDefault();
    saveFahrzeug();
  });
  document.getElementById("fzNewBtn").addEventListener("click", e => {
    e.preventDefault();
    clearFahrzeugForm();
  });
  document.getElementById("fzDeleteBtn").addEventListener("click", e => {
    e.preventDefault();
    deleteFahrzeug();
  });

  // -------------------------------------------------------------------
  //  Init
  // -------------------------------------------------------------------
  async function init() {
    resetForm();
    clearMitarbeiterForm();
    clearFahrzeugForm();
    await loadMitarbeiter();
    await loadFahrzeuge();
    await loadEntries();
  }

  init();
</script>

</body>
</html>
