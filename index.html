<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plantafel Digital</title>

  <!-- Dark Theme + Layout -->
  <style>
    :root {
      --bg-main: #121212;
      --bg-card: #1e1e1e;
      --bg-toolbar: #1f1f1f;
      --bg-border: #333;
      --txt-main: #fff;
      --txt-dim: #aaa;
      --accent: #2962ff;
      --danger: #d32f2f;
      --radius-card: 8px;
      --radius-btn: 6px;
      --gap: 12px;
      --border-card: 1px solid rgba(255,255,255,0.08);
      --border-focus: 1px solid rgba(41,98,255,.6);
      --shadow-card: 0 8px 24px rgba(0,0,0,0.6);
      --shadow-dialog: 0 32px 64px rgba(0,0,0,0.8);
      --toolbar-h: auto;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      background: radial-gradient(circle at 20% 20%, rgba(60,60,60,.2) 0%, rgba(0,0,0,0) 60%), var(--bg-main);
      color: var(--txt-main);
      margin: 0;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header.toolbar {
      background-color: var(--bg-toolbar);
      color: var(--txt-main);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 16px 32px rgba(0,0,0,0.8);
      padding: 12px clamp(12px,1.5vw,20px) 16px;
      display: flex;
      flex-wrap: wrap;
      row-gap: 10px;
      column-gap: 12px;
      align-items: flex-start;
    }

    /* Toolbar groups */
    .tool-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: max-content;
    }

    .tool-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      column-gap: 8px;
      row-gap: 8px;
    }

    .online-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:#2ecc71;
      margin-right:8px;
      box-shadow:0 0 8px #2ecc71;
    }
    .online-wrap {
      background:#1b1f1c;
      border:1px solid rgba(46,204,113,.4);
      color:#2ecc71;
      font-size:14px;
      line-height:1.2;
      font-weight:500;
      padding:8px 12px;
      border-radius:var(--radius-btn);
      display:flex;
      align-items:center;
      gap:8px;
      min-width:max-content;
      box-shadow:0 8px 20px rgba(0,0,0,.8);
    }

    label.small-label {
      font-size:13px;
      font-weight:500;
      color:var(--txt-dim);
      display:block;
      margin-bottom:4px;
    }

    select,
    input[type="date"],
    input[type="text"] {
      background-color:#0f0f10;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:var(--radius-btn);
      color:var(--txt-main);
      font-size:14px;
      padding:9px 10px;
      min-width:160px;
      box-shadow:0 8px 24px rgba(0,0,0,0.8);
    }
    select:focus,
    input:focus {
      outline:none;
      border:1px solid rgba(41,98,255,.7);
      box-shadow:0 0 0 2px rgba(41,98,255,.3),0 24px 48px rgba(0,0,0,.9);
    }

    button,
    .btn {
      appearance:none;
      border:none;
      cursor:pointer;
      font-size:14px;
      line-height:1.2;
      font-weight:500;
      border-radius:var(--radius-btn);
      padding:9px 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      min-height:36px;
      box-shadow:0 12px 32px rgba(0,0,0,.8);
      user-select:none;
      -webkit-user-select:none;
      background-color:#2a2a2f;
      color:#fff;
      border:1px solid rgba(255,255,255,0.12);
    }
    button.primary,
    .btn.primary {
      background-color:var(--accent);
      border:1px solid rgba(41,98,255,.6);
      box-shadow:0 16px 32px rgba(41,98,255,.4);
      color:#fff;
      font-weight:600;
    }
    button.danger {
      background-color:#2a1a1a;
      border:1px solid rgba(211,47,47,.6);
      color:#ff8080;
      box-shadow:0 16px 32px rgba(211,47,47,.4);
    }
    button.ghost {
      background:transparent;
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
    }
    button:active {
      transform:scale(.98);
    }

    .chk-wrap {
      display:flex;
      flex-wrap:nowrap;
      align-items:center;
      gap:8px;
      font-size:14px;
      font-weight:500;
      background:#1a1a1f;
      padding:9px 12px;
      border-radius:var(--radius-btn);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 12px 32px rgba(0,0,0,.8);
      color:#fff;
      min-height:36px;
    }
    .chk-wrap input[type="checkbox"]{
      width:16px;
      height:16px;
      accent-color:var(--accent);
      cursor:pointer;
    }

    main {
      flex:1;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      padding:16px clamp(12px,1.5vw,20px) 96px;
      color:var(--txt-main);
    }

    .hint-row{
      font-size:13px;
      color:var(--txt-dim);
      line-height:1.4;
    }

    .board-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(min(280px,100%),1fr));
      gap:var(--gap);
      align-items:flex-start;
    }

    /* Wochen-Column */
    .week-col {
      background:var(--bg-card);
      border:var(--border-card);
      border-radius:var(--radius-card);
      box-shadow:var(--shadow-card);
      display:flex;
      flex-direction:column;
      min-height:220px;
      max-height:90vh;
      overflow:hidden;
      position:relative;
    }

    .week-head {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.07);
      background:rgba(255,255,255,0.02);
    }

    .week-head-left {
      display:flex;
      flex-direction:column;
      font-size:13px;
      line-height:1.3;
    }
    .kw-title {
      color:#6fa2ff;
      font-weight:600;
      font-size:13px;
      margin-bottom:4px;
    }
    .kw-date {
      font-size:13px;
      color:var(--txt-dim);
      font-weight:400;
    }

    .week-head-right {
      display:flex;
      gap:6px;
    }
    .mini-btn {
      width:24px;
      height:24px;
      border-radius:6px;
      background:#2a2a2f;
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      font-size:16px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 12px 32px rgba(0,0,0,.8);
      user-select:none;
    }
    .mini-btn:active {
      transform:scale(.95);
    }

    /* Slot / Kartenbereich */
    .slot-area{
      flex:1;
      min-height:120px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:#555 transparent;
      font-size:13px;
      line-height:1.4;
      color:var(--txt-dim);
    }
    .slot-area::-webkit-scrollbar{
      width:6px;
    }
    .slot-area::-webkit-scrollbar-track{
      background:rgba(255,255,255,0.03);
    }
    .slot-area::-webkit-scrollbar-thumb{
      background:#555;
      border-radius:3px;
    }

    /* Einsatzkarte */
    .card {
      background:#1b1f2b;
      border:var(--border-focus);
      border-radius:var(--radius-card);
      box-shadow:0 20px 32px rgba(0,0,0,.9),0 0 20px rgba(41,98,255,.4);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      color:#fff;
      font-size:14px;
      position:relative;
    }
    .card.red {
      background:#2a1a1a;
      border:1px solid rgba(211,47,47,.6);
      box-shadow:0 20px 32px rgba(0,0,0,.9),0 0 20px rgba(211,47,47,.4);
    }

    .card-row-top{
      font-size:15px;
      font-weight:600;
      color:#fff;
      line-height:1.3;
      word-break:break-word;
    }

    .card-row-middle{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px 8px;
    }

    .pill{
      font-size:12px;
      line-height:1.2;
      font-weight:500;
      background:#2a2f3a;
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:4px 8px;
      box-shadow:0 12px 24px rgba(0,0,0,.9);
    }
    .pill.worker{
      background:#263238;
    }
    .pill.car{
      background:#1a237e;
      border-color:rgba(96,125,139,.6);
    }
    .pill.red{
      background:#3a1e1e;
      border-color:rgba(211,47,47,.6);
      color:#ff8a80;
    }

    .card-row-bottom{
      font-size:12px;
      line-height:1.2;
      color:var(--txt-dim);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .card-actions{
      position:absolute;
      top:8px;
      right:8px;
      display:flex;
      gap:4px;
    }
    .card-act-btn{
      width:22px;
      height:22px;
      border-radius:4px;
      background:#00000066;
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      font-size:12px;
      line-height:1;
      text-align:center;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.9);
      user-select:none;
      padding-top:3px;
    }
    .card-act-btn.danger{
      border-color:rgba(211,47,47,.7);
      color:#ff8a80;
    }

    footer.statusbar {
      color: var(--txt-dim);
      font-size: 12px;
      line-height:1.4;
      padding: 8px 12px 80px;
    }

    /* Floating + Button unten rechts */
    .fab-wrap {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      z-index:999;
      pointer-events:none;
    }
    .fab-main {
      pointer-events:auto;
      background:var(--accent);
      color:#fff;
      font-size:28px;
      line-height:1;
      width:52px;
      height:52px;
      border-radius:50%;
      border:1px solid rgba(41,98,255,.6);
      box-shadow:0 24px 32px rgba(41,98,255,.5),0 24px 64px rgba(0,0,0,.9);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:500;
    }
    .fab-main:active { transform:scale(.96); }

    /* Dialoge */
    dialog {
      background:#1b1c22;
      color:#fff;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.1);
      box-shadow:var(--shadow-dialog);
      padding:0;
      width:min(400px,90vw);
      max-width:90vw;
      max-height:90vh;
      border-top:1px solid rgba(255,255,255,.2);
      overflow:hidden;
    }
    dialog::backdrop{
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(4px);
    }

    .dlg-head{
      background:#2a2a30;
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:16px;
      font-size:15px;
      font-weight:600;
      line-height:1.3;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .dlg-head button{
      background:#0000;
      box-shadow:none;
      border:0;
      font-size:14px;
      color:var(--txt-dim);
      padding:4px 8px;
      line-height:1.2;
    }
    .dlg-body{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      font-size:14px;
      line-height:1.4;
    }
    .dlg-row{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .dlg-row label{
      font-size:13px;
      color:var(--txt-dim);
      font-weight:500;
    }
    .dlg-row input,
    .dlg-row textarea,
    .dlg-row select{
      width:100%;
      border-radius:var(--radius-btn);
      border:1px solid rgba(255,255,255,.15);
      background:#0f0f10;
      color:#fff;
      font-size:14px;
      padding:10px 12px;
      line-height:1.4;
      min-height:38px;
      box-shadow:0 12px 32px rgba(0,0,0,.8);
    }
    .dlg-row textarea{
      resize:none;
      min-height:60px;
    }

    .tag-line{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }

    .dlg-foot{
      border-top:1px solid rgba(255,255,255,.08);
      background:#2a2a30;
      padding:16px;
      display:flex;
      justify-content:flex-end;
      flex-wrap:wrap;
      gap:8px;
    }

    /* Stammdaten-Abschnitt im Dialog */
    .subbox{
      background:#26262f;
      border:1px solid rgba(255,255,255,.1);
      border-radius:var(--radius-card);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:0 20px 32px rgba(0,0,0,.9);
    }
    .subbox-head{
      font-size:13px;
      font-weight:600;
      color:#fff;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
    }
    .subbox-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
      line-height:1.2;
    }
    .sub-pill{
      background:#30303a;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      line-height:1.2;
      padding:4px 8px;
      color:#fff;
      box-shadow:0 16px 32px rgba(0,0,0,.9);
      display:flex;
      gap:6px;
      align-items:center;
    }
    .sub-pill .x{
      cursor:pointer;
      color:#ff8a80;
      font-weight:600;
    }

    /* kleine Statuszeile */
    .legend-row{
      font-size:12px;
      line-height:1.3;
      color:var(--txt-dim);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .legend-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--danger);
      box-shadow:0 0 6px var(--danger);
    }

    @media(min-width:900px){
      header.toolbar {
        flex-wrap:nowrap;
        align-items:flex-start;
      }
      .tool-col {
        flex-direction:column;
        min-width:auto;
      }
      .tool-row.wrap-break {
        flex-wrap:nowrap;
      }
    }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <header class="toolbar">
    <!-- Status / Verbunden -->
    <div class="tool-col">
      <div class="online-wrap">
        <div class="online-dot" id="cloudDot"></div>
        <span id="cloudTxt">verbunden</span>
      </div>

      <div class="legend-row">
        <div class="legend-dot"></div>
        <span>Status rot = Urlaub/Krank/Schule</span>
      </div>
    </div>

    <!-- Ansicht + Start + Reload -->
    <div class="tool-col" style="flex:1 1 auto; min-width:220px;">
      <div class="tool-row wrap-break">
        <div>
          <label class="small-label" for="viewSel">Ansicht:</label>
          <select id="viewSel">
            <option value="4w">4 Wochen (Mo–Fr)</option>
            <option value="2w">2 Wochen (Mo–Fr)</option>
            <option value="1w">1 Woche (Mo–Fr)</option>
          </select>
        </div>

        <div>
          <label class="small-label" for="startDate">Start:</label>
          <input id="startDate" type="date" />
        </div>

        <div style="align-self:flex-end;">
          <button class="btn ghost" id="btnReload">Neu laden</button>
        </div>
      </div>

      <div class="tool-row">
        <label class="chk-wrap">
          <input id="chkUrlaub" type="checkbox" />
          <span>Urlaub/Krank/Schule</span>
        </label>

        <label class="chk-wrap">
          <input id="chkAutoReload" type="checkbox" />
          <span>Auto-Reload</span>
        </label>

        <button class="btn ghost" id="btnMaster">Stammdaten</button>

        <button class="btn primary" id="btnAdd">+ Eintrag</button>
      </div>
    </div>
  </header>

  <!-- Hinweiszeile direkt unter Toolbar -->
  <main>
    <div class="hint-row">
      Drag &amp; Drop: Karte auf Ziel ziehen → „Verschieben“ oder „Duplizieren“. Klick auf Karte = bearbeiten, X = löschen.
    </div>

    <!-- Board -->
    <div id="board" class="board-grid">
      <!-- Dynamisch befüllt -->
    </div>
  </main>

  <footer class="statusbar">
    Status rot = Urlaub/Krank/Schule
  </footer>

  <!-- FAB unten rechts -->
  <div class="fab-wrap">
    <div class="fab-main" id="fabPlus">+</div>
  </div>

  <!-- Dialog Neuer Eintrag / Bearbeiten -->
  <dialog id="entryDlg">
    <div class="dlg-head">
      <div>
        <div id="dlgTitle" style="font-weight:600;">Neuer Eintrag</div>
        <div style="font-size:12px;color:var(--txt-dim);line-height:1.4;">
          Einsatz planen / bearbeiten
        </div>
      </div>
      <button id="btnEntryClose">✕</button>
    </div>

    <div class="dlg-body">
      <div class="dlg-row">
        <label for="fTitle">Titel / Projekt</label>
        <input id="fTitle" placeholder="z.B. Dachsanierung Müller" />
      </div>

      <div class="dlg-row">
        <label for="fWorkers">Mitarbeiter</label>
        <input id="fWorkers" placeholder="z.B. Herbert, Patrick" />
        <div class="tag-line" id="tagWorkers"></div>
      </div>

      <div class="dlg-row">
        <label for="fVehicles">Fahrzeuge / Geräte</label>
        <input id="fVehicles" placeholder="z.B. Mercedes Bus, Kran" />
        <div class="tag-line" id="tagVehicles"></div>
      </div>

      <div class="dlg-row">
        <label for="fDate">Tag</label>
        <input id="fDate" type="date" />
      </div>

      <div class="dlg-row">
        <label for="fNote">Team-Notiz</label>
        <textarea id="fNote" placeholder="optional"></textarea>
      </div>
    </div>

    <div class="dlg-foot">
      <button class="ghost" id="btnEntryCancel">Abbrechen</button>
      <button class="primary" id="btnEntrySave">Speichern</button>
    </div>
  </dialog>

  <!-- Dialog Stammdaten -->
  <dialog id="masterDlg">
    <div class="dlg-head">
      <div>
        <div style="font-weight:600;">Stammdaten</div>
        <div style="font-size:12px;color:var(--txt-dim);line-height:1.4;">
          Mitarbeiter &amp; Fahrzeuge verwalten
        </div>
      </div>
      <button id="btnMasterClose">✕</button>
    </div>

    <div class="dlg-body" style="max-height:60vh;overflow-y:auto;">
      <!-- Mitarbeiter -->
      <div class="subbox">
        <div class="subbox-head">
          <span>Mitarbeiter</span>
        </div>
        <div class="subbox-list" id="listWorkers">
          <!-- wird aus Firestore geladen -->
        </div>

        <div class="dlg-row">
          <label for="mNewWorker">Neuen Mitarbeiter hinzufügen</label>
          <input id="mNewWorker" placeholder="Name" />
        </div>
        <div class="dlg-row">
          <button class="primary" id="btnAddWorker">+ Mitarbeiter speichern</button>
        </div>
      </div>

      <!-- Fahrzeuge -->
      <div class="subbox">
        <div class="subbox-head">
          <span>Fahrzeuge / Geräte</span>
        </div>
        <div class="subbox-list" id="listVehicles">
          <!-- wird aus Firestore geladen -->
        </div>

        <div class="dlg-row">
          <label for="mNewVehicle">Neues Fahrzeug/ Gerät hinzufügen</label>
          <input id="mNewVehicle" placeholder="z.B. Mercedes Bus" />
        </div>
        <div class="dlg-row">
          <button class="primary" id="btnAddVehicle">+ Fahrzeug speichern</button>
        </div>
      </div>

      <div style="font-size:12px;color:var(--txt-dim);line-height:1.4;">
        Tipp: Mit diesen Stammdaten kannst du in den Einsätzen schneller Mitarbeiter/Fahrzeuge auswählen.
      </div>
    </div>

    <div class="dlg-foot">
      <button class="ghost" id="btnMasterCancel">Schließen</button>
    </div>
  </dialog>

  <!-- Firebase + App Logik -->
  <script type="module">
    /********************************
     * Firebase SDK (stabil, ohne AppCheck)
     ********************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      getDoc,
      getDocs,
      onSnapshot,
      query,
      where,
      orderBy,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---- Deine Firebase-Konfiguration (aus der Konsole) ----
    const firebaseConfig = {
      apiKey: "AIzaSyDpWF-XnO23Bx-ebCVg6a42Drxm9f4SxDI",
      authDomain: "plantafelfreyllich100.firebaseapp.com",
      projectId: "plantafelfreyllich100",
      storageBucket: "plantafelfreyllich100.firebasestorage.app",
      messagingSenderId: "962959139135",
      appId: "1:962959139135:web:e4462794477815c0ef914da",
      measurementId: "G-W5VGSSLTRC"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Verbindungsanzeige
    const cloudDot  = document.getElementById('cloudDot');
    const cloudTxt  = document.getElementById('cloudTxt');

    function setOnlineStatus(ok) {
      if (ok) {
        cloudDot.style.background = '#2ecc71';
        cloudDot.style.boxShadow  = '0 0 8px #2ecc71';
        cloudTxt.textContent = 'verbunden';
      } else {
        cloudDot.style.background = '#d32f2f';
        cloudDot.style.boxShadow  = '0 0 8px #d32f2f';
        cloudTxt.textContent = 'offline';
      }
    }

    // Wir versuchen regelmäßig was aus Firestore zu lesen:
    async function heartbeat() {
      try {
        // winziger Zugriff: lies eine (ggf. nicht vorhandene) Dummy-Collection
        const testCol = collection(db, "_heartbeat");
        await getDocs(testCol);
        setOnlineStatus(true);
      } catch (err) {
        console.warn("heartbeat fail:", err);
        setOnlineStatus(false);
      }
    }
    heartbeat();
    setInterval(heartbeat, 15000); // alle 15s prüfen

    /********************************
     * DOM-Referenzen
     ********************************/
    const boardEl        = document.getElementById('board');
    const viewSel        = document.getElementById('viewSel');
    const startDateInp   = document.getElementById('startDate');
    const chkUrlaub      = document.getElementById('chkUrlaub');
    const chkAutoReload  = document.getElementById('chkAutoReload');
    const btnReload      = document.getElementById('btnReload');
    const btnAdd         = document.getElementById('btnAdd');
    const btnMaster      = document.getElementById('btnMaster');
    const fabPlus        = document.getElementById('fabPlus');

    // Dialog Neuer Eintrag
    const entryDlg       = document.getElementById('entryDlg');
    const btnEntryClose  = document.getElementById('btnEntryClose');
    const btnEntryCancel = document.getElementById('btnEntryCancel');
    const btnEntrySave   = document.getElementById('btnEntrySave');
    const dlgTitle       = document.getElementById('dlgTitle');

    const fTitle         = document.getElementById('fTitle');
    const fWorkers       = document.getElementById('fWorkers');
    const fVehicles      = document.getElementById('fVehicles');
    const fDate          = document.getElementById('fDate');
    const fNote          = document.getElementById('fNote');

    const tagWorkers     = document.getElementById('tagWorkers');
    const tagVehicles    = document.getElementById('tagVehicles');

    // Dialog Stammdaten
    const masterDlg      = document.getElementById('masterDlg');
    const btnMasterClose = document.getElementById('btnMasterClose');
    const btnMasterCancel= document.getElementById('btnMasterCancel');
    const btnAddWorker   = document.getElementById('btnAddWorker');
    const btnAddVehicle  = document.getElementById('btnAddVehicle');
    const mNewWorker     = document.getElementById('mNewWorker');
    const mNewVehicle    = document.getElementById('mNewVehicle');
    const listWorkers    = document.getElementById('listWorkers');
    const listVehicles   = document.getElementById('listVehicles');

    /********************************
     * Helfer / State
     ********************************/
    let currentEditId = null;    // welcher Eintrag wird bearbeitet
    let autoReloadTimer = null;  // Intervall fürs Auto-Reload

    // Startdatum initial = heute
    const todayISO = new Date().toISOString().slice(0,10);
    startDateInp.value = todayISO;

    // Ansicht initial
    viewSel.value = "4w";

    // Urlaub/Krank default AUS (false)
    chkUrlaub.checked = false;

    // autoReload default AUS
    chkAutoReload.checked = false;

    // Dummy-Liste Mitarbeiter / Fahrzeuge lokal (wird aus Firestore geladen)
    let cachedWorkers  = [];
    let cachedVehicles = [];

    /********************************
     * Firestore Zugriff
     ********************************/

    // Collections:
    // - "plantafel"  -> einzelne Einsätze mit Feldern:
    //    { title, workers[], vehicles[], date (YYYY-MM-DD), note, redFlag (bool), ts }
    // - "settings/workers"  -> { list: ["Herbert","Patrick", ...] }
    // - "settings/vehicles" -> { list: ["Mercedes Bus","Kran", ...] }

    async function loadStammdaten() {
        try {
            const workersDocRef = doc(db, "settings", "workers");
            const workersSnap   = await getDoc(workersDocRef);
            cachedWorkers = workersSnap.exists() ? (workersSnap.data().list || []) : [];

            const vehiclesDocRef = doc(db, "settings", "vehicles");
            const vehiclesSnap   = await getDoc(vehiclesDocRef);
            cachedVehicles = vehiclesSnap.exists() ? (vehiclesSnap.data().list || []) : [];

            renderStammdaten();
        } catch (err) {
            console.error("loadStammdaten error:", err);
        }
    }

    async function saveWorkers() {
        const ref = doc(db, "settings", "workers");
        await setDoc(ref, { list: cachedWorkers, ts: serverTimestamp() });
    }
    async function saveVehicles() {
        const ref = doc(db, "settings", "vehicles");
        await setDoc(ref, { list: cachedVehicles, ts: serverTimestamp() });
    }

    async function addWorker(name) {
        if (!name.trim()) return;
        if (!cachedWorkers.includes(name.trim())) {
            cachedWorkers.push(name.trim());
            await saveWorkers();
            renderStammdaten();
        }
    }
    async function removeWorker(name) {
        cachedWorkers = cachedWorkers.filter(w => w !== name);
        await saveWorkers();
        renderStammdaten();
    }
    async function addVehicle(v) {
        if (!v.trim()) return;
        if (!cachedVehicles.includes(v.trim())) {
            cachedVehicles.push(v.trim());
            await saveVehicles();
            renderStammdaten();
        }
    }
    async function removeVehicle(v) {
        cachedVehicles = cachedVehicles.filter(x => x !== v);
        await saveVehicles();
        renderStammdaten();
    }

    // Einsätze laden innerhalb eines Bereichs
    async function loadEntries(startIso, numDays){
        // wir holen ALLE Einträge zwischen startIso .. startIso+numDays
        // in Collection "plantafel"
        try {
            const colRef = collection(db, "plantafel");
            // einfache Variante: hol ALLES, filter dann in JS
            const snap = await getDocs(colRef);
            const all = [];
            snap.forEach(d=>{
                const data = d.data();
                all.push({
                    id: d.id,
                    ...data
                });
            });

            // Filter per Datum
            const startMs = Date.parse(startIso);
            const endMs   = startMs + (numDays*24*60*60*1000);

            const filtered = all.filter(it=>{
                if(!it.date) return false;
                const t = Date.parse(it.date);
                return (t>=startMs && t<endMs);
            });

            return filtered;
        } catch(err){
            console.error("loadEntries error:",err);
            return [];
        }
    }

    async function saveEntry(obj) {
        // neu oder update?
        if (currentEditId) {
            const ref = doc(db,"plantafel",currentEditId);
            await updateDoc(ref,{
                title:obj.title||"",
                workers:obj.workers||[],
                vehicles:obj.vehicles||[],
                date:obj.date||todayISO,
                note:obj.note||"",
                redFlag:!!obj.redFlag,
                ts: serverTimestamp()
            });
        } else {
            const colRef = collection(db,"plantafel");
            await addDoc(colRef,{
                title:obj.title||"",
                workers:obj.workers||[],
                vehicles:obj.vehicles||[],
                date:obj.date||todayISO,
                note:obj.note||"",
                redFlag:!!obj.redFlag,
                ts: serverTimestamp()
            });
        }
    }

    async function deleteEntry(id){
        const ref = doc(db,"plantafel",id);
        await deleteDoc(ref);
    }

    /********************************
     * Render Stammdaten-Dialog
     ********************************/
    function renderStammdaten(){
        // Mitarbeiter
        listWorkers.innerHTML = "";
        cachedWorkers.forEach(w=>{
            const pill = document.createElement("div");
            pill.className = "sub-pill";
            pill.innerHTML = `
              <span>${w}</span>
              <span class="x" data-w="${w}">✕</span>
            `;
            listWorkers.appendChild(pill);
        });

        // Fahrzeuge
        listVehicles.innerHTML = "";
        cachedVehicles.forEach(v=>{
            const pill = document.createElement("div");
            pill.className = "sub-pill";
            pill.innerHTML = `
              <span>${v}</span>
              <span class="x" data-v="${v}">✕</span>
            `;
            listVehicles.appendChild(pill);
        });
    }

    listWorkers.addEventListener("click", (e)=>{
        const x = e.target.closest(".x");
        if(!x) return;
        const name = x.getAttribute("data-w");
        if(!name) return;
        removeWorker(name);
    });

    listVehicles.addEventListener("click", (e)=>{
        const x = e.target.closest(".x");
        if(!x) return;
        const name = x.getAttribute("data-v");
        if(!name) return;
        removeVehicle(name);
    });

    btnAddWorker.addEventListener("click", async ()=>{
        await addWorker(mNewWorker.value||"");
        mNewWorker.value="";
    });
    btnAddVehicle.addEventListener("click", async ()=>{
        await addVehicle(mNewVehicle.value||"");
        mNewVehicle.value="";
    });

    /********************************
     * Render Board / Wochen
     ********************************/

    function getViewRangeDays(){
        // für "4w" zeigen wir 20 Tage (Mo-Fr x4)
        // für "2w" -> 10 Tage
        // für "1w" -> 5 Tage
        switch(viewSel.value){
            case "2w": return 10;
            case "1w": return 5;
            default: return 20;
        }
    }

    function buildDayBuckets(startIso, numDays){
        // wir gruppieren nach einzelnen Tagen,
        // packen dann je Tag in "KW xx <Wochentag>"
        // -> später können wir Tage einer KW auch zusammenfassen
        const buckets = [];
        const startMs = Date.parse(startIso);

        for(let i=0;i<numDays;i++){
            const dMs = startMs + i*24*60*60*1000;
            const d   = new Date(dMs);
            const iso = d.toISOString().slice(0,10);

            // KW berechnen (ISO Woche)
            const tmp = new Date(d);
            // ISO Week
            const dayNum = (d.getDay()+6)%7 + 1;
            tmp.setDate(d.getDate() - dayNum + 3);
            const firstThursday = tmp.getTime();
            tmp.setMonth(0,1);
            tmp.setDate(tmp.getDate() + 3 - ((tmp.getDay()+6)%7 + 1));
            const week = 1 + Math.round((firstThursday - tmp.getTime()) / 604800000);

            const weekdayNames = ["So","Mo","Di","Mi","Do","Fr","Sa"];
            const wdShort = weekdayNames[d.getDay()] || "";

            buckets.push({
                iso,
                week,
                weekday: wdShort,
                entries: []
            });
        }
        return buckets;
    }

    function renderBoard(buckets){
        boardEl.innerHTML = "";

        // wir gruppieren Tage mit gleichem week zusammen in Spalten
        const byWeek = {};
        for(const b of buckets){
            if(!byWeek[b.week]) byWeek[b.week] = [];
            byWeek[b.week].push(b);
        }

        Object.keys(byWeek).sort((a,b)=>Number(a)-Number(b)).forEach(kw=>{
            const days = byWeek[kw];

            // Spalten-Element
            const col = document.createElement("div");
            col.className = "week-col";

            // Kopf
            const head = document.createElement("div");
            head.className = "week-head";

            const left = document.createElement("div");
            left.className = "week-head-left";

            // z.B. "KW 44 Do"
            const firstDay = days[0];
            const titleTxt = `KW ${kw} ${firstDay.weekday}`;
            const dateTxt  = firstDay.iso;

            const titleEl = document.createElement("div");
            titleEl.className = "kw-title";
            titleEl.textContent = titleTxt;

            const dateEl = document.createElement("div");
            dateEl.className = "kw-date";
            dateEl.textContent = dateTxt;

            left.appendChild(titleEl);
            left.appendChild(dateEl);

            const right = document.createElement("div");
            right.className = "week-head-right";

            // plus-button (hinzufügen in dieser Spalte)
            const plusBtn = document.createElement("div");
            plusBtn.className = "mini-btn";
            plusBtn.textContent = "+";
            plusBtn.title = "Neuer Eintrag für diesen Tag";
            plusBtn.addEventListener("click", ()=>{
                openEntryDialogForNew(dateTxt);
            });

            right.appendChild(plusBtn);

            head.appendChild(left);
            head.appendChild(right);

            col.appendChild(head);

            // Inhaltstage in dieser KW zusammen rendern
            const bodyArea = document.createElement("div");
            bodyArea.className = "slot-area";

            // Jeder Tag kriegt Überschrift + Karten
            days.forEach(day=>{
                // Tag-Titel in Spalte
                const subHead = document.createElement("div");
                subHead.style.color = "var(--txt-dim)";
                subHead.style.fontSize = "12px";
                subHead.style.fontWeight = "500";
                subHead.style.marginBottom = "4px";
                subHead.textContent = day.iso + " ("+day.weekday+")";
                bodyArea.appendChild(subHead);

                if(day.entries.length===0){
                    const empty = document.createElement("div");
                    empty.style.border="1px dashed rgba(255,255,255,.15)";
                    empty.style.borderRadius="6px";
                    empty.style.padding="10px";
                    empty.style.fontSize="12px";
                    empty.style.color="var(--txt-dim)";
                    empty.style.lineHeight="1.4";
                    empty.textContent="Klicken zum Eintragen · Drag & Drop möglich";
                    // Klick = neuer Eintrag auf genau dieses Datum
                    empty.addEventListener("click", ()=>{
                        openEntryDialogForNew(day.iso);
                    });
                    bodyArea.appendChild(empty);
                } else {
                    day.entries.forEach(ent=>{
                        // Karte bauen
                        const card = document.createElement("div");
                        card.className = "card";
                        if(ent.redFlag) card.classList.add("red");

                        // Aktionen (X / edit)
                        const acts = document.createElement("div");
                        acts.className = "card-actions";
                        const btnDel = document.createElement("div");
                        btnDel.className="card-act-btn danger";
                        btnDel.textContent="X";
                        btnDel.title="Löschen";
                        btnDel.addEventListener("click",(ev)=>{
                            ev.stopPropagation();
                            reallyDelete(ent.id);
                        });
                        const btnEdit = document.createElement("div");
                        btnEdit.className="card-act-btn";
                        btnEdit.textContent="✎";
                        btnEdit.title="Bearbeiten";
                        btnEdit.addEventListener("click",(ev)=>{
                            ev.stopPropagation();
                            openEntryDialogForEdit(ent);
                        });

                        acts.appendChild(btnEdit);
                        acts.appendChild(btnDel);
                        card.appendChild(acts);

                        // Titel
                        const topRow = document.createElement("div");
                        topRow.className = "card-row-top";
                        topRow.textContent = ent.title || "(kein Titel)";
                        card.appendChild(topRow);

                        // middle row -> Mitarbeiter / Fahrzeuge
                        const midRow = document.createElement("div");
                        midRow.className = "card-row-middle";

                        // Mitarbeiter
                        (ent.workers||[]).forEach(w=>{
                            const p = document.createElement("div");
                            p.className="pill worker";
                            p.textContent=w;
                            midRow.appendChild(p);
                        });
                        // Fahrzeuge
                        (ent.vehicles||[]).forEach(v=>{
                            const p = document.createElement("div");
                            p.className="pill car";
                            p.textContent=v;
                            midRow.appendChild(p);
                        });

                        // Flag rot?
                        if(ent.redFlag){
                            const pr = document.createElement("div");
                            pr.className="pill red";
                            pr.textContent="Urlaub/Krank/Schule";
                            midRow.appendChild(pr);
                        }

                        card.appendChild(midRow);

                        // bottom row -> Notiz
                        const btmRow = document.createElement("div");
                        btmRow.className = "card-row-bottom";
                        if(ent.note){
                            const noteEl = document.createElement("div");
                            noteEl.textContent = ent.note;
                            btmRow.appendChild(noteEl);
                        }
                        card.appendChild(btmRow);

                        // Klick auf ganze Karte = bearbeiten
                        card.addEventListener("click",()=>{
                            openEntryDialogForEdit(ent);
                        });

                        bodyArea.appendChild(card);
                    });
                }

                // kleiner Abstand zwischen den Tagen
                const sep = document.createElement("div");
                sep.style.height="12px";
                bodyArea.appendChild(sep);
            });

            col.appendChild(bodyArea);
            boardEl.appendChild(col);
        });
    }

    /********************************
     * Dialog Steuerung Eintrag
     ********************************/
    function clearEntryDialog(){
        currentEditId = null;
        dlgTitle.textContent = "Neuer Eintrag";
        fTitle.value    = "";
        fWorkers.value  = "";
        fVehicles.value = "";
        fDate.value     = todayISO;
        fNote.value     = "";
        renderTagPreview();
    }

    function fillEntryDialog(ent){
        currentEditId = ent.id;
        dlgTitle.textContent = "Eintrag bearbeiten";
        fTitle.value    = ent.title || "";
        fWorkers.value  = (ent.workers||[]).join(", ");
        fVehicles.value = (ent.vehicles||[]).join(", ");
        fDate.value     = ent.date || todayISO;
        fNote.value     = ent.note || "";
        renderTagPreview();
    }

    function openEntryDialogForNew(defaultDate){
        clearEntryDialog();
        if(defaultDate){
            fDate.value = defaultDate;
        }
        entryDlg.showModal();
    }
    function openEntryDialogForEdit(ent){
        fillEntryDialog(ent);
        entryDlg.showModal();
    }

    btnEntryClose.addEventListener("click",()=>entryDlg.close());
    btnEntryCancel.addEventListener("click",()=>entryDlg.close());

    btnEntrySave.addEventListener("click", async ()=>{
        const workersArr  = splitToArray(fWorkers.value);
        const vehiclesArr = splitToArray(fVehicles.value);

        const obj = {
            title:fTitle.value.trim(),
            workers:workersArr,
            vehicles:vehiclesArr,
            date:fDate.value || todayISO,
            note:fNote.value.trim(),
            redFlag: chkUrlaub.checked ? true : false
        };
        try{
            await saveEntry(obj);
            entryDlg.close();
            await reloadBoard(); // neu laden
        }catch(err){
            console.error("Speichern fehlgeschlagen:", err);
            alert("Fehler beim Speichern. Siehe Konsole.");
        }
    });

    function splitToArray(str){
        return str
          .split(",")
          .map(s=>s.trim())
          .filter(s=>s.length>0);
    }

    function renderTagPreview(){
        // Nur optische Vorschau unter den Inputs.
        tagWorkers.innerHTML="";
        splitToArray(fWorkers.value).forEach(w=>{
            const el=document.createElement("div");
            el.className="pill worker";
            el.textContent=w;
            tagWorkers.appendChild(el);
        });

        tagVehicles.innerHTML="";
        splitToArray(fVehicles.value).forEach(v=>{
            const el=document.createElement("div");
            el.className="pill car";
            el.textContent=v;
            tagVehicles.appendChild(el);
        });
    }

    fWorkers.addEventListener("input", renderTagPreview);
    fVehicles.addEventListener("input", renderTagPreview);

    /********************************
     * Dialog Stammdaten
     ********************************/
    btnMaster.addEventListener("click", async ()=>{
        await loadStammdaten();
        masterDlg.showModal();
    });
    btnMasterClose.addEventListener("click",()=> masterDlg.close());
    btnMasterCancel.addEventListener("click",()=> masterDlg.close());

    /********************************
     * Löschen
     ********************************/
    async function reallyDelete(id){
        const ok = confirm("Diesen Eintrag wirklich löschen?");
        if(!ok) return;
        try {
            await deleteEntry(id);
            await reloadBoard();
        } catch(err){
            console.error("Löschen fehlgeschlagen:",err);
            alert("Fehler beim Löschen (Konsole).");
        }
    }

    /********************************
     * Board neu laden
     ********************************/
    async function reloadBoard(){
        const startIso = startDateInp.value || todayISO;
        const numDays  = getViewRangeDays();

        // 1. Buckets (Tage)
        const buckets = buildDayBuckets(startIso,numDays);

        // 2. Einträge laden
        const entries = await loadEntries(startIso,numDays);

        // 3. Zuordnen
        for(const b of buckets){
            b.entries = entries.filter(e => e.date===b.iso);
        }

        // 4. Rendern
        renderBoard(buckets);
    }

    btnReload.addEventListener("click", reloadBoard);
    fabPlus.addEventListener("click", ()=>openEntryDialogForNew(todayISO));
    btnAdd  .addEventListener("click", ()=>openEntryDialogForNew(todayISO));

    viewSel.addEventListener("change", reloadBoard);
    startDateInp.addEventListener("change", reloadBoard);
    chkUrlaub.addEventListener("change", ()=>{/* Flag wirkt nur beim Speichern, kein Reload nötig */});

    // Auto-Reload Handling
    chkAutoReload.addEventListener("change", ()=>{
        if(chkAutoReload.checked){
            // alle 20s reload
            autoReloadTimer = setInterval(reloadBoard, 20000);
        }else{
            clearInterval(autoReloadTimer);
            autoReloadTimer=null;
        }
    });

    // Initial einmal laden
    reloadBoard();
  </script>
</body>
</html>
