<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Plantafel Dachdeckerei Frey – V2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --blue:#0b63c6; --bg:#e9e9ee; --card:#fff;
  --line:#d0d0d4; --text:#0f172a; --radius:10px;
  --vehicle:#cc0000; --urlaub:#facc15;
  --krank:#ef4444; --schule:#38bdf8;
}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);font-family:system-ui;color:var(--text);}
header{background:var(--blue);color:#fff;padding:.8rem 1rem;display:flex;gap:.8rem;flex-wrap:wrap;align-items:center;}
header h1{margin:0;font-size:1.2rem;white-space:nowrap;}

.btn-tabs button{
  background:rgba(255,255,255,.15);
  color:#fff;border:1px solid rgba(255,255,255,.3);
  border-radius:6px;padding:.3rem .7rem;cursor:pointer;
}
.btn-tabs .active{background:#fff;color:var(--blue);}

input[type="date"]{
  border:1px solid rgba(255,255,255,.4);
  background:rgba(255,255,255,.25);
  color:#fff;border-radius:6px;padding:.25rem .4rem;
}
.btn{
  background:#fff;color:var(--blue);
  border:none;border-radius:6px;
  padding:.35rem .75rem;cursor:pointer;
  font-weight:600;
}
.btn.secondary{background:rgba(255,255,255,.2);color:#fff;}

.legend{
  margin-left:auto;background:rgba(255,255,255,.2);
  padding:.4rem .6rem;border-radius:6px;
  display:flex;flex-direction:column;gap:.25rem;font-size:.65rem;
}
.legend-row{display:flex;align-items:center;gap:.35rem;}
.legend-color{width:14px;height:14px;border-radius:3px;border:1px solid #fff;}

main{padding:1rem;min-height:calc(100vh - 120px);}

/* Monatsraster 3x4 */
.months-grid{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:.8rem;
}

.month-box{
  background:var(--card);border:1px solid var(--line);
  border-radius:var(--radius);display:flex;
  flex-direction:column;min-height:180px;
}
.month-head{
  background:#f1f5f9;border-bottom:1px solid #d0d4dd;
  padding:.5rem .6rem;font-weight:600;font-size:.85rem;
}
.month-body{
  padding:.5rem;display:flex;flex-direction:column;
  gap:.35rem;flex:1;
}

.entry{
  padding:.25rem .35rem;border-radius:6px;cursor:pointer;
  font-size:.72rem;border:1px solid rgba(0,0,0,.08);
  box-shadow:0 1px 2px rgba(0,0,0,.07);
}
.entry-title{font-weight:600;}
.entry-meta{font-size:.65rem;}

dialog{
  border:none;border-radius:12px;padding:1rem 1.2rem;
  width:min(95vw,480px);box-shadow:0 15px 40px rgba(0,0,0,.35);
}
dialog::backdrop{background:rgba(0,0,0,.4);}
label{margin-top:.5rem;display:block;font-size:.78rem;font-weight:600;}
input,textarea,select{
  width:100%;border:1px solid #ccd;
  border-radius:6px;padding:.3rem .4rem;font-size:.8rem;
}
textarea{min-height:60px;}

.checklist{
  border:1px solid #ccd;border-radius:6px;padding:.3rem;
  max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:.25rem;
}
.checklist label{display:flex;align-items:center;gap:.5rem;font-weight:500;margin:0;}

footer{
  background:var(--blue);color:#fff;text-align:center;
  padding:.4rem;font-size:.7rem;
}
</style>
</head>

<body>
<header>
  <h1>Plantafel Dachdeckerei Frey</h1>

  <div class="btn-tabs" id="viewTabs">
    <button data-view="4w" class="active">4 Wochen</button>
    <button data-view="14d">14 Tage</button>
    <button data-view="12m">12 Monate</button>
  </div>

  <div>Start: <input type="date" id="startDate"></div>

  <button class="btn secondary" id="reloadBtn">Neu laden</button>
  <button class="btn secondary" id="stammBtn">Stammdaten</button>
  <button class="btn" id="newEntryBtn">+ Eintrag</button>

  <div class="legend">
    <div class="legend-row"><div class="legend-color" style="background:var(--urlaub)"></div>Urlaub</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--krank)"></div>Krank</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--schule)"></div>Schule</div>
    <div class="legend-row"><div class="legend-color" style="background:var(--vehicle)"></div>Fahrzeug</div>
  </div>
</header>

<main>
  <div id="boardContainer"></div>
</main>

<!-- EINTRAG DIALOG -->
<dialog id="entryDialog">
  <form id="entryForm" method="dialog">
    <h3>Eintrag</h3>

    <label>Baustelle / Auftrag
      <input type="text" id="fBaustelle" required>
    </label>

    <label>Von
      <input type="date" id="fVon" required>
    </label>

    <label>Bis (optional)
      <input type="date" id="fBis">
    </label>

    <label>Mitarbeiter</label>
    <div class="checklist" id="fMitarbeiterBox"></div>

    <label>Fahrzeuge</label>
    <div class="checklist" id="fFahrzeugeBox"></div>

    <label>Status
      <select id="fStatus">
        <option value="">normal</option>
        <option>Urlaub</option>
        <option>Krank</option>
        <option>Schule</option>
      </select>
    </label>

    <label>Notiz
      <textarea id="fNotiz"></textarea>
    </label>

    <input type="hidden" id="fId">

    <div style="margin-top:.7rem;display:flex;gap:.4rem;">
      <button type="button" id="deleteEntryBtn" style="background:#fee2e2;border:1px solid #fca5a5;padding:.3rem .6rem;display:none;">Löschen</button>
      <button type="button" onclick="entryDialog.close()">Abbrechen</button>
      <button class="btn">Speichern</button>
    </div>
  </form>
</dialog>

<!-- STAMMDATEN -->
<dialog id="stammDialog">
  <form id="stammForm" method="dialog">
    <h3>Stammdaten</h3>

    <label>Neuer Mitarbeiter
      <input type="text" id="sMitarbeiter">
    </label>
    <button type="button" class="btn" onclick="addStamm('mitarbeiter')">+ hinzufügen</button>
    <div id="listMitarbeiter"></div>

    <label>Neues Fahrzeug
      <input type="text" id="sFahrzeug">
    </label>
    <button type="button" class="btn" onclick="addStamm('fahrzeuge')">+ hinzufügen</button>
    <div id="listFahrzeuge"></div>

    <label>Neue Baustelle
      <input type="text" id="sBaustelle">
    </label>
    <button type="button" class="btn" onclick="addStamm('baustellen')">+ hinzufügen</button>
    <div id="listBaustellen"></div>

    <button type="button" onclick="stammDialog.close()" style="margin-top:.7rem;">Schließen</button>
  </form>
</dialog>

<footer>© 2025 Dachdeckerei Frey – Digitale Plantafel</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

// SUPABASE
const supa = supabase.createClient(
  "https://mtybmrkyhavxpvwysglo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10eWJtcmt5aGF2eHB2d3lzZ2xvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNjQ1OTIsImV4cCI6MjA3Nzc0MDU5Mn0.UToAmJAvACYvnO9hCIeyfm-VYKr5jincXdnEDDtbhvo"
);

let mitarbeiter=[], fahrzeuge=[], baustellen=[], eintraege=[];
let currentView="4w";

// Farben für Mitarbeiter
function colorFromName(name){
  if(!name)return "#94a3b8";
  let hash=0;
  for(let i=0;i<name.length;i++){
    hash=name.charCodeAt(i)+((hash<<5)-hash);
  }
  const h=Math.abs(hash)%360;
  return `hsl(${h},65%,50%)`;
}

// Laden aller Daten
async function loadAll(){
  const m=await supa.from("mitarbeiter").select("*").order("name");
  mitarbeiter=m.data||[];
  const f=await supa.from("fahrzeuge").select("*").order("name");
  fahrzeuge=f.data||[];
  const b=await supa.from("baustellen").select("*").order("name");
  baustellen=b.data||[];
  await loadEntries();
}

// Einträge laden
async function loadEntries(){
  const e=await supa.from("plantafel").select("*").order("tag");
  eintraege=e.data||[];
  renderBoard();
}

// BOARD rendern
function renderBoard(){
  const start=new Date(startDateInput.value);
  boardContainer.innerHTML="";

  if(currentView==="12m") renderMonths(start);
  else if(currentView==="14d") render14days(start);
  else render4weeks(start);
}

// 12 MONATE – ROLLING 3x4
function renderMonths(startDate){
  const wrap=document.createElement("div");
  wrap.className="months-grid";

  for(let i=0;i<12;i++){
    const d=new Date(startDate);
    d.setMonth(d.getMonth()+i);

    const box=document.createElement("div");
    box.className="month-box";

    const head=document.createElement("div");
    head.className="month-head";
    head.textContent=d.toLocaleString("de-DE",{month:"long",year:"numeric"});

    const body=document.createElement("div");
    body.className="month-body";

    const items=eintraege.filter(e=>{
      const t=new Date(e.tag);
      return t.getFullYear()==d.getFullYear() && t.getMonth()==d.getMonth();
    });

    items.forEach(e=>body.appendChild(buildEntryCard(e)));

    box.appendChild(head);
    box.appendChild(body);
    wrap.appendChild(box);
  }
  boardContainer.appendChild(wrap);
}


// 14 Tage
function render14days(start){
  const wrap=document.createElement("div");
  wrap.style.display="grid";
  wrap.style.gridTemplateColumns="repeat(auto-fit,minmax(180px,1fr))";
  wrap.style.gap=".8rem";

  let d=new Date(start);
  let added=0;

  while(added<14){
    const day=d.getDay();
    if(day!==0 && day!==6){
      wrap.appendChild(buildDayBox(new Date(d)));
      added++;
    }
    d.setDate(d.getDate()+1);
  }
  boardContainer.appendChild(wrap);
}

// 4 Wochen
function render4weeks(start){
  const wrap=document.createElement("div");
  wrap.style.display="grid";
  wrap.style.gridTemplateColumns="repeat(5,minmax(160px,1fr))";
  wrap.style.gap=".8rem";

  const s=new Date(start);
  const day=s.getDay();
  const diff=(day===0?6:day-1);
  s.setDate(s.getDate()-diff);

  for(let w=0;w<4;w++){
    for(let wd=0;wd<5;wd++){
      const d=new Date(s);
      d.setDate(s.getDate()+w*7+wd);
      wrap.appendChild(buildDayBox(d));
    }
  }
  boardContainer.appendChild(wrap);
}

// EINZELNER TAG
function buildDayBox(d){
  const col=document.createElement("div");
  col.className="month-box";
  col.dataset.date=d.toISOString().slice(0,10);

  const head=document.createElement("div");
  head.className="month-head";
  head.textContent=d.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit"});

  const list=document.createElement("div");
  list.className="month-body";

  const items=eintraege.filter(e=>e.tag===col.dataset.date);
  items.forEach(e=>list.appendChild(buildEntryCard(e)));

  col.appendChild(head);
  col.appendChild(list);
  return col;
}

// EINTRAG CARD
function buildEntryCard(e){
  const div=document.createElement("div");
  div.className="entry";
  div.onclick=()=>openEntry(e);

  let bg="#f8fafc", col="#000";

  if(e.status==="Urlaub"){bg="var(--urlaub)";col="#000";}
  else if(e.status==="Krank"){bg="var(--krank)";col="#fff";}
  else if(e.status==="Schule"){bg="var(--schule)";col="#fff";}
  else if(e.mitarbeiter){
    const first=e.mitarbeiter.split(",")[0].trim();
    bg=colorFromName(first); col="#fff";
  }

  div.style.background=bg;
  div.style.color=col;

  const title=document.createElement("div");
  title.className="entry-title";
  title.textContent=e.titel;

  const meta=document.createElement("div");
  meta.className="entry-meta";
  meta.textContent=(e.mitarbeiter||"") + " " + (e.fahrzeug||"");

  div.appendChild(title);
  div.appendChild(meta);
  return div;
}

// ENTRY DIALOG ÖFFNEN
function openEntry(e){
  document.getElementById("fId").value=e.id||"";
  document.getElementById("fBaustelle").value=e.titel||"";
  document.getElementById("fVon").value=e.tag||startDateInput.value;
  document.getElementById("fBis").value=e.tag||"";
  document.getElementById("fStatus").value=e.status||"";
  document.getElementById("fNotiz").value=e.notiz||"";

  buildChecklist("fMitarbeiterBox",mitarbeiter,e.mitarbeiter);
  buildChecklist("fFahrzeugeBox",fahrzeuge,e.fahrzeug);

  deleteEntryBtn.style.display=e.id?"inline-block":"none";
  entryDialog.showModal();
}

// CHECKLISTE BAUEN
function buildChecklist(id, list, selected){
  const box=document.getElementById(id);
  box.innerHTML="";
  const sel=(selected||"").split(",").map(s=>s.trim());
  list.forEach(item=>{
    const lbl=document.createElement("label");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.value=item.name;
    if(sel.includes(item.name))cb.checked=true;
    lbl.appendChild(cb);
    lbl.append(" "+item.name);
    box.appendChild(lbl);
  });
}

// SPEICHERN EINTRAG
entryForm.addEventListener("submit", async (e)=>{
  e.preventDefault();

  const id=fId.value;
  const titel=fBaustelle.value.trim();
  const von=fVon.value;
  const bis=fBis.value||von;
  const status=fStatus.value;
  const notiz=fNotiz.value.trim();

  const mit=Array.from(document.querySelectorAll("#fMitarbeiterBox input:checked")).map(e=>e.value).join(", ");
  const fahr=Array.from(document.querySelectorAll("#fFahrzeugeBox input:checked")).map(e=>e.value).join(", ");

  if(id){
    await supa.from("plantafel").update({
      titel,tag:von,status,notiz,mitarbeiter:mit,fahrzeug:fahr
    }).eq("id",id);
  } else {
    const s=new Date(von);
    const e2=new Date(bis);
    let cur=new Date(s);

    const rows=[];
    while(cur<=e2){
      rows.push({
        titel,tag:cur.toISOString().slice(0,10),
        status,notiz,mitarbeiter:mit,fahrzeug:fahr
      });
      cur.setDate(cur.getDate()+1);
    }
    await supa.from("plantafel").insert(rows);
  }

  entryDialog.close();
  loadEntries();
});

// EINTRAG LÖSCHEN
deleteEntryBtn.onclick=async()=>{
  const id=fId.value;
  await supa.from("plantafel").delete().eq("id",id);
  entryDialog.close();
  loadEntries();
};

// STAMMDATEN
stammBtn.onclick=()=>{renderStamm();stammDialog.showModal();};

async function addStamm(type){
  const idMap={
    mitarbeiter:"sMitarbeiter",
    fahrzeuge:"sFahrzeug",
    baustellen:"sBaustelle"
  };
  const val=document.getElementById(idMap[type]).value.trim();
  if(!val) return;
  await supa.from(type).insert({name:val});
  document.getElementById(idMap[type]).value="";
  loadAll();
}

async function delStamm(type,id){
  await supa.from(type).delete().eq("id",id);
  loadAll();
}

function renderStamm(){
  renderList("listMitarbeiter",mitarbeiter,"mitarbeiter");
  renderList("listFahrzeuge",fahrzeuge,"fahrzeuge");
  renderList("listBaustellen",baustellen,"baustellen");
}

function renderList(boxId,list,type){
  const box=document.getElementById(boxId);
  box.innerHTML="";
  list.forEach(i=>{
    const div=document.createElement("div");
    div.style.margin=".2rem 0";
    div.innerHTML=
      `<span style="background:#eef;padding:.2rem .4rem;border-radius:4px;">${i.name}</span>
       <button onclick="delStamm('${type}', '${i.id}')" style="margin-left:.4rem;font-size:.7rem;">x</button>`;
    box.appendChild(div);
  });
}

// NAVIGATION
viewTabs.onclick=(e)=>{
  if(e.target.tagName!=="BUTTON")return;
  viewTabs.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  e.target.classList.add("active");
  currentView=e.target.dataset.view;
  renderBoard();
};

startDateInput.onchange=renderBoard;
reloadBtn.onclick=loadAll;
newEntryBtn.onclick=()=>openEntry({tag:startDateInput.value});

const today=new Date();
startDateInput.value=today.toISOString().slice(0,10);

loadAll();

</script>
</body>
</html>
